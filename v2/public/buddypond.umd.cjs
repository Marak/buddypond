(function(e,l){typeof exports=="object"&&typeof module<"u"?module.exports=l():typeof define=="function"&&define.amd?define(l):(e=typeof globalThis<"u"?globalThis:e||self,e.BP=l())})(this,function(){"use strict";const e={};return window.bp=e,e.log=console.log,e.log=function(){},e.error=console.error,e.config={host:""},e.apps={},e.data={},e._modules={},e._cache={},e._cache.css={},e._cache.html={},e._cache.js={},e.setConfig=function(o,t=!1){console.log("setConfig",o,t),t?e.config={...e.config,...o}:e.config=o},e.start=async function(o=[]){for(let t of o)await e.importModule(t)},e.open=async function(o,t={context:"default"}){console.log("bp.open",o,t);let n=o;typeof o=="string"&&(console.log("string loading async import app",n),await e.importModule(n,{},!0)),typeof o=="object"&&(n=o.name,t=o,console.log("object loading async import app",n,t),await e.importModule(n,t,!0)),console.log("aaa",n,e.apps),typeof e.apps[n].open=="function"&&(console.log("open",n,t),console.log("open",n,t),e.apps[n].open(t))},e.load=async function(o){if(typeof o=="string"){if(o.endsWith(".css"))return e.appendCSS(o);if(o.endsWith(".html"))return e.fetchHTMLFragment(o);if(o.endsWith(".js"))return e.appendScript(o);if(!o.includes("."))return e.importModule(o)}console.log("Cannot load unknown resource type",o)},e.importModule=async function(o,t,n=!0){console.log("importModule",o,t,n);let i=e.config.host+`/v2/apps/based/${o}/${o}.js`,r=o;if(typeof o=="object"&&(i=e.config.host+`/v2/apps/based/${o.name}/${o.name}.js`,t=o,r=o.name),n||(i=o),e._modules[i])return console.log("module already loaded",o),e._modules[i];try{console.log("attempting to load module",i);let c=await import(i);return n&&(e.apps[r]=new c.default(e,t),await e.apps[r].init(),e.log("init complete",r)),e._modules[i]=c,console.log("module loaded",c),c}catch(c){e.error("Failed to load module:",r,c),delete e.apps[r]}},e.fetchHTMLFragment=async function(o){let t=`${e.config.host}${o}`;return console.log("fetchHTMLFragment",t),e._cache.html[t]||(e._cache.html[t]=await fetch(t).then(n=>n.text())),e._cache.html[t]},e.appendCSS=function(o,t=!1){let n=o;if(!o.includes("http")&&!o.includes("blob")&&(n=`${e.config.host}${o}`),e._cache.css[n]&&!t)return"cached";e._cache.css[n]=new Date().getTime();let i=document.createElement("link");i.rel="stylesheet",i.href=n,document.head.appendChild(i)},e.appendScript=async function(o){let t=o;!o.includes("http")&&!o.includes("blob")&&(t=`${e.config.host}${o}`);let n=document.createElement("script");return n.src=t,document.head.appendChild(n),new Promise((i,r)=>{n.onload=i,n.onerror=r})},e.createWorker=async function(o,t={}){let n=`${e.config.host}/v2${o}`;e.log("createWorker",n);try{const r=await(await fetch(n)).blob(),c=URL.createObjectURL(r);let s=t||{};const a=new Worker(c,s);return e.log("Local Worker created from:",o),a}catch(i){return console.error("Failed to load worker script:",o,i),null}},e._emitters={},e.emit=function(o,...t){e.log("emit",o,...t),e._emitters[o]&&e._emitters[o].forEach(n=>{n.callback&&n.callback(...t)})},e.on=function(o,t,n){if(!o||!t||!n)throw new Error("Missing required parameters for on()");e._emitters[o]||(e._emitters[o]=[]),e._emitters[o].push({label:t,callback:n}),e.log("on",o,t)},e.off=function(o,t){e.log("off",o,t),e._emitters[o]&&(e._emitters[o]=e._emitters[o].filter(n=>n.label!==t))},e.me="Guest",e});
