(function(e,r){typeof exports=="object"&&typeof module<"u"?module.exports=r():typeof define=="function"&&define.amd?define(r):(e=typeof globalThis<"u"?globalThis:e||self,e.BP=r())})(this,function(){"use strict";const e={};return typeof window<"u"&&(window.bp=e),e.log=console.log,e.log=function(){},e.error=console.error,e.reportError=function(){},e.config={host:""},e.apps={},e.data={},e.settings={},e._modules={},e.vendor={},e._cache={},e._cache.css={},e._cache.html={},e._cache.js={},e.setConfig=function(t,n=!1){console.log("setConfig",t,n),n?e.config={...e.config,...t}:e.config=t},e.start=async function(t=[]){for(let n of t)await e.importModule(n)},e.open=async function(t,n={context:"default"}){let o=t;if(typeof t=="string"&&await e.importModule(o,{},!0),typeof t=="object"&&(o=t.name,n=t,await e.importModule(o,n,!0)),typeof e.apps[o].open=="function"){let i=await e.apps[o].open(n);i&&typeof i.focus=="function"&&i.focus()}},e.load=async function(t,n={}){if(typeof t=="string"){if(t.endsWith(".css"))return e.appendCSS(t);if(t.endsWith(".html"))return e.fetchHTMLFragment(t);if(t.endsWith(".js"))return e.appendScript(t);if(t.endsWith(".json"))return e.fetchJSON(t);if(!t.includes("."))return e.importModule(t,n)}console.log("Cannot load unknown resource type",t)},e.importModule=async function(t,n,o=!0,i){let s=e.config.host+`/v5/apps/based/${t}/${t}.js`,c=t;if(o&&e.emit("bp::loading",c),typeof t=="object"&&(s=e.config.host+`/v5/apps/based/${t.name}/${t.name}.js`,n=t,c=t.name),o||(s=t),e._modules[s])return e._modules[s];try{let l=await import(s);return o&&(e.apps[c]=new l.default(e,n),typeof e.apps[c].init=="function"?(await e.apps[c].init(n),e.log("init complete",c)):e.log("no init function found",c),i&&(e.emit("bp::loaded",c,l),i(e.apps[c]))),e._modules[s]=l,l}catch(l){e.error("Failed to load module:",c,l),delete e.apps[c]}},e.fetchHTMLFragment=async function(t){let n=`${e.config.host}${t}`;return e._cache.html[n]||(e._cache.html[n]=await fetch(n).then(o=>o.text())),e._cache.html[n]},e.fetchJSON=async function(t){return fetch(t).then(n=>n.json())},e.appendCSS=async function(t,n=!1){let o=t;if(!t.includes("http")&&!t.includes("blob")&&(o=`${e.config.host}${t}`),e._cache.css[o]&&!n)return"cached";e._cache.css[o]=new Date().getTime();let i=document.createElement("link");return i.rel="stylesheet",i.href=o,new Promise((s,c)=>{i.onload=()=>{s("loaded")},i.onerror=()=>{c(new Error(`Failed to load CSS from ${o}`))},document.head.appendChild(i)})},e.appendScript=async function(t){let n=t;!t.includes("http")&&!t.includes("blob")&&(n=`${e.config.host}${t}`);let o=document.createElement("script");return o.src=n,document.head.appendChild(o),new Promise((i,s)=>{o.onload=i,o.onerror=s})},e.createWorker=async function(t,n={}){let o=`${e.config.host}/v5${t}`;e.log("createWorker",o);try{const s=await(await fetch(o)).blob(),c=URL.createObjectURL(s);let l=n||{};const f=new Worker(c,l);return e.log("Local Worker created from:",t),f}catch(i){return console.error("Failed to load worker script:",t,i),null}},e._emitters={},e.emit=function(t,...n){e.log("emit",t,...n),e._emitters[t]&&e._emitters[t].forEach(o=>{o.callback&&o.callback(...n)})},e.on=function(t,n,o){if(!t||!n||!o)throw new Error("Missing required parameters for on(). Try: bp.on(event, label, callback). All Event Emitter require a label");e._emitters[t]||(e._emitters[t]=[]),e._emitters[t].push({label:n,callback:o}),e.log("on",t,n)},e.off=function(t,n){e.log("off",t,n),e._emitters[t]&&(e._emitters[t]=e._emitters[t].filter(o=>o.label!==n))},e.set=function(t,n){const o=t.split(".");let i=e.settings,s="";o.slice(0,-1).forEach((l,f)=>{s+=(f>0?".":"")+l,i[l]||(i[l]={}),i=i[l],e.emit(`settings::${s}`,i)});const c=o[o.length-1];s+=(s?".":"")+c,i[c]=n,e.emit("settings",t,n),e.emit(`settings::${s}`,n)},e.get=function(t){const n=t.split(".");let o=e.settings;for(const i of n){if(o[i]===void 0)return;o=o[i]}return o},e.play=async function(){await e.importModule("play"),e.play.call(this,...arguments)},e.focus=function(){},e.isMobile=function(){return window.innerWidth<1e3},e.me="Guest",e});
