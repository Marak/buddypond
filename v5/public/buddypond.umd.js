(function(t,c){typeof exports=="object"&&typeof module<"u"?module.exports=c():typeof define=="function"&&define.amd?define(c):(t=typeof globalThis<"u"?globalThis:t||self,t.BP=c())})(this,function(){"use strict";const t={};return typeof window<"u"&&(window.bp=t),t.log=console.log,t.log=function(){},t.error=console.error,t.config={host:""},t.apps={},t.data={},t.settings={},t._modules={},t._cache={},t._cache.css={},t._cache.html={},t._cache.js={},t.setConfig=function(e,n=!1){console.log("setConfig",e,n),n?t.config={...t.config,...e}:t.config=e},t.start=async function(e=[]){for(let n of e)await t.importModule(n)},t.open=async function(e,n={context:"default"}){let o=e;typeof e=="string"&&await t.importModule(o,{},!0),typeof e=="object"&&(o=e.name,n=e,await t.importModule(o,n,!0)),typeof t.apps[o].open=="function"&&t.apps[o].open(n)},t.load=async function(e,n={}){if(typeof e=="string"){if(e.endsWith(".css"))return t.appendCSS(e);if(e.endsWith(".html"))return t.fetchHTMLFragment(e);if(e.endsWith(".js"))return t.appendScript(e);if(e.endsWith(".json"))return t.fetchJSON(e);if(!e.includes("."))return t.importModule(e,n)}console.log("Cannot load unknown resource type",e)},t.importModule=async function(e,n,o=!0){let i=t.config.host+`/v5/apps/based/${e}/${e}.js`,s=e;if(typeof e=="object"&&(i=t.config.host+`/v5/apps/based/${e.name}/${e.name}.js`,n=e,s=e.name),o||(i=e),t._modules[i])return t._modules[i];try{let r=await import(i);return o&&(t.apps[s]=new r.default(t,n),typeof t.apps[s].init=="function"?(await t.apps[s].init(),t.log("init complete",s)):t.log("no init function found",s)),t._modules[i]=r,r}catch(r){t.error("Failed to load module:",s,r),delete t.apps[s]}},t.fetchHTMLFragment=async function(e){let n=`${t.config.host}${e}`;return t._cache.html[n]||(t._cache.html[n]=await fetch(n).then(o=>o.text())),t._cache.html[n]},t.fetchJSON=async function(e){return fetch(e).then(n=>n.json())},t.appendCSS=function(e,n=!1){let o=e;if(!e.includes("http")&&!e.includes("blob")&&(o=`${t.config.host}${e}`),t._cache.css[o]&&!n)return"cached";t._cache.css[o]=new Date().getTime();let i=document.createElement("link");i.rel="stylesheet",i.href=o,document.head.appendChild(i)},t.appendScript=async function(e){let n=e;!e.includes("http")&&!e.includes("blob")&&(n=`${t.config.host}${e}`);let o=document.createElement("script");return o.src=n,document.head.appendChild(o),new Promise((i,s)=>{o.onload=i,o.onerror=s})},t.createWorker=async function(e,n={}){let o=`${t.config.host}/v5${e}`;t.log("createWorker",o);try{const s=await(await fetch(o)).blob(),r=URL.createObjectURL(s);let f=n||{};const l=new Worker(r,f);return t.log("Local Worker created from:",e),l}catch(i){return console.error("Failed to load worker script:",e,i),null}},t._emitters={},t.emit=function(e,...n){t.log("emit",e,...n),t._emitters[e]&&t._emitters[e].forEach(o=>{o.callback&&o.callback(...n)})},t.on=function(e,n,o){if(!e||!n||!o)throw new Error("Missing required parameters for on()");t._emitters[e]||(t._emitters[e]=[]),t._emitters[e].push({label:n,callback:o}),t.log("on",e,n)},t.off=function(e,n){t.log("off",e,n),t._emitters[e]&&(t._emitters[e]=t._emitters[e].filter(o=>o.label!==n))},t.set=function(e,n){const o=e.split(".");let i=t.settings,s="";o.slice(0,-1).forEach((f,l)=>{s+=(l>0?".":"")+f,i[f]||(i[f]={}),i=i[f],t.emit(`settings::${s}`,i)});const r=o[o.length-1];s+=(s?".":"")+r,i[r]=n,t.emit("settings",e,n),t.emit(`settings::${s}`,n)},t.get=function(e){const n=e.split(".");let o=t.settings;for(const i of n){if(o[i]===void 0)return;o=o[i]}return o},t.play=function(){},t.focus=function(){},t.me="Guest",t});
