{"version":3,"file":"ui.js","sources":["../../../apps/based/ui/Window/StartPanel.js","../../../apps/based/ui/Window/TaskBar.js","../../../apps/based/ui/Window/Window.js","../../../apps/based/ui/Window/WindowManager.js","../../../apps/based/ui/CountdownManager.js","../../../apps/based/ui/ui.js"],"sourcesContent":["/* StartPanel.js - Marak Squires 2025 - BuddyPond */\nexport default class StartPanel {\n    constructor({ onAppLaunch, bp } = {}) {\n        this.onAppLaunch = onAppLaunch || function () { };\n        this.bp = bp;\n        this.panelElement = null;\n    }\n\n    open() {\n        // console.log('Opening start panel', this.panelElement);\n        if (this.panelElement) {\n            // if the panel is already open, close it first\n            this.close();\n            return;\n        }\n\n        const panel = document.createElement('div');\n        panel.className = 'start-panel';\n\n        const searchInput = document.createElement('input');\n        searchInput.id = 'start-panel-search';\n        searchInput.className = 'start-panel-search';\n        searchInput.type = 'text';\n        searchInput.placeholder = 'Search apps...';\n\n        const recentSection = document.createElement('div');\n        recentSection.className = 'start-panel-section';\n        recentSection.innerHTML = `<h3>Recent Apps</h3>`;\n        const recentGrid = document.createElement('div');\n        recentGrid.className = 'start-panel-grid';\n        recentSection.appendChild(recentGrid);\n\n        const allSection = document.createElement('div');\n        allSection.className = 'start-panel-section';\n        allSection.innerHTML = `<h3>All Apps</h3>`;\n        const allGrid = document.createElement('div');\n        allGrid.className = 'start-panel-grid';\n        allSection.appendChild(allGrid);\n\n        panel.appendChild(searchInput);\n        panel.appendChild(recentSection);\n        panel.appendChild(allSection);\n\n        document.body.appendChild(panel);\n        this.panelElement = panel;\n\n        // Populate recent apps (stub)\n        const recentApps = (window.bp?.apps?.ui?.recentApps || []).slice(0, 10);\n        // console.log('Recent apps:', recentApps);\n        recentApps.forEach(appData => {\n            //appData.app = appData.app || appName; // Ensure appName is available\n            //appData.id = appData.id || appName; // Ensure id is available\n            const app = this.createAppTile(appData);\n            recentGrid.appendChild(app);\n        });\n\n        // Populate all apps (stub)\n        const appList = window.bp?.apps?.desktop?.appList || {};\n\n        // TODO: we should have a sort on here, maybe preserve appList order itself to keep it simple\n        const allAppEntries = Object.entries(appList);\n        allAppEntries.forEach(([appName, appData]) => {\n            if (appData.adminOnly && this.bp.me !== 'Marak') { // TODO: admin rbac\n                // Skip apps that are admin-only unless the user is Marak\n                return;\n            }\n            appData.app = appData.app || appName; // Ensure appName is available\n            appData.id = appData.id || appName; // Ensure id is available\n            const app = this.createAppTile(appData, appData.icon);\n            allGrid.appendChild(app);\n        });\n\n        // Live search filtering\n        searchInput.addEventListener('input', () => {\n            const query = searchInput.value.toLowerCase();\n            allGrid.querySelectorAll('.start-panel-app').forEach(el => {\n                const label = el.dataset.name.toLowerCase();\n                let _app = this.bp.apps.desktop.appList[el.dataset.id];\n                console.log('Searching app:', el.dataset.app, _app);\n                let showResult = false;\n                if (_app) {\n                    console.log('Found app in appList', _app);\n                    // first search the label\n                    if (label.includes(query)) {\n                        showResult = true;\n                    }\n                    // then search the category\n                    if (!showResult && _app.categories) {\n                        console.log('App has categories', _app.categories);\n                        // _app.category is an array of strings, so we need to check if any of them match\n                        showResult = _app.categories.some(cat => cat.toLowerCase().includes(query));\n                    }\n                }\n\n                console.log('el.dataset.name', el.dataset, 'query', query);\n                if (showResult) {\n                    el.style.display = 'flex'\n                } else {\n                    el.style.display = 'none';\n                }\n                // el.style.display = label.includes(query) ? '' : 'none';\n            });\n        });\n\n        this.closeEventHandler = (event) => {\n            // console.log('click event target', event.target);\n            if ($(event.target).hasClass('taskbar-item')) {\n                // If the click is inside the panel or on the search input, do nothing\n                return;\n            }\n            // close the panel if it exists\n            if (this.panelElement && !this.panelElement.contains(event.target) && event.target !== searchInput) {\n                this.close();\n            }\n            // If the click is outside the panel and not on the search input, close the panel\n            // .taskbar-item, .taskbar-container\n        }\n        // add event listener to close panel on click outside\n        document.addEventListener('click', this.closeEventHandler);\n\n        // focus on the start-panel-search input\n        searchInput.focus();\n\n    }\n\n    close() {\n        if (this.panelElement) {\n            this.panelElement.remove();\n            this.panelElement = null;\n        }\n        // remove the event listener for closing the panel\n        if (this.closeEventHandler) {\n            document.removeEventListener('click', this.closeEventHandler);\n            this.closeEventHandler = null;\n        }\n    }\n\n    createAppTile(appData, icon = 'icons/default.png') {\n        // console.log('Creating app tile for:', appData);\n        let name = appData.id || appData.appName || appData.name || appData.label || 'Unknown App';\n        icon = appData.icon || icon || 'icons/default.png';\n        const tile = document.createElement('div');\n        tile.className = 'start-panel-app';\n        tile.dataset.name = name;\n        tile.dataset.id = appData.id || appData.app || name;\n        tile.dataset.app = appData.app || appData.id || name;\n\n        const img = document.createElement('img');\n        img.src = icon;\n        img.alt = name;\n\n        const label = document.createElement('div');\n        label.textContent = appData.label || name;\n\n        tile.appendChild(img);\n        tile.appendChild(label);\n\n        tile.onclick = async () => {\n            let win = await this.bp.open(appData.app || appData.id, { context: appData.context });\n            this.onAppLaunch(name);\n            this.close();\n        };\n\n        return tile;\n    }\n}","import StartPanel from \"./StartPanel.js\";\n\nexport default class TaskBar {\n    constructor({ homeCallback, bp } = {}) {\n        this.taskBarElement = document.createElement(\"div\");\n        this.taskBarElement.className = \"taskbar-container\";\n        document.body.appendChild(this.taskBarElement);\n\n        this.bp = bp; // reference to the base platform instance\n\n        this.items = new Map(); // id -> config\n        this.shortcuts = new Set(); // id\n\n\n        function openStartPanel() {\n            if (!this.startPanel) {\n                this.startPanel = new StartPanel({ bp: this.bp });\n            }\n            this.startPanel.open();\n        }\n\n        if (homeCallback) {\n            this.addItem({\n                id: \"home\",\n                label: \"Home\",\n                // onClick: homeCallback,\n                onClick: openStartPanel,\n                icon: \"desktop/assets/images/icons/icon_mantra_64.png\",\n                isShortcut: true,\n            });\n        }\n        this.taskBarElement.addEventListener('contextmenu', (e) => {\n            e.preventDefault();\n            const target = e.target.closest('.taskbar-item');\n            if (!target) return;\n            const id = target.dataset.id;\n            if (!id || id === 'home') return;\n            this.showContextMenu(id, e.clientX, e.clientY);\n        });\n\n        this.enableDragAndDrop();\n    }\n\n    showContextMenu(id, x, y) {\n        const existing = document.querySelector('.taskbar-context-menu');\n        if (existing) existing.remove();\n\n        const item = this.items.get(id);\n        if (!item) return;\n\n        const menu = document.createElement('div');\n        menu.className = 'taskbar-context-menu';\n        menu.style.position = 'fixed';\n        menu.style.left = `${x}px`;\n        menu.style.visibility = 'hidden'; // hide until we calculate dimensions\n        document.body.appendChild(menu);\n\n        // Helper\n        const makeOption = (label, handler) => {\n            const option = document.createElement('div');\n            option.className = 'taskbar-context-menu-item';\n            option.textContent = label;\n            option.onclick = () => {\n                handler();\n                menu.remove();\n            };\n            menu.appendChild(option);\n        };\n\n        // Options\n        if (item.isOpen) {\n            makeOption('Close', () => this.closeItem(id));\n        } else {\n            makeOption('Open', () => this.openItem(item));\n        }\n\n        if (this.shortcuts.has(id)) {\n            makeOption('Unpin from Taskbar', () => {\n                this.shortcuts.delete(id);\n                // this.removeItem(id);\n            });\n        } else {\n\n            if (item.app === 'buddylist' && id !== 'buddylist') {\n                // don't allow pinning buddylist with context\n            } else {\n                // Remark: Issue with non-singleton apps like 'emulator'\n                // Needs to be handled differently\n                if (item.app !== 'emulator') {\n                    makeOption('Keep in Taskbar', () => {\n                        // console.log('Pinning item to taskbar:', item);\n                        // console.log('Adding shortcut to taskbar:', item.app);\n                        this.shortcuts.add(item.app || id);\n                        // save the taskbar_apps to settings\n                        let installedTaskBarApps = this.bp.settings.taskbar_apps || {};\n                        installedTaskBarApps[item.app || id] = {\n                            app: item.app || id,\n                            context: item.context || 'default',\n                            label: item.label || id,\n                            icon: item.icon || ''\n                        };\n                        this.bp.set('taskbar_apps', installedTaskBarApps);\n                    });\n                }\n\n            }\n\n        }\n\n        // makeOption('Remove from Taskbar', () => this.removeItem(id));\n\n        // Wait for DOM to layout, then position the menu\n        requestAnimationFrame(() => {\n            const menuHeight = menu.offsetHeight;\n            const viewportHeight = window.innerHeight;\n\n            // Attempt to place above the cursor\n            let top = y - menuHeight - 4; // slight offset\n\n            // If that would go off screen, place below (fallback)\n            if (top < 0) {\n                top = y + 4;\n            }\n\n            menu.style.top = `${top}px`;\n            menu.style.visibility = 'visible';\n        });\n\n        const removeMenu = () => menu.remove();\n        setTimeout(() => {\n            window.addEventListener('click', removeMenu, { once: true });\n            window.addEventListener('contextmenu', removeMenu, { once: true });\n        }, 0);\n    }\n\n\n    addItem(config) {\n        let { app, id, context, label = \"\", onClick, icon, isShortcut = true } = config;\n        // console.log('TaskBar.addItem', config);\n\n        // save the taskbar_apps\n        if (context && context !== 'default') {\n            // app = app + '-' + context; // append context to app name\n        }\n\n        let installedTaskBarApps = this.bp.settings.taskbar_apps || {};\n        if (id !== 'home') {\n            installedTaskBarApps[app || id] = {\n                id: id,\n                app: app || id,\n                context: context || 'default',\n                label: label || id,\n                icon: icon || ''\n            };\n            // console.log('TaskBar.addItem installedTaskBarApps', installedTaskBarApps);\n\n        }\n\n        if (isShortcut) {\n            // save the taskbar_apps to settings, if it is a shortcut\n            this.bp.set('taskbar_apps', installedTaskBarApps);\n        }\n\n        // console.log('TaskBar.addItem', config);\n        if (typeof onClick !== 'function') {\n            // default action is to open the app, bp.open()\n            onClick = async (ev, itemElement) => {\n\n                // first check to see if the window exists / is open\n                let existingWindow = this.bp.apps.ui.windowManager.getWindow(id);\n\n                if (!existingWindow) {\n                    console.log('default onClick, opening window', id, config);\n                    // Remark: this.bp wasn't scoped here? should work...\n                    let win = await this.bp.open(app || id, { context });\n                    // console.log('TaskBar.onClick bp.open', id, win);\n                } else {\n                    if (existingWindow.isMinimized) {\n                        // console.log('TaskBar.onClick restoring window', existingWindow);\n                        existingWindow.restore();\n                        existingWindow.focus();\n                    } else {\n                        // console.log('TaskBar.onClick minimizing window', existingWindow);\n                        existingWindow.minimize();\n                    }\n                }\n                ev.stopPropagation();\n            };\n        }\n\n        let existing = this.taskBarElement.querySelector(`[data-id=\"${id}\"]`);\n        if (existing) return existing;\n\n        const itemElement = document.createElement(\"div\");\n        itemElement.className = \"taskbar-item\";\n        itemElement.dataset.id = id;\n        itemElement.draggable = true;\n\n        const itemText = document.createElement(\"div\");\n        itemText.className = \"taskbar-item-text\";\n        itemText.textContent = label;\n        itemElement.appendChild(itemText);\n\n        if (icon) {\n            const itemIcon = document.createElement(\"img\");\n            itemIcon.src = icon;\n            itemIcon.height = 32;\n            itemIcon.width = 32;\n            itemIcon.alt = label;\n            itemElement.appendChild(itemIcon);\n        } else {\n            itemElement.textContent = label;\n        }\n\n        itemElement.onclick = (ev) => {\n            if (onClick) onClick.call(this, ev, itemElement);\n            this.alertItem(id);\n        };\n\n        if (isShortcut) {\n            this.shortcuts.add(id);\n        }\n\n        this.taskBarElement.appendChild(itemElement);\n        this.items.set(id, {\n            ...config,\n            element: itemElement,\n            isOpen: false,\n            isShortcut: isShortcut\n        });\n\n        return itemElement;\n    }\n\n    openItem(config) {\n        // console.log('TaskBar.openItem', config);\n        let item = this.items.get(config.id);\n        if (item) {\n            item.isOpen = true;\n            item.element.classList.add(\"taskbar-item-open\");\n            // console.log('TaskBar.openItem', item);\n            // item.onClick?.(null, item.element); // call the onClick handler if it exists\n        } else {\n            this.addItem({ ...config, isShortcut: false }); // treat open as temporary unless marked otherwise\n            this.openItem(config); // re-call to apply open state\n        }\n    }\n\n    closeItem(id) {\n        const item = this.items.get(id);\n        if (!item) return;\n\n        item.isOpen = false;\n        item.element.classList.remove(\"taskbar-item-open\");\n\n        console.log('TaskBar.closeItem', id, item);\n        console.log('shortcuts', this.shortcuts);\n\n        // shouldn't this be checking this.shortcuts instead of item.isShortcut?\n        if (!this.shortcuts.has(id)) {\n            this.removeItem(id);\n        }\n        /*\n        console.log('shortcuts', this.shortcuts);\n        // If the item is NOT a shortcut, remove it from the taskbar\n        if (!item.isShortcut) {\n            this.removeItem(id);\n        }\n        */\n\n        // get the window instance and close it\n        const win = this.bp.apps.ui.windowManager.getWindow(id);\n        if (win) {\n            win.close();\n        } else {\n            console.warn(`No window found with ID: ${id}`);\n        }\n    }\n\n    removeItem(id) {\n        const item = this.items.get(id);\n        if (item) {\n            this.taskBarElement.removeChild(item.element);\n            this.items.delete(id);\n            this.shortcuts.delete(id);\n\n            // save the updated taskbar_apps\n            let taskBarApps = this.bp.settings.taskbar_apps || {};\n            if (taskBarApps[id]) {\n                delete taskBarApps[id];\n                this.bp.set('taskbar_apps', taskBarApps);\n            }\n            console.log('TaskBar.removeItem', id, item);\n\n        }\n    }\n\n    getItem(id) {\n        return this.items.get(id);\n    }\n\n    alertItem(id) {\n        const item = this.items.get(id);\n        if (item) {\n            item.element.classList.add(\"taskbar-item-alert\");\n            setTimeout(() => item.element.classList.remove(\"taskbar-item-alert\"), 3000);\n        }\n    }\n\n    enableDragAndDrop() {\n        let dragged = null;\n\n        this.taskBarElement.addEventListener(\"dragstart\", (e) => {\n            dragged = e.target.closest(\".taskbar-item\");\n        });\n\n        this.taskBarElement.addEventListener(\"dragover\", (e) => {\n            e.preventDefault();\n            const over = e.target.closest(\".taskbar-item\");\n            if (dragged && over && dragged !== over) {\n                const draggedIndex = [...this.taskBarElement.children].indexOf(dragged);\n                const overIndex = [...this.taskBarElement.children].indexOf(over);\n                if (draggedIndex < overIndex) {\n                    this.taskBarElement.insertBefore(over, dragged);\n                } else {\n                    this.taskBarElement.insertBefore(dragged, over);\n                }\n            }\n        });\n\n        this.taskBarElement.addEventListener(\"dragend\", () => {\n            dragged = null;\n\n            // resave the new order of shortcuts\n            const newOrder = Array.from(this.taskBarElement.children).map(item => item.dataset.id);\n            let taskBarApps = this.bp.settings.taskbar_apps || {};\n            // reorder the taskbar_apps based on the new order\n            const newTaskBarApps = {};\n            newOrder.forEach(id => {\n                if (taskBarApps[id]) {\n                    newTaskBarApps[id] = taskBarApps[id];\n                }\n            });\n            //console.log('New taskbar order:', newOrder);\n            this.bp.set('taskbar_apps', newTaskBarApps);\n\n        });\n    }\n}\n","// Buddy Pond - Window.js - Marak Squires 2023\n// A simple window class for creating draggable, resizable windows\n// Remark: WindowManager interface is optional and will be stubbed out if not provided\nlet idCounter = 0;\n\nclass Window {\n    constructor(options = {}, windowManager) {\n        const {\n            title = \"Window\", // Title of the window\n            width = '400px', // Default width\n            height = '300px', // Default height\n            app = 'default', // default app\n            type = 'singleton', // Default type ( intended to not have siblings )\n            context = 'default', // Default context\n            content = '', // Default content\n            iframeContent = false,\n            icon = '', // Default icon\n            x = 50, // Default x position\n            y = 50, // Default y position\n            z = 99, // Default z-index\n            parent = window.document.body, // Parent element to append to\n            id = `window-${idCounter}`, // Unique ID for the panel\n            onFocus = () => { }, // Callback when the window is focused\n            onClose = () => { }, // Callback when the window is closed\n            onOpen = () => { }, // Callback when the window is opened\n            onMessage = () => { }, // Callback when the window receives a message\n            onLoad = () => { }, // Callback when the window is loaded ( remote content )\n            className = '', // Custom classes for styling\n            resizeable = true, // Enable resizable feature\n            preventOverlap = true, // prevents direct overlap with other windows\n            canBeBackground = false // Can be set as background\n        } = options;\n\n        this.windowManager = windowManager;\n\n        // ensure that no other window has the same id\n        // we could check the windowManger.windows array for this\n        // we will check the document ( in case another system has created a window )\n        let existingWindow = document.getElementById(id);\n        if (existingWindow) {\n            console.log('Window with id already exists', id);\n            return existingWindow;\n        }\n\n        this.title = title;\n        this.icon = icon;\n        this.width = width;\n        this.height = height;\n\n        if (app !== 'default') {\n            this.app = app;\n        } else {\n            this.app = id;\n        }\n\n        \n        this.type = type;\n        this.x = x;\n        this.y = y;\n        this.z = 99;\n        this.context = context;\n        this.parent = parent;\n        this.id = id;\n        this.isMaximized = false;\n        this.isMinimized = false;\n        this.container = null;\n        this.content = null;\n        this.iframeContent = iframeContent;\n        this.contentValue = content;\n        this.isActive = false;\n        this.className = className;\n        this.resizeable = resizeable;\n        this.preventOverlap = preventOverlap;\n        this.canBeBackground = canBeBackground;\n\n        windowManager = windowManager || {\n            windows: [],\n            saveWindowsState: () => { },\n            removeWindow: () => { },\n\n        };\n\n        this.bp = options.bp;\n\n        this.onFocus = onFocus;\n        this.onClose = onClose;\n        this.onOpen = onOpen;\n        this.onLoad = onLoad;\n        this.onMessage = onMessage;\n\n        this.startDrag = this.startDrag.bind(this);\n        this.drag = this.drag.bind(this);\n        this.stopDrag = this.stopDrag.bind(this);\n\n\n        this.createWindow();\n        this.open();\n\n        return this;\n    }\n\n    createWindow() {\n        // Create the main window container\n        this.container = document.createElement(\"div\");\n        this.container.classList.add(\"window-container\");\n\n        // add dataset for app, type, context\n        this.container.dataset.app = this.app;\n        this.container.dataset.type = this.type;\n        this.container.dataset.context = this.context;\n\n        if (this.className) {\n            this.container.classList.add(this.className);\n        }\n\n        if (!this.resizeable) {\n            this.container.classList.add(\"window-not-resizeable\");\n        }\n\n\n        // Helper function to check if two rectangles overlap\n        function checkOverlap(x1, y1, w1, h1, x2, y2, w2, h2, buffer = 10) {\n            // console.log('checkOverlap', x1, y1, w1, h1, x2, y2, w2, h2, buffer);\n            w1 = parseInt(w1);\n            h1 = parseInt(h1);\n            w2 = parseInt(w2);\n            h2 = parseInt(h2);\n            return (\n                x1 < x2 + w2 + buffer &&\n                x1 + w1 + buffer > x2 &&\n                y1 < y2 + h2 + buffer &&\n                y1 + h1 + buffer > y2\n            );\n        }\n\n        // Function to adjust position to prevent overlap\n        function adjustPosition(newWindow, windows, screenWidth, screenHeight, buffer = 10) {\n            let adjustedX = newWindow.x;\n            let adjustedY = newWindow.y;\n\n            // Check overlap with other windows\n            windows.forEach((win) => {\n                if (checkOverlap(adjustedX, adjustedY, newWindow.width, newWindow.height, win.x, win.y, win.width, win.height, buffer)) {\n                    // console.log('OVERLAP DETECTED');\n                    adjustedX += buffer; // Move slightly to the right\n                    // adjustedY += buffer; // Move slightly down\n                }\n            });\n\n            // Check screen boundaries\n            if (adjustedX + newWindow.width + buffer > screenWidth) {\n                adjustedX = screenWidth - newWindow.width - buffer; // Move to the left\n            }\n            if (adjustedY + newWindow.height + buffer > screenHeight) {\n                adjustedY = screenHeight - newWindow.height - buffer; // Move up\n            }\n            if (adjustedX < buffer) {\n                adjustedX = buffer; // Move to the right\n            }\n            if (adjustedY < buffer) {\n                adjustedY = buffer; // Move down\n            }\n\n            return { x: adjustedX, y: adjustedY };\n        }\n\n        // Main Window Creation Logic\n        this.container.id = this.id;\n        this.container.style.width = `${this.width}px`;\n        this.container.style.height = `${this.height}px`;\n        this.container.style.position = \"absolute\";\n\n        // Assume screen dimensions\n        const screenWidth = window.innerWidth;\n        const screenHeight = window.innerHeight;\n\n        /*\n        // Remark: We could perform a general zoom scale for mobile devices\n        if (screenWidth <= 980) {\n            // this.container.style.zoom = 1.5; // Adjust zoom for mobile\n        } else {\n            // do nothing\n        }\n        */\n\n        // Adjust position to prevent overlap\n        let adjustedPosition = {\n            x: this.x,\n            y: this.y,\n        };\n\n        if (this.preventOverlap) {\n            adjustedPosition = adjustPosition(\n                { x: this.x, y: this.y, width: this.width, height: this.height },\n                this.windowManager.windows,\n                screenWidth,\n                screenHeight,\n                32\n            );\n        }\n\n\n        // Apply adjusted position\n        this.x = adjustedPosition.x;\n        this.y = adjustedPosition.y;\n        this.container.style.top = `${this.y}px`;\n        this.container.style.left = `${this.x}px`;\n\n        this.container.style.zIndex = 99;\n\n        // add a mousedown handler to container itself to set 'window-active' status\n        this.container.addEventListener('mousedown', () => {\n            // set all windows to inactive\n            document.querySelectorAll('.window-container').forEach((window) => {\n                window.classList.remove('window-active');\n                window.isActive = false;\n            });\n            // set this window to active\n            this.container.classList.add('window-active');\n            this.isActive = true;\n        });\n\n        // same for touchstart\n        this.container.addEventListener('touchstart', () => {\n            // set all windows to inactive\n            document.querySelectorAll('.window-container').forEach((window) => {\n                window.classList.remove('window-active');\n                window.isActive = false;\n            });\n            // set this window to active\n            this.container.classList.add('window-active');\n            this.isActive = true;\n        });\n\n        // Create the title bar\n        this.titleBar = document.createElement(\"div\");\n        this.titleBar.classList.add(\"window-title-bar\");\n\n        if (this.bp.isMobile()) {\n            this.titleBar.onclick = () => {\n                console.log('titleBar clicked on mobile');\n                this.minimize();\n                return;\n                if (!this.isMinimized) {\n                    this.minimize(true); // force minimize on mobile\n                } else {\n                    this.restore(); // restore on mobile\n                }\n            }\n        }\n\n        // on double click maximize\n        this.titleBar.ondblclick = () => this.maximize();\n\n        if (this.icon) {\n            let iconTitleBar = document.createElement(\"img\");\n            iconTitleBar.src = this.icon;\n            iconTitleBar.classList.add(\"window-icon\");\n            this.titleBar.appendChild(iconTitleBar);\n        }\n\n        let titleBarSpan = document.createElement(\"span\");\n        titleBarSpan.classList.add(\"window-title-text\");\n        titleBarSpan.textContent = this.title;\n        this.titleBarSpan = titleBarSpan;\n\n        // Drag functionality\n        // Add mouse and touch event listeners to the titleBar\n        this.titleBar.addEventListener('mousedown', this.startDrag);\n        this.titleBar.addEventListener('touchstart', this.startDrag, { passive: false });\n\n        // Touch events for mobile\n\n\n        // Create control buttons (Minimize, Maximize, Close)\n        const controls = document.createElement(\"div\");\n        controls.classList.add(\"window-controls\");\n\n        if (!this.bp.isMobile()) {\n            this.minimizeButton = document.createElement(\"button\");\n            this.minimizeButton.innerHTML = \"&#x1F7E1;\"; // Yellow circle\n            this.minimizeButton.classList.add(\"minimize-button\");\n            this.minimizeButton.title = \"Minimize\";\n            this.minimizeButton.onclick = () => this.minimize();\n\n            controls.appendChild(this.minimizeButton);\n\n\n        }\n\n\n        this.maximizeButton = document.createElement(\"button\");\n        this.maximizeButton.innerHTML = \"&#x1F7E2;\"; // Green circle\n        this.maximizeButton.classList.add(\"maximize-button\");\n        this.maximizeButton.title = \"Maximize\";\n        this.maximizeButton.onclick = () => this.maximize();\n\n        controls.appendChild(this.maximizeButton);\n\n\n        this.closeButton = document.createElement(\"button\");\n        this.closeButton.innerHTML = \"&#x1F534;\"; // Red circle\n        this.closeButton.classList.add(\"close-button\");\n        this.closeButton.title = \"Close\";\n        this.closeButton.onclick = () => this.close();\n\n        controls.appendChild(this.closeButton);\n\n        this.titleBar.appendChild(titleBarSpan);\n        this.titleBar.appendChild(controls);\n\n        this.initContentArea();\n\n        // Append components\n        this.container.appendChild(this.titleBar);\n        this.container.appendChild(this.content);\n\n        if (this.parent) {\n            this.parent.appendChild(this.container);\n        }\n\n        // Resizing\n        if (this.resizeable) {\n            this.addResizeHandles();\n        }\n\n        if (this.canBeBackground) {\n            // get the menubar-set-window-as-background element and remove disabled class\n            let el = document.getElementById('menubar-set-window-as-background');\n            if (el) {\n                el.classList.remove('disabled');\n            }\n        }\n\n\n        return this.container;\n    }\n\n\n    initContentArea() {\n        if (typeof this.iframeContent === 'boolean' && this.iframeContent) {\n            this.content = document.createElement(\"iframe\");\n            this.content.classList.add(\"bp-window-content\");\n            document.body.appendChild(this.content);\n            this.content.src = 'about:blank';\n            this.content.onload = () => {\n                let iframeDoc = this.content.contentDocument || this.content.contentWindow.document;\n                iframeDoc.open();\n                iframeDoc.write(this.contentValue);\n                iframeDoc.close();\n                this.setupMessageHandling();\n            };\n        } else if (typeof this.iframeContent === 'string' && this.iframeContent.length) {\n            this.content = document.createElement(\"iframe\");\n            this.content.classList.add(\"bp-window-content\");\n            this.content.src = this.iframeContent;\n            this.content.onload = () => this.setupMessageHandling();\n        } else {\n            this.content = document.createElement(\"div\");\n            this.content.classList.add(\"bp-window-content\");\n            if (typeof this.contentValue === 'string') {\n                this.content.innerHTML = this.contentValue;\n            } else {\n                this.content.appendChild(this.contentValue);\n            }\n        }\n    }\n\n    // TODO: migrate away from iframe messages and use BroadcastChannel instead\n    setupMessageHandling() {\n        // iframe is loaded by now\n        this.onLoad(this);\n        const iframeWindow = this.content.contentWindow;\n\n        // Inject a script into the iframe to listen for the ESC key\n        const iframeDoc = this.content.contentDocument || this.content.contentWindow.document;\n        const script = iframeDoc.createElement(\"script\");\n        script.type = \"text/javascript\";\n        script.textContent = `\n            document.addEventListener('keydown', (event) => {\n                if (event.key === 'Escape') {\n                    window.parent.postMessage({ event: 'ESC_KEY_PRESSED' }, '*');\n                }\n            });\n        `;\n        //alert(script.textContent)\n        iframeDoc.body.appendChild(script);\n\n        // Set the message event listener on the iframe's window\n        window.addEventListener('message', this.receiveMessage.bind(this), false);\n    }\n\n\n    sendMessage(message) {\n        if (this.content && this.content.contentWindow) {\n            this.content.contentWindow.postMessage(message, '*'); // Consider specifying an origin here instead of '*'\n        }\n    }\n\n    receiveMessage(event) {\n        // Ensure security by checking the event.origin, if possible\n        if (typeof event.data === 'object' && event.data.event) {\n            if (event.data.event === 'ESC_KEY_PRESSED') {\n                console.log('ESC key pressed inside iframe. Closing window...');\n                this.close();\n            } else {\n                this.handleReceivedMessage(event.data);\n            }\n        }\n    }\n\n    handleReceivedMessage(data) {\n        //console.log('Handled Received message:', data, this.onMessage);\n        if (this.onMessage) {\n            this.onMessage(data);\n        }\n    }\n\n\n    move(x, y) {\n        this.x = x;\n        this.y = y;\n        this.container.style.top = `${this.y}px`;\n        this.container.style.left = `${this.x}px`;\n        this.windowManager.saveWindowsState();\n    }\n\n    serialize() {\n\n        // we need an xpath selector for this.parent\n        let parentXpath = getXPathForElement(this.parent);\n        // console.log('parentXpath', parentXpath);\n        return {\n            title: this.title,\n            width: this.width,\n            height: this.height,\n            type: this.type,\n            app: this.app,\n            x: this.x,\n            y: this.y,\n            z: this.z,\n            context: this.context,\n            parent: parentXpath,\n            id: this.id,\n            onClose: this.onClose,\n            onOpen: this.onOpen,\n            className: this.className,\n            resizeable: this.resizeable,\n            canBeBackground: this.canBeBackground\n        };\n    }\n\n    hydrate(data) {\n        console.log('hydrate', data);\n        this.title = data.title;\n        this.width = data.width;\n        this.height = data.height;\n        this.app = data.app;\n        this.type = data.type;\n        this.x = data.x;\n        this.y = data.y;\n        this.z = Number(data.z);\n        this.context = data.context;\n        // TODO: some of these are constructor...maybe all?\n        // this.parent = document.querySelector(data.parent);\n        this.id = data.id;\n        this.onClose = data.onClose;\n        this.onOpen = data.onOpen;\n        this.onMessage = data.onMessage;\n        this.className = data.className;\n        this.resizeable = data.resizeable;\n        this.canBeBackground = data.canBeBackground;\n\n        this.updateWindow();\n    }\n\n    updateWindow() {\n        this.container.style.width = `${this.width}px`;\n        this.container.style.height = `${this.height}px`;\n        this.container.style.top = `${this.y}px`;\n        this.container.style.left = `${this.x}px`;\n        this.container.style.zIndex = this.z;\n        // console.log('updateWindow', this);\n    }\n\n    setDepth(depth) {\n        this.z = depth;\n        this.container.style.zIndex = depth;\n        // console.log('container depth was set to', this.id, depth);\n        this.windowManager.saveWindowsState();\n    }\n\n    setAsBackground() {\n        console.log('setAsBackground', this.windowManager.windows);\n        if (!this.canBeBackground) {\n            console.log('This window cannot be set as background. Try setting canBeBackground:true in the Window declaration');\n            return;\n        }\n        // check other api.ui.windowManager.windows and restore them if isBackground is true\n        this.windowManager.windows.forEach((window) => {\n            if (window.isBackground) {\n                window.restoreWindowFromBackground();\n            }\n        });\n\n        this.container.style.zIndex = -1;\n\n        // make full window size\n        this.container.style.width = \"100%\";\n        this.container.style.height = \"100%\";\n\n        // set top and left to 0\n        this.container.style.top = \"0\";\n        this.container.style.left = \"0\";\n\n        this.isBackground = true;\n        this.isActive = false;\n    }\n\n    restoreWindowFromBackground() {\n\n        this.isBackground = false;\n\n        // reset the z-index\n        this.container.style.zIndex = 11000;\n\n        // reset the window size\n        this.container.style.width = `${this.width}`;\n        this.container.style.height = `${this.height}`;\n\n        // put window back to original position\n        this.container.style.top = `${this.y}px`;\n        this.container.style.left = `${this.x}px`;\n\n        // get the menubar-restore-background-window element and add disabled class\n        let el = document.getElementById('menubar-restore-background-window');\n        if (el) {\n            el.classList.add('disabled');\n        }\n\n    }\n\n    startDrag(e) {\n        this.isDragging = true;\n        this.container.style.cursor = \"grabbing\";\n\n        // Disable pointer events on iframe\n        const iframes = this.container.querySelectorAll('iframe');\n        iframes.forEach(iframe => {\n            iframe.style.pointerEvents = 'none';\n        });\n\n        // Get coordinates from mouse or touch event\n        const { clientX, clientY } = this.getEventCoordinates(e);\n        this.offsetX = clientX - this.container.offsetLeft;\n        this.offsetY = clientY - this.container.offsetTop;\n\n        // Add event listeners for both mouse and touch events\n        document.addEventListener('mousemove', this.drag);\n        document.addEventListener('touchmove', this.drag, { passive: false });\n        document.addEventListener('mouseup', this.stopDrag);\n        document.addEventListener('touchend', this.stopDrag);\n    }\n\n    drag(e) {\n        if (!this.isDragging) return;\n\n        // Prevent default behavior for touchmove to avoid scrolling\n        e.preventDefault();\n\n        // Get coordinates from mouse or touch event\n        const { clientX, clientY } = this.getEventCoordinates(e);\n\n        // Update container position\n        // Ensure window does not drag off the screen\n        let menuBarHeight = 42;\n        let bottomLimit = window.innerHeight - 52; // 50px from bottom\n        if (clientY > menuBarHeight && clientY < bottomLimit) {\n            this.container.style.top = `${clientY - this.offsetY}px`;\n        }\n        let leftLimit = 52; // 0px from left\n        let rightLimit = window.innerWidth - 52; // 0px from right\n        if (clientX > leftLimit && clientX < rightLimit) {\n            this.container.style.left = `${clientX - this.offsetX}px`;\n        }\n    }\n\n    stopDrag() {\n        this.isDragging = false;\n        this.container.style.cursor = \"default\";\n\n        // Restore pointer events on iframe\n        const iframes = this.container.querySelectorAll('iframe');\n        iframes.forEach(iframe => {\n            iframe.style.pointerEvents = 'auto';\n        });\n\n        // Remove event listeners\n        document.removeEventListener('mousemove', this.drag);\n        document.removeEventListener('touchmove', this.drag);\n        document.removeEventListener('mouseup', this.stopDrag);\n        document.removeEventListener('touchend', this.stopDrag);\n\n        // Save window state\n        this.x = this.container.offsetLeft;\n        this.y = this.container.offsetTop;\n        this.z = Number(this.container.style.zIndex);\n        if (this.windowManager) {\n            this.windowManager.saveWindowsState();\n        } else {\n            console.warn('windowManager is not defined');\n        }\n    }\n\n    getEventCoordinates(e) {\n        let clientX, clientY;\n        if (e.type.startsWith('touch')) {\n            // Use the first touch point for dragging\n            const touch = e.touches[0] || e.changedTouches[0];\n            clientX = touch.clientX;\n            clientY = touch.clientY;\n        } else {\n            // Mouse event\n            clientX = e.clientX;\n            clientY = e.clientY;\n        }\n        return { clientX, clientY };\n    }\n\n    minimize(force = false) {\n        // console.log('minimize', this.isMinimized);\n        if (this.bp.isMobile()) {\n\n            if (this.isMinimized && !force) {\n                this.restore();\n                // this.content.style.display = \"block\"; // Show content area\n            } else {\n                // Minimize the window\n                // this.container.style.display = \"none\";  // Hide content area\n                // hides the `bp-window-content` area\n                //this.content.style.display = \"none\";  // Hide content area\n                // set the window-container height to 50px\n                this.container.style.height = \"120px\"; // Set height to 50px\n\n                this.isMinimized = true;\n            }\n\n            this.windowManager.arrangeVerticalStacked();\n\n        } else {\n            if (this.isMinimized && !force) {\n                this.restore();\n            } else {\n                // Minimize the window\n                this.container.style.display = \"none\";  // Hide content area\n                this.isMinimized = true;\n            }\n        }\n        // TODO: save the window state\n    }\n\n    // Restore the window\n    restore() {\n        // console.log('restore', this)\n        // Restore the window's content and original size\n        this.container.style.display = \"flex\";\n\n        //this.container.style.top = this.y + 'px';\n        //this.container.style.left = this.x + 'px';\n\n        // Mark as not minimized\n        this.isMinimized = false;\n        // TODO: save the window state\n\n        if (this.bp.isMobile()) {\n            this.windowManager.arrangeVerticalStacked();\n        }\n    }\n\n    maximize() {\n\n        // offset the top position by $('.desktop-menu-bar').height()\n        // so that on smaller devices the window is not hidden behind the menubar\n        if (this.isMaximized) {\n            if (this.bp.isMobile()) {\n                //this.container.style.width = \"100vw\";\n                //this.container.style.height = \"100vh\";\n                //this.container.style.top = \"0\";\n                //this.container.style.left = \"0\";\n                this.windowManager.arrangeVerticalStacked();\n\n            } else {\n                this.container.style.width = `${this.width}px`;\n                this.container.style.height = `${this.height}px`;\n                this.container.style.top = \"50px\";\n                this.container.style.left = \"50px\";\n                this.isMaximized = false;\n\n            }\n        } else {\n            let normalMenuBarHeight = 21;\n            let currentMenuBarHeight = $('.desktop-menu-bar').height() || normalMenuBarHeight;\n            let diff = currentMenuBarHeight - normalMenuBarHeight;\n            diff += (normalMenuBarHeight + 2); // add 2px for border\n            let pixelOffset = diff + 'px';\n\n            if (this.bp.isMobile()) {\n                this.container.style.width = \"100vw\";\n                this.container.style.height = \"100vh\";\n                this.container.style.top = pixelOffset;\n                this.container.style.left = \"0\";\n\n            } else {\n                this.container.style.width = \"100vw\";\n                this.container.style.height = \"calc(100vh - 104px)\";\n                this.container.style.top = pixelOffset;\n                this.container.style.left = \"0\";\n\n            }\n            this.isMaximized = true;\n        }\n        // TODO: save the window state\n\n    }\n\n    focus(propigate = true) {\n        // console.log('on focus called from Window.js')\n        if (propigate) {\n            this.windowManager.focusWindow(this);\n        }\n        this.onFocus(this);\n    }\n\n    open() {\n        // set focus to this window ( first )\n        this.focus();\n\n        try {\n            // onOpen may have additional focus events\n            this.onOpen(this);\n        } catch (err) {\n            console.error(err);\n        }\n        // TODO: save the window state ???\n        // ???? this.parent.appendChild(this.container);\n\n        if (this.bp.isMobile()) {\n            // this.minimizeAllWindows(true);\n            // alert('opening window on mobile');\n            setTimeout(() => {\n                this.windowManager.arrangeVerticalStacked();\n            }, 100);\n        }\n\n        this.bp.emit('window::open', this);\n\n        // console.log('Window opened:', this);\n        let _app = {\n            id: this.id,\n            app: this.app,\n            label: this.title,\n            icon: this.icon,\n            // app: this.app,\n            type: this.type,\n            context: this.context\n        };\n        // console.log('openWindow openItem', _app);\n        this.bp.apps.ui.windowManager.taskBar.openItem(_app);\n\n        // add the items to this.bp.apps.ui.recentApps\n        // TODO: truncate the array to a maximum of 10 items, newest first\n        this.bp.apps.ui.recentApps = this.bp.apps.ui.recentApps || this.bp.settings.recentApps || [];\n\n        // remove items with the same id if already exists\n        this.bp.apps.ui.recentApps = this.bp.apps.ui.recentApps.filter(app => app.id !== this.id);\n        \n        this.bp.apps.ui.recentApps.unshift({\n            id: this.id,\n            app: this.app,\n            label: this.label || this.title,\n            icon: this.icon,\n            type: this.type\n        });\n\n        // update the recentApps localStorage\n        this.bp.apps.ui.recentApps = this.bp.apps.ui.recentApps.slice(-10); // keep only the last 10 items\n        this.bp.set('recentApps', this.bp.apps.ui.recentApps);\n\n\n    }\n    close() {\n\n        if (this.parent) {\n            // check first to see if child is in parent\n            if (this.container.parentElement && this.container.parentElement === this.parent) {\n                this.parent.removeChild(this.container);\n            }\n        } else {\n            this.container.parentElement.removeChild(this.container);\n        }\n\n        // check to see if this is an iframe and remove event listener\n        if (this.content && this.content.contentWindow) {\n            this.content.contentWindow.removeEventListener('message', this.receiveMessage.bind(this), false);\n        }\n        if (this.content) {\n            if (this.content.parentNode) {\n                this.content.parentNode.removeChild(this.content);\n            }\n            this.content = null;\n        }\n\n        // check to see if no more windows\n        // TODO: remove this code from Window.js class ( it should not know about menubar )\n        // if window count is 0 get the menubar-set-window-as-background element and add disabled class\n        let windowCount = this.windowManager.windows.length;\n        if (windowCount === 0) {\n            let el = document.getElementById('menubar-set-window-as-background');\n            if (el) {\n                el.classList.add('disabled');\n            }\n        }\n        // console.log('removeWindow', this.id);\n        this.windowManager.removeWindow(this.id);\n\n\n        if (this.windowManager.taskBar) {\n            // remove the chat window from the taskbar\n            this.windowManager.taskBar.closeItem(this.id);\n        }\n\n        // TODO: save the window state ??? removeWindow could do it..?\n\n        this.onClose(this);\n        this.bp.emit('window::close', this);\n\n        if (this.bp.isMobile()) {\n            // this.minimizeAllWindows(true);\n            //this.windowManager.arrangeVerticalStacked();\n            setTimeout(() => {\n                this.windowManager.arrangeVerticalStacked();\n            }, 100);\n        }\n\n    }\n\n    addResizeHandles() {\n        const resizeHandle = document.createElement(\"div\");\n        resizeHandle.classList.add(\"resize-handle\");\n        this.container.appendChild(resizeHandle);\n        resizeHandle.addEventListener(\"mousedown\", (e) => this.startResize(e), { passive: false });\n        resizeHandle.addEventListener(\"touchstart\", (e) => {\n            e.preventDefault(); // Prevent default touch behavior\n            this.startResize(e.touches[0]);\n        }, { passive: false });\n    }\n\n    setSize(width, height) {\n        this.width = width;\n        this.height = height;\n        this.container.style.width = `${this.width}`;\n        this.container.style.height = `${this.height}`;\n        // save the window state\n        this.windowManager.saveWindowsState();\n    }\n\n    startResize(e) {\n        const container = this.container;\n        const startX = e.clientX;\n        const startY = e.clientY;\n        const startWidth = container.offsetWidth;\n        const startHeight = container.offsetHeight;\n\n        const onMove = (moveEvent) => {\n            const clientX = moveEvent.clientX || moveEvent.touches[0].clientX;\n            const clientY = moveEvent.clientY || moveEvent.touches[0].clientY;\n            const newWidth = startWidth + (clientX - startX);\n            const newHeight = startHeight + (clientY - startY);\n\n            // Apply new dimensions, respecting min/max constraints\n            container.style.width = `${Math.max(100, newWidth)}px`; // Example min-width\n            container.style.height = `${Math.max(100, newHeight)}px`; // Example min-height\n        };\n\n        const onUp = () => {\n            document.removeEventListener(\"mousemove\", onMove);\n            document.removeEventListener(\"mouseup\", onUp);\n            document.removeEventListener(\"touchmove\", onMove);\n            document.removeEventListener(\"touchend\", onUp);\n        };\n\n        document.addEventListener(\"mousemove\", onMove);\n        document.addEventListener(\"mouseup\", onUp);\n        document.addEventListener(\"touchmove\", onMove, { passive: false });\n        document.addEventListener(\"touchend\", onUp);\n    }\n\n    resize(e) {\n        if (!this.isResizing) return;\n        const newWidth = this.startWidth + (e.clientX - this.startX);\n        const newHeight = this.startHeight + (e.clientY - this.startY);\n\n        this.container.style.width = `${newWidth}px`;\n        this.container.style.height = `${newHeight}px`;\n    }\n\n    stopResize() {\n        this.isResizing = false;\n        // TODO: save the window state\n\n    }\n\n    setTitle(title) {\n        this.title = title;\n        this.titleBarSpan.textContent = title;\n        // save the window state\n        this.windowManager.saveWindowsState();\n    }\n\n    setContent(content) {\n        this.contentValue = content;\n        this.content.innerHTML = content;\n        // save the window state\n        this.windowManager.saveWindowsState();\n    }\n}\n\nexport default Window;\n\n\nfunction getXPathForElement(element) {\n    const fullPath = (el) => {\n        let names = [];\n        while (el.parentNode) {\n            if (el.id) { // If the element has an ID, use it as a unique identifier\n                names.unshift('#' + el.id);\n                break;\n            } else {\n                let e = el, sibling, count = 1;\n                while (sibling = e.previousSibling) {\n                    if (sibling.nodeType === 1 && sibling.tagName === e.tagName) { count++; }\n                    e = sibling;\n                }\n                const tagName = el.tagName.toLowerCase();\n                const nth = count > 1 ? `:nth-of-type(${count})` : '';\n                names.unshift(`${tagName}${nth}`);\n                el = el.parentNode;\n            }\n        }\n        return names.length ? names.join(' > ') : null;\n    };\n    return fullPath(element);\n}\n","/* Buddy Pond - WindowManager.js - Marak Squires 2023 */\nimport TaskBar from './TaskBar.js';\nimport Window from \"./Window.js\";\n\nexport default class WindowManager {\n    constructor(ui, options = {}) {\n        this.storage = options.storage || localStorage; // Use localStorage by default\n        this.storageKey = options.storageKey || 'windowsState'; // Key for storing data\n        this.windows = [];\n        this._windows = [];\n        this.options = options;\n\n        this.bp = ui.bp;\n\n        this.useKeyboardControls = true;\n\n        if (typeof options.useKeyboardControls === \"boolean\") {\n            this.useKeyboardControls = options.useKeyboardControls;\n        }\n\n        if (typeof options.hideTaskBar === \"boolean\") {\n            this.hideTaskBar = options.hideTaskBar;\n        }\n\n        if (typeof options.openWindow === \"function\") {\n            this._openWindow = options.openWindow;\n        } else {\n            this._openWindow = function (name, config) {\n                const window = this.createWindow(config);\n                window.hydrate(config);\n            }\n        }\n\n        this.taskBar = new TaskBar({\n            bp: this.bp,\n            homeCallback: () => {\n\n                if (!this.state) {\n                    // save current window positions\n                    this.lastPositionsBeforeArranged = this.windows.map(w => {\n                        return {\n                            x: w.x,\n                            y: w.y,\n                            height: w.height,\n                            width: w.width\n                        }\n                    });\n                    // console.log('lastPositionsBeforeArranged', this.lastPositionsBeforeArranged);\n                    this.state = 'maximized';\n                }\n\n\n                if (this.state === 'minimized') {\n                    this.minimizeAllWindows();\n                    // this.arrangeHorizontalStacked();\n                    this.state = 'maximized';\n\n                } else if (this.state === 'stacked-vertical') {\n                    // stack-vertical has been removed ( for now )\n                    // it wasn't looking good as a default and was rarely used\n                    /*\n                    // restore all windows to their previous positions\n                    this.windows.forEach((w, i) => {\n                        w.move(this.lastPositionsBeforeArranged[i].x, this.lastPositionsBeforeArranged[i].y);\n                        w.setSize(this.lastPositionsBeforeArranged[i].width + 'px', this.lastPositionsBeforeArranged[i].height + 'px');\n                    });\n                    this.state = 'maximized';\n                    */\n\n                } else if (this.state === 'stacked-horizontal') {\n                    // this.arrangeVerticalStacked();\n                    // this.state = 'stacked-vertical';\n                    // restore all windows to their previous positions\n                    this.windows.forEach((w, i) => {\n                        w.move(this.lastPositionsBeforeArranged[i].x, this.lastPositionsBeforeArranged[i].y);\n                        w.setSize(this.lastPositionsBeforeArranged[i].width + 'px', this.lastPositionsBeforeArranged[i].height + 'px');\n                    });\n                    this.state = 'maximized';\n\n                } else {\n                    this.minimizeAllWindows(true);\n                    this.windows.forEach((w, i) => {\n                        w.move(this.lastPositionsBeforeArranged[i].x, this.lastPositionsBeforeArranged[i].y);\n                        w.setSize(this.lastPositionsBeforeArranged[i].width + 'px', this.lastPositionsBeforeArranged[i].height + 'px');\n                    });\n\n                    this.state = 'minimized';\n\n                }\n\n                // close all windows\n                // this.minimizeAllWindows();\n                // this.windowsClosed = true;\n\n                // hide all legacy BP windows\n                $('.window').hide();\n                $('.window').removeClass('window_stack');\n\n            }\n        });\n\n        if (this.options.hideTaskBar) {\n            this.taskBar.taskBarElement.style.display = 'none';\n        }\n\n        if (this.useKeyboardControls) {\n            window.addEventListener(\"keydown\", (e) => {\n                // alert(this.bp.editingMode);\n                if (e.key === \"Escape\" && !this.bp.ignoreUIControlKeys) {\n                    // alert(\"Escape key pressed\");\n                    // find the window with the highest depth and close it\n\n                    // first check to see if there is a dialog open, close that first\n                    const dialog = document.querySelector('.dialog');\n                    if (dialog) {\n                        dialog.remove();\n                        return;\n                    }\n\n                    const window = this.windows[0]; // no sort needed, windows are already sorted by depth\n                    if (window) {\n                        window.close();\n                    }\n                }\n            });\n        }\n\n    }\n\n    createWindow(options) {\n\n        // check to see if there is previous window data in this._windows\n        // check by id, if found, hydrate the window\n        // This is a temporary solution until full app hydration is back online\n        // This solution will allow for position and size to be saved and restored\n        options = { ...options, ...this.options.window };\n        // console.log('createWindow', options);\n        let previousWindowData = this._windows.find(w => w.id === options.id);\n        if (previousWindowData) {\n            // just merge the previous window data with the new options\n            options = { ...previousWindowData, ...options };\n        }\n\n        // check to see if window already exists with id\n        const existingWindow = this.getWindow(options.id);\n        let window;\n\n        if (existingWindow) {\n            window = existingWindow;\n            this.focusWindow(window); // Focus the newly created window\n            return window;\n        }\n        options.bp = this.bp;\n        window = new Window(options, this);\n\n        window.container.addEventListener(\"mousedown\", () => {\n            this.focusWindow(window);\n        });\n        this.addWindow(window);\n        this.focusWindow(window); // Focus the newly created window\n\n        // when opening a window, automatically add it to the taskbar\n        //alert(window.id)\n        /*\n        this.taskBar.openItem({\n            id: window.app,\n            title: window.title,\n            icon: window.icon,\n            onClick: () => {\n                // toggle window minimize / restore state\n                if (this.isMobile()) {\n                    // this.minimizeAllWindows(true);\n                    this.arrangeVerticalStacked();\n                    // we could minimize all other windows here\n                    // minimizeAllWindows();\n                }\n                if (window.isMinimized) {\n                    window.restore();\n                    window.focus();\n                } else {\n                    window.minimize();\n                }\n            }\n        });\n        */\n\n        return window;\n    }\n\n    isMobile() {\n        return window.innerWidth < 1000;\n    }\n\n    addWindow(window) {\n        this.windows.push(window);\n        this.saveWindowsState(); // Save state when a window is added\n        this.updateFocus();\n    }\n\n    removeWindow(window) {\n        // console.log(\"Removing window\", window);\n        this.windows = this.windows.filter(w => w.id !== window);\n        //console.log(\"Remaining windows\", this.windows);\n        this.saveWindowsState(); // Save state when a window is removed\n        this.updateFocus();\n    }\n\n    focusWindow(window) {\n        // window can be the window instance or the window id\n        if (typeof window === 'string') {\n            window = this.getWindow(window);\n        }\n\n        // console.log(\"Focusing window\", window);\n\n        // TODO: this isn't working consistenly?  there seems to be an issue with index\n        // console.log(\"Focusing window\", window.id);\n        const index = this.windows.indexOf(window);\n        if (index !== -1) {\n            this.windows.splice(index, 1);\n            this.windows.unshift(window);\n            // console.log('Focusing window', window.id, 'at index', index);\n            this.updateFocus();\n            window.focus(false);\n            this.saveWindowsState(); // Save state when focus changes\n        }\n        // iterate through all windows and set isFocused to false\n        // set this window isFocused to true\n        this.windows.forEach(w => {\n            if (w.id !== window) {\n                w.isFocused = false;\n\n            } else {\n                window.isFocused = true;\n\n            }\n        });\n    }\n\n    updateFocus() {\n        // console.log(\"Updating focus\");\n        this.windows.forEach((window, index) => {\n            // console.log(\"Setting depth for window\", window.id, \"to\", 1000 - index);\n            // console.log(\"setting depth for window\", window.id, \"to\", 1000 - index);\n            window.setDepth(1000 - index); // Higher index, higher depth\n        });\n    }\n\n    closeAllWindows() {\n        this.windows.forEach(window => window.close());\n        this.windows = [];\n        this.storage.removeItem(this.storageKey); // Clear storage when all windows are closed\n    }\n\n    minimizeAllWindows(force = false) {\n        if (!this.windowsHiding) {\n            this.windowsHiding = true;\n        } else {\n            this.windowsHiding = false;\n        }\n        this.windows.forEach(window => {\n\n            if (!this.windowsHiding || force) {\n                window.minimize(force);\n            } else {\n                window.restore();\n            }\n        });\n    }\n\n    getWindow(id) {\n        // console.log('searching for', id, 'in', this.windows)\n        return this.windows.find(w => w.id === id);\n    }\n\n    findWindows({ app, type }) {\n        if (!app) {\n            console.warn(\"No app provided to findWindows\");\n            return [];\n        }\n\n        // Normalize app and type to arrays for unified matching\n        const apps = Array.isArray(app) ? app : [app];\n        const types = type ? (Array.isArray(type) ? type : [type]) : null;\n\n        return this.windows.filter(w => {\n            const appMatch = apps.includes(w.app);\n            const typeMatch = types ? types.includes(w.type) : true;\n            return appMatch && typeMatch;\n        });\n    }\n\n    saveWindowsState() {\n        const state = JSON.stringify(this.windows.map(window => window.serialize()));\n        // console.log(\"Saving windows state\", JSON.parse(state));\n        this.storage.setItem(this.storageKey, state);\n    }\n\n    // Remark: This should probably be mostly in settings app or a separate app\n    loadWindows() {\n        const serializedWindows = this.storage.getItem(this.storageKey);\n        if (serializedWindows) {\n            this.restoreWindows(serializedWindows);\n        }\n    }\n\n    arrangeVerticalStacked() {\n        let containerHeight = document.body.clientHeight - 100; // Adjust for container and offset\n        let windowWidth = document.body.clientWidth - 10; // Adjust for container and offset\n        const defaultWindowHeight = containerHeight * 0.8; // Default height for non-minimized windows\n        const minimizedHeight = 120; // Height for minimized windows\n        const gap = 10; // Optional gap between windows for better spacing\n        let totalY = 0; // Initialize Y position\n\n        // console.log('window count', this.windows.length, 'defaultWindowHeight', defaultWindowHeight, 'windowWidth', windowWidth);\n        // console.log(this.windows);\n\n        this.windows.reverse().forEach((window, index) => {\n            // Determine the height for the current window\n            let currentWindowHeight = window.isMinimized ? minimizedHeight : defaultWindowHeight;\n\n            // console.log(\"index\", index, window.title, 'isMinimized', window.isMinimized, 'currentWindowHeight', currentWindowHeight, 'windowWidth', windowWidth);\n\n            // Set window size and position\n            window.setSize(windowWidth + 'px', currentWindowHeight + 'px'); // Set size\n            window.move(0, totalY); // Move to calculated Y position\n\n            // Increment totalY for the next window\n            totalY += currentWindowHeight + gap; // Add current window's height and gap\n\n            // console.log(\"totalY\", totalY, \"currentWindowHeight\", currentWindowHeight, \"windowWidth\", windowWidth);\n        });\n\n        // Position the shortCutsContainer below the last window\n        // console.log('setting shortCutsContainer top to', totalY);\n        if (this.bp.apps.desktop && this.bp.apps.desktop.shortCutsContainer) {\n            this.bp.apps.desktop.shortCutsContainer.style.position = 'absolute';\n            this.bp.apps.desktop.shortCutsContainer.style.left = '0px';\n            this.bp.apps.desktop.shortCutsContainer.style.top = totalY + 'px';\n        }\n    }\n\n    arrangeHorizontalStacked() {\n        const containerWidth = document.body.clientWidth; // Adjust to your specific container if not the body\n        const numWindows = this.windows.length;\n        let windowWidth = containerWidth / numWindows;\n        windowWidth -= 10; // Adjust to your desired offset\n        this.windows.forEach((window, index) => {\n            let xPos = windowWidth * index;\n            xPos += 5;\n            xPos += 10 * index; // Adjust to your desired offset\n            window.setSize(windowWidth + 'px', 'calc(100% - 80px)'); // Assuming you have a resize method\n            window.move(xPos, 30); // Assuming you have a move method\n        });\n\n    }\n\n    arrangeCascadeFromTopLeft() {\n        const offset = 20; // Adjust to your desired offset\n        this.windows.forEach((window, index) => {\n            const xPos = offset * index;\n            const yPos = offset * index;\n            window.move(xPos, yPos); // Assuming you have a move method\n        });\n    }\n\n    // Remark: This should probably be mostly in settings app or a separate app\n    // Restore windows from serialized state\n    restoreWindows(serializedWindows, inflate = false) {\n        const windowsData = JSON.parse(serializedWindows);\n        // console.log(\"Restoring windows\", windowsData);\n        // alert(\"Restoring windows from storage, this will be removed in the future, please use the settings app to manage windows\");\n        this._windows = windowsData;\n\n        if (!inflate) {\n            // for now, probably better suited elsewhere\n            return;\n        }\n        windowsData.forEach(data => {\n            // check to see if window already exists with id\n            const existingWindow = this.getWindow(data.id);\n            if (existingWindow) {\n                console.log(\"WARNING: Window with id\", data.id, \"already exists, hydrating instead of creating new window\");\n                existingWindow.hydrate(data);\n                return;\n            }\n            data.parent = document.querySelector(data.parent);\n            // console.log(\"hydrating window\", data);\n            // this.openWindow(data.app, data);\n            //const window = this.createWindow(data);\n            //window.hydrate(data);\n        });\n    }\n}","export default class CountdownManager {\n    constructor() {\n        this.intervalId = null;\n        this.expiryCallbacks = new WeakMap(); // store per-element callbacks\n    }\n\n    updateCountdowns() {\n        const countdownEls = $('.countdown-date').filter(function () {\n            return $(this).data('expired') !== true;\n        });\n\n        if (countdownEls.length === 0) {\n            if (this.intervalId) {\n                clearInterval(this.intervalId);\n                this.intervalId = null;\n                if (bp?.apps?.ui) {\n                    bp.apps.ui.countdownTimer = null;\n                }\n            }\n            return;\n        }\n\n        countdownEls.each((_, el) => {\n            const $el = $(el);\n\n            const expiry = new Date($el.data('expiry')).getTime();\n            const now = Date.now();\n            const distance = expiry - now;\n\n            if (!$el.data('duration')) {\n                const ctime = $el.data('ctime');\n                if (ctime) {\n                    $el.data('duration', expiry - ctime);\n                }\n            }\n            // console.log('distance for', $el, distance);\n            // distance is going negative? on recurse?\n            if (distance < 0) {\n                $el.data('expired', true);\n\n                const cb = this.expiryCallbacks.get(el);\n                if (typeof cb === 'function') {\n                    cb($el);\n                    this.expiryCallbacks.delete(el); // Cleanup\n                }\n\n                return;\n            }\n\n            const days = Math.floor(distance / (1000 * 60 * 60 * 24));\n            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));\n            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));\n            const seconds = Math.floor((distance % (1000 * 60)) / 1000);\n\n            let prefix = '';\n            let timeParts = [];\n\n            if (days > 0) {\n                prefix = `${days} Day${days > 1 ? 's' : ''} `;\n                timeParts.push(hours.toString().padStart(2, '0'));\n            } else if (hours > 0) {\n                timeParts.push(hours.toString());\n            }\n\n            timeParts.push(minutes.toString().padStart(2, '0'));\n            timeParts.push(seconds.toString().padStart(2, '0'));\n\n            $el.text(prefix + timeParts.join(':'));\n        });\n    }\n\n    /**\n     * Start a countdown on the given jQuery element\n     * @param {jQuery} $el - The element to attach the countdown to\n     * @param {string|Date} expiry - Expiry date/time\n     * @param {function} [onExpire] - Optional callback when countdown expires\n     */\n    startCountdown($el, expiry, onExpire) {\n        const expiryTime = new Date(expiry).getTime();\n        const now = Date.now();\n        const duration = expiryTime - now;\n\n        // console.log('Starting countdown for', $el, expiry);\n\n        $el\n            .data('expiry', expiryTime)\n            .data('ctime', now)\n            .data('duration', duration)\n            .data('expired', false);\n\n        if (typeof onExpire === 'function') {\n            this.expiryCallbacks.set($el[0], onExpire);\n        }\n\n        if (!this.intervalId) {\n            this.intervalId = setInterval(() => this.updateCountdowns(), 1000);\n            if (bp?.apps?.ui) {\n                bp.apps.ui.countdownTimer = this.intervalId;\n            }\n        }\n\n        this.updateCountdowns(); // Immediate update\n    }\n}\n","// Remark: We may be able to remove UI and put all this logic in the desktop app\nimport WindowManager from \"./Window/WindowManager.js\";\nimport CountdownManager from \"../ui/CountdownManager.js\";\n\nexport default class UI {\n    constructor(bp, options = {}) {\n        this.bp = bp;\n\n        let windowManagerOptions = {};\n        windowManagerOptions.openWindow = this.bp.open.bind(this.bp),\n        windowManagerOptions.window = options.window || {};\n        windowManagerOptions.hideTaskBar = options.hideTaskBar;\n        this.windowManager = new WindowManager(this, windowManagerOptions);\n        this.bp.windows = this.windowManager.windows;\n        // will re-load any previous stored metadata about windows\n        // storage provider is defaulted to localStorage\n        this.windowManager.loadWindows();\n\n        options.parent = options.parent || document.body;\n\n        // options.parent.classList.add('droparea');\n\n        this.options = options;\n\n        if (typeof options.fontAwesome !== 'boolean') {\n            options.fontAwesome = true;\n        }\n\n        this.parent = options.parent;\n\n        this.countdownManager = new CountdownManager(this.bp);\n        // this.countdownManager.updateCountdowns();\n        let that = this;\n        this.bp.window = that.windowManager.createWindow.bind(that.windowManager);\n        return this;\n    }\n\n    async init() {\n\n        // base CSS for ui, this can be themed in the future\n        if (!this.options.noCSS) {\n            this.bp.appendCSS('/v5/apps/based/ui/ui.css'); // no need to wait for CSS to load?\n            if (this.bp.mode !== 'prod') {\n                this.bp.appendCSS('/v5/apps/based/ui/mobile.css'); // no need to wait for CSS to load?\n                this.bp.appendCSS('/v5/apps/based/ui/Window/Window.css'); // no need to wait for CSS to load?\n                this.bp.appendCSS('/v5/apps/based/ui/Window/TaskBar.css'); // no need to wait for CSS to load?\n                this.bp.appendCSS('/v5/apps/based/ui/Window/StartPanel.css'); // no need to wait for CSS to load?\n\n            }\n        }\n\n        if (this.options.fontAwesome) {\n            this.bp.appendCSS('/v5/vendor/font-awesome/css/fontawesome.css', false, true);\n            this.bp.appendCSS('/v5/vendor/font-awesome/css/all.min.css', false, true);\n        }\n\n        // TODO: add these lines back after removing v4 completely ( as jQuery is already loaded in v4)\n        if (!this.options.noZepto) {\n            // If you need jQuery or another version of $\n            // we have the ability to not load Zepto as $\n            //await this.bp.appendScript('/v5/vendor/zepto.min.js');\n        } else {\n            //await this.bp.appendScript('/v5/vendor/jquery.min.js');\n\n        }\n\n        // await this.bp.appendScript('/desktop/assets/js/jquery.js');\n\n\n        if (!this.options.noTabs) {\n            // what happened here with config? we shouldn't need to reference host here,\n            // TODO: check implementation of importModule with options\n            let SimpleTabs = await this.bp.importModule(this.bp.config.host + '/v5/apps/based/ui/SimpleTabs.js', {}, false)\n            this.Tabs = SimpleTabs.default;\n\n        }\n\n        await this.bp.appendScript('/v5/vendor/DateFormat.js');\n\n        // bind common document events\n        // TODO: move UI events to separate file\n        let d = document;\n\n        $(d).on('click', '.open-app', function (e) {\n            let appName = $(this).data('app');\n            let context = $(e.target).data('context');\n            let type = $(this).data('type');\n            // let output = $(this).data('output');\n\n            console.log('open-app ' + appName);\n            // check to see if legacy app ( for now)\n            bp.open(appName, { context, type });\n\n        });\n\n        return 'loaded ui';\n    }\n\n    async appendToElement(el) {\n        console.log('appendToElement', this);\n        let html = await fetchHTMLFragment('ui.html'); // TODO: might need root\n        console.log(html);\n        el.innerHTML = html;\n        return 'hello ui';\n    }\n\n    async loadDocumentBody() {\n        console.log('loadDocumentBody', this);\n        let html = await this.bp.fetchHTMLFragment('/v5/apps/based/ui/ui.html'); // TODO: might need root\n        console.log(html);\n        $('body').append(html);\n        //document.body.innerHTML = html;\n        return 'hello ui';\n\n    }\n\n    toggleFullScreen() {\n        if (document.fullscreenElement) {\n            document.exitFullscreen();\n        } else {\n            document.documentElement.requestFullscreen();\n        }\n    }\n\n}"],"names":["StartPanel","constructor","onAppLaunch","bp","this","panelElement","open","close","panel","document","createElement","className","searchInput","id","type","placeholder","recentSection","innerHTML","recentGrid","appendChild","allSection","allGrid","body","window","apps","ui","recentApps","slice","forEach","appData","app","createAppTile","appList","desktop","Object","entries","appName","adminOnly","me","icon","addEventListener","query","value","toLowerCase","querySelectorAll","el","label","dataset","name","_app","console","log","showResult","includes","categories","some","cat","style","display","closeEventHandler","event","$","target","hasClass","contains","focus","remove","removeEventListener","tile","img","src","alt","textContent","onclick","async","context","TaskBar","homeCallback","taskBarElement","items","Map","shortcuts","Set","addItem","onClick","startPanel","isShortcut","e","preventDefault","closest","showContextMenu","clientX","clientY","enableDragAndDrop","x","y","existing","querySelector","item","get","menu","position","left","visibility","makeOption","handler","option","isOpen","closeItem","openItem","has","delete","add","installedTaskBarApps","settings","taskbar_apps","set","requestAnimationFrame","menuHeight","offsetHeight","top","removeMenu","setTimeout","once","config","ev","itemElement","existingWindow","windowManager","getWindow","isMinimized","restore","minimize","stopPropagation","draggable","itemText","itemIcon","height","width","call","alertItem","element","classList","removeItem","win","warn","removeChild","taskBarApps","getItem","dragged","over","children","indexOf","insertBefore","newOrder","Array","from","map","newTaskBarApps","idCounter","Window","options","title","content","iframeContent","z","parent","onFocus","onClose","onOpen","onMessage","onLoad","resizeable","preventOverlap","canBeBackground","getElementById","isMaximized","container","contentValue","isActive","windows","saveWindowsState","removeWindow","startDrag","bind","drag","stopDrag","createWindow","screenWidth","innerWidth","screenHeight","innerHeight","adjustedPosition","newWindow","buffer","adjustedX","adjustedY","x1","y1","w1","h1","x2","y2","w2","h2","parseInt","checkOverlap","adjustPosition","zIndex","titleBar","isMobile","ondblclick","maximize","iconTitleBar","titleBarSpan","passive","controls","minimizeButton","maximizeButton","closeButton","initContentArea","addResizeHandles","onload","iframeDoc","contentDocument","contentWindow","write","setupMessageHandling","length","script","receiveMessage","sendMessage","message","postMessage","data","handleReceivedMessage","move","serialize","parentXpath","names","parentNode","unshift","sibling","count","previousSibling","nodeType","tagName","nth","join","fullPath","hydrate","Number","updateWindow","setDepth","depth","setAsBackground","isBackground","restoreWindowFromBackground","isDragging","cursor","iframe","pointerEvents","getEventCoordinates","offsetX","offsetLeft","offsetY","offsetTop","bottomLimit","rightLimit","startsWith","touch","touches","changedTouches","force","arrangeVerticalStacked","normalMenuBarHeight","diff","pixelOffset","propigate","focusWindow","err","error","emit","taskBar","filter","parentElement","resizeHandle","startResize","setSize","startX","startY","startWidth","offsetWidth","startHeight","onMove","moveEvent","newWidth","newHeight","Math","max","onUp","resize","isResizing","stopResize","setTitle","setContent","WindowManager","storage","localStorage","storageKey","_windows","useKeyboardControls","hideTaskBar","openWindow","_openWindow","state","lastPositionsBeforeArranged","w","minimizeAllWindows","i","hide","removeClass","key","ignoreUIControlKeys","dialog","previousWindowData","find","addWindow","push","updateFocus","index","splice","isFocused","closeAllWindows","windowsHiding","findWindows","isArray","types","appMatch","typeMatch","JSON","stringify","setItem","loadWindows","serializedWindows","restoreWindows","containerHeight","clientHeight","windowWidth","clientWidth","defaultWindowHeight","totalY","reverse","currentWindowHeight","shortCutsContainer","arrangeHorizontalStacked","xPos","arrangeCascadeFromTopLeft","yPos","inflate","windowsData","parse","CountdownManager","intervalId","expiryCallbacks","WeakMap","updateCountdowns","countdownEls","each","_","$el","expiry","Date","getTime","distance","now","ctime","cb","days","floor","hours","minutes","seconds","prefix","timeParts","toString","padStart","text","clearInterval","countdownTimer","startCountdown","onExpire","expiryTime","duration","setInterval","UI","windowManagerOptions","fontAwesome","countdownManager","init","noCSS","appendCSS","mode","noZepto","noTabs","SimpleTabs","importModule","host","Tabs","default","appendScript","d","on","appendToElement","html","fetchHTMLFragment","loadDocumentBody","append","toggleFullScreen","fullscreenElement","exitFullscreen","documentElement","requestFullscreen"],"mappings":"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"}