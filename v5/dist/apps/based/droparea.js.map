{"version":3,"file":"droparea.js","sources":["../../../apps/based/droparea/droparea.js"],"sourcesContent":["export default class DropArea {\n    constructor(bp, options = {}) {\n        this.bp = bp;\n        this.options = options;\n        this.dropTarget = null; // Initialize with null to ensure proper targeting\n        this.dropInfoBar = this.createDropInfoBar(); // Create the UI element for displaying drop information\n    }\n\n    // Create a UI bar at the top of the document\n    createDropInfoBar() {\n        const bar = document.createElement('div');\n        bar.style.position = 'fixed';\n        bar.style.top = '0';\n        bar.style.left = '0';\n        bar.style.width = '100%';\n        bar.style.height = '120px';\n        bar.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';\n        bar.style.color = 'white';\n        bar.style.display = 'none'; // Start hidden\n        bar.style.alignItems = 'center';\n        bar.style.justifyContent = 'center';\n        bar.style.zIndex = '1000';\n        bar.style.padding = '10px';\n        document.body.appendChild(bar);\n        return bar;\n    }\n\n    // Called from parent bp app\n    async init() {\n        this.bp.log('Hello from DropArea');\n        this.setupListeners();\n        return 'DropArea loaded';\n    }\n\n    setupListeners() {\n        document.addEventListener('dragover', this.handleDragOver.bind(this), false);\n        document.addEventListener('dragleave', this.handleDragLeave.bind(this), false);\n        document.addEventListener('drop', this.handleDrop.bind(this), false);\n        document.addEventListener('dragend', this.handleDragEnd.bind(this), false);\n        document.addEventListener('mouseleave', this.handleDragLeave.bind(this), false);\n    }\n\n    handleDragOver(event) {\n        event.preventDefault(); // Prevent default behavior (prevent file from being opened)\n        // ignore drag events for .taskbar-container class\n        if (\n            event.srcElement.classList.contains('taskbar-item') ||\n            event.srcElement.classList.contains('taskbar-container') ||\n            event.srcElement.classList.contains('taskbar-items')) {\n            return false;\n        }\n\n        //console.log('srcElement:', event.srcElement);\n        this.dropInfoBar.style.display = 'flex'; // Show the info bar\n        let targetElement = event.target;\n\n        // Traverse up the DOM\n        while (targetElement && !targetElement.classList.contains('has-droparea')) {\n            if (targetElement === document.body) {\n                targetElement = null;\n                break;\n            }\n            targetElement = targetElement.parentNode;\n        }\n\n        // Update the visual state and drop information\n        if (targetElement !== this.dropTarget) {\n            if (this.dropTarget) {\n                this.dropTarget.style.border = ''; // Remove border from old drop target\n            }\n            if (targetElement) {\n                targetElement.style.border = '2px dashed #f0f'; // Apply border to new drop target\n                this.updateDropInfoBar(event, targetElement);\n            }\n            this.dropTarget = targetElement; // Update current drop target\n        } else if (targetElement) {\n            this.updateDropInfoBar(event, targetElement);\n        }\n    }\n\n    updateDropInfoBar(event, targetElement) {\n        const files = Array.from(event.dataTransfer.files).map(f => f.name).join(', ');\n        // console.log(\"Files during drag:\", event.dataTransfer.files);\n\n        // Gather data attributes from the target element\n        let targetData = {\n            id: targetElement.id || 'None',\n            app: targetElement.dataset.app || 'None',\n            type: targetElement.dataset.type || 'None',\n            context: targetElement.dataset.context || 'None'\n        };\n        // console.log('Target Data:', targetData);\n\n        // Build a string to display optional data attributes\n        let dataAttributes = `\n            <strong>ID:</strong> ${targetData.id}<br>\n            <strong>App:</strong> ${targetData.app}<br>\n            <strong>Type:</strong> ${targetData.type}<br>\n            <strong>Context:</strong> ${targetData.context}`;\n\n        // Update the innerHTML of the dropInfoBar to include targetData\n        this.dropInfoBar.innerHTML = `\n            <strong>Target:</strong> ${targetElement.className || 'None'}<br>\n            <strong>Files:</strong> ${files || 'None'}<br>\n            ${dataAttributes}`;\n    }\n\n    async handleDrop(event) {\n        console.log('DropArea: handleDrop called', event);\n        // ignore drag events for .taskbar-container class\n        if (\n            event.srcElement.classList.contains('taskbar-item') ||\n            event.srcElement.classList.contains('taskbar-container') ||\n            event.srcElement.classList.contains('taskbar-items')) {\n            console.log('DropArea: handleDrop ignored for taskbar-item');\n            return;\n        }\n        event.preventDefault();\n        if (this.dropTarget && event.target === this.dropTarget) {\n            this.triggerDropAreaHandler(event);\n        }\n        console.log('Files dropped:', event.target, event.dataTransfer.files);\n        // TODO: this should be on the EE for buddylist\n        // check to see if the target.id was \"mainOverlay\"\n\n\n        const hasFiles = event.dataTransfer.files.length > 0;\n\n        if (!hasFiles) {\n            console.warn('DropArea: No files dropped, ignoring event.');\n            this.clearDropTarget();\n            return;\n        }\n\n        // Experimental logic for dropped HTML elements with no files\n        /*\n        // this would have to be added in the parent app\n        // e.dataTransfer.setData('text/html', dragged.outerHTML);\n        // e.dataTransfer.effectAllowed = 'copyMove';\n\n\n        if (!hasFiles && event.dataTransfer.types.includes('text/html')) {\n            let htmlString = event.dataTransfer.getData('text/html');\n            if (htmlString) {\n                console.log('DropArea: HTML element dropped. Rendering preview...');\n                // Parse the HTML and extract relevant info\n                const temp = document.createElement('div');\n                temp.innerHTML = htmlString.trim();\n\n                let droppedEl = temp;\n\n                // If it's an image, render it directly\n                if (droppedEl) {\n                    const preview = document.createElement('div');\n                    preview.classList.add('file-preview');\n                    preview.style.textAlign = 'center';\n                    preview.style.padding = '10px';\n                    preview.innerHTML = `<strong>Dropped Image:</strong><br>`;\n                    preview.appendChild(droppedEl);\n\n                    // Close button\n                    let closeButton = document.createElement('button');\n                    closeButton.innerHTML = 'X';\n                    closeButton.style.position = 'absolute';\n                    closeButton.style.top = '25px';\n                    closeButton.style.right = '22px';\n                    closeButton.style.backgroundColor = '#f00';\n                    closeButton.style.color = '#fff';\n                    closeButton.style.border = 'none';\n                    closeButton.style.padding = '5px';\n                    closeButton.style.cursor = 'pointer';\n                    closeButton.onclick = () => preview.remove();\n                    preview.appendChild(closeButton);\n\n                    // Show in viewer or insert inline\n                    await this.bp.open('file-viewer');\n                    const viewer = this.bp.apps['file-viewer'];\n                    if (viewer && viewer.displayHTMLFragment) {\n                        viewer.displayHTMLFragment(droppedEl);\n                    }\n                   \n\n                    this.clearDropTarget();\n                    return;\n                }\n\n                // Fallback: render sanitized snippet\n                const preview = document.createElement('div');\n                preview.classList.add('file-preview');\n                preview.style.background = '#111';\n                preview.style.color = '#fff';\n                preview.style.padding = '15px';\n                preview.style.margin = '10px';\n                preview.style.fontFamily = 'monospace';\n                preview.innerHTML = `<strong>Dropped HTML:</strong><pre>${htmlString\n                    .replace(/</g, '&lt;')\n                    .replace(/>/g, '&gt;')}</pre>`;\n\n                document.body.appendChild(preview);\n                this.clearDropTarget();\n                return;\n            }\n        }\n        */\n\n        if (!this.dropTarget || this.dropTarget.id === 'mainOverlay') {\n            // open the file viewer\n            await this.bp.open('file-viewer');\n        } else {\n            let targetId = this.dropTarget.id;\n            let targetElement = $(this.dropTarget);\n            let targetApp = targetElement.data('app');\n            let targetType = targetElement.data('type');\n            let targetContext = targetElement.data('context');\n            // check to see if targetApp is loaded ( should be )\n            // and if target app has a droparea handler\n            let app = this.bp.apps[targetApp];\n            if (!app) {\n                console.error('target app not found:', targetApp);\n                return;\n            }\n\n            if (app.handleDrop) {\n                console.log('target app has droparea handler:', targetApp, 'using it...');\n                app.handleDrop(event);\n            }\n\n\n\n\n            // TODO: invert control, have the buddylist handle the drop event\n            if (targetApp === 'buddylist') {\n\n                let aimMessageControls = $('.aim-message-controls', this.dropTarget);\n                let aimSendButton = $('.aim-send-btn', aimMessageControls);\n                // set opacity to 1\n                aimSendButton.css('opacity', '1');\n\n                // insert a div above the .aim-input div\n                // this should be a preview of the file\n                let preview = document.createElement('div');\n                preview.innerHTML = 'File Preview';\n                preview.classList.add('file-preview');\n                //preview.style.border = '1px solid #f0f';\n                //preview.style.padding = '10px';\n                //preview.style.margin = '10px';\n                //preview.style.backgroundColor = '#f0f';\n                preview.style.color = '#fff';\n                preview.style.fontWeight = 'bold';\n                preview.style.textAlign = 'center';\n\n                // add cancel / remove x button in top right\n                let closeButton = document.createElement('button');\n                closeButton.innerHTML = 'X';\n                closeButton.style.position = 'absolute';\n                closeButton.style.top = '25px';\n                closeButton.style.right = '22px';\n                closeButton.style.backgroundColor = '#f00';\n                closeButton.style.color = '#fff';\n                closeButton.style.border = 'none';\n                closeButton.style.padding = '5px';\n                closeButton.style.cursor = 'pointer';\n                // opacity: 0.5;\n                closeButton.style.opacity = '0.9';\n                // closeButton.style.borderRadius = '50%';\n                closeButton.style.fontSize = '1.5em';\n                closeButton.style.zIndex = '1000';\n                closeButton.onclick = () => {\n                    preview.remove();\n                    aimSendButton.css('opacity', '0.5');\n                };\n\n                preview.appendChild(closeButton);\n\n                for (let i = 0; i < event.dataTransfer.files.length; i++) {\n                    let file = event.dataTransfer.files[i];\n\n                    let fileType = file.type;\n                    console.log(\"check file type\", fileType);\n                    const fileCategory = buddypond.getFileCategory(fileType);\n                    if (fileCategory === 'binary') {\n                        // not supported yet\n                        console.error('uploading binary files not supported yet...');\n\n                    } else {\n                        let fileViewerPreview = this.bp.apps['file-viewer'].displaySingleFile(file, preview);\n                        aimMessageControls.prepend(preview);\n                    }\n                }\n\n\n            }\n\n            //alert('Dropped on ' + targetId);\n        }\n\n        this.bp.emit('ui::droparea::drop', event.dataTransfer.files);\n        this.clearDropTarget();\n    }\n\n    handleDragLeave(event) {\n        if (event.target === document.documentElement || event.target === document.body) {\n            this.clearDropTarget();\n        }\n    }\n\n    handleDragEnd(event) {\n        this.clearDropTarget();\n    }\n\n    clearDropTarget() {\n        if (this.dropTarget) {\n            this.dropTarget.style.border = '';\n            this.dropTarget = null;\n        }\n        this.dropInfoBar.style.display = 'none'; // Hide the info bar\n    }\n\n    triggerDropAreaHandler(event) {\n        console.log('Files dropped:', event.dataTransfer.files);\n        // Implement custom handling logic here\n    }\n}\n"],"names":["DropArea","constructor","bp","options","this","dropTarget","dropInfoBar","createDropInfoBar","bar","document","createElement","style","position","top","left","width","height","backgroundColor","color","display","alignItems","justifyContent","zIndex","padding","body","appendChild","init","log","setupListeners","addEventListener","handleDragOver","bind","handleDragLeave","handleDrop","handleDragEnd","event","preventDefault","srcElement","classList","contains","targetElement","target","parentNode","border","updateDropInfoBar","files","Array","from","dataTransfer","map","f","name","join","dataAttributes","id","dataset","app","type","context","innerHTML","className","console","triggerDropAreaHandler","length","warn","clearDropTarget","$","targetApp","data","apps","error","aimMessageControls","aimSendButton","css","preview","add","fontWeight","textAlign","closeButton","right","cursor","opacity","fontSize","onclick","remove","i","file","fileType","buddypond","getFileCategory","displaySingleFile","prepend","open","emit","documentElement"],"mappings":"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"}