class t{constructor({onAppLaunch:t,bp:e}={}){this.onAppLaunch=t||function(){},this.bp=e,this.panelElement=null}open(){if(this.panelElement)return void this.close();const t=document.createElement("div");t.className="start-panel",t.style.display="none";const e=document.createElement("input");e.id="start-panel-search",e.className="start-panel-search",e.type="text",e.placeholder="Search apps...",e.autocomplete="off";const i=document.createElement("div");i.className="start-panel-section",i.innerHTML="<h3>Recent Apps</h3>";const s=document.createElement("div");s.className="start-panel-grid",i.appendChild(s);const n=document.createElement("div");n.className="start-panel-section",n.innerHTML="<h3>All Apps</h3>";const a=document.createElement("div");a.className="start-panel-grid",n.appendChild(a),t.appendChild(e),t.appendChild(i),t.appendChild(n),document.body.appendChild(t),this.panelElement=t,$(t).css({display:"block",opacity:1,transform:"translateY(100%)",transition:"all 300ms ease-out"}),requestAnimationFrame((()=>{$(t).css({opacity:1,transform:"translateY(0)"})}));(window.bp?.apps?.ui?.recentApps||[]).slice(0,10).forEach((t=>{const e=this.createAppTile(t);s.appendChild(e)}));const o=window.bp?.apps?.desktop?.appList||{};Object.entries(o).forEach((([t,e])=>{if(e.adminOnly&&"Marak"!==this.bp.me)return;e.app=e.app||t,e.id=e.id||t;const i=this.createAppTile(e,e.icon);a.appendChild(i)})),e.addEventListener("input",(()=>{const t=e.value.toLowerCase();i.style.display=t.length>0?"none":"",a.querySelectorAll(".start-panel-app").forEach((e=>{const i=e.dataset.name.toLowerCase(),s=this.bp.apps.desktop.appList[e.dataset.id];let n=i.includes(t);!n&&s?.categories&&(n=s.categories.some((e=>e.toLowerCase().includes(t)))),e.style.display=n?"flex":"none"}))})),this.closeEventHandler=t=>{$(t.target).hasClass("taskbar-item")||this.panelElement&&!this.panelElement.contains(t.target)&&t.target!==e&&this.close()},document.addEventListener("click",this.closeEventHandler),this.bp.isMobile()||e.focus()}close(){if(this.panelElement){const t=$(this.panelElement);t.css({transform:"translateY(0)",opacity:1,transition:"all 300ms ease-in"}),requestAnimationFrame((()=>{t.css({transform:"translateY(100%)",opacity:1}),setTimeout((()=>{t.remove(),this.panelElement=null}),300)}))}this.closeEventHandler&&(document.removeEventListener("click",this.closeEventHandler),this.closeEventHandler=null)}createAppTile(t,e="icons/default.png"){let i=t.id||t.appName||t.name||t.label||"Unknown App";e=t.icon||e||"icons/default.png";const s=document.createElement("div");s.className="start-panel-app",s.dataset.name=i,s.dataset.id=t.id||t.app||i,s.dataset.app=t.app||t.id||i;const n=document.createElement("img");n.src=e,n.alt=i;const a=document.createElement("div");return a.textContent=t.label||i,s.appendChild(n),s.appendChild(a),s.onclick=async()=>{await this.bp.open(t.app||t.id,{context:t.context}),this.onAppLaunch(i),this.close()},s}}t.prototype.enableKeyboardNavigation=function(t,e){let i=-1,s=[];function n(){s=Array.from(t.querySelectorAll(".start-panel-app")).filter((t=>"none"!==t.style.display))}function a(t){console.log("Focusing tile at index:",t),s.forEach(((e,i)=>{e.classList.toggle("focused",i===t),i===t&&e.scrollIntoView({block:"nearest"})})),i=t}n(),e.addEventListener("keydown",(t=>{"ArrowDown"===t.key&&(n(),s.length>0&&(a(0),t.preventDefault()))}));t.addEventListener("keydown",(t=>{if(console.log("Key pressed:",t.key),0!==s.length)if("Tab"!==t.key){if("ArrowDown"===t.key){if(-1===i)a(0);else{let t=i+5;t<s.length?a(t):a(s.length-1)}t.preventDefault()}if("ArrowUp"===t.key){if(-1===i)a(0);else{let t=i-5;a(t>=0?t:0)}t.preventDefault()}"ArrowRight"===t.key&&(a(-1===i?0:Math.min(i+1,s.length-1)),t.preventDefault()),"ArrowLeft"===t.key&&(a(-1===i?0:Math.max(i-1,0)),t.preventDefault()),"Enter"===t.key&&i>=0&&(s[i].click(),t.preventDefault()),"Escape"===t.key&&(s.forEach((t=>t.classList.remove("focused"))),i=-1,e.focus())}else{if(-1===i)a(0);else{let t=i+1;t<s.length?a(t):a(s.length-1)}t.preventDefault()}}))};class e{constructor({homeCallback:e,bp:i}={}){this.taskBarElement=document.createElement("div"),this.taskBarElement.className="taskbar-container",document.body.appendChild(this.taskBarElement),this.taskbarLeft=document.createElement("div"),this.taskbarLeft.className="taskbar-left",this.taskBarElement.appendChild(this.taskbarLeft),this.taskbarItems=document.createElement("div"),this.taskbarItems.className="taskbar-items",this.taskBarElement.appendChild(this.taskbarItems),this.taskbarRight=document.createElement("div"),this.taskbarRight.className="taskbar-right",this.taskBarElement.appendChild(this.taskbarRight),this.bp=i,this.items=new Map,this.shortcuts=new Set,this.taskbarItems.addEventListener("scroll",(()=>{const t=this.taskbarItems.scrollLeft+this.taskbarItems.clientWidth>=this.taskbarItems.scrollWidth-1;console.log("Scroll end reached:",t),this.taskbarItems.setAttribute("data-scroll-end",t)})),e&&this.addItem({id:"home",label:"Home",onClick:function(){this.startPanel||(this.startPanel=new t({bp:this.bp})),this.startPanel.open()},icon:"desktop/assets/images/icons/icon_mantra_64.png",isShortcut:!0,anchor:"right"}),this.bp.isMobile()&&this.addItem({id:"settings",label:"Settings",onClick:t=>{t.stopPropagation();const e=$(".menu-bar");e.hasClass("mobile-active")?e.animate({left:"-100%"},300,(()=>{e.removeClass("mobile-active")})):e.css({left:"-100%",display:"flex"}).addClass("mobile-active").animate({left:"0%"},300)},icon:"desktop/assets/images/icons/icon_settings_64.png",isShortcut:!0,anchor:"left"}),this.taskBarElement.addEventListener("contextmenu",(t=>{t.preventDefault();const e=t.target.closest(".taskbar-item");if(!e)return;const i=e.dataset.id;i&&"home"!==i&&"settings"!==i&&this.showContextMenu(i,t.clientX,t.clientY)})),this.enableDragAndDrop()}showContextMenu(t,e,i){const s=document.querySelector(".taskbar-context-menu");s&&s.remove();const n=this.items.get(t);if(!n)return;const a=document.createElement("div");a.className="taskbar-context-menu",a.style.position="fixed",a.style.left=`${e}px`,a.style.visibility="hidden",document.body.appendChild(a);const o=(t,e)=>{const i=document.createElement("div");i.className="taskbar-context-menu-item",i.textContent=t,i.onclick=()=>{e(),this.startPanel.close(),a.remove()},a.appendChild(i)};n.isOpen?o("Close",(()=>this.closeItem(t))):o("Open",(()=>this.openItem(n))),this.shortcuts.has(t)?o("Unpin from Taskbar",(()=>{this.shortcuts.delete(t),n.isOpen||this.removeItem(t)})):"buddylist"!==n.app&&"buddylist"!==t&&"emulator"!==n.app&&o("Keep in Taskbar",(()=>{this.shortcuts.add(n.app||t);let e=this.bp.settings.taskbar_apps||{};e[n.app||t]={app:n.app||t,context:n.context||"default",label:n.label||t,icon:n.icon||""},this.bp.set("taskbar_apps",e)})),requestAnimationFrame((()=>{const t=a.offsetHeight;let e=i-t-4;e<0&&(e=i+4),a.style.top=`${e}px`,a.style.visibility="visible"}));const h=()=>a.remove();setTimeout((()=>{window.addEventListener("click",h,{once:!0}),window.addEventListener("contextmenu",h,{once:!0})}),0)}addItem(t){let{app:e,id:i,context:s,label:n="",onClick:a,icon:o,isShortcut:h=!0,anchor:r}=t,d=this.bp.settings.taskbar_apps||{};"home"!==i&&"settings"!==i&&(d[e||i]={id:i,app:e||i,context:s||"default",label:n||i,icon:o||""},this.bp.set("taskbar_apps",d)),"function"!=typeof a&&(a=async(t,n)=>{let a=this.bp.apps.ui.windowManager.getWindow(i);a?a.isMinimized?(a.restore(),a.focus()):a.minimize():await this.bp.open(e||i,{context:s}),this.startPanel.close(),t.stopPropagation()});let l=this.taskBarElement.querySelector(`[data-id="${i}"]`);if(l)return l;const c=document.createElement("div");if(c.className="taskbar-item",c.dataset.id=i,c.draggable="home"!==i&&"settings"!==i,!this.bp.isMobile()){const t=document.createElement("div");t.className="taskbar-item-text",t.textContent=n,c.appendChild(t)}if(o){const t=document.createElement("img");t.src=o,t.height=32,t.width=32,t.alt=n,c.appendChild(t)}else c.textContent=n;return c.onclick=t=>{a&&a.call(this,t,c),this.alertItem(i)},h&&this.shortcuts.add(i),"home"===i&&"right"===r?this.taskbarRight.appendChild(c):"settings"===i&&"left"===r?this.taskbarLeft.appendChild(c):(this.taskbarItems.appendChild(c),this.bp.isMobile()&&requestAnimationFrame((()=>{c.scrollIntoView({behavior:"smooth",inline:"start"})}))),this.items.set(i,{...t,element:c,isOpen:!1,isShortcut:h}),c}openItem(t){let e=this.items.get(t.id);e?(e.isOpen=!0,e.element.classList.add("taskbar-item-open"),this.bp.isMobile()&&requestAnimationFrame((()=>{e.element.scrollIntoView({behavior:"smooth",inline:"start"})}))):(this.addItem({...t,isShortcut:!1}),this.openItem(t))}closeItem(t){const e=this.items.get(t);if(!e)return;e.isOpen=!1,e.element.classList.remove("taskbar-item-open"),this.shortcuts.has(t)||this.removeItem(t);const i=this.bp.apps.ui.windowManager.getWindow(t);i?i.close():console.warn(`No window found with ID: ${t}`)}removeItem(t){const e=this.items.get(t);if(!e)return;e.element.parentNode.removeChild(e.element),this.items.delete(t),this.shortcuts.delete(t);let i=this.bp.settings.taskbar_apps||{};i[t]&&(delete i[t],this.bp.set("taskbar_apps",i))}getItem(t){return this.items.get(t)}alertItem(t){const e=this.items.get(t);e&&(e.element.classList.add("taskbar-item-alert"),setTimeout((()=>e.element.classList.remove("taskbar-item-alert")),1e3))}enableDragAndDrop(){let t=null;this.taskbarItems.addEventListener("dragstart",(e=>{t=e.target.closest(".taskbar-item"),!t||"home"!==t.dataset.id&&"settings"!==t.dataset.id||(e.preventDefault(),t=null)})),this.taskbarItems.addEventListener("dragover",(e=>{e.preventDefault();const i=e.target.closest(".taskbar-item");if(t&&i&&t!==i&&"home"!==i.dataset.id&&"settings"!==i.dataset.id){[...this.taskbarItems.children].indexOf(t)<[...this.taskbarItems.children].indexOf(i)?this.taskbarItems.insertBefore(i,t):this.taskbarItems.insertBefore(t,i)}})),this.taskbarItems.addEventListener("dragend",(()=>{if(t){const t=Array.from(this.taskbarItems.children).map((t=>t.dataset.id));let e=this.bp.settings.taskbar_apps||{};const i={};t.forEach((t=>{e[t]&&(i[t]=e[t])})),this.bp.set("taskbar_apps",i)}t=null}))}}let i=0;class s{constructor(t={},e){const{title:s="Window",width:n="400px",height:a="300px",app:o="default",type:h="singleton",context:r="default",content:d="",iframeContent:l=!1,icon:c="",x:p=50,y:m=50,z:u=99,parent:w=window.document.body,id:g=`window-${i}`,onFocus:b=()=>{},onClose:f=()=>{},onOpen:y=()=>{},onMessage:v=()=>{},onLoad:k=()=>{},className:x="",resizeable:E=!0,preventOverlap:C=!0,canBeBackground:L=!1}=t;this.windowManager=e;let B=document.getElementById(g);return B?(console.log("Window with id already exists",g),B):(this.title=s,this.icon=c,this.width=n,this.height=a,this.app="default"!==o?o:g,this.type=h,this.x=p,this.y=m,this.z=99,this.context=r,this.parent=w,this.id=g,this.isMaximized=!1,this.isMinimized=!1,this.container=null,this.content=null,this.iframeContent=l,this.contentValue=d,this.isActive=!1,this.className=x,this.resizeable=E,this.preventOverlap=C,this.canBeBackground=L,e=e||{windows:[],saveWindowsState:()=>{},removeWindow:()=>{}},this.bp=t.bp,this.onFocus=b,this.onClose=f,this.onOpen=y,this.onLoad=k,this.onMessage=v,this.startDrag=this.startDrag.bind(this),this.drag=this.drag.bind(this),this.stopDrag=this.stopDrag.bind(this),this.createWindow(),this.open(),this)}createWindow(){this.container=document.createElement("div"),this.container.classList.add("window-container"),this.container.dataset.app=this.app,this.container.dataset.type=this.type,this.container.dataset.context=this.context,this.className&&this.container.classList.add(this.className),this.resizeable||this.container.classList.add("window-not-resizeable"),this.container.id=this.id,this.container.style.width=`${this.width}px`,this.container.style.height=`${this.height}px`,this.container.style.position="absolute";const t=window.innerWidth,e=window.innerHeight;let i={x:this.x,y:this.y};if(this.preventOverlap&&(i=function(t,e,i,s,n=10){let a=t.x,o=t.y;return e.forEach((e=>{(function(t,e,i,s,n,a,o,h,r=10){return i=parseInt(i),s=parseInt(s),o=parseInt(o),h=parseInt(h),t<n+o+r&&t+i+r>n&&e<a+h+r&&e+s+r>a})(a,o,t.width,t.height,e.x,e.y,e.width,e.height,n)&&(a+=n)})),a+t.width+n>i&&(a=i-t.width-n),o+t.height+n>s&&(o=s-t.height-n),a<n&&(a=n),o<n&&(o=n),{x:a,y:o}}({x:this.x,y:this.y,width:this.width,height:this.height},this.windowManager.windows,t,e,32)),this.x=i.x,this.y=i.y,this.container.style.top=`${this.y}px`,this.container.style.left=`${this.x}px`,this.container.style.zIndex=99,this.container.addEventListener("mousedown",(()=>{document.querySelectorAll(".window-container").forEach((t=>{t.classList.remove("window-active"),t.isActive=!1})),this.container.classList.add("window-active"),this.isActive=!0})),this.container.addEventListener("touchstart",(()=>{document.querySelectorAll(".window-container").forEach((t=>{t.classList.remove("window-active"),t.isActive=!1})),this.container.classList.add("window-active"),this.isActive=!0})),this.titleBar=document.createElement("div"),this.titleBar.classList.add("window-title-bar"),this.bp.isMobile()&&(this.titleBar.onclick=()=>{console.log("titleBar clicked on mobile"),this.minimize()}),this.titleBar.ondblclick=()=>this.maximize(),this.icon){let t=document.createElement("img");t.src=this.icon,t.classList.add("window-icon"),this.titleBar.appendChild(t)}let s=document.createElement("span");s.classList.add("window-title-text"),s.textContent=this.title,this.titleBarSpan=s,this.titleBar.addEventListener("mousedown",this.startDrag),this.titleBar.addEventListener("touchstart",this.startDrag,{passive:!1});const n=document.createElement("div");if(n.classList.add("window-controls"),this.bp.isMobile()||(this.minimizeButton=document.createElement("button"),this.minimizeButton.innerHTML="&#x1F7E1;",this.minimizeButton.classList.add("minimize-button"),this.minimizeButton.title="Minimize",this.minimizeButton.onclick=()=>this.minimize(),n.appendChild(this.minimizeButton)),this.maximizeButton=document.createElement("button"),this.maximizeButton.innerHTML="&#x1F7E2;",this.maximizeButton.classList.add("maximize-button"),this.maximizeButton.title="Maximize",this.maximizeButton.onclick=()=>this.maximize(),n.appendChild(this.maximizeButton),this.closeButton=document.createElement("button"),this.closeButton.innerHTML="&#x1F534;",this.closeButton.classList.add("close-button"),this.closeButton.title="Close",this.closeButton.onclick=()=>this.close(),n.appendChild(this.closeButton),this.titleBar.appendChild(s),this.titleBar.appendChild(n),this.initContentArea(),this.container.appendChild(this.titleBar),this.container.appendChild(this.content),this.parent&&this.parent.appendChild(this.container),this.resizeable&&this.addResizeHandles(),this.canBeBackground){let t=document.getElementById("menubar-set-window-as-background");t&&t.classList.remove("disabled")}return this.container}initContentArea(){if("boolean"==typeof this.iframeContent&&this.iframeContent)this.content=document.createElement("iframe"),this.content.classList.add("bp-window-content"),document.body.appendChild(this.content),this.content.src="about:blank",this.content.onload=()=>{let t=this.content.contentDocument||this.content.contentWindow.document;t.open(),t.write(this.contentValue),t.close(),this.setupMessageHandling()};else if("string"==typeof this.iframeContent&&this.iframeContent.length){this.content=document.createElement("div"),this.content.classList.add("bp-window-content"),this.iframe=document.createElement("iframe"),this.content.appendChild(this.iframe),this.iframe.setAttribute("allow","autoplay; encrypted-media; fullscreen; clipboard-write; accelerometer; gyroscope; web-share"),this.iframe.src=this.iframeContent;let t=window.location.origin;if(-1!==this.iframe.src.indexOf(t))this.iframe.onload=()=>this.setupMessageHandling();else{this.iframe.style.display="none",this.iframe.onload=()=>{t.remove(),this.iframe.style.display="block"};let t=document.createElement("div");t.id="loaderHolder",t.innerHTML=`\n                <div id="loader"></div>\n                <p class="loaderText">Loading... ${this.id||this.title||this.label||""}</p>\n            `,this.content.appendChild(t)}}else this.content=document.createElement("div"),this.content.classList.add("bp-window-content"),"string"==typeof this.contentValue?this.content.innerHTML=this.contentValue:this.content.appendChild(this.contentValue)}setupMessageHandling(){this.onLoad(this),this.iframe.contentWindow;const t=this.iframe.contentDocument||this.iframe.contentWindow.document,e=t.createElement("script");e.type="text/javascript",e.textContent="\n            document.addEventListener('keydown', (event) => {\n                if (event.key === 'Escape') {\n                    window.parent.postMessage({ event: 'ESC_KEY_PRESSED' }, '*');\n                }\n            });\n        ",t.body.appendChild(e),window.addEventListener("message",this.receiveMessage.bind(this),!1)}sendMessage(t){this.iframe&&this.iframe.contentWindow&&this.iframe.contentWindow.postMessage(t,"*")}receiveMessage(t){"object"==typeof t.data&&t.data.event&&("ESC_KEY_PRESSED"===t.data.event?(console.log("ESC key pressed inside iframe. Closing window..."),this.close()):this.handleReceivedMessage(t.data))}handleReceivedMessage(t){this.onMessage&&this.onMessage(t)}move(t,e){this.x=t,this.y=e,this.container.style.top=`${this.y}px`,this.container.style.left=`${this.x}px`,this.windowManager.saveWindowsState()}serialize(){let t=(t=>{let e=[];for(;t.parentNode;){if(t.id){e.unshift("#"+t.id);break}{let i,s=t,n=1;for(;i=s.previousSibling;)1===i.nodeType&&i.tagName===s.tagName&&n++,s=i;const a=t.tagName.toLowerCase(),o=n>1?`:nth-of-type(${n})`:"";e.unshift(`${a}${o}`),t=t.parentNode}}return e.length?e.join(" > "):null})(this.parent);return{title:this.title,width:this.width,height:this.height,type:this.type,app:this.app,x:this.x,y:this.y,z:this.z,context:this.context,parent:t,id:this.id,onClose:this.onClose,onOpen:this.onOpen,className:this.className,resizeable:this.resizeable,canBeBackground:this.canBeBackground}}hydrate(t){console.log("hydrate",t),this.title=t.title,this.width=t.width,this.height=t.height,this.app=t.app,this.type=t.type,this.x=t.x,this.y=t.y,this.z=Number(t.z),this.context=t.context,this.id=t.id,this.onClose=t.onClose,this.onOpen=t.onOpen,this.onMessage=t.onMessage,this.className=t.className,this.resizeable=t.resizeable,this.canBeBackground=t.canBeBackground,this.updateWindow()}updateWindow(){this.container.style.width=`${this.width}px`,this.container.style.height=`${this.height}px`,this.container.style.top=`${this.y}px`,this.container.style.left=`${this.x}px`,this.container.style.zIndex=this.z}setDepth(t){this.z=t,this.container.style.zIndex=t,this.windowManager.saveWindowsState()}setAsBackground(){console.log("setAsBackground",this.windowManager.windows),this.canBeBackground?(this.windowManager.windows.forEach((t=>{t.isBackground&&t.restoreWindowFromBackground()})),this.container.style.zIndex=-1,this.container.style.width="100%",this.container.style.height="100%",this.container.style.top="0",this.container.style.left="0",this.isBackground=!0,this.isActive=!1):console.log("This window cannot be set as background. Try setting canBeBackground:true in the Window declaration")}restoreWindowFromBackground(){this.isBackground=!1,this.container.style.zIndex=11e3,this.container.style.width=`${this.width}`,this.container.style.height=`${this.height}`,this.container.style.top=`${this.y}px`,this.container.style.left=`${this.x}px`;let t=document.getElementById("menubar-restore-background-window");t&&t.classList.add("disabled")}startDrag(t){this.isDragging=!0,this.titleBar.style.cursor="grabbing";this.container.querySelectorAll("iframe").forEach((t=>{t.style.pointerEvents="none"}));const{clientX:e,clientY:i}=this.getEventCoordinates(t);this.offsetX=e-this.container.offsetLeft,this.offsetY=i-this.container.offsetTop,document.addEventListener("mousemove",this.drag),document.addEventListener("touchmove",this.drag,{passive:!1}),document.addEventListener("mouseup",this.stopDrag),document.addEventListener("touchend",this.stopDrag)}drag(t){if(!this.isDragging)return;t.preventDefault();const{clientX:e,clientY:i}=this.getEventCoordinates(t);let s=window.innerHeight-52;i>42&&i<s&&(this.container.style.top=i-this.offsetY+"px");let n=window.innerWidth-52;e>52&&e<n&&(this.container.style.left=e-this.offsetX+"px")}stopDrag(){this.isDragging=!1,this.titleBar.style.cursor="grab";this.container.querySelectorAll("iframe").forEach((t=>{t.style.pointerEvents="auto"})),document.removeEventListener("mousemove",this.drag),document.removeEventListener("touchmove",this.drag),document.removeEventListener("mouseup",this.stopDrag),document.removeEventListener("touchend",this.stopDrag),this.x=this.container.offsetLeft,this.y=this.container.offsetTop,this.z=Number(this.container.style.zIndex),this.windowManager?this.windowManager.saveWindowsState():console.warn("windowManager is not defined")}getEventCoordinates(t){let e,i;if(t.type.startsWith("touch")){const s=t.touches[0]||t.changedTouches[0];e=s.clientX,i=s.clientY}else e=t.clientX,i=t.clientY;return{clientX:e,clientY:i}}minimize(t=!1){this.isMinimized&&!t?this.restore():(this.container.style.display="none",this.isMinimized=!0)}restore(){this.container.style.display="flex",this.isMinimized=!1,this.bp.isMobile()}maximize(){if(this.isMaximized)this.bp.isMobile()?(this.container.style.width="100vw",this.container.style.height="calc(var(--vh) * 90)",this.container.style.top="0",this.container.style.left="0"):(this.container.style.width=`${this.width}px`,this.container.style.height=`${this.height}px`,this.container.style.top="50px",this.container.style.left="50px",this.isMaximized=!1);else{let t=21,e=($(".desktop-menu-bar").height()||t)-t;e+=t+2;let i=e+"px";this.bp.isMobile()?(this.container.style.width="100vw",this.container.style.height="calc(var(--vh) * 90)",this.container.style.top="0",this.container.style.left="0"):(this.container.style.width="100vw",this.container.style.height="calc(100vh - 104px)",this.container.style.top=i,this.container.style.left="0"),this.isMaximized=!0}}focus(t=!0){t&&this.windowManager.focusWindow(this),this.onFocus(this);let e=this.bp.apps.desktop.appList[this.id],i=this.id;if(e&&e.alias){i=e.alias[0]}DelayedPushState.push({appId:i},this.title,`/app/${i}`)}open(){this.focus();try{this.onOpen(this)}catch(t){console.error(t)}this.bp.isMobile()&&(this.maximize(),setTimeout((()=>{}),100)),this.bp.emit("window::open",this);let t={id:this.id,app:this.app,label:this.title,icon:this.icon,type:this.type,context:this.context};this.bp.apps.ui.windowManager.taskBar.openItem(t),this.bp.apps.ui.recentApps=this.bp.apps.ui.recentApps||this.bp.settings.recentApps||[],this.bp.apps.ui.recentApps=this.bp.apps.ui.recentApps.filter((t=>t.id!==this.id)),this.bp.apps.ui.recentApps.unshift({id:this.id,app:this.app,label:this.label||this.title,icon:this.icon,type:this.type}),this.bp.apps.ui.recentApps=this.bp.apps.ui.recentApps.slice(0,10),this.bp.set("recentApps",this.bp.apps.ui.recentApps);let e=this.bp.apps.desktop.appList[this.id],i=this.id;if(e&&e.alias){i=e.alias[0]}DelayedPushState.push({appId:i},this.title,`/app/${i}`)}close(){if(this.parent?this.container.parentElement&&this.container.parentElement===this.parent&&this.parent.removeChild(this.container):this.container.parentElement.removeChild(this.container),this.content&&this.content.contentWindow&&this.content.contentWindow.removeEventListener("message",this.receiveMessage.bind(this),!1),this.content&&(this.content.parentNode&&this.content.parentNode.removeChild(this.content),this.content=null),0===this.windowManager.windows.length){let t=document.getElementById("menubar-set-window-as-background");t&&t.classList.add("disabled")}this.windowManager.removeWindow(this.id),this.windowManager.taskBar&&this.windowManager.taskBar.closeItem(this.id),this.onClose(this),this.bp.emit("window::close",this),this.bp.isMobile()&&setTimeout((()=>{}),100),DelayedPushState.push({},"","/")}addResizeHandles(){const t=document.createElement("div");t.classList.add("resize-handle"),this.container.appendChild(t),t.addEventListener("mousedown",(t=>this.startResize(t)),{passive:!1}),t.addEventListener("touchstart",(t=>{t.preventDefault(),this.startResize(t.touches[0])}),{passive:!1})}setSize(t,e){this.width=t,this.height=e,this.container.style.width=`${this.width}`,this.container.style.height=`${this.height}`,this.windowManager.saveWindowsState()}startResize(t){const e=this.container,i=t.clientX,s=t.clientY,n=e.offsetWidth,a=e.offsetHeight,o=t=>{const o=t.clientX||t.touches[0].clientX,h=t.clientY||t.touches[0].clientY,r=n+(o-i),d=a+(h-s);e.style.width=`${Math.max(100,r)}px`,e.style.height=`${Math.max(100,d)}px`},h=()=>{document.removeEventListener("mousemove",o),document.removeEventListener("mouseup",h),document.removeEventListener("touchmove",o),document.removeEventListener("touchend",h)};document.addEventListener("mousemove",o),document.addEventListener("mouseup",h),document.addEventListener("touchmove",o,{passive:!1}),document.addEventListener("touchend",h)}resize(t){if(!this.isResizing)return;const e=this.startWidth+(t.clientX-this.startX),i=this.startHeight+(t.clientY-this.startY);this.container.style.width=`${e}px`,this.container.style.height=`${i}px`}stopResize(){this.isResizing=!1}setTitle(t){this.title=t,this.titleBarSpan.textContent=t,this.windowManager.saveWindowsState()}setContent(t){this.contentValue=t,this.content.innerHTML=t,this.windowManager.saveWindowsState()}}class n{constructor(t,i={}){this.storage=i.storage||localStorage,this.storageKey=i.storageKey||"windowsState",this.windows=[],this._windows=[],this.options=i,this.bp=t.bp,this.useKeyboardControls=!0,"boolean"==typeof i.useKeyboardControls&&(this.useKeyboardControls=i.useKeyboardControls),"boolean"==typeof i.hideTaskBar&&(this.hideTaskBar=i.hideTaskBar),"function"==typeof i.openWindow?this._openWindow=i.openWindow:this._openWindow=function(t,e){this.createWindow(e).hydrate(e)},this.taskBar=new e({bp:this.bp,homeCallback:()=>{this.state||(this.lastPositionsBeforeArranged=this.windows.map((t=>({x:t.x,y:t.y,height:t.height,width:t.width}))),this.state="maximized"),"minimized"===this.state?(this.minimizeAllWindows(),this.state="maximized"):"stacked-vertical"===this.state||("stacked-horizontal"===this.state?(this.windows.forEach(((t,e)=>{t.move(this.lastPositionsBeforeArranged[e].x,this.lastPositionsBeforeArranged[e].y),t.setSize(this.lastPositionsBeforeArranged[e].width+"px",this.lastPositionsBeforeArranged[e].height+"px")})),this.state="maximized"):(this.minimizeAllWindows(!0),this.windows.forEach(((t,e)=>{t.move(this.lastPositionsBeforeArranged[e].x,this.lastPositionsBeforeArranged[e].y),t.setSize(this.lastPositionsBeforeArranged[e].width+"px",this.lastPositionsBeforeArranged[e].height+"px")})),this.state="minimized")),$(".window").hide(),$(".window").removeClass("window_stack")}}),this.options.hideTaskBar&&(this.taskBar.taskBarElement.style.display="none"),this.useKeyboardControls&&window.addEventListener("keydown",(t=>{if("Escape"===t.key&&!this.bp.ignoreUIControlKeys){const t=document.querySelector(".dialog");if(t)return void t.remove();const e=this.windows[0];e&&e.close()}}))}createWindow(t){t={...t,...this.options.window};let e=this._windows.find((e=>e.id===t.id));e&&(t={...e,...t});const i=this.getWindow(t.id);let n;return i?(n=i,this.focusWindow(n),n):(t.bp=this.bp,n=new s(t,this),n.container.addEventListener("mousedown",(()=>{this.focusWindow(n)})),this.addWindow(n),this.focusWindow(n),n)}isMobile(){return window.innerWidth<1e3}addWindow(t){this.windows.push(t),this.saveWindowsState(),this.updateFocus()}removeWindow(t){this.windows=this.windows.filter((e=>e.id!==t)),this.saveWindowsState(),this.updateFocus()}focusWindow(t){"string"==typeof t&&(t=this.getWindow(t));const e=this.windows.indexOf(t);-1!==e&&(this.windows.splice(e,1),this.windows.unshift(t),this.updateFocus(),t.focus(!1),this.saveWindowsState()),this.windows.forEach((e=>{e.id!==t?e.isFocused=!1:t.isFocused=!0}))}updateFocus(){this.windows.forEach(((t,e)=>{t.setDepth(1e3-e)}))}closeAllWindows(){this.windows.forEach((t=>t.close())),this.windows=[],this.storage.removeItem(this.storageKey)}minimizeAllWindows(t=!1){this.windowsHiding?this.windowsHiding=!1:this.windowsHiding=!0,this.windows.forEach((e=>{!this.windowsHiding||t?e.minimize(t):e.restore()}))}getWindow(t){return this.windows.find((e=>e.id===t))}findWindows({app:t,type:e}){if(!t)return console.warn("No app provided to findWindows"),[];const i=Array.isArray(t)?t:[t],s=e?Array.isArray(e)?e:[e]:null;return this.windows.filter((t=>{const e=i.includes(t.app),n=!s||s.includes(t.type);return e&&n}))}saveWindowsState(){const t=JSON.stringify(this.windows.map((t=>t.serialize())));this.storage.setItem(this.storageKey,t)}loadWindows(){const t=this.storage.getItem(this.storageKey);t&&this.restoreWindows(t)}arrangeVerticalStacked(){let t=document.body.clientHeight-100,e=document.body.clientWidth-10;const i=.8*t;let s=0;this.windows.reverse().forEach(((t,n)=>{let a=t.isMinimized?120:i;t.setSize(e+"px",a+"px"),t.move(0,s),s+=a+10})),this.bp.apps.desktop&&this.bp.apps.desktop.shortCutsContainer&&(this.bp.apps.desktop.shortCutsContainer.style.position="absolute",this.bp.apps.desktop.shortCutsContainer.style.left="0px",this.bp.apps.desktop.shortCutsContainer.style.top=s+"px")}arrangeHorizontalStacked(){let t=document.body.clientWidth/this.windows.length;t-=10,this.windows.forEach(((e,i)=>{let s=t*i;s+=5,s+=10*i,e.setSize(t+"px","calc(100% - 80px)"),e.move(s,30)}))}arrangeCascadeFromTopLeft(){this.windows.forEach(((t,e)=>{const i=20*e,s=20*e;t.move(i,s)}))}restoreWindows(t,e=!1){const i=JSON.parse(t);this._windows=i,e&&i.forEach((t=>{const e=this.getWindow(t.id);if(e)return console.log("WARNING: Window with id",t.id,"already exists, hydrating instead of creating new window"),void e.hydrate(t);t.parent=document.querySelector(t.parent)}))}}class a{constructor(){this.intervalId=null,this.expiryCallbacks=new WeakMap}updateCountdowns(){const t=$(".countdown-date").filter((function(){return!0!==$(this).data("expired")}));0!==t.length?t.each(((t,e)=>{const i=$(e),s=new Date(i.data("expiry")).getTime(),n=s-Date.now();if(!i.data("duration")){const t=i.data("ctime");t&&i.data("duration",s-t)}if(n<0){i.data("expired",!0);const t=this.expiryCallbacks.get(e);return void("function"==typeof t&&(t(i),this.expiryCallbacks.delete(e)))}const a=Math.floor(n/864e5),o=Math.floor(n%864e5/36e5),h=Math.floor(n%36e5/6e4),r=Math.floor(n%6e4/1e3);let d="",l=[];a>0?(d=`${a} Day${a>1?"s":""} `,l.push(o.toString().padStart(2,"0"))):o>0&&l.push(o.toString()),l.push(h.toString().padStart(2,"0")),l.push(r.toString().padStart(2,"0")),i.text(d+l.join(":"))})):this.intervalId&&(clearInterval(this.intervalId),this.intervalId=null,bp?.apps?.ui&&(bp.apps.ui.countdownTimer=null))}startCountdown(t,e,i){const s=new Date(e).getTime(),n=Date.now(),a=s-n;t.data("expiry",s).data("ctime",n).data("duration",a).data("expired",!1),"function"==typeof i&&this.expiryCallbacks.set(t[0],i),this.intervalId||(this.intervalId=setInterval((()=>this.updateCountdowns()),1e3),bp?.apps?.ui&&(bp.apps.ui.countdownTimer=this.intervalId)),this.updateCountdowns()}}class o{constructor(t,e={}){this.bp=t;let i={};i.openWindow=this.bp.open.bind(this.bp),i.window=e.window||{},i.hideTaskBar=e.hideTaskBar,this.windowManager=new n(this,i),this.bp.windows=this.windowManager.windows,this.windowManager.loadWindows(),e.parent=e.parent||document.body,this.options=e,"boolean"!=typeof e.fontAwesome&&(e.fontAwesome=!0),this.parent=e.parent,this.countdownManager=new a(this.bp);function s(){const t=.01*window.innerHeight;document.documentElement.style.setProperty("--vh",`${t}px`)}return this.bp.window=this.windowManager.createWindow.bind(this.windowManager),window.addEventListener("resize",s),s(),this}async init(){if(this.options.noCSS||(this.bp.appendCSS("/v5/apps/based/ui/ui.css"),"prod"!==this.bp.mode&&(this.bp.appendCSS("/v5/apps/based/ui/mobile.css"),this.bp.appendCSS("/v5/apps/based/ui/Window/Window.css"),this.bp.appendCSS("/v5/apps/based/ui/Window/TaskBar.css"),this.bp.appendCSS("/v5/apps/based/ui/Window/StartPanel.css"))),this.options.fontAwesome&&(this.bp.appendCSS("/v5/vendor/font-awesome/css/fontawesome.css",!1,!0),this.bp.appendCSS("/v5/vendor/font-awesome/css/all.min.css",!1,!0)),this.options.noZepto,!this.options.noTabs){let t=await this.bp.importModule(this.bp.config.host+"/v5/apps/based/ui/SimpleTabs.js",{},!1);this.Tabs=t.default}await this.bp.appendScript("/v5/vendor/DateFormat.js");let t=document;return $(t).on("click",".open-app",(function(t){let e=$(this).data("app"),i=$(t.target).data("context"),s=$(this).data("type");console.log("open-app "+e),bp.open(e,{context:i,type:s})})),"loaded ui"}async appendToElement(t){console.log("appendToElement",this);let e=await fetchHTMLFragment("ui.html");return console.log(e),t.innerHTML=e,"hello ui"}async loadDocumentBody(){console.log("loadDocumentBody",this);let t=await this.bp.fetchHTMLFragment("/v5/apps/based/ui/ui.html");return console.log(t),$("body").append(t),"hello ui"}toggleFullScreen(){document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen()}}export{o as default};
//# sourceMappingURL=ui.js.map
