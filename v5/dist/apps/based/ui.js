class t{constructor({homeCallback:t}={}){this.taskBarElement=document.createElement("div"),this.taskBarElement.className="taskbar-container",document.body.appendChild(this.taskBarElement),this.items=new Map,t&&this.addItem({id:"home",title:"Home",onClick:t,icon:"desktop/assets/images/icons/icon_mantra_64.png"})}addItem(t){const{id:e,title:i="",onClick:s,content:n,icon:o}=t,a=document.createElement("div");a.className="taskbar-item";const h=document.createElement("div");if(h.className="taskbar-item-text",h.textContent=i,a.appendChild(h),n)a.innerHTML=n;else if(o){const t=document.createElement("img");t.src=o,t.height=32,t.width=32,t.alt=i,a.appendChild(t)}else a.textContent=i;return a.onclick=t=>{s&&s(t,a),this.alertItem(e)},this.taskBarElement.appendChild(a),this.items.set(e,a),a}removeItem(t){const e=this.items.get(t);e&&(this.taskBarElement.removeChild(e),this.items.delete(t))}getItem(t){return this.items.get(t)}alertItem(t){const e=this.items.get(t);e&&(e.classList.add("taskbar-item-alert"),setTimeout((()=>e.classList.remove("taskbar-item-alert")),3e3))}}let e=0;class i{constructor(t={},i){const{title:s="Window",width:n="400px",height:o="300px",app:a="ui",type:h="singleton",context:d="default",content:r="",iframeContent:c=!1,icon:l="",x:p=50,y:w=50,z:m=99,parent:u=window.document.body,id:g=`window-${e}`,onFocus:y=()=>{},onClose:f=()=>{},onOpen:b=()=>{},onMessage:v=()=>{},onLoad:x=()=>{},className:z="",resizeable:B=!0,preventOverlap:C=!0,canBeBackground:k=!1}=t;this.windowManager=i;let M=document.getElementById(g);return M?(console.log("Window with id already exists",g),M):(this.title=s,this.icon=l,this.width=n,this.height=o,this.app=a,this.type=h,this.x=p,this.y=w,this.z=99,this.context=d,this.parent=u,this.id=g,this.isMaximized=!1,this.isMinimized=!1,this.container=null,this.content=null,this.iframeContent=c,this.contentValue=r,this.isActive=!1,this.className=z,this.resizeable=B,this.preventOverlap=C,this.canBeBackground=k,i=i||{windows:[],saveWindowsState:()=>{},removeWindow:()=>{}},this.bp=t.bp,this.onFocus=y,this.onClose=f,this.onOpen=b,this.onLoad=x,this.onMessage=v,this.startDrag=this.startDrag.bind(this),this.drag=this.drag.bind(this),this.stopDrag=this.stopDrag.bind(this),this.createWindow(),this.open(),this)}createWindow(){this.container=document.createElement("div"),this.container.classList.add("window-container"),this.container.dataset.app=this.app,this.container.dataset.type=this.type,this.container.dataset.context=this.context,this.className&&this.container.classList.add(this.className),this.resizeable||this.container.classList.add("window-not-resizeable"),this.container.id=this.id,this.container.style.width=`${this.width}px`,this.container.style.height=`${this.height}px`,this.container.style.position="absolute";const t=window.innerWidth,e=window.innerHeight;let i={x:this.x,y:this.y};if(this.preventOverlap&&(i=function(t,e,i,s,n=10){let o=t.x,a=t.y;return e.forEach((e=>{(function(t,e,i,s,n,o,a,h,d=10){return i=parseInt(i),s=parseInt(s),a=parseInt(a),h=parseInt(h),t<n+a+d&&t+i+d>n&&e<o+h+d&&e+s+d>o})(o,a,t.width,t.height,e.x,e.y,e.width,e.height,n)&&(o+=n,a+=n)})),o+t.width+n>i&&(o=i-t.width-n),a+t.height+n>s&&(a=s-t.height-n),o<n&&(o=n),a<n&&(a=n),{x:o,y:a}}({x:this.x,y:this.y,width:this.width,height:this.height},this.windowManager.windows,t,e,32)),this.x=i.x,this.y=i.y,this.container.style.top=`${this.y}px`,this.container.style.left=`${this.x}px`,this.container.style.zIndex=99,this.container.addEventListener("mousedown",(()=>{document.querySelectorAll(".window-container").forEach((t=>{t.classList.remove("window-active"),t.isActive=!1})),this.container.classList.add("window-active"),this.isActive=!0})),this.container.addEventListener("touchstart",(()=>{document.querySelectorAll(".window-container").forEach((t=>{t.classList.remove("window-active"),t.isActive=!1})),this.container.classList.add("window-active"),this.isActive=!0})),this.titleBar=document.createElement("div"),this.titleBar.classList.add("window-title-bar"),this.bp.isMobile()&&(this.titleBar.onclick=()=>{console.log("titleBar clicked on mobile"),this.minimize()}),this.titleBar.ondblclick=()=>this.maximize(),this.icon){let t=document.createElement("img");t.src=this.icon,t.classList.add("window-icon"),this.titleBar.appendChild(t)}let s=document.createElement("span");s.classList.add("window-title-text"),s.textContent=this.title,this.titleBarSpan=s,this.titleBar.addEventListener("mousedown",this.startDrag),this.titleBar.addEventListener("touchstart",this.startDrag,{passive:!1});const n=document.createElement("div");if(n.classList.add("window-controls"),this.bp.isMobile()||(this.minimizeButton=document.createElement("button"),this.minimizeButton.innerHTML="&#x1F7E1;",this.minimizeButton.classList.add("minimize-button"),this.minimizeButton.title="Minimize",this.minimizeButton.onclick=()=>this.minimize(),n.appendChild(this.minimizeButton)),this.maximizeButton=document.createElement("button"),this.maximizeButton.innerHTML="&#x1F7E2;",this.maximizeButton.classList.add("maximize-button"),this.maximizeButton.title="Maximize",this.maximizeButton.onclick=()=>this.maximize(),n.appendChild(this.maximizeButton),this.closeButton=document.createElement("button"),this.closeButton.innerHTML="&#x1F534;",this.closeButton.classList.add("close-button"),this.closeButton.title="Close",this.closeButton.onclick=()=>this.close(),n.appendChild(this.closeButton),this.titleBar.appendChild(s),this.titleBar.appendChild(n),this.initContentArea(),this.container.appendChild(this.titleBar),this.container.appendChild(this.content),this.parent&&this.parent.appendChild(this.container),this.resizeable&&this.addResizeHandles(),this.canBeBackground){let t=document.getElementById("menubar-set-window-as-background");t&&t.classList.remove("disabled")}return this.container}initContentArea(){"boolean"==typeof this.iframeContent&&this.iframeContent?(this.content=document.createElement("iframe"),this.content.classList.add("bp-window-content"),document.body.appendChild(this.content),this.content.src="about:blank",this.content.onload=()=>{let t=this.content.contentDocument||this.content.contentWindow.document;t.open(),t.write(this.contentValue),t.close(),this.setupMessageHandling()}):"string"==typeof this.iframeContent&&this.iframeContent.length?(this.content=document.createElement("iframe"),this.content.classList.add("bp-window-content"),this.content.src=this.iframeContent,this.content.onload=()=>this.setupMessageHandling()):(this.content=document.createElement("div"),this.content.classList.add("bp-window-content"),"string"==typeof this.contentValue?this.content.innerHTML=this.contentValue:this.content.appendChild(this.contentValue))}setupMessageHandling(){this.onLoad(this),this.content.contentWindow;const t=this.content.contentDocument||this.content.contentWindow.document,e=t.createElement("script");e.type="text/javascript",e.textContent="\n            document.addEventListener('keydown', (event) => {\n                if (event.key === 'Escape') {\n                    window.parent.postMessage({ event: 'ESC_KEY_PRESSED' }, '*');\n                }\n            });\n        ",t.body.appendChild(e),window.addEventListener("message",this.receiveMessage.bind(this),!1)}sendMessage(t){this.content&&this.content.contentWindow&&this.content.contentWindow.postMessage(t,"*")}receiveMessage(t){"object"==typeof t.data&&t.data.event&&("ESC_KEY_PRESSED"===t.data.event?(console.log("ESC key pressed inside iframe. Closing window..."),this.close()):this.handleReceivedMessage(t.data))}handleReceivedMessage(t){this.onMessage&&this.onMessage(t)}move(t,e){this.x=t,this.y=e,this.container.style.top=`${this.y}px`,this.container.style.left=`${this.x}px`,this.windowManager.saveWindowsState()}serialize(){let t=(t=>{let e=[];for(;t.parentNode;){if(t.id){e.unshift("#"+t.id);break}{let i,s=t,n=1;for(;i=s.previousSibling;)1===i.nodeType&&i.tagName===s.tagName&&n++,s=i;const o=t.tagName.toLowerCase(),a=n>1?`:nth-of-type(${n})`:"";e.unshift(`${o}${a}`),t=t.parentNode}}return e.length?e.join(" > "):null})(this.parent);return{title:this.title,width:this.width,height:this.height,type:this.type,app:this.app,x:this.x,y:this.y,z:this.z,context:this.context,parent:t,id:this.id,onClose:this.onClose,onOpen:this.onOpen,className:this.className,resizeable:this.resizeable,canBeBackground:this.canBeBackground}}hydrate(t){console.log("hydrate",t),this.title=t.title,this.width=t.width,this.height=t.height,this.app=t.app,this.type=t.type,this.x=t.x,this.y=t.y,this.z=Number(t.z),this.context=t.context,this.id=t.id,this.onClose=t.onClose,this.onOpen=t.onOpen,this.onMessage=t.onMessage,this.className=t.className,this.resizeable=t.resizeable,this.canBeBackground=t.canBeBackground,this.updateWindow()}updateWindow(){this.container.style.width=`${this.width}px`,this.container.style.height=`${this.height}px`,this.container.style.top=`${this.y}px`,this.container.style.left=`${this.x}px`,this.container.style.zIndex=this.z}setDepth(t){this.z=t,this.container.style.zIndex=t,this.windowManager.saveWindowsState()}setAsBackground(){console.log("setAsBackground",this.windowManager.windows),this.canBeBackground?(this.windowManager.windows.forEach((t=>{t.isBackground&&t.restoreWindowFromBackground()})),this.container.style.zIndex=-1,this.container.style.width="100%",this.container.style.height="100%",this.container.style.top="0",this.container.style.left="0",this.isBackground=!0,this.isActive=!1):console.log("This window cannot be set as background. Try setting canBeBackground:true in the Window declaration")}restoreWindowFromBackground(){this.isBackground=!1,this.container.style.zIndex=11e3,this.container.style.width=`${this.width}`,this.container.style.height=`${this.height}`,this.container.style.top=`${this.y}px`,this.container.style.left=`${this.x}px`;let t=document.getElementById("menubar-restore-background-window");t&&t.classList.add("disabled")}startDrag(t){this.isDragging=!0,this.container.style.cursor="grabbing";const{clientX:e,clientY:i}=this.getEventCoordinates(t);this.offsetX=e-this.container.offsetLeft,this.offsetY=i-this.container.offsetTop,document.addEventListener("mousemove",this.drag),document.addEventListener("touchmove",this.drag,{passive:!1}),document.addEventListener("mouseup",this.stopDrag),document.addEventListener("touchend",this.stopDrag)}drag(t){if(!this.isDragging)return;t.preventDefault();const{clientX:e,clientY:i}=this.getEventCoordinates(t);let s=window.innerHeight-52;i>42&&i<s&&(this.container.style.top=i-this.offsetY+"px");let n=window.innerWidth-52;e>52&&e<n&&(this.container.style.left=e-this.offsetX+"px")}stopDrag(){this.isDragging=!1,this.container.style.cursor="default",document.removeEventListener("mousemove",this.drag),document.removeEventListener("touchmove",this.drag),document.removeEventListener("mouseup",this.stopDrag),document.removeEventListener("touchend",this.stopDrag),this.x=this.container.offsetLeft,this.y=this.container.offsetTop,this.z=Number(this.container.style.zIndex),this.windowManager?this.windowManager.saveWindowsState():console.warn("windowManager is not defined")}getEventCoordinates(t){let e,i;if(t.type.startsWith("touch")){const s=t.touches[0]||t.changedTouches[0];e=s.clientX,i=s.clientY}else e=t.clientX,i=t.clientY;return{clientX:e,clientY:i}}minimize(t=!1){this.bp.isMobile()?(this.isMinimized&&!t?this.restore():(this.container.style.height="120px",console.log("setting content area"),this.isMinimized=!0),this.windowManager.arrangeVerticalStacked()):this.isMinimized&&!t?this.restore():(console.log("hiding content area"),this.container.style.display="none",this.isMinimized=!0)}restore(){this.container.style.display="flex",this.isMinimized=!1,this.bp.isMobile()&&this.windowManager.arrangeVerticalStacked()}maximize(){this.isMaximized?this.bp.isMobile()?this.windowManager.arrangeVerticalStacked():(this.container.style.width=`${this.width}px`,this.container.style.height=`${this.height}px`,this.container.style.top="50px",this.container.style.left="50px",this.isMaximized=!1):(this.bp.isMobile()?(this.container.style.width="100vw",this.container.style.height="100vh",this.container.style.top="0",this.container.style.left="0"):(this.container.style.width="100vw",this.container.style.height="calc(100vh - 75px)",this.container.style.top="23px",this.container.style.left="0"),this.isMaximized=!0)}focus(t=!0){t&&this.windowManager.focusWindow(this),this.onFocus(this)}open(){this.focus();try{this.onOpen(this)}catch(t){console.error(t)}this.bp.isMobile()&&setTimeout((()=>{this.windowManager.arrangeVerticalStacked()}),100),this.bp.emit("window::open",this)}close(){if(this.parent?this.container.parentElement&&this.container.parentElement===this.parent&&this.parent.removeChild(this.container):this.container.parentElement.removeChild(this.container),this.content&&this.content.contentWindow&&this.content.contentWindow.removeEventListener("message",this.receiveMessage.bind(this),!1),this.content&&(this.content.parentNode&&this.content.parentNode.removeChild(this.content),this.content=null),0===this.windowManager.windows.length){let t=document.getElementById("menubar-set-window-as-background");t&&t.classList.add("disabled")}this.windowManager.removeWindow(this.id),this.windowManager.taskBar&&this.windowManager.taskBar.removeItem(this.id),this.onClose(),this.bp.emit("window::close",this),this.bp.isMobile()&&setTimeout((()=>{this.windowManager.arrangeVerticalStacked()}),100)}addResizeHandles(){const t=document.createElement("div");t.classList.add("resize-handle"),this.container.appendChild(t),t.onmousedown=t=>this.startResize(t),document.onmouseup=()=>this.stopResize(),document.onmousemove=t=>this.resize(t),t.ontouchstart=t=>{t.preventDefault(),this.startResize(t.touches[0])},document.ontouchend=()=>this.stopResize(),document.ontouchmove=t=>{t.preventDefault(),this.resize(t.touches[0])}}setSize(t,e){this.width=t,this.height=e,this.container.style.width=`${this.width}`,this.container.style.height=`${this.height}`,this.windowManager.saveWindowsState()}startResize(t){this.isResizing=!0,this.startWidth=this.container.offsetWidth,this.startHeight=this.container.offsetHeight,this.startX=t.clientX,this.startY=t.clientY}resize(t){if(!this.isResizing)return;const e=this.startWidth+(t.clientX-this.startX),i=this.startHeight+(t.clientY-this.startY);this.container.style.width=`${e}px`,this.container.style.height=`${i}px`}stopResize(){this.isResizing=!1}setTitle(t){this.title=t,this.titleBarSpan.textContent=t,this.windowManager.saveWindowsState()}setContent(t){this.contentValue=t,this.content.innerHTML=t,this.windowManager.saveWindowsState()}}class s{constructor(e,i={}){this.storage=i.storage||localStorage,this.storageKey=i.storageKey||"windowsState",this.windows=[],this._windows=[],this.options=i,this.bp=e.bp,this.useKeyboardControls=!0,"boolean"==typeof i.useKeyboardControls&&(this.useKeyboardControls=i.useKeyboardControls),"boolean"==typeof i.hideTaskBar&&(this.hideTaskBar=i.hideTaskBar),"function"==typeof i.openWindow?this._openWindow=i.openWindow:this._openWindow=function(t,e){this.createWindow(e).hydrate(e)},this.taskBar=new t({homeCallback:()=>{this.state||(this.lastPositionsBeforeArranged=this.windows.map((t=>({x:t.x,y:t.y,height:t.height,width:t.width}))),this.state="maximized"),"minimized"===this.state?(this.minimizeAllWindows(),this.arrangeHorizontalStacked(),this.state="stacked-horizontal"):"stacked-vertical"===this.state||("stacked-horizontal"===this.state?(this.windows.forEach(((t,e)=>{t.move(this.lastPositionsBeforeArranged[e].x,this.lastPositionsBeforeArranged[e].y),t.setSize(this.lastPositionsBeforeArranged[e].width+"px",this.lastPositionsBeforeArranged[e].height+"px")})),this.state="maximized"):(this.minimizeAllWindows(!0),this.windows.forEach(((t,e)=>{t.move(this.lastPositionsBeforeArranged[e].x,this.lastPositionsBeforeArranged[e].y),t.setSize(this.lastPositionsBeforeArranged[e].width+"px",this.lastPositionsBeforeArranged[e].height+"px")})),this.state="minimized")),$(".window").hide(),$(".window").removeClass("window_stack")}}),this.options.hideTaskBar&&(this.taskBar.taskBarElement.style.display="none"),this.useKeyboardControls&&window.addEventListener("keydown",(t=>{if("Escape"===t.key&&!this.bp.ignoreUIControlKeys){const t=document.querySelector(".dialog");if(t)return void t.remove();const e=this.windows[0];e&&e.close()}}))}createWindow(t){t={...t,...this.options.window};let e=this._windows.find((e=>e.id===t.id));e&&(t={...e,...t});const s=this.findWindow(t.id);let n;return s?(n=s,this.focusWindow(n),n):(t.bp=this.bp,n=new i(t,this),n.container.addEventListener("mousedown",(()=>{this.focusWindow(n)})),this.addWindow(n),this.focusWindow(n),this.taskBar.addItem({id:n.id,title:n.title,icon:n.icon,onClick:()=>{this.isMobile()&&this.arrangeVerticalStacked(),n.minimize()}}),n)}isMobile(){return window.innerWidth<1e3}addWindow(t){this.windows.push(t),this.saveWindowsState(),this.updateFocus()}removeWindow(t){this.windows=this.windows.filter((e=>e.id!==t)),this.saveWindowsState(),this.updateFocus()}focusWindow(t){"string"==typeof t&&(t=this.findWindow(t));const e=this.windows.indexOf(t);-1!==e&&(this.windows.splice(e,1),this.windows.unshift(t),this.updateFocus(),t.focus(!1),this.saveWindowsState()),this.windows.forEach((e=>{e.id!==t?e.isFocused=!1:t.isFocused=!0}))}updateFocus(){this.windows.forEach(((t,e)=>{t.setDepth(1e3-e)}))}closeAllWindows(){this.windows.forEach((t=>t.close())),this.windows=[],this.storage.removeItem(this.storageKey)}minimizeAllWindows(t=!1){this.windowsHiding?this.windowsHiding=!1:this.windowsHiding=!0,this.windows.forEach((e=>{!this.windowsHiding||t?e.minimize(t):e.restore()}))}findWindow(t){return this.windows.find((e=>e.id===t))}saveWindowsState(){const t=JSON.stringify(this.windows.map((t=>t.serialize())));this.storage.setItem(this.storageKey,t)}loadWindows(){const t=this.storage.getItem(this.storageKey);t&&this.restoreWindows(t)}arrangeVerticalStacked(){let t=document.body.clientHeight-100,e=document.body.clientWidth-10;const i=.8*t;let s=0;this.windows.reverse().forEach(((t,n)=>{let o=t.isMinimized?120:i;t.setSize(e+"px",o+"px"),t.move(0,s),s+=o+10})),this.bp.apps.desktop&&this.bp.apps.desktop.shortCutsContainer&&(this.bp.apps.desktop.shortCutsContainer.style.position="absolute",this.bp.apps.desktop.shortCutsContainer.style.left="0px",this.bp.apps.desktop.shortCutsContainer.style.top=s+"px")}arrangeHorizontalStacked(){let t=document.body.clientWidth/this.windows.length;t-=10,this.windows.forEach(((e,i)=>{let s=t*i;s+=5,s+=10*i,e.setSize(t+"px","calc(100% - 80px)"),e.move(s,30)}))}arrangeCascadeFromTopLeft(){this.windows.forEach(((t,e)=>{const i=20*e,s=20*e;t.move(i,s)}))}restoreWindows(t,e=!1){const i=JSON.parse(t);this._windows=i,e&&i.forEach((t=>{const e=this.findWindow(t.id);if(e)return console.log("WARNING: Window with id",t.id,"already exists, hydrating instead of creating new window"),void e.hydrate(t);t.parent=document.querySelector(t.parent)}))}}class n{constructor(){this.intervalId=null,this.expiryCallbacks=new WeakMap}updateCountdowns(){const t=$(".countdown-date").filter((function(){return!0!==$(this).data("expired")}));0!==t.length?t.each(((t,e)=>{const i=$(e),s=new Date(i.data("expiry")).getTime(),n=s-Date.now();if(!i.data("duration")){const t=i.data("ctime");t&&i.data("duration",s-t)}if(n<0){i.data("expired",!0);const t=this.expiryCallbacks.get(e);return void("function"==typeof t&&(t(i),this.expiryCallbacks.delete(e)))}const o=Math.floor(n/864e5),a=Math.floor(n%864e5/36e5),h=Math.floor(n%36e5/6e4),d=Math.floor(n%6e4/1e3);let r="",c=[];o>0?(r=`${o} Day${o>1?"s":""} `,c.push(a.toString().padStart(2,"0"))):a>0&&c.push(a.toString()),c.push(h.toString().padStart(2,"0")),c.push(d.toString().padStart(2,"0")),i.text(r+c.join(":"))})):this.intervalId&&(clearInterval(this.intervalId),this.intervalId=null,bp?.apps?.ui&&(bp.apps.ui.countdownTimer=null))}startCountdown(t,e,i){const s=new Date(e).getTime(),n=Date.now(),o=s-n;t.data("expiry",s).data("ctime",n).data("duration",o).data("expired",!1),"function"==typeof i&&this.expiryCallbacks.set(t[0],i),this.intervalId||(this.intervalId=setInterval((()=>this.updateCountdowns()),1e3),bp?.apps?.ui&&(bp.apps.ui.countdownTimer=this.intervalId)),this.updateCountdowns()}}class o{constructor(t,e={}){this.bp=t;let i={};return i.openWindow=this.bp.open.bind(this.bp),i.window=e.window||{},i.hideTaskBar=e.hideTaskBar,this.windowManager=new s(this,i),this.bp.windows=this.windowManager.windows,this.windowManager.loadWindows(),e.parent=e.parent||document.body,this.options=e,"boolean"!=typeof e.fontAwesome&&(e.fontAwesome=!0),this.parent=e.parent,this.countdownManager=new n(this.bp),this}async init(){if(this.options.noCSS||(this.bp.appendCSS("/v5/apps/based/ui/ui.css"),"prod"!==this.bp.mode&&(this.bp.appendCSS("/v5/apps/based/ui/mobile.css"),this.bp.appendCSS("/v5/apps/based/ui/Window/Window.css"),this.bp.appendCSS("/v5/apps/based/ui/Window/TaskBar.css"))),this.options.fontAwesome&&(this.bp.appendCSS("/v5/vendor/font-awesome/css/fontawesome.css",!1,!0),this.bp.appendCSS("/v5/vendor/font-awesome/css/all.min.css",!1,!0)),this.options.noZepto,!this.options.noTabs){let t=await this.bp.importModule(this.bp.config.host+"/v5/apps/based/ui/SimpleTabs.js",{},!1);this.Tabs=t.default}await this.bp.appendScript("/v5/vendor/DateFormat.js");let t=document;return $(t).on("click",".open-app",(function(t){let e=$(this).data("app"),i=$(t.target).data("context"),s=$(this).data("type");console.log("open-app "+e),bp.open(e,{context:i,type:s})})),"loaded ui"}async appendToElement(t){console.log("appendToElement",this);let e=await fetchHTMLFragment("ui.html");return console.log(e),t.innerHTML=e,"hello ui"}async loadDocumentBody(){console.log("loadDocumentBody",this);let t=await this.bp.fetchHTMLFragment("/v5/apps/based/ui/ui.html");return console.log(t),$("body").append(t),"hello ui"}toggleFullScreen(){document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen()}}export{o as default};
//# sourceMappingURL=ui.js.map
