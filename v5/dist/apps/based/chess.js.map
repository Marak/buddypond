{"version":3,"file":"chess.js","sources":["../../../apps/based/chess/chess.js"],"sourcesContent":["export default class ChessApp {\n  constructor(bp, options = {}) {\n    this.bp = bp;\n    this.options = options;\n    this.board = null;\n    this.game = null;\n    this.ws = null;\n    this.playerColor = null;\n    this.stockfish = null;\n    this.mode = 'multiplayer'; // or 'stockfish'\n  }\n\n  async init() {\n    this.html = await this.bp.load('/v5/apps/based/chess/chess.html');\n    await this.bp.appendScript('https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.js');\n    await this.bp.appendScript('https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.js');\n    await this.bp.appendScript('/v5/apps/based/chess/vendor/stockfish.min.js');\n    await this.bp.appendCSS('https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css');\n    return 'loaded ChessApp';\n  }\n\n  async open() {\n    this.win = await this.bp.window(this.window());\n    this.bindUI();\n    // for now\n    this.mode = 'stockfish';\n\n     this.startStockfishGame();\n\n    return this.win;\n  } \n\n  window () {\n    return {\n      id: 'chess',\n      title: 'BuddyPond Chess',\n      icon: 'desktop/assets/images/icons/icon_chess_64.png',\n      x: 120,\n      y: 80,\n      width: 600,\n      height: 600,\n      content: this.html,\n      resizable: true,\n      closable: true,\n      onClose: () => this.cleanup()\n    }\n  }\n\n  bindUI() {\n    $('#join-game').on('click', () => {\n      this.mode = 'multiplayer';\n      this.joinGame();\n    });\n\n    $('#play-stockfish').on('click', () => {\n      this.mode = 'stockfish';\n      this.startStockfishGame();\n    });\n\n    this.game = new Chess();\n    let board = $('#chessboard', this.win.content);\n    this.board = Chessboard(board, {\n      pieceTheme: '/v5/apps/based/chess/img/chesspieces/wikipedia/{piece}.png',\n      draggable: true,\n      position: 'start',\n      onDragStart: this.onDragStart.bind(this),\n      onDrop: this.onDrop.bind(this),\n      onSnapEnd: this.onSnapEnd.bind(this)\n    });\n\n    this.updateStatus();\n  }\n\n  startStockfishGame() {\n    this.game.reset();\n    this.board.position('start');\n    this.playerColor = 'w';\n    this.setStatus('You are White. Make your move.');\n    // getting a same origin error here, do we need to vendor the dep on our site?\n    this.stockfish = new Worker('v5/apps/based/chess/vendor/stockfish.min.js');\n    this.stockfish.onmessage = (e) => {\n      if (typeof e.data === 'string' && e.data.startsWith('bestmove')) {\n        const move = e.data.split(' ')[1];\n        const from = move.substring(0, 2);\n        const to = move.substring(2, 4);\n        const result = this.game.move({ from, to, promotion: 'q' });\n        if (result) {\n          this.board.position(this.game.fen());\n          this.updateStatus();\n        }\n      }\n    };\n  }\n\n  joinGame() {\n    const gameId = document.getElementById('game-input').value.trim();\n    if (!gameId) return alert('Please enter a game ID');\n\n    const endpoint = 'ws://192.168.200.59:5556/ws/game/' + gameId;\n    this.ws = new WebSocket(endpoint);\n\n    this.ws.onopen = () => {\n      this.ws.send(JSON.stringify({ type: 'join', gameId }));\n      this.setStatus('Connected! Waiting for opponent...');\n    };\n\n    this.ws.onmessage = (event) => {\n      const data = JSON.parse(event.data);\n      if (data.type === 'color') {\n        this.playerColor = data.color;\n        this.board.orientation(this.playerColor === 'w' ? 'white' : 'black');\n        this.setStatus(`You are ${this.playerColor === 'w' ? 'White' : 'Black'}. ${this.game.turn() === 'w' ? 'White' : 'Black'} to move.`);\n      } else if (data.type === 'move') {\n        const move = this.game.move(data.move);\n        if (move) {\n          this.board.position(this.game.fen());\n          this.updateStatus();\n        }\n      } else if (data.type === 'gameStart') {\n        this.setStatus('Game started! ' + (this.playerColor === this.game.turn() ? 'Your move' : 'Opponent\\'s move'));\n      } else if (data.type === 'error') {\n        this.setStatus('Error: ' + data.message);\n      }\n    };\n\n    this.ws.onclose = () => this.setStatus('Disconnected from game');\n    this.ws.onerror = () => this.setStatus('WebSocket error occurred');\n  }\n\n  onDragStart(source, piece) {\n    if (this.game.game_over()) return false;\n    if (this.mode === 'multiplayer') {\n      if (this.playerColor && piece[0] !== this.playerColor) return false;\n      if (this.game.turn() !== this.playerColor) return false;\n    } else if (this.mode === 'stockfish') {\n      if (this.game.turn() !== 'w') return false;\n    }\n    return true;\n  }\n\n  onDrop(source, target) {\n    const move = this.game.move({ from: source, to: target, promotion: 'q' });\n    if (move === null) return 'snapback';\n\n    if (this.mode === 'multiplayer' && this.ws?.readyState === WebSocket.OPEN) {\n      this.ws.send(JSON.stringify({\n        type: 'move',\n        gameId: document.getElementById('game-input').value,\n        move: { from: source, to: target, promotion: 'q' }\n      }));\n    } else if (this.mode === 'stockfish') {\n      setTimeout(() => {\n        this.stockfish.postMessage('position fen ' + this.game.fen());\n        this.stockfish.postMessage('go depth 15');\n      }, 200);\n    }\n\n    this.updateStatus();\n  }\n\n  onSnapEnd() {\n    this.board.position(this.game.fen());\n  }\n\n  updateStatus() {\n    let status = '';\n    if (this.game.in_checkmate()) {\n      status = 'Checkmate! ' + (this.game.turn() === 'w' ? 'Black' : 'White') + ' wins!';\n    } else if (this.game.in_draw()) {\n      status = 'Game Over: Draw!';\n    } else {\n      status = (this.game.turn() === 'w' ? 'White' : 'Black') + ' to move';\n    }\n    this.setStatus(status);\n  }\n\n  setStatus(message) {\n    document.getElementById('status').textContent = message;\n  }\n\n  cleanup() {\n    if (this.ws) this.ws.close();\n    if (this.stockfish) {\n      this.stockfish.terminate();\n      this.stockfish = null;\n    }\n  }\n}\n"],"names":["ChessApp","constructor","bp","options","this","board","game","ws","playerColor","stockfish","mode","init","html","load","appendScript","appendCSS","open","win","window","bindUI","startStockfishGame","id","title","icon","x","y","width","height","content","resizable","closable","onClose","cleanup","$","on","joinGame","Chess","Chessboard","pieceTheme","draggable","position","onDragStart","bind","onDrop","onSnapEnd","updateStatus","reset","setStatus","Worker","onmessage","e","data","startsWith","move","split","from","substring","to","promotion","fen","gameId","document","getElementById","value","trim","alert","endpoint","WebSocket","onopen","send","JSON","stringify","type","event","parse","color","orientation","turn","message","onclose","onerror","source","piece","game_over","target","readyState","OPEN","setTimeout","postMessage","status","in_checkmate","in_draw","textContent","close","terminate"],"mappings":"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"}