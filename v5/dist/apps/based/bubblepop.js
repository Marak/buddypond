class t{constructor(t,s={}){return this.bp=t,this.options=s,this.bubbles=[],this.score=0,this.maxBubbles=50,this.lastPos=null,this.positionHistory=[],this.maxHistory=3,this.spawnRate=200,this.burstAnimations=[],this.lastPopTime=0,this.cooldown=50,this.lastCursorTime=0,this.cursorTimeout=500,this.spawnInterval=null,this.animationFrameId=null,this.chainCount=0,this.chainThreshold=800,this.pitchNotes=["C5","C#5","D5","D#5","E5","F5"],this.isHandDetected=!1,this}async init(){await this.bp.appendScript("https://cdn.jsdelivr.net/npm/@mediapipe/hands"),await this.bp.appendScript("https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils"),await this.bp.appendScript("https://cdnjs.cloudflare.com/ajax/libs/tone/15.2.6/Tone.js"),this.html=await this.bp.load("/v5/apps/based/bubblepop/bubblepop.html"),await this.bp.appendCSS("/v5/apps/based/bubblepop/bubblepop.css"),this.synth=new Tone.Synth({oscillator:{type:"sine"},envelope:{attack:.001,decay:.1,sustain:0,release:.1}}).toDestination();try{Tone.start()}catch(t){console.log(t)}return"loaded BubblePop"}async open(){return this.win?(console.warn("BubblePop window already open, returning existing window"),this.win.restore(),this.win.focus(),this.win):(this.win=this.bp.window(this.window()),this.startLoadingSequence(),this.startBubblePop(),this.win.maximize(),this.win)}window(){return{id:"bubblepop",title:"BubblePop",icon:"desktop/assets/images/icons/icon_bubblepop_64.png",x:300,y:100,width:700,height:520,content:this.html,parent:$("#desktop")[0],resizable:!0,maximizable:!0,closable:!0,onClose:()=>{this.spawnInterval&&(clearInterval(this.spawnInterval),this.spawnInterval=null),this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.camera&&(this.camera.stop(),this.camera=null),this.hands&&(this.hands.close(),this.hands=null),this.video&&this.video.srcObject&&(this.video.srcObject.getTracks().forEach((t=>t.stop())),this.video.srcObject=null),this.canvas&&this.mouseMoveHandler&&this.canvas.removeEventListener("mousemove",this.mouseMoveHandler),this.video=null,this.bubbles=[],this.positionHistory=[],this.lastPos=null,this.lastCursorTime=0,this.burstAnimations=[],this.score=0,this.win=null}}}smoothPosition(t){this.positionHistory.push(t),this.positionHistory.length>this.maxHistory&&this.positionHistory.shift();const s={x:0,y:0};return this.positionHistory.forEach((t=>{s.x+=t.x,s.y+=t.y})),s.x/=this.positionHistory.length,s.y/=this.positionHistory.length,s}spawnBubble(){const t=20+20*Math.random(),s=Math.random()*(640-2*t)+t,i=-(1+1.5*Math.random()),e=1.5*(Math.random()-.5);this.bubbles.length>=this.maxBubbles||this.bubbles.push({x:s,y:480+t,radius:t,speedY:i,speedX:e})}async startBubblePop(){this.video=document.getElementById("video"),this.canvas=document.getElementById("canvas");const t=this.canvas.getContext("2d"),s=document.getElementById("status"),i=document.getElementById("score-display");let e;i.innerText=`Score: ${this.score}`,this.mouseMoveHandler=t=>{if(this.isHandDetected)return;const s=this.canvas.getBoundingClientRect(),i=t.clientX-s.left,e=t.clientY-s.top,a=this.smoothPosition({x:i,y:e});this.lastPos={x:a.x,y:a.y},this.lastCursorTime=Date.now()},this.canvas.addEventListener("mousemove",this.mouseMoveHandler),document.addEventListener("keydown",(e=>{switch(e.key.toLowerCase()){case"c":this.bubbles=[],t.clearRect(0,0,this.canvas.width,this.canvas.height),s.innerText="ðŸŽˆ BubblePop | C: Clear, R: Reset",i.innerText=`Score: ${this.score}`;break;case"r":this.bubbles=[],this.score=0,this.chainCount=0,this.spawnRate=1e3,t.clearRect(0,0,this.canvas.width,this.canvas.height),s.innerText="ðŸŽˆ BubblePop | C: Clear, R: Reset",i.innerText=`Score: ${this.score}`,this.spawnInterval&&(clearInterval(this.spawnInterval),this.spawnInterval=setInterval((()=>this.spawnBubble()),this.spawnRate))}})),this.spawnInterval=setInterval((()=>{this.spawnBubble();const t=Math.max(300,.95*this.spawnRate);Math.abs(t-this.spawnRate)>1&&(this.spawnRate=t,this.spawnInterval&&(clearInterval(this.spawnInterval),this.spawnInterval=setInterval((()=>this.spawnBubble()),this.spawnRate)))}),this.spawnRate);try{e=await navigator.mediaDevices.getUserMedia({video:!0}),this.video.srcObject=e,await new Promise((t=>this.video.onloadeddata=t)),this.video.play()}catch(t){console.warn("Camera access denied, falling back to mouse input:",t),s.innerText="ðŸŽˆ BubblePop | Using mouse | C: Clear, R: Reset",this.canvas.classList.add("no-hand"),$(".bubblepop-loading",this.win.content).fadeOut(300)}this.hands=new Hands({locateFile:t=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${t}`}),this.hands.setOptions({maxNumHands:1,modelComplexity:1,minDetectionConfidence:.7,minTrackingConfidence:.7,selfieMode:!0}),e&&(this.camera=new Camera(this.video,{onFrame:async()=>await this.hands.send({image:this.video}),width:640,height:480}),this.camera.start());const a=()=>{t.clearRect(0,0,this.canvas.width,this.canvas.height),this.bubbles.forEach((s=>{t.beginPath(),t.arc(s.x,s.y,s.radius,0,2*Math.PI),t.fillStyle="rgba(100, 150, 255, 0.5)",t.fill(),t.strokeStyle="rgba(255, 255, 255, 0.8)",t.lineWidth=1,t.stroke(),s.y+=s.speedY,s.x+=s.speedX})),this.burstAnimations=this.burstAnimations.filter((t=>t.radius<60)),this.burstAnimations.forEach((s=>{t.beginPath(),t.arc(s.x,s.y,s.radius,0,2*Math.PI),t.strokeStyle=`rgba(255, 255, 255, ${1-s.radius/60})`,t.lineWidth=2,t.stroke(),s.radius+=2})),this.lastPos&&Date.now()-this.lastCursorTime<this.cursorTimeout&&(t.beginPath(),t.arc(this.lastPos.x,this.lastPos.y,6,0,2*Math.PI),t.fillStyle=`rgba(255, 255, 255, ${1-(Date.now()-this.lastCursorTime)/this.cursorTimeout})`,t.fill());const e=Date.now();this.lastPos&&Date.now()-this.lastCursorTime<this.cursorTimeout&&(this.bubbles=this.bubbles.filter((t=>{if(Math.hypot(this.lastPos.x-t.x,this.lastPos.y-t.y)<t.radius&&e-this.lastPopTime>=this.cooldown){this.score++,e-this.lastPopTime<=this.chainThreshold?this.chainCount=Math.min(this.chainCount+1,this.pitchNotes.length-1):this.chainCount=0;const a=this.pitchNotes[this.chainCount];try{this.synth.triggerAttackRelease(a,"16n",Tone.now())}catch(t){}return this.lastPopTime=e,this.burstAnimations.push({x:t.x,y:t.y,radius:t.radius}),i.innerText=`Score: ${this.score}`,s.innerText=this.isHandDetected?"ðŸŽˆ BubblePop | C: Clear, R: Reset":"ðŸŽˆ BubblePop | Using mouse | C: Clear, R: Reset",!1}return!0}))),this.bubbles=this.bubbles.filter((t=>t.y>-t.radius)),this.animationFrameId=requestAnimationFrame(a)};this.animationFrameId=requestAnimationFrame(a);let n=!1;this.hands.onResults((t=>{if(n||(n=!0,$(".bubblepop-loading",this.win.content).fadeOut(300)),this.isHandDetected=!!(t.multiHandLandmarks&&t.multiHandLandmarks.length>0),this.isHandDetected?(this.canvas.classList.remove("no-hand"),s.innerText="ðŸŽˆ BubblePop | C: Clear, R: Reset"):(this.canvas.classList.add("no-hand"),s.innerText="ðŸŽˆ BubblePop | Using mouse | C: Clear, R: Reset"),!this.isHandDetected)return;const i=t.multiHandLandmarks[0][8];let e=i.x*this.canvas.width,a=i.y*this.canvas.height;const o=this.smoothPosition({x:e,y:a});e=o.x,a=o.y,this.lastPos={x:e,y:a},this.lastCursorTime=Date.now()}))}}t.prototype.startLoadingSequence=function(t){const s=["Initializing camera...","Loading vision model...","Warming up tensors...","Calibrating hand gestures...","Initializing Synth...","Finalizing setup..."];let i=0;const e=$("#loading-text",this.win.content),a=setInterval((()=>{e.text(s[i]),i++,i>=s.length&&clearInterval(a)}),1200)};export{t as default};
//# sourceMappingURL=bubblepop.js.map
