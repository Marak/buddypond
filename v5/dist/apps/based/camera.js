class e{constructor(e,a={}){return this.bp=e,this.allDevices={},this.devices={videoinput:{},audioinput:{},audiooutput:{}},this.mode="local",this.fullMirror=!1,this.showingControls=!0,this.viewMode="Normal",this.selectedCameraIndex=0,this.MAX_FRAMES_PER_SNAP=10,this.DEFAULT_SNAP_TIMER=777,this.CAMERA_SHUTTER_DELAY=55,this.currentFrame=0,this.snaps=[],this}async init(){this.bp.log("Hello from Example"),await this.bp.load("/v5/apps/based/camera/camera.css"),await this.bp.appendScript("/v5/apps/based/camera/vendor/jsman.js"),await this.bp.appendScript("/v5/apps/based/camera/lib/CanvasVideo.js"),await this.bp.appendScript("/desktop/assets/js/gif.js");let e=await this.bp.load("/v5/apps/based/camera/camera.html");return this.html=e,"loaded Camera"}async open(e={}){this.cameraWindow||(this.cameraWindow=this.bp.apps.ui.windowManager.createWindow({id:"camera",title:"Camera",x:50,y:100,width:640,height:550,minWidth:200,minHeight:200,parent:$("#desktop")[0],icon:"/desktop/assets/images/icons/icon_camera_64.png",content:this.html,resizable:!0,minimizable:!0,maximizable:!0,closable:!0,focusable:!0,maximized:!1,minimized:!1,onClose:()=>{delete this.cameraWindow,this.makingSnap&&this.cancelSnap(),this.localStream&&this.localStream.getTracks&&this.localStream.getTracks().forEach((function(e){e.stop()}))}}),$("#mirrorCanvasMe",this.cameraWindow.content).css("width","100%"),$("#mirrorCanvasMe",this.cameraWindow.content).css("height","100%"),$("#snapDelaySlider",this.cameraWindow.content).show(),this.bindUIEvents()),this.snapContext=e.context,this.snapType=e.type,e.context?this.mode="snap":this.mode="local","local"===this.mode?$(".approveSnap").attr("title","Save to Local"):$(".approveSnap").attr("title","Approve and Send"),await this.enumerateDevices();let a=this.devices.videoinput[Object.keys(this.devices.videoinput)[0]].label;await this.startCamera(a),this.bp.apps.ui.windowManager.focusWindow(this.cameraWindow)}}e.prototype.enumerateDevices=async function(){try{const e=await navigator.mediaDevices.enumerateDevices();$(".selectMirrorCamera").html("");let a=0;return e.forEach(((e,t)=>{if(e.index=t,this.allDevices||(this.allDevices={}),this.devices||(this.devices={}),this.allDevices[e.label]=e,this.devices[e.kind]=this.devices[e.kind]||{},this.devices[e.kind][e.label]=e,"videoinput"===e.kind){a++;let t="";this.selectedCameraIndex===a&&(t='selected="selected"',e.label="ACTIVE"),$(".selectMirrorCamera",this.cameraWindow.content).append(`<option ${t}>${e.label}</option>`)}e.kind})),e}catch(e){throw console.error("Error enumerating devices:",e),e}},e.prototype.startCamera=function(e){let a=this,t=this.devices.videoinput[e].deviceId;navigator.mediaDevices.getUserMedia({video:{deviceId:t},audio:!1}).then((function(e){e.getTracks().forEach((function(e){$(".selectMirrorCamera").val(e.label)}));let t=document.querySelector("#mirrorVideoMe");t.onplay=function(){this.snapContext&&$(".recordSnap").show()},t.srcObject=e,a.localStream=e,$("#mirrorPlaceHolder",a.cameraWindow.content).fadeOut()})).catch((e=>{console.log("error in calling navigator.mediaDevices.getUserMedia",e)}))},e.prototype.bindUIEvents=function(){let e=this;function a(){e.showingControls?(e.showingControls=!1,$(".mirrorControl").hide(),$(".cameraControls").hide(),$(".snapControl").hide(),$(".snapControls").hide()):(e.showingControls=!0,t())}function t(){e.makingSnap?($(".cameraControls").show(),$(".snapControl").show(),$(".snapControls").show(),Object.keys(e.snaps).length>1&&$(".snapDelaySliderControl").show()):($(".mirrorControl").show(),$(".cameraControls").show(),$(".snapControl").hide(),$(".snapControls").hide())}$(e.cameraWindow.container).resize((function(){console.log("resize"),"Full"===e.viewMode&&e.resizeFullVideo()})),$("#snapDelaySlider").slider({value:777,min:1,max:2222,change:function(a,t){let i=2222-t.value;e.snapDelay=i,$("#snapsPreview").data("delay",i),e.createGif(i)}}),$(".showMirrorControls").on("click",(function(){a()})),$(".showFullMirror").on("click",(function(){"Normal"===e.viewMode?($("#mirrorCanvasMe").css("width",320),$("#mirrorCanvasMe").css("height",240),$("#snapsPreview").css("width",320),$("#snapsPreview").css("height",240),$("#mirrorCanvasMe").css("padding-top",32),$("#snapsPreview").css("padding-top",32),$("#mirrorCanvasMe").css("position","relative"),e.viewMode="Half",$(".showFullMirror").html(e.viewMode+" View")):"Half"===e.viewMode?($("#mirrorCanvasMe").css("padding-top",0),$("#snapsPreview").css("padding-top",0),e.resizeFullVideo(),e.viewMode="Full",$(".showFullMirror").html(e.viewMode+" View")):"Full"===e.viewMode&&($("#mirrorCanvasMe").css("width","100%"),$("#mirrorCanvasMe").css("height","100%"),$("#snapsPreview").css("width",640),$("#snapsPreview").css("height",480),$("#mirrorCanvasMe").css("padding-top",0),$("#snapsPreview").css("padding-top",0),$("#mirrorCanvasMe").css("position","relative"),e.viewMode="Normal",$(".showFullMirror").html(e.viewMode+" View"))})),e.showingControls&&t(),$(".selectMirrorCamera").on("change",(()=>{let a=$(this).val();this.bp.set("mirror_selected_camera_device_label",a),e.startCamera(a)})),Object.keys(JSManipulate).forEach((e=>{$(".selectMirrorFilter",this.cameraWindow.content).append(`<option value="${e}">${e}</option>`)})),$(".selectMirrorFilter",this.cameraWindow.content).on("change",(e=>{this.canvasVideo.filter=e.currentTarget.value.toLowerCase()})),this.canvasVideo=new window.CanvasVideo("#mirrorVideoMe","#mirrorCanvasMe"),this.canvasVideo.bindPlayEvent(),e.snaps=[],e.snapsGIF=[],$(".takeSingleSnap").on("click",(function(){e.makingSnap=!0,e.takeSingleSnap()})),$(".takeSnap").on("click",(function(){e.makingSnap=!0,e.takeSnap()})),$(".approveSnap").on("click",(function(){if($(".mirrorVideoHolder").show(),$("#snapsPreview").hide(),$(".recordSnap").show(),$(".confirmSnap").hide(),$(".takeSingleSnap").css("left","122"),$(".cameraControls").show(),"local"===e.mode){let e=$("#snapsPreview").attr("src").replace(/^data:image\/[^;]+/,"data:application/octet-stream");return void window.open(e)}let a=$("#snapsPreview").attr("src");e.cameraWindow.close(),buddypond.sendSnaps(e.snapType,e.snapContext,"I sent a Snap!",a,e.snapDelay,"camera",(function(a,t){e.snaps=[],e.currentFrame=0,$(".gifFrames").html(""),$("#snapsPreview").data("stopped",!0),$("#snapDelaySlider").slider("value",777),$("#snapDelaySlider").data("delay",777),e.makingSnap=!1;let i={to:e.snapContext,from:bp.me,type:e.snapType,text:t};console.log("sending multimedia message",i),bp.emit("buddy::sendMessage",i)}))})),e.cancelSnap=function(){e.snaps=[],e.currentFrame=0,$(".cameraControls").show(),$(".gifFrames").html(""),$("#snapsPreview").data("stopped",!0),$(".mirrorVideoHolder").show(),$("#snapsPreview").hide(),$(".takeSingleSnap").css("left","122"),$(".recordSnap").show(),$(".confirmSnap").hide(),$(".snapDelaySliderControl").hide(),$("#snapDelaySlider").slider("value",777),$("#snapDelaySlider").data("delay",777),e.makingSnap=!1},$(".cancelSnap").on("click",(function(){e.cancelSnap()})),$(".continueSnap").on("click",(function(){$(".cameraControls").show(),$(".mirrorVideoHolder").show(),$("#snapsPreview").hide(),$(".snapDelaySliderControl").hide(),$(".recordSnap").show(),$(".confirmSnap").hide(),$(".takeSnap").hide(),$(".takeSingleSnap").css("left",244),$(".takeSingleSnap").show()})),bp.settings.mirror_snaps_camera_countdown_enabled&&$(".cameraCountdownEnabled").prop("checked","checked"),$(".cameraCountdownEnabled").on("change",(e=>{$(e.target).prop("checked")?this.bp.set("mirror_snaps_camera_countdown_enabled",!0):this.bp.set("mirror_snaps_camera_countdown_enabled",!1)}))},e.prototype.resizeFullVideo=function(){$("#snapsPreview").css("width",$("#window_mirror").css("width")),$("#snapsPreview").css("height",$("#window_mirror").css("height")),$("#mirrorCanvasMe").css("position","absolute"),$("#mirrorCanvasMe").css("top",0),$("#mirrorCanvasMe").css("left",0)},e.prototype.takeSingleSnap=function(){let e=this,a=this.bp;if($(".recordSnap").hide(),!this.bp.settings.mirror_snaps_camera_countdown_enabled&&0===e.currentFrame)return this.bp.play("desktop/assets/audio/CAMERA_SNAP.wav"),void setTimeout((function(){e.recordSnaps(1)}),44);a.play("desktop/assets/audio/CAMERA_COUNTDOWN.wav"),$(".snapCountDown").show(),setTimeout((function(){$(".snapCountDown").html("2..."),setTimeout((function(){$(".snapCountDown").html("1..."),setTimeout((function(){$(".snapCountDown").hide(),$(".snapCountDown").html("3..."),setTimeout((function(){0===e.currentFrame&&(a.play("desktop/assets/audio/CAMERA_SNAP.wav"),setTimeout((function(){e.recordSnaps(1)}),44))}),333)}),1e3)}),1e3)}),1e3)},e.prototype.recordSnaps=function(e,a,t){let i=this;$(".cameraControls").hide(),a=a||$("#snapsPreview").data("delay")||i.DEFAULT_SNAP_TIMER,$("#snapsPreview").data("delay",a),i.snapDelay=a,t=t||"photo",$(".recordSnap").hide(),$(".mirrorVideoHolder").css("opacity","1");let n=document.getElementById("snaps"),s=n.getContext("2d");e>1&&bp.play("desktop/assets/audio/CAMERA_SHUTTER.wav",{tryHard:!0}),n.width=320,n.height=240,s.scale(.5,.5),s.drawImage(document.getElementById("mirrorCanvasMe"),0,0);let o=n.toDataURL("image/png"),r=n.toDataURL("image/gif");if($(".gifFrames",this.cameraWindow.content).append(`<img src="${r}"/>`),o=o.replace("data:image/png;base64,",""),i.snaps.push(o),i.currentFrame++,$(".mirrorVideoHolder").css("opacity","0.88"),$("#snapsPreview").data("stopped",!1),$(".mirrorVideoHolder").css("opacity","1"),i.currentFrame>=e)return i.currentFrame=0,void setTimeout((function(){i.createGif(a),$(".mirrorVideoHolder").hide(),$("#snapsPreview").show(),$(".confirmSnap").show(),"photo"===t?($(".retrySnap").hide(),$(".retrySingleSnap").show(),Object.keys(i.snaps).length>1&&$(".snapDelaySliderControl").show()):($(".continueSnap").hide(),$(".retrySingleSnap").hide(),$(".retrySnap").show(),$(".snapDelaySliderControl").show())}),i.CAMERA_SHUTTER_DELAY);setTimeout((function(){i.recordSnaps(e,a,t)}),a)},e.prototype.createGif=function(e){let a=new GIF({workers:2,quality:3,width:320,height:240});a.on("finished",(function(e){let a=new FileReader;a.readAsDataURL(e),a.onloadend=function(){let e=a.result;$("#snapsPreview").attr("src",e)}})),$(".gifFrames img",this.cameraWindow.content).each((function(t,i){a.addFrame(i,{delay:e})})),a.render()},e.prototype.takeSnap=function(){let e=this,a=this.bp;$(".recordSnap").hide(),this.bp.settings.mirror_snaps_camera_countdown_enabled||0!==e.currentFrame?(a.play("desktop/assets/audio/CAMERA_COUNTDOWN.wav"),$(".snapCountDown").show(),setTimeout((function(){$(".snapCountDown").html("2..."),setTimeout((function(){$(".snapCountDown").html("1..."),setTimeout((function(){$(".snapCountDown").hide(),$(".snapCountDown").html("3..."),setTimeout((function(){0===e.currentFrame&&setTimeout((function(){e.recordSnaps(10,100,"film")}),44)}),333)}),1e3)}),1e3)}),1e3)):setTimeout((function(){e.recordSnaps(10,100,"film")}),44)};export{e as default};
//# sourceMappingURL=camera.js.map
