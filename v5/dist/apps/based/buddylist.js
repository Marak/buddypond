function e(e){$(e).on("contextmenu",(e=>{e.preventDefault();let t=e.target.closest("li").dataset.buddy;this.showContextMenu(e.pageX,e.pageY,t)}))}function t(e){if(!e)return"";if(function(e){if(!e)return!1;const t=s(e),o=new Set(Object.keys(EMOJIS)),n=t.filter((e=>o.has(e)||o.has(e.replace(/\uFE0F/g,""))));return n.length>0&&n.length<=7&&n.join("")===e.trim()}(e))return'<div class="emoji-only">'+s(e).map((e=>`<span class="big-emoji">${e}</span>`)).join("")+"</div>";const t=["red","blue","green","yellow","purple","orange","black","white","gray","cyan","magenta","pink"],o=["bold","italic","underline","strike","blink","reverse","hidden","dim","rainbow"],n={name:"link",level:"inline",renderer(e){return`<a href="${e.href.replace(/"/g,"&quot;")}" target="_blank" rel="noopener">${this.parser.parseInline(e.tokens)}</a>`}},i={name:"style",level:"inline",tokenizer(e){const s=/^((?:\w+\.)*\w+)\(\s*([\s\S]+?)\s*\)/.exec(e);if(s){const e=s[0],n=s[1].split("."),i=s[2];if(!n.every((e=>t.includes(e)||o.includes(e))))return;return{type:"style",raw:e,modifiers:n,text:i,tokens:this.lexer.inlineTokens(i)}}},renderer(e){let s=this.parser.parseInline(e.tokens);return e.modifiers.reverse().forEach((e=>{t.includes(e)?s=`<span style="color: ${e};">${s}</span>`:"bold"===e?s=`<strong>${s}</strong>`:"italic"===e?s=`<em>${s}</em>`:"underline"===e?s=`<u>${s}</u>`:"strike"===e?s=`<s>${s}</s>`:"blink"===e?s=`<span style="animation: blink 1s step-start infinite;">${s}</span>`:"reverse"===e?s=s.split("").reverse().join(""):"hidden"===e?s=`<span style="visibility: hidden;" onmouseover="this.style.visibility='visible'" onmouseout="this.style.visibility='hidden'">${s}</span>`:"dim"===e?s=`<span style="opacity: 0.5;">${s}</span>`:"rainbow"===e&&(s=s.split("").map(((e,t)=>`<span style="color: hsl(${360*t/s.length}, 100%, 50%);">${e}</span>`)).join(""))})),s},walkTokens(e){"style"===e.type&&console.log(`Detected style token: ${e.modifiers.join(".")}`)}};let a;marked.use({extensions:[i,n]});try{a=marked.parse(e)}catch(t){a=e}return a.replace(/^<p>(.*?)<\/p>\s*$/s,"$1")}function s(e){return(new GraphemeSplitter).splitGraphemes(e.trim())}function o(e){const t=document.createElement("div");t.className="aim-hover-menu";const s=[];return e.from!==this.bp.me&&"Marak"!==this.bp.me||s.push({text:"Edit Message",action:"edit-message",icon:"fa-duotone fa-regular fa-pencil"}),s.push({text:"Reply Message",action:"reply-message",icon:"fa-duotone fa-regular fa-reply"}),s.push({text:"...",action:"more-options",icon:"fa-solid fa-regular fa-ellipsis"}),s.forEach((e=>{const s=document.createElement("button");if(s.setAttribute("data-action",e.action),s.className="aim-hover-menu-item",e.icon){const t=document.createElement("i");t.className=e.icon,s.appendChild(t),s.appendChild(document.createTextNode(" "))}else s.appendChild(document.createTextNode(e.text));s.setAttribute("title",e.text),t.appendChild(s)})),t}let n={base64:"WyI0cjVlIiwiNWgxdCIsIjVoaXQiLCJhNTUiLCJhbmFsIiwiYW51cyIsImFyNWUiLCJhcnJzZSIsImFyc2UiLCJhc3MiLCJhc3MtZnVja2VyIiwiYXNzZXMiLCJhc3NmdWNrZXIiLCJhc3NmdWtrYSIsImFzc2hvbGUiLCJhc3Nob2xlcyIsImFzc3dob2xlIiwiYV9zX3MiLCJiIXRjaCIsImIwMGJzIiwiYjE3Y2giLCJiMXRjaCIsImJhbGxiYWciLCJiYWxscyIsImJhbGxzYWNrIiwiYmFzdGFyZCIsImJlYXN0aWFsIiwiYmVhc3RpYWxpdHkiLCJiZWxsZW5kIiwiYmVzdGlhbCIsImJlc3RpYWxpdHkiLCJiaStjaCIsImJpYXRjaCIsImJpdGNoIiwiYml0Y2hlciIsImJpdGNoZXJzIiwiYml0Y2hlcyIsImJpdGNoaW4iLCJiaXRjaGluZyIsImJsb29keSIsImJsb3cgam9iIiwiYmxvd2pvYiIsImJsb3dqb2JzIiwiYm9pb2xhcyIsImJvbGxvY2siLCJib2xsb2siLCJib25lciIsImJvb2IiLCJib29icyIsImJvb29icyIsImJvb29vYnMiLCJib29vb29icyIsImJvb29vb29vYnMiLCJicmVhc3RzIiwiYnVjZXRhIiwiYnVnZ2VyIiwiYnVtIiwiYnVubnkgZnVja2VyIiwiYnV0dCIsImJ1dHRob2xlIiwiYnV0dG11bmNoIiwiYnV0dHBsdWciLCJjMGNrIiwiYzBja3N1Y2tlciIsImNhcnBldCBtdW5jaGVyIiwiY2F3ayIsImNoaW5rIiwiY2lwYSIsImNsMXQiLCJjbGl0IiwiY2xpdG9yaXMiLCJjbGl0cyIsImNudXQiLCJjb2NrIiwiY29jay1zdWNrZXIiLCJjb2NrZmFjZSIsImNvY2toZWFkIiwiY29ja211bmNoIiwiY29ja211bmNoZXIiLCJjb2NrcyIsImNvY2tzdWNrICIsImNvY2tzdWNrZWQgIiwiY29ja3N1Y2tlciIsImNvY2tzdWNraW5nIiwiY29ja3N1Y2tzICIsImNvY2tzdWthIiwiY29ja3N1a2thIiwiY29rIiwiY29rbXVuY2hlciIsImNva3N1Y2thIiwiY29vbiIsImNveCIsImNyYXAiLCJjdW0iLCJjdW1tZXIiLCJjdW1taW5nIiwiY3VtcyIsImN1bXNob3QiLCJjdW5pbGluZ3VzIiwiY3VuaWxsaW5ndXMiLCJjdW5uaWxpbmd1cyIsImN1bnQiLCJjdW50bGljayAiLCJjdW50bGlja2VyICIsImN1bnRsaWNraW5nICIsImN1bnRzIiwiY3lhbGlzIiwiY3liZXJmdWMiLCJjeWJlcmZ1Y2sgIiwiY3liZXJmdWNrZWQgIiwiY3liZXJmdWNrZXIiLCJjeWJlcmZ1Y2tlcnMiLCJjeWJlcmZ1Y2tpbmcgIiwiZDFjayIsImRhbW4iLCJkaWNrIiwiZGlja2hlYWQiLCJkaWxkbyIsImRpbGRvcyIsImRpbmsiLCJkaW5rcyIsImRpcnNhIiwiZGxjayIsImRvZy1mdWNrZXIiLCJkb2dnaW4iLCJkb2dnaW5nIiwiZG9ua2V5cmliYmVyIiwiZG9vc2giLCJkdWNoZSIsImR5a2UiLCJlamFjdWxhdGUiLCJlamFjdWxhdGVkIiwiZWphY3VsYXRlcyAiLCJlamFjdWxhdGluZyAiLCJlamFjdWxhdGluZ3MiLCJlamFjdWxhdGlvbiIsImVqYWt1bGF0ZSIsImYgdSBjIGsiLCJmIHUgYyBrIGUgciIsImY0bm55IiwiZmFnIiwiZmFnZ2luZyIsImZhZ2dpdHQiLCJmYWdnb3QiLCJmYWdncyIsImZhZ290IiwiZmFnb3RzIiwiZmFncyIsImZhbm55IiwiZmFubnlmbGFwcyIsImZhbm55ZnVja2VyIiwiZmFueXkiLCJmYXRhc3MiLCJmY3VrIiwiZmN1a2VyIiwiZmN1a2luZyIsImZlY2siLCJmZWNrZXIiLCJmZWxjaGluZyIsImZlbGxhdGUiLCJmZWxsYXRpbyIsImZpbmdlcmZ1Y2sgIiwiZmluZ2VyZnVja2VkICIsImZpbmdlcmZ1Y2tlciAiLCJmaW5nZXJmdWNrZXJzIiwiZmluZ2VyZnVja2luZyAiLCJmaW5nZXJmdWNrcyAiLCJmaXN0ZnVjayIsImZpc3RmdWNrZWQgIiwiZmlzdGZ1Y2tlciAiLCJmaXN0ZnVja2VycyAiLCJmaXN0ZnVja2luZyAiLCJmaXN0ZnVja2luZ3MgIiwiZmlzdGZ1Y2tzICIsImZsYW5nZSIsImZvb2siLCJmb29rZXIiLCJmdWNrIiwiZnVja2EiLCJmdWNrZWQiLCJmdWNrZXIiLCJmdWNrZXJzIiwiZnVja2hlYWQiLCJmdWNraGVhZHMiLCJmdWNraW4iLCJmdWNraW5nIiwiZnVja2luZ3MiLCJmdWNraW5nc2hpdG1vdGhlcmZ1Y2tlciIsImZ1Y2ttZSAiLCJmdWNrcyIsImZ1Y2t3aGl0IiwiZnVja3dpdCIsImZ1ZGdlIHBhY2tlciIsImZ1ZGdlcGFja2VyIiwiZnVrIiwiZnVrZXIiLCJmdWtrZXIiLCJmdWtraW4iLCJmdWtzIiwiZnVrd2hpdCIsImZ1a3dpdCIsImZ1eCIsImZ1eDByIiwiZl91X2NfayIsImdhbmdiYW5nIiwiZ2FuZ2JhbmdlZCAiLCJnYW5nYmFuZ3MgIiwiZ2F5bG9yZCIsImdheXNleCIsImdvYXRzZSIsImdvZC1kYW0iLCJnb2QtZGFtbmVkIiwiZ29kZGFtbiIsImdvZGRhbW5lZCIsImhhcmRjb3Jlc2V4ICIsImhlbGwiLCJoZXNoZSIsImhvYXIiLCJob2FyZSIsImhvZXIiLCJob21vIiwiaG9yZSIsImhvcm5pZXN0IiwiaG9ybnkiLCJob3RzZXgiLCJqYWNrLW9mZiAiLCJqYWNrb2ZmIiwiamFwIiwiamVyay1vZmYgIiwiamlzbSIsImppeiAiLCJqaXptICIsImppenoiLCJrYXdrIiwia25vYiIsImtub2JlYWQiLCJrbm9iZWQiLCJrbm9iZW5kIiwia25vYmhlYWQiLCJrbm9iam9ja3kiLCJrbm9iam9rZXkiLCJrb2NrIiwia29uZHVtIiwia29uZHVtcyIsImt1bSIsImt1bW1lciIsImt1bW1pbmciLCJrdW1zIiwia3VuaWxpbmd1cyIsImtpdW50IiwibDNpK2NoIiwibDNpdGNoIiwibGFiaWEiLCJsbWZhbyIsImx1c3QiLCJsdXN0aW5nIiwibTBmMCIsIm0wZm8iLCJtNDV0ZXJiYXRlIiwibWE1dGVyYjgiLCJtYTV0ZXJiYXRlIiwibWFzb2NoaXN0IiwibWFzdGVyLWJhdGUiLCJtYXN0ZXJiOCIsIm1hc3RlcmJhdCoiLCJtYXN0ZXJiYXQzIiwibWFzdGVyYmF0ZSIsIm1hc3RlcmJhdGlvbiIsIm1hc3RlcmJhdGlvbnMiLCJtYXN0dXJiYXRlIiwibW8tZm8iLCJtb2YwIiwibW9mbyIsIm1vdGhhZnVjayIsIm1vdGhhZnVja2EiLCJtb3RoYWZ1Y2thcyIsIm1vdGhhZnVja2F6IiwibW90aGFmdWNrZWQgIiwibW90aGFmdWNrZXIiLCJtb3RoYWZ1Y2tlcnMiLCJtb3RoYWZ1Y2tpbiIsIm1vdGhhZnVja2luZyAiLCJtb3RoYWZ1Y2tpbmdzIiwibW90aGFmdWNrcyIsIm1vdGhlciBmdWNrZXIiLCJtb3RoZXJmdWNrIiwibW90aGVyZnVja2VkIiwibW90aGVyZnVja2VyIiwibW90aGVyZnVja2VycyIsIm1vdGhlcmZ1Y2tpbiIsIm1vdGhlcmZ1Y2tpbmciLCJtb3RoZXJmdWNraW5ncyIsIm1vdGhlcmZ1Y2trYSIsIm1vdGhlcmZ1Y2tzIiwibXVmZiIsIm11dGhhIiwibXV0aGFmZWNrZXIiLCJtdXRoYWZ1Y2trZXIiLCJtdXRoZXIiLCJtdXRoZXJmdWNrZXIiLCJuMWdnYSIsIm4xZ2dlciIsIm5hemkiLCJuaWdnM3IiLCJuaWdnNGgiLCJuaWdnYSIsIm5pZ2dhaCIsIm5pZ2dhcyIsIm5pZ2dheiIsIm5pZ2dlciIsIm5pZ2dlcnMiLCJub2IiLCJub2Igam9rZXkiLCJub2JoZWFkIiwibm9iam9ja3kiLCJub2Jqb2tleSIsIm51bWJudXRzIiwibnV0c2FjayIsIm9yZ2FzaW0gIiwib3JnYXNpbXMgIiwib3JnYXNtIiwib3JnYXNtcyAiLCJwMHJuIiwicGF3biIsInBlY2tlciIsInBlbmlzIiwicGVuaXNmdWNrZXIiLCJwaG9uZXNleCIsInBodWNrIiwicGh1ayIsInBodWtlZCIsInBodWtpbmciLCJwaHVra2VkIiwicGh1a2tpbmciLCJwaHVrcyIsInBodXEiLCJwaWdmdWNrZXIiLCJwaW1waXMiLCJwaXNzIiwicGlzc2VkIiwicGlzc2VyIiwicGlzc2VycyIsInBpc3NlcyAiLCJwaXNzZmxhcHMiLCJwaXNzaW4gIiwicGlzc2luZyIsInBpc3NvZmYgIiwicG9vcCIsInBvcm4iLCJwb3JubyIsInBvcm5vZ3JhcGh5IiwicG9ybm9zIiwicHJpY2siLCJwcmlja3MgIiwicHJvbiIsInB1YmUiLCJwdXNzZSIsInB1c3NpIiwicHVzc2llcyIsInB1c3N5IiwicHVzc3lzICIsInJlY3R1bSIsInJldGFyZCIsInJpbWphdyIsInJpbW1pbmciLCJzIGhpdCIsInMuby5iLiIsInNhZGlzdCIsInNjaGxvbmciLCJzY3Jld2luZyIsInNjcm9hdCIsInNjcm90ZSIsInNjcm90dW0iLCJzZW1lbiIsInNleCIsInNoISsiLCJzaCF0Iiwic2gxdCIsInNoYWciLCJzaGFnZ2VyIiwic2hhZ2dpbiIsInNoYWdnaW5nIiwic2hlbWFsZSIsInNoaSsiLCJzaGl0Iiwic2hpdGRpY2siLCJzaGl0ZSIsInNoaXRlZCIsInNoaXRleSIsInNoaXRmdWNrIiwic2hpdGZ1bGwiLCJzaGl0aGVhZCIsInNoaXRpbmciLCJzaGl0aW5ncyIsInNoaXRzIiwic2hpdHRlZCIsInNoaXR0ZXIiLCJzaGl0dGVycyAiLCJzaGl0dGluZyIsInNoaXR0aW5ncyIsInNoaXR0eSAiLCJza2FuayIsInNsdXQiLCJzbHV0cyIsInNtZWdtYSIsInNtdXQiLCJzbmF0Y2giLCJzb24tb2YtYS1iaXRjaCIsInNwYWMiLCJzcHVuayIsInNfaF9pX3QiLCJ0MXR0MWU1IiwidDF0dGllcyIsInRlZXRzIiwidGVleiIsInRlc3RpY2FsIiwidGVzdGljbGUiLCJ0aXQiLCJ0aXRmdWNrIiwidGl0cyIsInRpdHQiLCJ0aXR0aWU1IiwidGl0dGllZnVja2VyIiwidGl0dGllcyIsInRpdHR5ZnVjayIsInRpdHR5d2FuayIsInRpdHdhbmsiLCJ0b3NzZXIiLCJ0dXJkIiwidHc0dCIsInR3YXQiLCJ0d2F0aGVhZCIsInR3YXR0eSIsInR3dW50IiwidHd1bnRlciIsInYxNGdyYSIsInYxZ3JhIiwidmFnaW5hIiwidmlhZ3JhIiwidnVsdmEiLCJ3MDBzZSIsIndhbmciLCJ3YW5rIiwid2Fua2VyIiwid2Fua3kiLCJ3aG9hciIsIndob3JlIiwid2lsbGllcyIsIndpbGx5IiwieHJhdGVkIiwieHh4Il0="};function i(e){let t=(e.text||"").match(/https?:\/\/(?:[^\s()<>\[\]{}"']+|\([^\s()]*?\))+/gi);if(t&&function(e){if(!e)return!1;e=e.trim();try{const t=new URL(e);return"http:"===t.protocol||"https:"===t.protocol}catch(e){return!1}}(t[0])){let s=t[0];e.card={url:s,type:"website"};let o=s.split(".").pop().split(/\#|\?/)[0];if(o&&"string"==typeof o&&(buddypond.supportedImageTypesExt.includes(o.toLowerCase())&&(e.card.type="image"),buddypond.supportedAudioTypesExt.includes(o.toLowerCase())&&(e.card.type="audio"),buddypond.supportedVideoTypesExt.includes(o.toLowerCase())&&(e.card.type="video")),function(e){const t=e.match(/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/);return t?t[1]:null}(s)){const t=new URL(s).searchParams.get("v");t&&(e.card.type="youtube",e.card.thumbnail=`https://img.youtube.com/vi/${t}/0.jpg`,e.card.context=t)}if(function(e){const t=e.match(/^https?:\/\/github\.com\/([^\/]+)\/([^\/]+)\/blob\/([^\/]+)\/(.+)$/);return t?t.slice(1):null}(s)){e.card.type="github";const t=/^https?:\/\/github\.com\/([^\/]+)\/([^\/]+)\/blob\/([^\/]+)\/(.+)$/,o=s.match(t);o?(e.card.owner=o[1],e.card.repo=o[2],e.card.filename=o[4]):console.error("Invalid GitHub URL format.")}}}function a(e,t,s){const o=$(".aim-input",s.content),n=$(".message_form",s.content),i=$(".aim-send-btn",s.content);let a=this;o.on("input",(function(e){const t=$(".aim-send-btn",s.content);a.handleEmojiInput(e,t);const n=this.selectionStart,i=o.val(),d=a.getInputContext(i,n);d&&("emoji"===d.type&&d.text.length>=2||"command"===d.type)?$(this).autocomplete("search",d.text):$(this).autocomplete("close")})),o.on("keydown",(d=>{if(13===d.which&&d.shiftKey){const e=o.val(),t=o[0].selectionStart,s=e.slice(0,t)+"\n"+e.slice(t);return o.val(s),o[0].setSelectionRange(t+1,t+1),i.css("opacity",s.length>0?1:.5),!1}if(13===d.which&&o.autocomplete("widget").is(":visible")){const e=o.val();return e.startsWith("/")||e.startsWith("\\")?(n.submit(),d.preventDefault(),!1):(d.preventDefault(),!1)}if(9===d.which)return d.preventDefault(),!1;if(13===d.which){let e=o.val().replace(/\n/g,"<br>");return e=a.replaceShortcodes(e),o.val(e),n.submit(),d.preventDefault(),!1}let r=s.currentActiveContext||t;this.bp.emit("buddy::typing",{from:this.bp.me,to:r,type:e,isTyping:!0,ctime:Date.now()})})),o.on("keyup",(e=>{const t=o.val();i.css("opacity",t.length>0?1:.5)}))}function d(e){if(!this.options.autocomplete)return;const t=$(".aim-input",e.content);$(".message_form",e.content);const s=$(".aim-send-btn",e.content);if(this.replaceShortcodes=l.bind(this),!this.emojiMap){const e=new Set;this.emojiMap=Object.keys(EMOJIS).reduce(((t,s)=>(EMOJIS[s].filter(r).forEach((o=>{const n=`:${o}:`;e.has(n)||(t[n]=s,e.add(n))})),t)),{})}function o(e,t){const s=e.slice(0,t);e.slice(t);const o=s.lastIndexOf(":");if(-1!==o){let s=t;const n=e.indexOf(":",t);if(-1!==n){const t=e.slice(o,n+1);/^:[a-z0-9_+]+:$/.test(t)&&(s=n+1)}const i=e.slice(o,s);if(/^:[a-z0-9_+]*(?::|$)/.test(i))return{type:"emoji",text:i,startIndex:o,endIndex:s}}const n=s.charAt(0);return["/","\\"].includes(n)?{type:"command",text:s,startIndex:0,endIndex:t}:null}this.emojiSuggestions||(this.emojiSuggestions=Object.keys(EMOJIS).reduce(((e,t)=>(EMOJIS[t].filter(r).forEach((s=>{e.push({label:`${t} :${s}:`,value:`:${s}:`,emoji:t,type:"emoji"})})),e)),[])),this.commands||(this.commands=Object.keys(this.options.autocomplete).map((e=>({label:`/${e}`,value:`/${e}`,type:"command"})))),this.handleEmojiInput=c.bind(this),this.getInputContext=o.bind(this);let n=this;t.autocomplete({focus:function(e,t){return e.preventDefault(),!1},source:function(e,s){const i=t[0].selectionStart,a=o(t.val(),i);if(a)if("emoji"===a.type&&a.text.length>=2){const e=a.text.replace(/^:|:$/g,"").toLowerCase();s(n.emojiSuggestions.filter((t=>t.value.toLowerCase().includes(e))).slice(0,10))}else if("command"===a.type){const e=a.text.slice(1).toLowerCase();console.log("Command query:",e),console.log("Available commands:",n.commands);s(n.commands.filter((t=>t.value.toLowerCase().includes(e))).slice(0,10))}else s([]);else s([])},select:function(e,n){const i=t[0],a=i.selectionStart,d=t.val(),r=o(d,a);if(r){const e=d.slice(0,r.startIndex),o=d.slice(r.endIndex),a=e+(n.item.emoji||n.item.value)+o;t.val(a);const l=r.startIndex+n.item.value.length;return i.setSelectionRange(l,l),"emoji"===n.item.type&&t.trigger("input"),s.css("opacity",a.length>0?1:.5),!1}return t.autocomplete("close"),!1},minLength:0,position:{my:"left bottom",at:"left top",collision:"none"},open:function(){$(".ui-autocomplete").css({"max-height":"200px","overflow-y":"auto","z-index":1e3})}})}function r(e){return/^[a-z0-9_+]+$/.test(e)&&!e.startsWith(":")&&!e.includes(" ")}function l(e){return e.replace(/:[a-z0-9_+]+:/g,(e=>this.emojiMap[e]||e))}function c(e,t){const s=e.target,o=$(s),n=s.selectionStart,i=o.val(),a=l.call(this,i);if(a!==i){o.val(a);const e=n+(a.length-i.length);s.setSelectionRange(e,e),t.css("opacity",a.length>0?1:.5)}}n.randowFunWord=function(){let e=["daffodil","chrysanthemum","waffles","puppies","senpai","kohai","rainbow","fluffy","marklar"];return e[Math.floor(Math.random()*e.length)]},n.containsBadWord=function(e){const t=e.toLowerCase();return n.decoded.some((function(e){return new RegExp(`\\b${e}\\b`,"i").test(t)}))},n.filter=function(e){return n.decoded.forEach((function(t){e=(e=e.replace(new RegExp("\\b"+t+"\\b"),n.randowFunWord())).replace(new RegExp("\\b"+t+"\\b","gi"),n.randowFunWord())})),e},n.decoded=JSON.parse(atob(n.base64));class p{constructor(e,t={}){this.bp=e,this.options=t;const s=t.buttons||[],o=this.bp.settings?.["buttonBar.buttons"];return Array.isArray(o)?this.buttons=this.sortButtonsByOrder(s,o):this.buttons=s,this.container=this.render(),this.enableDragAndDrop(),this}render(){const e=document.createElement("div");return e.classList.add("button-bar"),this.buttons.forEach((t=>{const s=this.createButtonElement(t);e.appendChild(s)})),e}createButtonElement(e){let t;const s={context:this.options.context||e.text,type:this.options.type||"buddy"};return e.image?(t=document.createElement("img"),t.src=e.image,t.alt=e.text,t.title=e.text,t.draggable=!1):(t=document.createElement("button"),t.innerText=e.text),Object.entries(s).forEach((([e,s])=>{t.dataset[e]=s})),t.classList.add("button-bar-button"),e.className&&t.classList.add(e.className),t.dataset.text=e.text,t.onclick=e.onclick,t}addButton(e){if(this.buttons.some((t=>t.text===e.text)))return void console.warn(`Button with text "${e.text}" already exists.`);this.buttons.push(e);const t=this.createButtonElement(e);this.container.appendChild(t),this.refreshSortable()}removeButton(e){const t=this.buttons.findIndex((t=>t.text===e));if(-1===t)return;this.buttons.splice(t,1);const s=Array.from(this.container.children);for(const t of s)if((t.innerText===e||t.alt===e)&&t.classList.contains("button-bar-button")){this.container.removeChild(t);break}this.refreshSortable(),this.saveButtonOrder()}enableDragAndDrop(){$(this.container).sortable({items:".button-bar-button",tolerance:"pointer",stop:()=>this.syncButtonOrder()})}refreshSortable(){$(this.container).sortable("refresh")}syncButtonOrder(){const e=Array.from(this.container.children).map((e=>e.dataset.text));this.buttons=e.map((e=>this.buttons.find((t=>t.text===e)))).filter(Boolean),this.saveButtonOrder()}saveButtonOrder(){const e=this.buttons.map((e=>e.text));this.bp.set("buttonBar.buttons",e);const t=this.bp.apps.ui.windowManager.findWindows({app:"buddylist",type:["buddy","pond"]});console.log("openWindows to reorder",t),t.forEach((t=>{t.buttonBar&&(t.buttonBar.buttons=this.sortButtonsByOrder(t.buttonBar.buttons,e),t.buttonBar.reRenderButtons())}))}reRenderButtons(){this.container.innerHTML="",this.buttons.forEach((e=>{const t=this.createButtonElement(e);this.container.appendChild(t)})),this.refreshSortable()}sortButtonsByOrder(e,t){const s=Object.fromEntries(e.map((e=>[e.text,e])));return[...t.map((e=>s[e])).filter(Boolean),...e.filter((e=>!t.includes(e.text)))]}}function m(e,t,s){if(!this.options.chatWindowButtons)return;let o=this.options.chatWindowButtons.slice();"pond"===e&&(o=o.filter((e=>"buddy-only"!==e.type))),this.bp.isMobile()&&"buddy"===e&&(o=o.filter((e=>"BuddyHelp"!==e.text))),/iPad|iPhone|iPod/.test(navigator.userAgent)&&"ontouchend"in document&&(o=o.filter((e=>"desktop-only"!==e.env))),s.buttonBar=new p(this.bp,{context:t,type:e,buttons:o}),$(".aim-message-controls",s.content).prepend(s.buttonBar.container)}function u(e,t,s=null){const o=$(".aim-room-list-items",t.content);if(!o.length)return;if(!e||!Array.isArray(e))return;const n=[...e].sort(((e,t)=>t.connection_count-e.connection_count)),i=this.data.activePonds||[],a=new Map,d=new Set;o.find(".aim-room-item").each(((e,t)=>{const s=$(t).data("pond");s&&(a.set(s,$(t)),d.add(s))})),n.forEach((e=>{const t=e.pond_id,n=t.replace("pond/",""),r=i.includes(t),l=t===s,c=a.get(t);if(c){const o=c.find(".aim-room-list-item-score");o.text()!==String(e.connection_count)&&(console.log(`Updating connection_count for ${t}: ${e.connection_count}`),o.text(e.connection_count));const n=c.find(".aim-room-close-btn");if(r?n.length||(console.log(`Adding close button for ${t}`),c.append(`<button class="aim-room-close-btn" data-context="${t}">X</button>`)):n.length&&(console.log(`Removing close button for ${t}`),n.remove()),null!==s){const e=l;c.hasClass("aim-room-active")!==e&&(console.log(`Updating active class for ${t}: ${e}`),c.toggleClass("aim-room-active",e))}d.delete(t)}else{const i=r?`<button class="aim-room-close-btn" data-context="${t}">X</button>`:"",d=$(`\n                <li class="aim-room-item aim-room-list-item${l&&null!==s?" aim-room-active":""}" data-pond="${t}" data-context="${t}">\n                    <span class="aim-room-list-item-name">#${n}</span>\n                    <span class="aim-room-list-item-score">${e.connection_count}</span>\n                    ${i}\n                </li>\n            `);o.append(d),a.set(t,d)}})),d.forEach((e=>{console.log(`Removing room item for ${e}`),a.get(e)?.remove(),a.delete(e)}));let r=null;n.forEach((e=>{const t=a.get(e.pond_id);if(t){if(r){const s=r.next();s.length&&s.data("pond")===e.pond_id||(console.log(`Moving ${e.pond_id} after ${r.data("pond")}`),t.insertAfter(r))}else{const s=o.children().first();s.length&&s.data("pond")===e.pond_id||(console.log(`Moving ${e.pond_id} to top`),t.prependTo(o))}r=t}})),null!==s&&(console.log(`Ensuring only ${s} has .aim-room-active`),o.find(".aim-room-item").not(`[data-pond="${s}"]`).removeClass("aim-room-active"),a.get(s)&&a.get(s).addClass("aim-room-active"))}function h(e){const t=e.chatId;if(!t)return void console.log("No chatId provided for updating pond connected users");let s=t.replace("pond/","");const o=$(`.aim-user-list[data-context="${s}"][data-type="pond"] .aim-user-list-items`);if(!o.length)return void console.log(`No .aim-user-list-items found for chatId: ${t}`);const n=new Set;o.find(".aim-user-item").each(((e,t)=>{let s=$(t).data("username");s?(s=s.toString(),n.add(s)):$(t).remove()})),(e.users||[]).forEach((e=>{let{userId:t,profilePicture:s}=e;if(t=t?t.toString():null,!t||"string"!=typeof t)return void console.log("Skipping invalid user with missing or non-string userId:",e);const i=$(`.aim-user-item[data-username="${t}"]`,o);if(i.length){const e=i.find(".aim-user-item-text");e.text()!==t&&e.text(t);const o=i.find(".aim-profile-picture"),a=g.call(this,t,s,o);a&&o.empty().append(a.html()),n.delete(t)}else{const e=$("<li>",{class:"aim-user-item","data-username":t}),n=g.call(this,t,s),i=$("<span>",{class:"aim-user-item-text",text:t});e.append(n,i),o.append(e)}})),n.forEach((e=>{e=e.toString(),$(`.aim-user-item[data-username="${e}"]`,o).remove()}))}function g(e,t,s=null){const o=$("<div>",{class:"aim-profile-picture"});if(t){const n=$("<img>",{class:"aim-chat-message-profile-picture-img",src:t,alt:`${e}'s avatar`});if(n.attr("draggable","false"),o.append(n),s){const e=s.find(".aim-chat-message-profile-picture-img");if(e.length&&e.attr("src")===t)return null}}else{const t=this.defaultAvatarSvg(e);if(o.html(t),s){if(s.html().trim()===t.trim())return null}}return o}function b({windowType:e,contextName:t,windowTitle:s,windowId:o,client:n,data:i}){const a=y.call(this,e,t,s,o,i),d=this.bp.apps.ui.windowManager.createWindow({...a,onOpen:async s=>{await f.call(this,e,t,s,n)},onClose:s=>{if("pond"===e){if($(".aim-room-list-items",d.content).find(".aim-room-item").each(((e,t)=>{const s=$(t).data("context");n.removeSubscription("pond",s)})),this.data.activePonds=[],"pond-chat"===s.id)for(let[e,t]of bp.apps.client.messagesWsClients)e.startsWith("pond/")&&t.wsClient.closeConnection()}else n.removeSubscription(e,t)}});return"pond"===e&&(W.call(this,d,n),$(".no-open-ponds",d.content).hide(),$(".aim-message-controls",d.content).flexShow()),d.loggedIn=!0,d}function y(e,t,s,o,n){const i="buddy"===e;let a=i?"":"desktop/assets/images/icons/icon_pond_64.png";i&&this.bp.apps.buddylist.data.profileState?.buddylist?.[t]?.profile_picture&&(a=this.bp.apps.buddylist.data.profileState.buddylist[t].profile_picture);let d=i?500:Math.floor(.8*window.innerHeight),r=i?600:Math.floor(.75*window.innerWidth);return this.bp.isMobile()&&(d="calc(var(--vh) * 90)"),{app:"buddylist",id:o,title:i?t:s,icon:a,type:e,context:t,parent:this.bp.apps.ui.parent,className:"chatWindow",x:n.x||10,y:50,width:r,height:d}}async function f(e,t,s,o){if(console.log("initializeChatWindow",e,t,s),x.call(this,e,t,s,o),o.addSubscription(e,t),"buddy"===e&&(console.log(`Opening buddy chat window for: ${t}`),$(".aim-chat-area",s.content).css("margin-top","0"),$(".aim-chat-area",s.content).css("top","10px"),I.call(this,t)),"pond"===e){let e=this.bp.apps?.pond?.data?.hotPonds||[];u.call(this,e,s,t),C.call(this,t,s)}await w.call(this,t,s),this.bp.isMobile()||function(e){function t(){const s=$(".aim-input",e.content);0!==s.length?s.focus():setTimeout(t,100)}t()}(s)}function I(e){this.data.profileState?.buddylist?.[e]?.newMessages&&(this.data.profileState.buddylist[e].newMessages=!1,this.client.receivedInstantMessage(e,((e,t)=>{})))}async function w(e,t){this.data.processedMessages[e]=this.data.processedMessages[e]||[];const s=[...this.data.processedMessages[e]];this.data.processedMessages[e]=[];for(const e of s)try{await this.renderChatMessage(e,t,!0)}catch(s){console.error("Error rendering message",e,s,t)}}function v(e,t,s){const o=$(".aim-chat-area",t.content),n=$(".aim-user-list-area",t.content);if(!o.length||!n.length)return void console.log("Missing chatArea or userListArea for context:",e);const i=e.replace("pond/","");if(!$(`.aim-messages-container[data-context="${e}"]`,o).length){console.log("Creating new messages container for context:",e);const n=document.createElement("div");n.className="aim-messages-container",n.setAttribute("data-context",e),n.setAttribute("data-type","pond"),n.style.display="none",n.innerHTML=`\n            <div class="aim-messages-header">\n                <h2 class="aim-chat-title"><span class="aim-chat-username">#${i}</span></h2>\n                <button class="aim-close-chat-btn" data-context="${e}">Close</button>\n            </div>\n            <div class="aim-no-messages">\n                Your conversation has just started. You can send a message using the form below.\n            </div>\n            <div class="aim-messages"></div>\n        `,o.append(n),s.addSubscription("pond",e),this.data.activePonds=this.data.activePonds||[],this.data.activePonds.includes(e)||this.data.activePonds.push(e),$(".no-open-ponds",t.content).hide(),$(".aim-message-controls",t.content).flexShow()}if(!$(`.aim-user-list[data-context="${i}"][data-type="pond"]`,n).length){console.log("Creating new user list for context:",i);const e=document.createElement("div");e.className="aim-user-list",e.setAttribute("data-context",i),e.setAttribute("data-type","pond"),e.style.display="none",e.innerHTML='\n            <div class="aim-user-list-header">\n                <h3>Buddies</h3>\n            </div>\n            <ul class="aim-user-list-items"></ul>\n        ',n.append(e)}}function C(e,t){const s=$(".aim-chat-area",t.content),o=$(".aim-user-list-area",t.content);if(!s.length||!o.length)return void console.log("Missing chatArea or userListArea for context:",e);$(".aim-messages-container",s).hide(),$(".aim-user-list",o).hide();const n=e.replace("pond/","");t.currentActiveContext=n;const i=$(`.aim-messages-container[data-context="${e}"][data-type="pond"]`,s),a=$(`.aim-user-list[data-context="${n}"][data-type="pond"]`,o);if(i.length||(console.log("Creating messages container for context:",e),v.call(this,e,t,this.bp.apps.client),i=$(`.aim-messages-container[data-context="${e}"][data-type="pond"]`,s)),i.length&&i.show(),a.length&&a.show(),!i.length||!a.length){const e=$(".aim-messages-container",s);if(e.length>0){const n=e.first().data("context"),i=n.replace("pond/","");$(`.aim-messages-container[data-context="${n}"]`,s).show(),$(`.aim-user-list[data-context="${i}"][data-type="pond"]`,o).show(),$(".aim-room-item",t.content).removeClass("aim-room-active"),$(`.aim-room-item[data-context="${n}"]`,t.content).addClass("aim-room-active"),$(".message_form .aim-to",t.content).val(n)}else console.log("No available message containers or user lists")}let d=$(".button-bar",t.content);d.length&&d.children().each(((t,s)=>{$(s).attr("data-context",e)})),this.scrollToBottom(t.content)}function x(e,t,s,o){const n=this.messageTemplateString,i=document.createElement("div");i.innerHTML=n;const r=$(".aim-messages-container",i)[0];if(r.setAttribute("data-context",t),r.setAttribute("data-type",e),"buddy"===e)$(".aim-user-list-area",i).remove(),$(".aim-room-list",i).remove(),$(".aim-messages-header",i).remove(),s.container.classList.add("has-droparea"),s.content.appendChild($(".aim-window",i)[0]);else{const c=$(".aim-user-list",i)[0];c.setAttribute("data-context",t),c.setAttribute("data-type",e),this.bp.isMobile()?($(".aim-close-chat-btn",i).text("Close #"+t.replace("pond/","")),$(".aim-chat-title",i).remove()):$(".aim-chat-title",i).text(`#${t.replace("pond/","")}`),$(".joinPondForm",i).on("submit",(e=>{e.preventDefault();try{let e=$(".customPondName").val();S.call(this,e)}catch(e){console.error("Error joining pond:",e)}return!1})),s.container.classList.add("has-droparea"),s.content.appendChild($(".aim-window",i)[0]);const p=$(".aim-window",s.content)[0];console.log("chatWindow.contentchatWindow.content",s.content),console.log("aimWindow",p);let u=0,h=0;function g(){const e=h-u;e>50?(p.classList.remove("show-room-list"),p.classList.add("show-user-list")):e<-50?(p.classList.remove("show-user-list"),p.classList.add("show-room-list")):p.classList.remove("show-room-list","show-user-list")}p.addEventListener("touchstart",(e=>{u=e.changedTouches[0].screenX})),p.addEventListener("touchend",(e=>{h=e.changedTouches[0].screenX,g()}));const b=document.createElement("div");b.className="pond-button-bar",b.setAttribute("data-context",t),b.setAttribute("data-type",e);const y=document.createElement("button");y.textContent="Ponds",y.className="toggle-room-list";const f=document.createElement("button");f.textContent="Buddies",f.className="toggle-user-list";const I=document.createElement("button");I.textContent="Close #"+t.replace("pond/",""),I.classList.add("aim-close-pond-chat-btn"),I.classList.add("aim-room-close-btn"),I.setAttribute("data-context",t),I.setAttribute("data-type",e),s.content.appendChild(b),s.content.append(y,I,f),W.call(this,s,o),y.addEventListener("click",(()=>{p.classList.toggle("show-room-list"),p.classList.remove("show-user-list")})),f.addEventListener("click",(()=>{p.classList.toggle("show-user-list"),p.classList.remove("show-room-list")}))}d.call(this,s),m.call(this,e,t,s),k.call(this,e,t,s),a.call(this,e,t,s);const l=$(".aim-close-chat-btn",s.content);l.length?l.attr("data-context",t):console.warn("No close button found in chat window for context:",t),"pond"===e&&($(".aim-user-list-items").on("click",(e=>{const t=$(e.target).closest(".aim-user-item").data("username");t?this.openChatWindow({name:t}):console.error("No username found in clicked element")})),L.call(this,s))}function k(e,t,s){$(".message_form .aim-to",s.content).val(t),$(".message_form",s.content).submit((async o=>{o.preventDefault(),await this.sendMessageHandler(o,s,e,t)}))}function L(e){$(".aim-room-list-items",e.content).on("click",".aim-room-item",(t=>{let s=$(t.target).parent().data("context");s?(s=s.replace("pond/",""),$(".aim-room-item",e.content).removeClass("aim-room-active"),$(t.target).addClass("aim-room-active"),v.call(this,s,e,this.bp.apps.client),$(".message_form .aim-to",e.content).val(s),C.call(this,s,e)):console.warn("No context found for clicked room item target",t.target)}))}function W(e,t){$(e.content).on("click",".aim-close-chat-btn, .aim-room-close-btn",(s=>{s.stopPropagation();const o=s.target.getAttribute("data-context");t.removeSubscription("pond",o),$(`.aim-messages-container[data-context="${o}"]`,e.content).remove(),$(`.aim-room-item[data-context="${o}"]`,e.content).remove(),$(`.aim-user-list[data-context="${o.replace("pond/","")}"][data-type="pond"]`,e.content).remove(),this.data.activePonds=this.data.activePonds.filter((e=>e!==o)),this.data.processedMessages[o]&&(this.data.processedMessages[o]=[]);const n=$(".aim-messages-container",e.content);if(n.length>0){const t=n.first().data("context");C.call(this,t,e),$(".aim-room-item",e.content).removeClass("aim-room-active"),$(`.aim-room-item[data-context="${t}"]`,e.content).addClass("aim-room-active"),$(".message_form .aim-to",e.content).val(t)}else $(".aim-messages-container",e.content).hide(),$(".message_form .aim-to",e.content).val("");const i=$(`.aim-room-item[data-context="pond/${o}"]`,e.content);$(".aim-room-list-item-name",i).removeClass("aim-room-active");0===$(".aim-messages-container",e.content).length?($(".no-open-ponds",e.content).flexShow(),$(".aim-message-controls",e.content).hide()):($(".no-open-ponds",e.content).hide(),$(".aim-message-controls",e.content).flexShow())}))}function S(e){if(!e)return void console.error("Pond name is required to join a pond.");if(n.containsBadWord(e))return void alert("Invalid pond name. Please choose a different name.");let t=this.bp.apps.ui.windowManager.getWindow("pond-chat");if(!t)return void console.error("Pond message main window not found, cannot join pond.");let s=`${e}`;v.call(this,s,t,this.bp.apps.client),$(".message_form .aim-to",t.content).val(s),C.call(this,s,t)}const M={"index.html":'\n<!DOCTYPE html>\n<html lang="en">\n<head>\n    <meta charset="UTF-8">\n    <meta name="viewport" content="width=device-width, initial-scale=1.0">\n    <title>My BuddyPond Profile</title>\n    <link rel="stylesheet" href="./style.css">\n</head>\n<body>\n    <h1>My Profile</h1>\n    <div class="profile-section">\n        <p>Welcome to my BuddyPond profile, hosted on the BuddyPond CDN!</p>\n        <p><strong>Customize Your Profile:</strong></p>\n        <ul>\n            <li>This default profile includes <code>index.html</code>, <code>style.css</code>, and <code>profile.js</code>.</li>\n            <li>You may use any files, the only requirement is <code>index.html</code> must be located in root.</li>\n            <li>Edit or upload files in the <strong>Buddy Files</strong> app (root directory).</li>\n            <li>Add any static files (HTML, CSS, JS, images) or projects (e.g., React, Vue).</li>\n            <li>Use relative paths (e.g., <code>./style.css</code>) to link files.</li>\n        </ul>\n        <p><strong>Example:</strong> Click to change text color.</p>\n        <button id="toggleButton">Toggle Text Color</button>\n        <p class="color-text">This text changes color!</p>\n    </div>\n    <script src="./profile.js"><\/script>\n</body>\n</html>',"style.css":"\nbody {\n    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n    background-color: #f4f4f9;\n    color: #333;\n    margin: 0;\n    padding: 20px;\n    line-height: 1.5;\n}\nh1 {\n    color: #007bff;\n    text-align: center;\n}\n.profile-section {\n    max-width: 600px;\n    margin: 0 auto;\n}\nul {\n    padding-left: 20px;\n    font-size: 0.9em;\n}\ncode {\n    background: #f0f0f0;\n    padding: 2px 4px;\n    border-radius: 3px;\n}\nbutton {\n    background-color: #007bff;\n    color: white;\n    padding: 8px 16px;\n    border: none;\n    border-radius: 4px;\n    cursor: pointer;\n    display: block;\n    margin: 10px auto;\n}\nbutton:hover {\n    background-color: #0056b3;\n}\n.color-text {\n    font-size: 1.1em;\n    text-align: center;\n    transition: color 0.3s ease;\n}\n.color-text.toggled {\n    color: #dc3545;\n}","profile.js":"\nconst text = document.querySelectorAll('.color-text');\nconst button = document.getElementById('toggleButton');\nbutton.addEventListener('click', () => {\n    text.forEach(item => item.classList.toggle('toggled'));\n});\n"};function J(e){return e.endsWith(".html")?"text/html":e.endsWith(".css")?"text/css":e.endsWith(".js")?"application/javascript":"text/plain"}function N(e,t){E.call(this,e,t),"more-options"!==e&&B.call(this)}function Z(e,t){const s=t.closest(".aim-editable-container")?.querySelector(".aim-message-content");if(!s)return void console.error("No message content found for edit hint action");const o=s.closest(".aim-chat-message")?.getAttribute("data-uuid"),n=document.querySelector(`.aim-chat-message[data-uuid="${o}"]`);if(!n)return void console.error("No original message found");const i={uuid:o,chatId:n.getAttribute("data-chat-id"),text:n.getAttribute("data-original-text")||s.innerText};"cancel-edit"===e?R.call(this,s,i.text):"save-edit"===e&&j.call(this,s,i)}function B(){this.activeMessageContextMenu&&(this.activeMessageContextMenu.remove(),this.activeMessageContextMenu=null),this.activeMessageHoverMenu&&(this.activeMessageHoverMenu=null),this.activeReplyBox}function E(e,t){const s=t.closest(".aim-context-menu")||t.closest(".aim-chat-message");if(!s)return void console.error("No closest target found");const o=s.getAttribute("data-uuid"),n={uuid:o,chatId:s.getAttribute("data-chat-id"),from:s.getAttribute("data-from")},i=document.querySelector(`.aim-chat-message[data-uuid="${o}"]`);if(i)if(n.text=i.querySelector(".aim-message-content").innerText,n.uuid&&n.chatId)switch(e){case"add-reaction":console.log("Add reaction clicked");break;case"edit-message":A.call(this,n);break;case"reply-message":T.call(this,n,i);break;case"more-options":event.preventDefault();const s=t.closest(".aim-chat-message");console.log("closestMessage",s),s&&this.createMessageContextMenu(t,s);break;case"quote-message":console.log("Quote message clicked");break;case"say-message":console.log("Say message clicked"),console.log("sayMessage",n),this.bp.emit("say::message",n);break;case"report-message":console.log("Report message clicked");break;case"copy-message":console.log("Copy message clicked");break;case"delete-message":Y.call(this,n);break;case"cast-spell":this.bp.open("spellbook",{context:n.from,output:"buddy"});break;default:console.error(`Unknown action: ${e}`)}else console.error("No message data found");else console.error("No original message found")}function Y(e){console.log("Deleting message",e),buddypond.removeInstantMessage(e)}function A(e){const t=document.querySelector(`.aim-chat-message[data-uuid="${e.uuid}"] .aim-message-content`);if(!t)return void console.error("No message content found");this.bp.ignoreUIControlKeys=!0;const s=e.text,o=document.createElement("div");o.className="aim-editable-container",t.parentNode.insertBefore(o,t),o.appendChild(t),t.closest(".aim-chat-message").setAttribute("data-original-text",s),t.setAttribute("contenteditable","true"),t.setAttribute("data-editing","true"),t.focus();const n=document.createElement("div");n.className="aim-edit-hint",n.innerHTML='\n    <span class="aim-edit-hint-action" data-action="cancel-edit">escape</span> to cancel • \n    <span class="aim-edit-hint-action" data-action="save-edit">enter</span> to save\n  ',o.appendChild(n);const i=t.closest(".chatWindow");this.scrollToBottom(i);const a=o=>{"Escape"===o.key?(R.call(this,t,s),r(),o.preventDefault(),o.stopPropagation()):"Enter"===o.key&&(j.call(this,t,e),r(),o.preventDefault(),o.stopPropagation())},d=e=>{console.log("handleBlur",e.relatedTarget,e.target.classList),e.relatedTarget&&!e.relatedTarget.classList.contains("aim-edit-hint-action")&&(R.call(this,t,s),r())},r=()=>{t.removeEventListener("keydown",a),t.removeEventListener("blur",d),this.bp.ignoreUIControlKeys=!1};t.addEventListener("keydown",a),t.addEventListener("blur",d),console.log("Editing message",e)}function R(e,t,s=!0){const o=e.closest(".aim-editable-container");o&&(o.parentNode.insertBefore(e,o),o.remove()),e.setAttribute("contenteditable","false"),e.removeAttribute("data-editing"),s&&(e.innerText=t),e.blur();const n=e.closest(".aim-chat-message");n&&n.removeAttribute("data-original-text"),console.log("Edit cancelled"),this.bp.ignoreUIControlKeys=!1}async function j(e,t){const s=e.closest(".aim-editable-container");s&&console.log("Editable container found",s);const o=e.innerText;e.setAttribute("contenteditable","false"),e.removeAttribute("data-editing"),e.blur();const n=e.closest(".aim-chat-message");n&&n.removeAttribute("data-original-text"),console.log("Edit saved",o),await buddypond.editInstantMessage({from:t.from,chatId:t.chatId,uuid:t.uuid,text:o}),R.call(this,e,null,!1)}function T(e,t){this.activeReplyBox&&(this.activeReplyBox.remove(),this.activeReplyBox=null),this.bp.ignoreUIControlKeys=!0,this.bp.replyData=e;const s=document.createElement("div");s.className="aim-reply-box",s.innerHTML=`\n    <span class="aim-reply-header">Replying to ${e.from}</span>\n    <button class="aim-reply-cancel" data-action="cancel-reply">Cancel</button>\n  `,console.log("originalMessage",t);const o=$(t).parent().parent().parent().parent().find(".aim-message-sender")[0];if(console.log("REEE messageSender",o),!o)return void console.error("No message sender found");o.parentNode.insertBefore(s,o),this.activeReplyBox=s;const n=s.closest(".chatWindow").querySelector('input[name="message_replyto"]'),i=s.closest(".chatWindow").querySelector('textarea[name="message_text"]');n?n.value=e.uuid:console.error("No reply input found"),i?i.focus():console.error("No message text input found");const a=t.closest(".chatWindow");a&&this.scrollToBottom(a);const d=e=>{"Escape"===e.key?(G.call(this,s),r(),e.preventDefault(),e.stopPropagation()):"Enter"===e.key&&(r(),e.preventDefault(),e.stopPropagation())},r=()=>{i.removeEventListener("keydown",d),this.bp.ignoreUIControlKeys=!1};i.addEventListener("keydown",d),console.log("Reply mode activated",e)}function G(e){if(console.log("Cancel reply",e),console.log("aimReplyBox",e),e){const t=e.closest(".chatWindow").querySelector('input[name="message_replyto"]');t?t.value="":console.error("No reply input found"),e.remove(),this.activeReplyBox=null,this.bp.ignoreUIControlKeys=!1,this.bp.replyData=null}console.log("Reply cancelled")}function X(){document.addEventListener("click",(e=>{let t=e.target;if($(t).parents().hasClass("aim-profile-picture")){const e=t.closest(".aim-chat-message");if(!e)return;let s=e.getAttribute("data-from");console.log("Profile picture clicked",s),s===this.bp.me?this.bp.open("profile",{context:"edit"}):this.bp.open("user-profile",{context:s})}}))}class P{constructor(e,t={}){return this.bp=e,this.config={host:"",api:""},this.api=buddypond,this.reconnectAttempts=0,this.maxReconnectAttempts=999999,this.maxBackoffDelay=1e4,this.isIntentionallyClosed=!1,this}}function F(){return(new Date).getTime()}P.prototype.connect=async function(){console.log("Connecting to BuddyList WebSocket..."),this.wsClient=await this.createWebSocketClient(),console.log("Connected to BuddyList WebSocket!"),this.bp.emit("buddylist::connected",this.wsClient)},P.prototype.disconnect=async function(){console.log("Attempting disconnecting from BuddyList WebSocket..."),this.wsClient?(this.wsClient.closeConnection(),this.wsClient=null,console.log("Disconnected from BuddyList WebSocket")):console.log("No active WebSocket connection to disconnect")},P.prototype.addBuddy=async function(e,t){console.log("NEW Calling addBuddy",this,e),function(e,t,s,o){let n;n=buddypond.endpoint+e;let i={Accept:"application/json","Content-Type":"application/json; charset=utf-8","X-Me":buddypond.me};buddypond.qtokenid&&(i.Authorization=`Bearer ${buddypond.qtokenid}`);let a=JSON.stringify(s);const d={method:t,headers:i,body:a},r=new AbortController,l=setTimeout((()=>r.abort()),3e4);buddypond.incrementPackets("packetsSent");let c={start:new Date};fetch(n,{...d,signal:r.signal}).then((e=>(clearTimeout(l),e.ok?e.json():e.json().then((t=>{const s=new Error(`HTTP ${e.status}: ${e.statusText}`);throw s.status=e.status,s.data=t,s}))))).then((e=>{buddypond.incrementPackets("packetsReceived"),c.end=new Date,buddypond.addPerfTime(c),o(null,e)})).catch((e=>{let t="Fetch connection error. Retrying shortly.";t="AbortError"===e.name?"Fetch request timeout":e.message.includes("Payload Too Large")?"File upload was too large. Try a smaller file.":400===e.status&&e.data?e.data.error||e.data.message||"Invalid input. Please try again.":e.message,console.error("❌ API Request Failed:",e),o(new Error(t),e.data||null)}))}("/buddylist/"+this.bp.me+"/add-buddy","POST",{buddyname:e},(function(e,s){t(e,s)}))},P.prototype.receivedInstantMessage=async function(e,t){this.wsClient.send(JSON.stringify({action:"receivedInstantMessage",buddyname:e})),t(null)},P.prototype.setStatus=async function(e,t,s=function(){}){this.wsClient.send(JSON.stringify({action:"setStatus",buddyname:e,status:t.status,profilePicture:t.profilePicture})),s(null)},P.prototype.createWebSocketClient=function(){return console.log("Creating WebSocket client for buddylist"),new Promise(((e,t)=>{const s=new WebSocket(`${buddypond.buddylistWsEndpoint}?me=${buddypond.me}&qtokenid=${buddypond.qtokenid}`),o=()=>{console.log("WebSocket connection opened to buddylist"),this.reconnectAttempts=0,this.wsClient=s,s.send(JSON.stringify({action:"getProfile",buddyname:buddypond.me,qtokenid:buddypond.qtokenid})),bp.emit("buddylist-websocket::connected"),e(s)},n=e=>{try{const t=JSON.parse(e.data);switch(t.action){case"buddy_added":bp.emit("profile::buddy::in",{name:t.buddyname,profile:t.profile||{ctime:(new Date).getTime(),dtime:0}});break;case"getRemoteProfiles":t.profile&&t.profile.buddylist?bp.emit("profile::fullBuddyList",t.profile):console.error("getProfile message received but no buddylist:",t);break;case"getProfile":t.profile&&t.profile.buddylist?bp.emit("profile::fullBuddyList",t.profile):console.error("getProfile message received but no buddylist:",t),console.log("Requesting remote profile backfill for all buddies"),s.send(JSON.stringify({action:"getRemoteProfiles",buddyname:buddypond.me,qtokenid:buddypond.qtokenid}));break;case"ping":break;case"buddy_removed":console.log("buddy_removed WebSocket message received:",t),this.bp.emit("profile::buddy::out",{name:t.buddyname});break;case"rewards:response":t.success?bp.emit("buddylist-websocket::reward",{success:!0,message:t.message,reward:t.reward}):bp.emit("buddylist-websocket::reward",{success:!1,message:t.message});break;case"getCoinBalance":t.success,bp.emit("buddylist-websocket::coinBalance",t);break;default:console.log("Last message:",e.data),console.warn("Unknown action received:",t)}}catch(t){console.log("Last message:",e.data),console.error("Error parsing WebSocket message:",t),bp.emit("buddylist-websocket::error",{error:"Message parsing failed"})}},i=e=>{if(console.log("WebSocket connection closed to","buddylist","Code:",e.code,"Reason:",e.reason),clearInterval(this.updateStatusInterval),bp.emit("buddylist-websocket::disconnected",{code:e.code,reason:e.reason}),!this.isIntentionallyClosed&&this.reconnectAttempts<this.maxReconnectAttempts){const e=Math.min(200*Math.pow(2,this.reconnectAttempts)*(1+.1*Math.random()),this.maxBackoffDelay);console.log(`Scheduling reconnect attempt ${this.reconnectAttempts+1} for buddylist in ${e}ms`),setTimeout((async()=>{this.reconnectAttempts++,bp.emit("buddylist-websocket::reconnecting",{attempt:this.reconnectAttempts});try{const e=await this.createWebSocketClient();Object.assign(s,e),this.wsClient=e}catch(e){console.error("Reconnect failed:",e)}}),e)}else this.reconnectAttempts>=this.maxReconnectAttempts&&(console.error(`Max reconnect attempts (${this.maxReconnectAttempts}) reached for buddylist. Giving up.`),bp.emit("buddylist-websocket::reconnect_failed"))},a=e=>{console.error("WebSocket error buddylist",e),bp.emit("buddylist-websocket::error",{error:"WebSocket error"}),s.readyState!==WebSocket.OPEN&&t(new Error("WebSocket connection failed")),s.close(1e3,"Error occurred")};s.addEventListener("open",o.bind(this)),s.addEventListener("message",n.bind(this)),s.addEventListener("close",i.bind(this)),s.addEventListener("error",a.bind(this)),s.closeConnection=()=>{this.isIntentionallyClosed=!0,console.log("Intentionally closing WebSocket for buddylist"),s.close(1e3,"Normal closure"),s.removeEventListener("open",o),s.removeEventListener("message",n),s.removeEventListener("close",i),s.removeEventListener("error",a),bp.emit("buddylist-websocket::closed")}}))};class V{constructor(e,t={}){this.bp=e,this.data={processedMessages:{},profileState:{me:null,status:null,profilePicture:null,updates:{}},avatarCache:new Map},this.defaultPond="Buddy",this.subscribedBuddies=[],this.subscribedPonds=[],this.options=t,e.apps.buddyscript&&e.apps.buddyscript.commands&&(this.options.autocomplete=e.apps.buddyscript.commands),this.showedHelp=!1,this.bp.logout=this.logout.bind(this),this.options.chatWindowButtons=this.options.chatWindowButtons||function(e){return[{text:"Image Search",image:"desktop/assets/images/icons/icon_image-search_64.png",onclick:async t=>{let s=t.target.dataset.context,o=t.target.dataset.type;return e.open("image-search",{output:o||"buddy",context:s,provider:"giphy-stickers"}),!1}},{text:"BuddySound",image:"desktop/assets/images/icons/icon_soundrecorder_64.png",onclick:t=>{console.log("BuddySound button clicked",t);let s=t.target.dataset.context,o=t.target.dataset.type;e.open("soundrecorder",{type:o||"buddy",output:o||"buddy",context:s})}},{text:"BuddyPaint",image:"desktop/assets/images/icons/icon_paint_64.png",onclick:t=>{let s=t.target.dataset.context,o=t.target.dataset.type;e.open("paint",{type:o||"buddy",output:o||"buddy",context:s})}},{text:"BuddySnap",image:"desktop/assets/images/icons/svg/1f4f7.svg",onclick:t=>{let s=t.target.dataset.context,o=t.target.dataset.type;e.open("camera",{type:o||"buddy",output:o||"buddy",context:s})}},{text:"BuddyEmoji",image:"desktop/assets/images/icons/svg/1f600.svg",className:"emojiPicker",onclick:async e=>{let t=$(e.target);$(".emoji-picker-popup").length>0&&$(".emoji-picker-popup").remove(),t.emojiPicker({onSelect:e=>{console.log("Selected:",e);let s=t.closest(".aim-message-controls");$(".aim-input",s).val(((t,s)=>s+e)).trigger("input").focus()}}),t.data("emojiPicker_show")?.(),$(".emoji-picker-popup").length>0&&$(".emoji-search").focus()}},{text:"BuddyCall",type:"buddy-only",image:"desktop/assets/images/icons/icon_phone_64.png",onclick:t=>{let s=t.target.dataset.context,o=t.target.dataset.type;e.open("videochat",{type:o||"buddy",output:o||"buddy",context:s,isHost:!0});let n={from:e.me,to:s,text:"Let's have a video call",type:"buddy",card:{type:"videochat"}};console.log("BuddyCall message",n),buddypond.sendCardMessage(n,(function(e,t){e?console.error("Error sending message",e):console.log("Message sent",t)}))}},{text:"Spellbook",image:"desktop/assets/images/icons/icon_spellbook_64.png",onclick:t=>{t.preventDefault(),t.stopPropagation();let s=t.target.dataset.context,o=t.target.dataset.type;e.open("spellbook",{type:o||"buddy",output:o||"buddy",context:s})}},{text:"BuddyCoins",image:"desktop/assets/images/icons/icon_coin_64.png",onclick:t=>{let s=t.target.dataset.context,o=t.target.dataset.type;e.open("portfolio",{type:o||"buddy",output:s,context:"#portfolio-transfer"})}},{text:"Dictate",env:"desktop-only",image:"desktop/assets/images/icons/icon_dictate_64.png",onclick:async t=>{let s=t.target.dataset.context,o=t.target.dataset.type,n=$(".aim-input",$(t.target).parent().parent());await e.open("dictate",{type:o||"buddy",output:o||"buddy",context:s,targetEl:n})}},{text:"BuddyHelp",image:"desktop/assets/images/icons/icon_help_64.png",align:"right",onclick:t=>{let s=t.target.dataset.context,o=t.target.dataset.type,n=("pond"===o?"pond_message_-":"messages/")+s;"pond"===o&&(n="pond-chat");let i=e.apps.ui.windowManager.getWindow(n);console.log("chatWindow",i);let a=i.content.querySelector(".aim-input"),d=i.content.querySelector(".aim-send-btn");a&&(a.value="/help",a.dispatchEvent(new Event("input",{bubbles:!0}))),d&&d.click()}}]}(this.bp);let s=this.bp.apps.desktop.enabledChatWindowButtons;s&&Array.isArray(s)&&s.forEach((e=>{let t=this.bp.apps.desktop.appList[e.name];t&&t.chatButton&&this.options.chatWindowButtons.push(t.chatButton)})),this.opened=!1,this.showingIsTyping=this.showingIsTyping||{},this.activeMessageContextMenu=null,this.faucetAttempts=0}async init(){window.addEventListener("beforeunload",(e=>{this.client&&this.client.setStatus(this.bp.me,{status:"offline"},(function(e,t){console.log("buddypond.setStatus",e,t)}))})),await this.bp.appendScript("/v5/apps/based/buddylist/vendor/marked.min.js"),this.bp.vendor.dicebear=await this.bp.importModule("/v5/apps/based/buddylist/vendor/dicebear.core.js",{},!1),this.bp.vendor.dicebearAvatars=await this.bp.importModule("/v5/apps/based/buddylist/vendor/dicebear.identicon.js",{},!1),await bp.load("emoji-picker"),this.bindMessageContextMenu()}async open(e={type:"buddylist-profile"}){if("string"!=typeof e.type&&(e.type="buddylist-profile"),"buddylist-profile"===e.type){if(this.opened)return this.buddyListWindow.open(),this.bp.apps.ui.windowManager.focusWindow(this.buddyListWindow),this.buddyListWindow.restore(),$('.loginForm input[name="username"]').focus(),"buddylist already open";this.opened=!0;const e=await this.bp.fetchHTMLFragment("/v5/apps/based/buddylist/buddylist.html");this.messageTemplateString=await this.bp.fetchHTMLFragment("/v5/apps/based/buddylist/message.html"),this.bp.appendCSS("/v5/apps/based/buddylist/buddylist.css"),this.bp.appendCSS("/v5/apps/based/buddylist/messages.css"),await this.bp.importModule("affirmations");const t=this.createBuddyListWindow();return t.content.appendChild(this.createHTMLContent(e)),this.buddyListWindow=t,!0!==this.eventsBound&&this.registerEventHandlers(),this.buddylistUIEvents(),this.handleAuthentication(),this.eventsBound=!0,"hello buddyList"}"pond"===e.type&&(console.log("BuddyList open config.type is pond",e),this.openChatWindow(e)),"chat"!==e.type&&"buddy"!==e.type||this.openChatWindow(e)}createBuddyListWindow(){let e=window.innerWidth-250;return this.bp.apps.ui.windowManager.createWindow({app:"buddylist",type:"buddylist-profile",title:"Buddy List",icon:"/desktop/assets/images/icons/icon_profile_64.png",id:"buddylist",parent:this.bp.apps.ui.parent,width:250,height:500,x:e,y:50,onOpen:()=>{$('.loginForm input[name="username"]').focus()},onClose:()=>{this.opened=!1,this.client&&(this.client.disconnect(),this.client=null)}})}registerEventHandlers(){this.bp.on("auth::qtoken","handle-auth-success",(e=>this.handleAuthSuccess(e))),this.bp.on("auth::qtoken","load-user-apps",(e=>this.loadUserApps())),this.bp.on("auth::qtoken","generate-default-profile-files",(e=>{setTimeout((()=>{try{this.generateDefaultProfile(e)}catch(e){console.error("generate-default-profile-files",e)}}),6e3)})),this.bp.on("buddylist-websocket::connected","update-buddylist-connected",(e=>{$(".onlineStatusSelect").val("online"),$(".loggedOut").flexHide(),$(".loggedIn").flexShow(),this.bp.apps.buddylist.client.wsClient.send(JSON.stringify({action:"getCoinBalance",buddyname:this.bp.me,qtokenid:this.bp.qtokenid}))})),this.bp.on("profile::buddylist","process-buddylist",(e=>this.processBuddylist(e.data))),this.bp.on("profile::buddy::in","render-or-update-buddy-in-buddylist",(e=>this.renderOrUpdateBuddyInBuddyList(e))),this.bp.on("profile::buddy::out","remove-buddy-from-buddylist",(e=>{console.log("profile::buddy::out",e);const t=e.name;let s=$(`li[data-buddy="${t}"]`,".buddylist");console.log("buddyListItem",s),s.remove()})),this.bp.on("profile::fullBuddyList","render-or-update-buddy-in-buddylist",(e=>{let t=e.buddylist||{};console.log("profile::buddy::full_profile",e);for(let e in t){let s={name:e,profile:t[e]};this.data.profileState=this.data.profileState||{},this.data.profileState.buddylist=this.data.profileState.buddylist||{},this.data.profileState.buddylist[e]=s.profile,this.renderOrUpdateBuddyInBuddyList(s)}t[this.bp.me]&&(t[this.bp.me].profile_picture&&(this.data.profileState.profilePicture=t[this.bp.me].profile_picture),t[this.bp.me].status&&(this.data.profileState.status=t[this.bp.me].status)),e.email&&(this.data.profileState.email=e.email,$(".buddy_email").val(e.email)),"boolean"==typeof e.emailVerified&&(this.data.profileState.emailVerified=e.emailVerified,e.emailVerified?$(".buddy_email_verified_text").html("Email Verified"):$(".buddy_email_verified_text").html("Email Not Verified"))})),this.bp.on("buddy::message::processed","play-im-sound",(e=>{if(e.noAlert)return;let t=new Date(e.ctime);(new Date).getTime()-t.getTime()<5e3&&bp.play("desktop/assets/audio/IM.wav")})),this.bp.on("profile::buddy::newmessage","open-chat-window",(e=>{let t="messages/"+e.name;this.bp.apps.ui.windowManager.getWindow(t)||this.openChatWindow(e)})),this.bp.on("profile::buddy::newmessage","mark-messages-as-read",(e=>this.buddyReadNewMessages(e))),this.bp.on("profile::buddy::calling","start-call",(e=>{desktop.app.videochat.startCall(!1,e.name,(function(e,t){console.log("startCall callback",e,t)}))})),this.bp.on("profile::status","update-profile-status",(e=>{"signout"===e&&this.logout(),this.client.setStatus(this.bp.me,{status:e},(function(e,t){e&&console.error("error setting status",e)}))})),this.bp.on("buddy::messages","render-chat-message",(e=>this.handleChatMessages(e))),this.bp.on("buddy::sendMessage","send-buddy-message-to-server",(e=>this.sendMessageToServer(e))),this.bp.on("buddy::isTyping","show-is-typing-message",(e=>{if(!0===e.isTyping){if(e.from===this.bp.me)return;let t,s=new Date(e.ctime);(new Date).getTime();"buddy"===e.type&&(t=e.to===this.bp.me?`messages/${e.from}`:`messages/${e.to}`),"pond"===e.type&&(t="pond-chat");let o=this.bp.apps.ui.windowManager.getWindow(t);s.getTime();let n=`typing-${e.from}`,i=`${e.from} is typing...`;if("pond"===e.type&&o.currentActiveContext!==e.to)return void console.log("pond chat window is not active for this pond",e.to);let a=$(`.aim-typing span[data-user="${e.from}"]`,o.content);return 0===a.length?a=$("<span></span>").attr("data-user",e.from).text(i).appendTo($(".aim-typing",o.content)):a.text(i),this.showingIsTyping[n]&&clearTimeout(this.showingIsTyping[n]),void(this.showingIsTyping[n]=setTimeout((()=>{a.remove()}),500))}})),this.bp.on("buddy::typing","send-typing-message-to-server",(e=>{this.lastTypingMessage=this.lastTypingMessage||0,(new Date).getTime(),this.lastTypingMessage,this.lastTypingMessage=(new Date).getTime();let t="";if("buddy"===e.type){t="buddy/"+[e.from,e.to].sort().join("/")}"pond"===e.type&&(t="pond/"+e.to),bp.apps.client.sendWsMessage(t,{action:"send",chatId:t,buddyname:buddypond.me,qtokenid:buddypond.qtokenid,message:{...e,chatId:t,isTyping:!0}})})),this.bp.on("buddylist-websocket::reward","update-local-coin-balance",(e=>{if(e.success){if(q($("#menu-bar-coin-balance"),e.message.newBalance),this.bp.apps.portfolio&&this.bp.apps.portfolio.portfolioWindow&&this.bp.apps.portfolio.portfolioWindow.content&&this.bp.apps.portfolio.portfolioData){this.bp.apps.portfolio.updateCoinRow(e.message.symbol,{symbol:e.message.symbol,amount:e.message.newBalance,available:e.message.newBalance,price:.001,cost:.001*e.message.newBalance});let t=$("#coin-send-name"),s=$("#current-balance");if("GBP"===t.val()){const t=e.message.newBalance.toLocaleString("en-US");s.text(t)}}}else console.log(e.message)})),this.bp.on("buddylist-websocket::coinBalance","update-local-coin-balance",(async e=>{console.log("buddylist-websocket::coinBalance",e),"number"==typeof e.message.balance?q($("#menu-bar-coin-balance"),e.message.balance):(this.faucetAttempts++,this.faucetAttempts<3?(await this.requestDefaultCoinAllocations(),this.bp.apps.buddylist.client.wsClient.send(JSON.stringify({action:"getCoinBalance",buddyname:this.bp.me,qtokenid:this.bp.qtokenid}))):console.warn("BuddyList: Too many faucet attempts, not requesting balance again this session"))}))}createHTMLContent(e){const t=document.createElement("div");return t.innerHTML=e,$('.loginForm input[name="username"]').focus(),t}getLatestMessages(){const e={buddyname:this.subscribedBuddies.join(","),pondname:this.subscribedPonds.join(","),me:this.bp.me};this.bp.apps.client.sendMessage({id:F(),method:"getMessages",data:e})}buddyReadNewMessages(e){this.bp.log("BuddyReadNewMessages",e),e.name}async handleChatMessages(e){let t=new Set;for(const s of e.result.messages)try{s.from&&this.data.profileState&&this.data.profileState.buddylist&&this.data.profileState.buddylist[s.from]&&this.data.profileState.buddylist[s.from].newMessages&&(this.data.profileState.buddylist[s.from].newMessages=!1,this.client.receivedInstantMessage(s.from,(function(e,t){console.log("receivedInstantMessage",e,t)})));let e=await this.renderChatMessage(s);t.add(e)}catch(e){console.log("error rendering chat message",s,e)}for(const e of t)e&&e.content&&this.scrollToBottom(e.content);if(!0!==this.bp.settings["viewed-help-card"]&&!this.bp.isMobile()){let e=t.values().next().value;this.showCard({chatWindow:e,cardName:"help"}),this.showedHelp=!0}}sendMessageToServer(e,t=!1){this.bp.log("buddy::sendMessage",e),e.uuid=F(),""!==e.text?("pond"===e.type&&(console.log("sendMessageToServer",e),buddypond.pondSendMessage(e.to,e.text,e,(function(e,t){console.log("pondSendMessage",e,t),console.log(e,t)}))),"buddy"===e.type&&(console.log("sendMessageToServer",e),buddypond.sendMessage(e.to,e.text,e,(function(e,t){console.log("pondSendMessage",e,t),console.log(e,t)})))):console.log("will not sendMessageToServer: no text")}handleAuthentication(){const e=this.bp.apps.client.api,t=localStorage.getItem("qtokenid"),s=localStorage.getItem("me");t&&e.verifyToken(s,t,((e,o)=>{if(e)return console.error("Failed to verify token:",e),$(".password").show(),void $(".loginForm .error").text("Failed to authenticate buddy");console.log("verified token",o),o.success?(this.bp.emit("auth::qtoken",{qtokenid:t,me:s,hasPassword:o.user.hasPassword}),$(".loggedIn").flexShow(),$(".loggedOut").flexHide(),o.user.hasPassword||this.bp.open("pincode")):($(".loginForm .error").text("Failed to authenticate buddy"),$(".password").show(),console.error("Failed to authenticate buddy:"))}))}async handleAuthSuccess(e){this.client?console.error("buddylist websocket client already exists and has not been closed. This should not happen"):(this.bp.me=e.me,this.bp.qtokenid=e.qtokenid,this.data.profileState=this.data.profileState||{},this.data.profileState.me=this.bp.me,$("#me_title").html("Welcome "+this.bp.me),this.bp.play("desktop/assets/audio/WELCOME.mp3",{tryHard:1/0}),this.client=new this.Client(bp),await this.client.connect(),e.hasPassword||this.bp.open("pincode"),this.defaultPond&&setTimeout((()=>{this.openChatWindow({pondname:this.defaultPond}),bp.load("pond")}),100))}}function q(e,t){const s=t.toLocaleString("en-US"),o=s.split("");bp.isMobile()?e.text(s):(e.empty(),o.forEach(((t,s)=>{if(","===t)return void e.append('<span class="odometer-comma">,</span>');const o=$('<div class="odometer-digit"></div>'),n=$('<div class="odometer-digit-inner"></div>');for(let e=0;e<=9;e++)n.append(`<span>${e}</span>`);o.append(n),e.append(o),setTimeout((()=>{n.css({transition:"transform 0.5s ease-in-out",transform:`translateY(-${1*t}em)`})}),50+100*s)})))}V.prototype.renderOrUpdateBuddyInBuddyList=function(t){let s=this.bp,o=t.name,n=t.profile;this.bp.buddyTimeouts=this.bp.buddyTimeouts||{};let i=document.querySelectorAll(".buddylist li"),a=Array.from(i).find((e=>e.dataset.buddy===o)),d=!!a&&a.querySelector(".buddy-status").textContent.includes("🟢");if(n.hasOwnProperty("status")){"online"===n.status?n.isConnected=!0:n.isConnected=!1,this.bp.buddyTimeouts[o]&&(clearTimeout(this.bp.buddyTimeouts[o]),delete this.bp.buddyTimeouts[o]);let e=(new Date).getTime()-n.utime;if(n.isConnected&&e>18e6&&(n.isConnected=!1),o!==this.bp.me)if(n.isConnected&&!d){(new Date).getTime()-n.utime>300&&s.play("desktop/assets/audio/BUDDY-IN.mp3")}else n.isConnected}let r=n.hasOwnProperty("isConnected")?n.isConnected:d;n.newMessages&&n.newMessages&&(r=!0,this.bp.apps.buddylist.openChatWindow({context:o,type:"buddy"}));let l,c=r?"🟢":"🟠",p=n.isCalling?"<span>📞</span>":"",m=n.newMessages?"<span>💬</span>":"",u=n.utime?n.utime:0,h=new Date(u),g="";try{g="Last seen: "+h.toLocaleString("en-US",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!0})}catch(e){console.log("Error formatting last seen date",e)}if(a)l=a,l.dataset.utime=n.utime,l.title=g,l.querySelector(".buddy-status").innerHTML=`${m}${c}${p}`,l.querySelector(".message-buddy").textContent=o,l.style.display="hidden"===n.status?"none":"";else{let e=`<li data-buddy="${o}" data-utime="${n.utime}" class="buddy-message-sender" title="${g}">\n                          <span class="buddy-status">${m}${c}${p}</span> \n                          <span data-buddy="${o}" class="message-buddy" href="#" draggable="false">${o}</span>\n                        </li>`;l=document.createElement("div"),l.innerHTML=e,l=l.firstChild,"hidden"===n.status&&(l.style.display="none")}if(n.utime){let e=DateFormat.format.date(n.utime,"E MMMM dd, hh:mm:ss a");$(l).find(".buddy-status").attr("title",e)}a||$(".buddylist").append(l),this.sortBuddyList(),e.call(this,l)},V.prototype.createChatMessageElement=function(e,s,n,i){const a=document.createElement("div");a.className="aim-chat-message",a.setAttribute("data-id",e.id),a.setAttribute("data-from",e.from),a.setAttribute("data-to",e.to),a.setAttribute("data-type",e.type),a.setAttribute("data-uuid",e.uuid),a.setAttribute("data-chat-id",e.chatId);const d=document.createElement("div");if(d.className="aim-profile-picture",e.profilePicture||this.bp.apps.buddylist.data.profileState&&this.bp.apps.buddylist.data.profileState.buddylist&&this.bp.apps.buddylist.data.profileState.buddylist[e.from]&&this.bp.apps.buddylist.data.profileState.buddylist[e.from].profile_picture&&(e.profilePicture=this.bp.apps.buddylist.data.profileState.buddylist[e.from].profile_picture),e.profilePicture){const t=document.createElement("img");t.src=e.profilePicture,t.alt=`${e.from}'s avatar`,t.className="aim-chat-message-profile-picture-img",d.appendChild(t)}else{const t=this.defaultAvatarSvg(e.from);d.innerHTML=t}d.alt=`${e.from}'s avatar`;const r=document.createElement("div");r.className="aim-content-wrapper";const l=document.createElement("div");l.className="aim-message-header";const c=document.createElement("span");c.className="aim-sender",c.textContent="anonymous"===e.from?`Anonymous (${e.tripcode||"tr1pc0d3"})`:e.from;const p=document.createElement("span");p.className="aim-timestamp",p.textContent=s;const m=document.createElement("div");m.className="aim-message-meta";const u=function(e){if("outer space"!==e.location&&e.location||(e.location="AQ"),!e.location||"outer space"===e.location)return document.createElement("span");let t=document.createElement("img");return t.className="geoFlag",t.src=`desktop/assets/geo-flags/flags/4x3/${e.location.toLowerCase()}.svg`,t}(e),h=document.createElement("span");h.className="aim-badges",m.appendChild(u),m.appendChild(h),l.appendChild(c),l.appendChild(m),l.appendChild(p);let g=null;if(e.replyto){const t=n.content.querySelector(`.aim-chat-message[data-uuid="${e.replyto}"]`);if(t){const e=t.querySelector(".aim-sender")?.textContent||"Unknown",s=t.querySelector(".aim-message-content")?.innerText||"";g=document.createElement("div"),g.className="aim-reply-indicator",g.innerHTML=`\n        <span class="aim-reply-sender">${e}</span>\n        <span class="aim-reply-content">${s}</span>\n      `;g.querySelector(".aim-reply-sender").addEventListener("click",(()=>{t.scrollIntoView({behavior:"smooth",block:"center"}),t.classList.add("aim-highlight"),setTimeout((()=>t.classList.remove("aim-highlight")),2e3)}))}}const b=document.createElement("div");b.className="aim-message-content";const y=t(e.text);b.innerHTML=y;const f=o.call(this,e);return r.appendChild(l),g&&r.appendChild(g),r.appendChild(b),r.appendChild(f),a.appendChild(d),a.appendChild(r),i&&r.appendChild(i),a.querySelectorAll("img").forEach((e=>{e.addEventListener("load",(()=>{}))})),function(e,t,s){let o=e.content.querySelector(".aim-messages");"pond"===t.type&&(o=e.content.querySelector(`.aim-messages-container[data-context="${t.to}"] .aim-messages`));if(!o)return void console.error("aim-messages not found. user most likely not in the chat window");const n=Array.from(o.querySelectorAll(".aim-chat-message"));let i=!1;for(const e of n){const n=parseInt(e.getAttribute("data-id"),10);if(t.id<n){o.insertBefore(s,e),i=!0;break}}i||o.appendChild(s)}(n,e,a),a},V.prototype.renderChatMessage=async function(e,t){let s="default";if(e.text&&e.text.length>0&&(e.text=n.filter(e.text)),i(e),e.text&&e.text.length>0){let t=function(e){const t=function(e){const t={"&amp;":"&","&quot;":'"',"&lt;":"<","&gt;":">","&apos;":"'","&nbsp;":" "};return e.replace(/&[a-zA-Z0-9#]+;/g,(e=>t[e]||e))}(e),s=/(^|\s)#([a-zA-Z0-9\p{L}][a-zA-Z0-9\p{L}_-]*)/gu;return Array.from(t.matchAll(s),(e=>e[2]))}(e.text);t.length>0&&(e.card={type:"pond",pondNames:t})}let o=`messages/${e.to}`;if("buddy"===e.type&&(e.to===this.bp.me?(o=`messages/${e.from}`,s=e.from):(o=`messages/${e.to}`,s=e.to)),"pond"===e.type&&(s=e.to,o="pond-chat"),this.data.processedMessages[s]=this.data.processedMessages[s]||[],this.data.activeUsers=this.data.activeUsers||[],this.data.activeUsersInContext=this.data.activeUsersInContext||{},this.data.activeUsersInContext[s]=this.data.activeUsersInContext[s]||[],this.data.activePonds=this.data.activePonds||[],"pond"===e.type&&e.to&&!this.data.activePonds.includes(e.to)&&(this.data.activePonds.push(e.to),this.bp.emit("pond::activePondAdded",e.to)),"buddy"===e.type&&(e.to&&!this.data.activeUsers.includes(e.to)&&(this.data.activeUsers.push(e.to),this.bp.emit("buddy::activeUserAdded",e.to)),e.to&&!this.data.activeUsersInContext[s].includes(e.to)&&this.data.activeUsersInContext[s].push(e.to)),e.from&&!this.data.activeUsers.includes(e.from)&&(this.data.activeUsers.push(e.from),this.bp.emit("buddy::activeUserAdded",e.from)),e.from&&!this.data.activeUsersInContext[s].includes(e.from)&&this.data.activeUsersInContext[s].push(e.from),e.removed){console.log("ATTEMPTING TO REMOVE MESSAGE",e);let t=$(`.aim-chat-message[data-uuid="${e.removed}"]`);return void(t.length>0&&t.remove())}if(e.edited){console.log("ATTEMPTING TO EDIT MESSAGE",e);let t=$(`.aim-chat-message[data-uuid="${e.edited}"]`);if(!t.length>0)return void console.error("No original message found");let s=t.find(".aim-message-content");return void(s.length>0&&s.html(e.text))}let a=this.bp.apps.ui.windowManager.getWindow(o);if(t&&(a=t),!a||!a.content)return console.log("chat window not ready, trying again soon",o,e),void console.log(e);if(document.querySelector(`.chatMessage[data-uuid="${e.uuid}"]`))return;(new Date).getTime();let d,r=new Date(e.ctime).getTime();$(".aim-no-messages",a.content).remove();for(let t=0;t<this.data.processedMessages[s].length;t++)if(this.data.processedMessages[s][t].uuid===e.uuid)return a;if(this.data.processedMessages[s].length>5e3&&this.data.processedMessages[s].shift(),this.data.processedMessages[s].push(e),"agent"===e.type){if(desktop&&desktop.app&&desktop.app.spellbook&&desktop.app.spellbook[e.text])return void desktop.app.spellbook[e.text]();console.log("unknown agent message",e)}if(this.bp.apps.say&&e.text&&e.text.startsWith("/say")&&this.bp.apps.say.processMessages(e),r=this.bp.isMobile()?DateFormat.format.date(r,"hh:mm:ss a"):DateFormat.format.date(r,"E MMMM dd, hh:mm:ss a"),r=r.toString(),e.card&&this.bp&&this.bp.apps&&this.bp.apps.card){let t=e.card;if(Object.keys(t).length>0){t.message=e;let s=this.bp.apps.card.cardManager;const o=await s.loadCard(t.type,t,a);d=document.createElement("div"),d.classList.add("cardContainer"),await o.render(d)}}return this.bp,this.createChatMessageElement(e,r,a,d),"pond"===e.type?this.bp.emit("pond::message::processed",e):this.bp.emit("buddy::message::processed",e),a},V.prototype.renderBuddyRequests=function(e){$(".you_have_no_buddies").hide();let t=this.bp.apps.client.api;if(e){$(".pendingIncomingBuddyRequests").html(""),$(".pendingOutgoingBuddyRequests").html(""),$(".loading").remove();for(let t in e){let s=e[t];s=JSON.parse(s),s.to===this.bp.me?$(".pendingIncomingBuddyRequests").append("<li>"+s.from+' - <a href="#" class="approveBuddyRequest pointer" data-buddyname="'+s.from+'">Approve</a> / <a href="#" class="denyBuddyRequest pointer" data-buddyname="'+s.from+'">Remove</a> </li>'):$(".pendingOutgoingBuddyRequests").append("<li>"+s.to+' - <a href="#" class="denyBuddyRequest pointer" data-buddyname="'+s.to+'">Remove</a></li>')}$(".apiResult").val(JSON.stringify(e,!0,2)),this.data.pendingIncomingBuddyRequests=this.data.pendingIncomingBuddyRequests||0;let s=$(".pendingIncomingBuddyRequests li").length;s>this.data.pendingIncomingBuddyRequests&&(this.data.pendingIncomingBuddyRequests=s,setTimeout((function(){}),2222)),0===s?$(".pendingIncomingBuddyRequestsHolder").hide():$(".pendingIncomingBuddyRequestsHolder").show(),0==$(".pendingOutgoingBuddyRequests li").length?$(".pendingOutgoingBuddyRequestsHolder").hide():$(".pendingOutgoingBuddyRequestsHolder").show(),$(".denyBuddyRequest").on("click",(function(){return $(this).parent().hide(),t.denyBuddy($(this).attr("data-buddyname"),(function(e,t){$(".apiResult").val(JSON.stringify(t,!0,2))})),!1})),$(".approveBuddyRequest",".pendingIncomingBuddyRequests").on("click",(function(){$(this).parent().hide();let e=$(this).attr("data-buddyname");return t.approveBuddy(e,(function(e,t){$(".apiResult").val(JSON.stringify(t,!0,2))})),!1}))}},V.prototype.processBuddylist=async function(e){if(this.data.buddylist||(this.data.buddylist={}),this.data.buddyrequests||(this.data.buddyrequests={}),this.data.profileState&&Number(e.powerlevel)>Number(this.data.profileState.powerlevel)){bp.apps.powerlevel.popup.show(e.powerlevel,{duration:7777})}this.data.profileState={...e},e.system&&($(".totalConnectedCount").html(e.system.totalIsConnected),$(".totalOnlineCount").html(e.system.totalIsOnline)),e.ponds&&e.ponds.ponds&&e.ponds.ponds.forEach((function(e){let t=$("#pond_message_-"+e.name);t&&$(".window-title-text",t).html(e.name+" Pond ("+e.connected+")")})),function(e,t){let s=!1;if(e)for(let o in t){let n=t[o],i=o.replace("buddies/","");e.renderOrUpdateBuddyInBuddyList({name:i,buddydata:n,wasOnline:!1}),n.newMessages&&(e.bp.emit("profile::buddy::newmessage",{name:i}),e.data.profileState.buddylist["buddies/"+i]={newMessages:!1},s=!0),n.isCalling&&e.bp.emit("profile::buddy::calling",{name:i})}}(this,e.buddylist),function(e,t){t&&e.renderBuddyRequests(t)}(this,e.buddyrequests),this.bp.apps.client.api,e.updates=e.updates||{}},V.prototype.buddylistUIEvents=function(){let e=this.bp.apps.client.api,t=this.bp.apps.affirmations.affirmations;function s(){let e=t[Math.floor(Math.random()*t.length)];$(".positiveAffirmation").html(e)}$(".loginForm").submit((t=>{t.preventDefault(),$(".loginButton").prop("disabled",!0),$(".loginButton").addClass("disabled");let s=$('.loginForm input[name="username"]').val(),o=$('.loginForm input[name="password"]').val();return o||(o=s),e.authBuddy(s,o,(function(e,t){if(console.log("authBuddy",e,t),e)return t&&t.error?($(".loginStatus").html(t.error),"Incorrect password."===t.error&&$(".resetPasswordLink").show()):"Failed to fetch"===e.message?$(".loginStatus").text("Failed to connect to Buddy Pond"):$(".loginStatus").html(e.message||"Failed to authenticate buddy"),$(".loginButton").prop("disabled",!1),$(".loginButton").removeClass("disabled"),$(".password").show(),void console.error("Failed to authenticate buddy:",e);if(t.success)t.me=s,bp.emit("auth::qtoken",t),$(".loginForm .error").text("");else{if($(".loginButton").prop("disabled",!1),$(".loginButton").removeClass("disabled"),s===o)return $(".password").show(),void $(".password").focus();$(".loginForm .error").text("Failed to authenticate buddy"),$(".password").show(),console.error("Failed to authenticate buddy:")}})),!1})),$(".onlineStatusSelect").change((e=>{let t=$(e.target).val();bp.emit("profile::status",t)})),$(".forgot-password").on("click",(e=>{$(".loginForm").flexHide(),$(".forgot-password-modal").flexShow(),$(".tos-checkbox").flexHide(),$(".loginStatus").html(""),$(".resetPasswordLink").flexHide()})),$(".closeForgotPassword").on("click",(e=>{$(".forgot-password-modal").flexHide(),$(".loginForm").flexShow(),$(".tos-checkbox").flexShow(),$(".resetPasswordLink").flexShow()})),$(".resetPasswordButton").on("click",(t=>{t.preventDefault();let s=$(".resetPasswordEmail").val();s?($(".resetPasswordEmail").removeClass("error"),$(".loginStatus").html("Sending password reset email..."),$(".resetPasswordForm").flexHide(),$(".resetPasswordMessage").flexHide(),e.sendPasswordResetEmail(s,((e,t)=>{if(e||!t.success)return $(".loginStatus").html("Failed to send password reset email."),void console.error(e||t);$(".loginStatus").removeClass("error").addClass("success").html(t.message)}))):$(".resetPasswordEmail").addClass("error")})),$(".buddylist").click((e=>{if(!$(e.target).closest(".buddy-message-sender").data("buddy"))return;let t=$(e.target).closest(".buddy-message-sender").data("buddy");this.openChatWindow({name:t})})),$(".sendBuddyRequest").on("click",(e=>{e.preventDefault();let t=$(".buddy_request_name").val();t?($(".you_have_no_buddies").html("Buddy Request Sent!"),$(".buddy_request_name").removeClass("error"),$(".buddy_request_name").val(""),this.bp.log("buddypond.addBuddy ->",t),this.client.addBuddy(t,((e,t)=>(console.log("buddypond.addBuddy <-",e,t),t.error?($(".you_have_no_buddies").html(t.error),void console.error(t)):t.success?void this.bp.log("buddypond.addBuddy <-",t):($(".you_have_no_buddies").html(t.message),void console.error(t)))))):$(".buddy_request_name").addClass("error")})),$(".loginButton").prop("disabled",!0),$(".loginButton").addClass("disabled"),$("#tosAgree").change((function(){$(this).is(":checked")?($(".loginButton").prop("disabled",!1),$(".loginButton").removeClass("disabled")):($(".loginButton").prop("disabled",!0),$(".loginButton").addClass("disabled"))})),$(".inviteBuddy").on("click",(()=>{let e=[`Find me as "${this.bp.me}" on https://buddypond.com and let's start a conversation that could last a lifetime.`,`I've taken my conversations to the cloud! Reach me at "${this.bp.me}" on https://buddypond.com where the future of messaging unfolds.`,`Wave goodbye to the old and hello to the old! I'm waiting at "${this.bp.me}" on https://buddypond.com. Let's catch up!`,`Missing chat sessions? They're back and better than ever at "${this.bp.me}" on https://buddypond.com. Join me and let's reconnect!`,`Taking conversations to the next level. Find me at "${this.bp.me}" on https://buddypond.com and let's dive into new topics together!`,`Remember the ease of old-school messaging? Experience it again with a twist! I'm "${this.bp.me}" at https://buddypond.com. Chat soon?`,`I'm charting new territories in the world of digital communication. Join me as "${this.bp.me}" on https://buddypond.com and let's explore together!`,`Just like the good old days but better! Find me on "${this.bp.me}" at https://buddypond.com and let's keep the conversations flowing.`],t=e[Math.floor(Math.random()*e.length)];return window.open(`https://twitter.com/intent/tweet?url=${t}`),!1})),this.positiveAffirmationInterval&&clearInterval(this.positiveAffirmationInterval),this.positiveAffirmationInterval=setInterval((function(){$(".positiveAffirmation").fadeOut({duration:4444,complete:function(){s(),$(".positiveAffirmation").fadeIn({duration:4444,complete:function(){}})}})}),199800),s(),$(".positiveAffirmation").on("click",(function(){s()}))},V.prototype.openChatWindow=function(e){const{windowType:t,contextName:s,windowTitle:o}=function(e){let t=e.pondname?"pond":"buddy",s=e.pondname||e.name,o="pond"===t?"Pond Chat":"";e.context&&(s=e.context);e.type&&(t=e.type);return s=s.toString(),{windowType:t,contextName:s,windowTitle:o}}(e);if(!function(e){const t=e.replace("pond/","");if(n.containsBadWord(t))return console.error("Forbidden context name:",e),alert("Pond name not allowed, please choose a different name."),!1;return!0}(s))return;this.populateRoomList||(this.populateRoomList=u.bind(this)),this.updatePondConnectedUsers||(this.updatePondConnectedUsers=h.bind(this)),this.forbiddenNotes||(this.forbiddenNotes=n),this.joinPond||(this.joinPond=S.bind(this));const i=this.bp.apps.client,a=function(e,t){return"pond"===e?"pond-chat":`messages/${t}`}(t,s),d=this.bp.apps.ui.windowManager.getWindow(a);return d?(function(e,t,s,o,n){"pond"===t&&(console.log("Opening pond window",t,s),v.call(this,n,s,e,o),C.call(this,s,e));e.focus()}(d,t,s,i,this),d):b.call(this,{windowType:t,contextName:s,windowTitle:o,windowId:a,client:i,data:e})},V.prototype.generateDefaultProfile=async function(e){const t="https://files.buddypond.com/"+e.me;for(const[e,s]of Object.entries(M))try{const s=await fetch(`${t}/${e}`);if(!s.ok)throw new Error("File not found, needs creation");if(200!==s.status)throw new Error("File not found, needs creation");if("https://buddypond.com/four-ohh-four"===s.url)throw new Error("File not found, needs creation")}catch(t){console.log(`Creating ${e}: ${t.message}`);const o=new Blob([s],{type:J(e)}),n=new File([o],e,{type:o.type,lastModified:new Date});n.filePath=`${e}`;try{await this.bp.apps.client.api.uploadFile(n),console.log(`${e} uploaded successfully.`)}catch(t){console.error(`Error uploading ${e}: ${t.message}`)}}},V.prototype.requestDefaultCoinAllocations=async function(){let e,t=buddypond.qtokenid,s=this.bp.me;console.log(`requestDefaultCoinAllocations ${s} ${t}`);try{let o=`${buddypond.randolphEndpoint}/randolph/faucet`;console.log("faucetUrl",o),e=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`,"x-me":s}}),console.log("requestDefaultCoinAllocations",e.status,e.statusText);let n=await e.json();console.log("requestDefaultCoinAllocations",n)}catch(e){throw e}},V.prototype.sortBuddyList=function(){let e=document.querySelector(".buddylist");if(!e)return void console.log("Buddy list not found, unable to sort");let t=Array.from(document.querySelectorAll(".buddylist li"));t.sort(((e,t)=>{let s=e.querySelector(".buddy-status").textContent.includes("🟢")?0:1,o=t.querySelector(".buddy-status").textContent.includes("🟢")?0:1;if(s!==o)return s-o;if(0===s&&0===o)return e.dataset.buddy.localeCompare(t.dataset.buddy);let n=parseInt(e.dataset.utime||0),i=parseInt(t.dataset.utime||0);return n!==i?i-n:e.dataset.buddy.localeCompare(t.dataset.buddy)})),e.innerHTML="",t.forEach((t=>e.appendChild(t)))},V.prototype.showContextMenu=function(e,t,s){const o=$("<div>",{id:"customContextMenu",css:{position:"absolute",top:t,left:e,zIndex:99999,display:"block",background:"white",border:"1px solid #ccc",padding:"10px",cursor:"pointer"}}).append($("<ul>").append($("<li>").text("View Profile").on("click",(()=>function(e){console.log("Opening profile for "+e),bp.admin?bp.open("admin-profile",{context:e}):bp.open("user-profile",{context:e})}(s)))));$("#customContextMenu").remove(),$("body").append(o),$(document).one("click",(function(){$("#customContextMenu").remove()}))},V.prototype.createMessageContextMenu=function(e,t){this.activeMessageContextMenu&&(this.activeMessageContextMenu.remove(),this.activeMessageContextMenu=null),this.activeMessageHoverMenu&&(this.activeMessageHoverMenu=null);const s=e.closest(".aim-hover-menu"),o=document.createElement("div");o.className="aim-context-menu";const n=t.getAttribute("data-from"),i=[{text:"Reply",action:"reply-message"},{text:"Say Message",action:"say-message"}];n!==this.bp.me&&"Marak"!==this.bp.me||i.push({text:"Edit Message",action:"edit-message"},{text:"Delete Message",action:"delete-message"}),i.push({text:"Cast Spell",action:"cast-spell"}),i.forEach((e=>{const t=document.createElement("div");t.className="aim-context-menu-item",t.textContent=e.text,t.setAttribute("data-action",e.action),o.appendChild(t)})),document.body.appendChild(o);const a=e.getBoundingClientRect();o.style.left=a.left-150+"px",o.style.top=a.bottom+window.scrollY-20+"px";const d=t.getAttribute("data-chat-id"),r=t.getAttribute("data-uuid");return o.setAttribute("data-chat-id",d),o.setAttribute("data-uuid",r),o.setAttribute("data-from",n),this.activeMessageContextMenu=o,this.activeMessageHoverMenu=s,o},V.prototype.bindMessageContextMenu=function(){X.call(this),document.addEventListener("click",(e=>{const t=e.target;let s=t.getAttribute("data-action");if(t.classList.contains("aim-context-menu-item")&&s)return void N.call(this,s,t);let o=$(t).hasClass("aim-hover-menu-item")||$(t).parents().hasClass("aim-hover-menu-item");if(s=t.getAttribute("data-action")||t.parentNode.getAttribute("data-action"),o&&s)N.call(this,s,t);else if(t.classList.contains("aim-edit-hint-action")&&s)Z.call(this,s,t);else if(t.classList.contains("aim-reply-cancel")&&"cancel-reply"===s){const e=t.closest(".aim-reply-box");G.call(this,e)}else B.call(this)}))},V.prototype.loadUserApps=function(){if("Marak"===this.bp.me){let e=this.bp.settings.apps_installed||{};console.log("installedApps",e),e.admin||this.bp.apps.desktop.addApp("admin"),window.arrangeDesktop()}},V.prototype.sendMessageHandler=async function(e,t,s,o){console.log("sendMessageHandler called",e,t,s,o);const n=$(".aim-input",t.content).val(),i={to:$(".aim-to",t.content).val(),replyto:$(".aim-replyto",t.content).val(),type:s,from:this.bp.me,message:n,ctime:Date.now(),text:n,files:[]};console.log("sendMessageHandler _data",i);const a=$(".file-preview",t.content),d=[];if((!n||0===n.length)&&0===a.length)return void console.log("No message to send");a.each(((e,t)=>{$(".file-content",t).each(((e,t)=>{const s=this.bp.apps["file-viewer"].getFile(t);s&&d.push({file:s,element:t})}))})),d.forEach((({file:e,element:t})=>{const s=$("<div>",{class:"upload-status",css:{position:"absolute",top:0,left:0,right:0,bottom:0,background:"rgba(0, 0, 0, 0.7)",color:"white",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1e3}}).text("Waiting...");$(t).css("position","relative").append(s)}));try{for(const{file:e,element:t}of d){const s=$(t).find(".upload-status");s.text("Uploading...");try{console.log("is there a filepath?",e.filePath),console.log("this is the file",e),e.filePath=e.filePath||e.name;let o=["jpeg","png","gif","webp","svg"],n=["mp3","wav","ogg","flac","aac","m4a"],a=["mp4","webm","ogg","avi","mov","mkv"],d=e.name.split(".").pop().toLowerCase();o.includes(d)&&(e.filePath="images/"+e.filePath),n.includes(d)&&(e.filePath="audio/"+e.filePath),a.includes(d)&&(e.filePath="videos/"+e.filePath),e.filePath=encodeURIComponent(e.filePath),console.log("assigning file path",e.filePath);let r=await this.bp.apps.client.api.uploadFile(e,(e=>{s.text("Uploading: "+e+"%")})),l={to:i.to,from:i.from,type:i.type,replyto:i.replyto,text:r};console.log("sending multimedia message",l),this.bp.emit("buddy::sendMessage",l),await $(t).fadeOut(300),$(t).remove()}catch(e){console.error("Error uploading file:",e),s.text("Failed: "+e.message).css("background","rgba(255, 0, 0, 0.7)"),await new Promise((e=>setTimeout(e,8e3))),await $(t).fadeOut(300),$(t).remove()}}}catch(e){console.error("Error in file upload process:",e)}if(a.each(((e,t)=>{0===$(t).children().length&&$(t).remove()})),$(".file-preview",t.content).remove(),i.type="pond"===s?"pond":"buddy",i.text.startsWith("/gif")){let e=i.text.split(" ").slice(1);if(await bp.load("image-search"),0===e.length)return await bp.open("image-search",{query:e[0],provider:"giphy-stickers",context:i.to,output:s}),void $(".aim-input",t.content).val("");let o=await bp.apps["image-search"].fetchImages(e[0],6,"giphy-stickers");if(o.error)return console.error("Image search error:",o.error),await this.showCard({chatWindow:t,cardName:"error",context:{message:o.error}}),void console.error("Error fetching images:",o.error);if(0===o.length)return void console.error("No images found for query:",e[0]);let n=o[Math.floor(Math.random()*o.length)];console.log("Random image selected:",n),i.card={type:"image",url:n}}if(i.text.startsWith("/image")){let e=i.text.split(" ").slice(1);if(console.log("/image params",e),0===e.length)return await bp.open("image-search",{query:e[0],provider:"pexels"}),void $(".aim-input",t.content).val("");await bp.load("image-search"),console.log("pppp",e);let s=await bp.apps["image-search"].fetchImages(e[0],6,"pexels");if(s.error)return console.error("Image search error:",s.error),await this.showCard({chatWindow:t,cardName:"error",context:{message:s.error}}),void console.error("Error fetching images:",s.error);if(0===s.length)return void console.error("No images found for query:",e[0]);let o=s[Math.floor(Math.random()*s.length)];console.log("Random image selected:",o),i.card={type:"image",url:o}}if(i.text.startsWith("/")&&!i.text.startsWith("/say")&&!i.text.startsWith("/roll")&&!i.text.startsWith("/gif")&&!i.text.startsWith("/image")&&!i.text.startsWith("/deepseek")){let e=this.bp.apps.buddyscript.parseCommand(i.text);return console.log("got back buddyscript command",e),e.pipe?(e.pipe({chatWindow:t,contextName:i.to,windowType:s}),$(".aim-input",t.content).val(""),!1):(console.log(" ",e),"show-card"===e.type&&(e.data,this.showCard({chatWindow:t,cardName:"bs",context:{...e,context:n.to,type:s}})),$(".aim-input",t.content).val(""),!1)}console.log(`Sending message to ${i.to} from ${i.from} of type ${i.type}:`,i.text),console.log(i.text.startsWith("\\")),i.text.startsWith("\\")&&(i.card={type:"bs",command:i.text.replace("\\","/").trim()}),console.log("emitting message",i),this.bp.emit("buddy::sendMessage",i),$(".aim-input",t.content).val(""),$(".aim-reply-box",t.content).remove(),$(".aim-replyto",t.content).val(""),$(".aim-send-btn",t.content).css("opacity",.5)},V.prototype.showCard=async function({chatWindow:e,cardName:t,context:s={}}){let o=this.bp.apps.card.cardManager;const n=await o.loadCard(t,s,e);let i=document.createElement("div");i.classList.add("cardContainer");let a=await n.render(i,e);if(!e||!e.content)throw console.error("chatWindow not found. user most likely not in the chat window"),new Error("chatWindow.content not found. user most likely not in the chat window");let d=e.content.querySelector(".aim-messages-container");"pond"===s.type&&(d=e.content.querySelector(`.aim-messages-container[data-context="${s.context}"]`));const r=d.querySelector(".aim-messages");if(r)return r.appendChild(i),$(".aim-input",e.content).val(""),this.bp.isMobile()||i.scrollIntoView({behavior:"instant"}),a;console.error("aim-messages not found. user most likely not in the chat window")},V.prototype.scrollToBottom=function e(t,s=0,o=0){if(!t)return;if(o>5)return;const n=$(".aim-chat-area",t)[0];n&&(0===o&&n._scrollRetryTimer&&(clearTimeout(n._scrollRetryTimer),n._scrollRetryTimer=null),$(n).scrollTop(n.scrollHeight),requestAnimationFrame((()=>{const i=n.scrollHeight-n.scrollTop-n.clientHeight<10;i?n._scrollRetryTimer=null:(s+=200,o++,n._scrollRetryTimer=setTimeout((()=>{e(t,s,o)}),s)),o>=5&&!i&&n.lastElementChild?.scrollIntoView({block:"end"})})))},V.prototype.defaultAvatarSvg=function(e){if(this.data.avatarCache.has(e))return this.data.avatarCache.get(e);const t=this.bp.vendor.dicebear.createAvatar(this.bp.vendor.dicebearAvatars,{seed:e,size:40,backgroundColor:["#f0f0f0"]}).toString();return this.data.avatarCache.set(e,t),t},V.prototype.Client=P,V.prototype.logout=function(){$(".loginButton").prop("disabled",!1),$(".loginButton").removeClass("disabled"),$("#menu-bar-coin-balance").text("0"),this.client.setStatus(this.bp.me,{status:"offline"},((e,t)=>{console.log("buddypond.setStatus",e,t),$(".chatWindow").remove(),$(".password").val(""),$(".loggedIn").flexHide(),$(".loggedOut").flexShow(),this.data.profileState=null,this.bp.play("desktop/assets/audio/GOODBYE.wav"),this.bp.apps.client.logout(),this.client.disconnect(),this.client=null,this.data={processedMessages:{},profileState:{},activeUsersInContext:{},activeUsers:[],activePonds:[],avatarCache:new Map},$(".buddylist").empty(),$(".dialog").remove()}))};export{V as default};
//# sourceMappingURL=buddylist.js.map
