class t{constructor(t,s={}){this.bp=t,this.options=s,this.board=null,this.game=null,this.ws=null,this.playerColor=null,this.stockfish=null,this.mode="multiplayer"}async init(){return this.html=await this.bp.load("/v5/apps/based/chess/chess.html"),await this.bp.appendScript("https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.js"),await this.bp.appendScript("https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.js"),await this.bp.appendScript("/v5/apps/based/chess/vendor/stockfish.min.js"),await this.bp.appendCSS("https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css"),"loaded ChessApp"}async open(){return this.win=await this.bp.window(this.window()),this.bindUI(),this.mode="stockfish",this.startStockfishGame(),this.win}window(){return{id:"chess",title:"BuddyPond Chess",icon:"desktop/assets/images/icons/icon_chess_64.png",x:120,y:80,width:600,height:600,content:this.html,resizable:!0,closable:!0,onClose:()=>this.cleanup()}}bindUI(){$("#join-game").on("click",(()=>{this.mode="multiplayer",this.joinGame()})),$("#play-stockfish").on("click",(()=>{this.mode="stockfish",this.startStockfishGame()})),this.game=new Chess;let t=$("#chessboard",this.win.content);this.board=Chessboard(t,{pieceTheme:"/v5/apps/based/chess/img/chesspieces/wikipedia/{piece}.png",draggable:!0,position:"start",onDragStart:this.onDragStart.bind(this),onDrop:this.onDrop.bind(this),onSnapEnd:this.onSnapEnd.bind(this)}),this.updateStatus()}startStockfishGame(){this.game.reset(),this.board.position("start"),this.playerColor="w",this.setStatus("You are White. Make your move."),this.stockfish=new Worker("v5/apps/based/chess/vendor/stockfish.min.js"),this.stockfish.onmessage=t=>{if("string"==typeof t.data&&t.data.startsWith("bestmove")){const s=t.data.split(" ")[1],e=s.substring(0,2),i=s.substring(2,4);this.game.move({from:e,to:i,promotion:"q"})&&(this.board.position(this.game.fen()),this.updateStatus())}}}joinGame(){const t=document.getElementById("game-input").value.trim();if(!t)return alert("Please enter a game ID");const s="ws://192.168.200.59:5556/ws/game/"+t;this.ws=new WebSocket(s),this.ws.onopen=()=>{this.ws.send(JSON.stringify({type:"join",gameId:t})),this.setStatus("Connected! Waiting for opponent...")},this.ws.onmessage=t=>{const s=JSON.parse(t.data);if("color"===s.type)this.playerColor=s.color,this.board.orientation("w"===this.playerColor?"white":"black"),this.setStatus(`You are ${"w"===this.playerColor?"White":"Black"}. ${"w"===this.game.turn()?"White":"Black"} to move.`);else if("move"===s.type){this.game.move(s.move)&&(this.board.position(this.game.fen()),this.updateStatus())}else"gameStart"===s.type?this.setStatus("Game started! "+(this.playerColor===this.game.turn()?"Your move":"Opponent's move")):"error"===s.type&&this.setStatus("Error: "+s.message)},this.ws.onclose=()=>this.setStatus("Disconnected from game"),this.ws.onerror=()=>this.setStatus("WebSocket error occurred")}onDragStart(t,s){if(this.game.game_over())return!1;if("multiplayer"===this.mode){if(this.playerColor&&s[0]!==this.playerColor)return!1;if(this.game.turn()!==this.playerColor)return!1}else if("stockfish"===this.mode&&"w"!==this.game.turn())return!1;return!0}onDrop(t,s){if(null===this.game.move({from:t,to:s,promotion:"q"}))return"snapback";"multiplayer"===this.mode&&this.ws?.readyState===WebSocket.OPEN?this.ws.send(JSON.stringify({type:"move",gameId:document.getElementById("game-input").value,move:{from:t,to:s,promotion:"q"}})):"stockfish"===this.mode&&setTimeout((()=>{this.stockfish.postMessage("position fen "+this.game.fen()),this.stockfish.postMessage("go depth 15")}),200),this.updateStatus()}onSnapEnd(){this.board.position(this.game.fen())}updateStatus(){let t="";t=this.game.in_checkmate()?"Checkmate! "+("w"===this.game.turn()?"Black":"White")+" wins!":this.game.in_draw()?"Game Over: Draw!":("w"===this.game.turn()?"White":"Black")+" to move",this.setStatus(t)}setStatus(t){document.getElementById("status").textContent=t}cleanup(){this.ws&&this.ws.close(),this.stockfish&&(this.stockfish.terminate(),this.stockfish=null)}}export{t as default};
//# sourceMappingURL=chess.js.map
