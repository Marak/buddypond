{"version":3,"file":"image-search.js","sources":["../../../apps/based/image-search/image-search.js"],"sourcesContent":["/* image-search.js - Marak Squires 2025 - BuddyPond */\nexport default class ImageSearch {\n    constructor(bp, config = {}) {\n        this.bp = bp;\n        this.context = null;\n        this.output = null;\n    }\n\n    async init() {\n\n        this.html = await this.bp.load('/v5/apps/based/image-search/image-search.html');\n        await this.bp.appendCSS('/v5/apps/based/image-search/image-search.css');\n        this.bp.searchImages = async (query, numResults = 6) => {\n            return await this.fetchImages(query, numResults);\n        };\n        this.bp.searchImage = async (query) => {\n            let imgs = await this.fetchImages(query, 10);\n            return imgs[Math.floor(Math.random() * imgs.length)];\n        };\n    }\n\n    async open(options = {}) {\n        if (options.context) {\n            this.context = options.context;\n        }\n        if (options.output) {\n            this.output = options.output;\n        }\n        // console.log(\"Opening image search window with options:\", options);\n        if (!this.imageSearchWindow) {\n\n            this.imageSearchWindow = this.bp.apps.ui.windowManager.createWindow({\n                id: 'image-search',\n                title: 'Search Images',\n                icon: 'desktop/assets/images/icons/icon_image-search_64.png',\n                x: 250,\n                y: 75,\n                width: 460,\n                height: 500,\n                minWidth: 400,\n                minHeight: 300,\n                parent: $('#desktop')[0],\n                content: this.html,\n                resizable: true,\n                minimizable: true,\n                maximizable: true,\n                closable: true,\n                focusable: true,\n                maximized: false,\n                minimized: false,\n                onClose: () => {\n                    this.imageSearchWindow = null; // Clear reference on close\n                }\n            });\n\n            // âœ… Bind search form events\n            const $form = $('#image-search-form');\n            const $input = $('#image-search-input');\n            const $results = $('#image-search-results');\n\n            $form.on('submit', async (e) => {\n                e.preventDefault();\n                const query = $input.val().trim();\n                if (!query) return;\n                $results.empty(); // Clear previous results\n                console.log(\"Searching for images with query:\", query);\n                // Fetch images from the API\n                const images = await this.fetchImages(query, 12, options.provider);\n\n                if (images.error) {\n                    $('#image-search-error').html(`<p>${images.error}</p>`);\n                    $('#image-search-error').show();\n                    console.error(\"Image search error:\", images.error);\n                    return;\n                }\n\n                if (images.length === 0) {\n                    $('#image-search-error').html('<p>No images found.</p>');\n                    $('#image-search-error').show();\n\n                    return;\n                }\n                $('#image-search-error').hide();\n                $('#image-search-error').html('');\n\n                images.forEach((url) => {\n                    const $img = $(`<img src=\"${url}\" style=\"width: 100%; cursor: pointer; border-radius: 4px;\" />`);\n                    $img.on('click', () => {\n                        if (this.selectedImages.has(url)) {\n                            this.selectedImages.delete(url);\n                            // $img.css('border', 'none');\n                        } else {\n                            //$img.css('border', '3px solid #0f0');\n                            this.selectedImages.add(url);\n                            sendImageToChat.call(this);\n\n\n                        }\n                    });\n                    $results.append($img);\n                });\n            });\n\n            this.selectedImages = new Set(); // inside constructor or open()\n\n            async function sendImageToChat() {\n\n                let windowIdPrefix = this.output === 'pond' ? 'pond_message_-' : 'buddy_message_-';\n\n                let windowId = windowIdPrefix + this.context;\n                // console.log('opening chat window ', windowId)\n                let chatWindow = this.bp.apps.ui.windowManager.getWindow(windowId);\n\n\n                console.log(`context: ${this.context}, type: ${this.type}`);\n                console.log('chatWindow', chatWindow);\n                const files = [];\n\n                for (let url of this.selectedImages) {\n                    const response = await fetch(url);\n                    const blob = await response.blob();\n                    const filename = url.split('/').pop().split('?')[0]; // crude filename\n                    const file = new File([blob], filename, { type: blob.type });\n                    files.push(file);\n                    // remove the image from the selectedImages set\n                    this.selectedImages.delete(url);\n                }\n\n                if (files.length === 0) return;\n\n                // Simulate a drop event to reuse the drop handler\n                const dt = new DataTransfer();\n                files.forEach(file => dt.items.add(file));\n\n                this.bp.apps.droparea.dropTarget = chatWindow.container; // set the drop target to the active window\n                const event = new DragEvent('drop', {\n                    dataTransfer: dt,\n                    bubbles: true,\n                    cancelable: true,\n                    // target: activeWindow // not working?\n                });\n\n                chatWindow.container.dispatchEvent(event);\n                // focus the active chat window\n                if (chatWindow) {\n\n                    let id = $(chatWindow).attr('id');\n                    this.bp.apps.ui.windowManager.focusWindow(id);\n\n\n                    //  activeWindow.focus();\n                } else {\n                    console.warn(\"No active chat window found to send images to.\");\n                }\n\n            }\n        }\n\n        if (options.provider) {\n            $('#image-search-provider', this.imageSearchWindow.content).val(options.provider);\n        }\n\n        // focus the input field\n        $('#image-search-input', this.imageSearchWindow.content).focus();\n        return this.imageSearchWindow;\n    }\n\n    async fetchImages(query, numResults = 12, provider = 'pexels') {\n        try {\n            const _provider = provider || $('#image-search-provider').val() || 'google';\n            const url = `${buddypond.imageSearchEndpoint}/image-search?q=${encodeURIComponent(query)}&num=${numResults}&provider=${_provider}`;\n            const response = await fetch(url, {\n                headers: {\n                    'Content-Type': 'application/json',\n                    'Authorization': `Bearer ${this.bp.qtokenid}`, // Use your actual token\n                    'X-Me': this.bp.me // Use your actual user identifier\n                }\n            });\n            if (!response.ok) {\n                throw new Error(`Image search failed: ${response.status} ${response.statusText}`);\n            }\n            const data = await response.json();\n            return data;\n        } catch (err) {\n            console.warn(\"ImageSearch error:\", err);\n            return [];\n        }\n    }\n\n}\n"],"names":["ImageSearch","constructor","bp","config","this","context","output","init","html","load","appendCSS","searchImages","async","query","numResults","fetchImages","searchImage","imgs","Math","floor","random","length","open","options","imageSearchWindow","apps","ui","windowManager","createWindow","id","title","icon","x","y","width","height","minWidth","minHeight","parent","$","content","resizable","minimizable","maximizable","closable","focusable","maximized","minimized","onClose","$form","$input","$results","sendImageToChat","windowId","chatWindow","getWindow","console","log","type","files","url","selectedImages","response","fetch","blob","filename","split","pop","file","File","push","delete","dt","DataTransfer","forEach","items","add","droparea","dropTarget","container","event","DragEvent","dataTransfer","bubbles","cancelable","dispatchEvent","attr","focusWindow","warn","on","e","preventDefault","val","trim","empty","images","provider","error","show","hide","$img","has","call","append","Set","focus","_provider","buddypond","imageSearchEndpoint","encodeURIComponent","headers","Authorization","qtokenid","me","ok","Error","status","statusText","json","err"],"mappings":"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"}