{"version":3,"file":"website-card.js","sources":["../../../../../../apps/based/card/cards/website/website-card.js"],"sourcesContent":["export default function applyData(el, data, cardClass, parent) {\n\n    // Helper to show content\n    const showContent = ($el, metadata) => {\n        // console.log('showContent Website metadata:', metadata);\n        $el.find('.card-website-loading').hide();\n        const $content = $el.find('.card-website-content');\n        $content.find('.card-website-link').attr('href', url);\n        $content.find('.card-website-title').text(metadata.title || new URL(url).hostname);\n        $content.find('.card-website-description').text(metadata.description || '');\n        const $image = $content.find('.card-website-image');\n\n        if (metadata.image) {\n            $image\n                .one('load', () => {\n                    console.log('Image loaded:', metadata.image);\n                    triggerScroll.call(this);\n                })\n                .one('error', () => {\n                    console.warn('Image failed to load:', metadata.image);\n                    triggerScroll.call(this);\n                })\n                .attr('src', metadata.image)\n                .show();\n\n            // Force load if cached\n            if ($image[0].complete) {\n                $image.trigger('load');\n            }\n        }\n\n        $content.removeClass('card-website-hidden');\n\n        // ensure we scroll to bottom of chat after rendering image card\n        function triggerScroll() {\n            if (parent && parent.content) {\n                // console.log('Scrolling to bottom of parent content');\n                // Scroll to bottom of parent content\n                if (cardClass.bp && cardClass.bp.apps && cardClass.bp.apps.buddylist) {\n                    cardClass.bp.apps.buddylist.scrollToBottom(parent.content);\n                }\n            }\n        }\n\n    };\n\n\n    // Initialize cache\n    buddypond.websiteCardCache = buddypond.websiteCardCache || {};\n    const $el = $(el);\n    const { url } = data || {};\n    // console.log('Website card data', { url });\n\n    if (!url || !/^https?:\\/\\//i.test(url)) {\n        showError($el, 'Invalid URL');\n        return;\n    }\n\n    // Check cache\n    if (buddypond.websiteCardCache[url]) {\n        // console.log('Using cached metadata for:', url);\n        showContent($el, buddypond.websiteCardCache[url]);\n        return;\n    }\n\n    // Show loading state\n    $el.find('.card-website-loading').show();\n    $el.find('.card-website-content, .card-website-error').addClass('card-website-hidden');\n\n    // Check if URL is same-origin\n    const isSameOrigin = url.startsWith(window.location.origin);\n\n    // Helper to parse HTML for metadata\n    const parseMetadata = (html) => {\n        const parser = new DOMParser();\n        const doc = parser.parseFromString(html, 'text/html');\n        const getMeta = (property) => doc.querySelector(`meta[property=\"${property}\"]`)?.content || '';\n        const getMetaName = (name) => doc.querySelector(`meta[name=\"${name}\"]`)?.content || '';\n        return {\n            title: getMeta('og:title') || doc.title || '',\n            description: getMeta('og:description') || getMetaName('description') || '',\n            image: getMeta('og:image') || getMetaName('twitter:image') || getMetaName('image') || ''\n        };\n    };\n\n    // Helper to show error\n    const showError = ($el, message) => {\n        $el.find('.card-website-loading').hide();\n        const $error = $el.find('.card-website-error');\n        $error.find('.card-website-error-message').text(message);\n        $error.removeClass('card-website-hidden');\n    };\n\n    // Try browser fetch for same-origin URLs\n    if (isSameOrigin) {\n        fetch(url, { method: 'GET' })\n            .then(response => {\n                if (!response.ok) throw new Error('Network error');\n                return response.text();\n            })\n            .then(html => {\n                // console.log('Fetched HTML:', html);\n                const metadata = parseMetadata(html);\n                // console.log('Parsed metadata:', metadata);\n                // Cache metadata\n                buddypond.websiteCardCache[url] = metadata;\n                showContent($el, metadata);\n            })\n            .catch(() => {\n                // Fall back to proxy for same-origin failures\n                fetchProxy($el, url, parseMetadata, showContent, showError);\n            });\n    } else {\n        // Use proxy for cross-origin URLs\n        fetchProxy($el, url, parseMetadata, showContent, showError);\n    }\n}\n\n// Helper to show fallback link\nconst showFallback = ($el, url) => {\n    //console.log('Showing fallback link for:', url);\n    $el.find('.card-website-loading').hide();\n    const $fallback = $el.find('.card-website-fallback');\n    $fallback.find('.card-website-fallback-link')\n        .attr('href', url)\n        .text(new URL(url));\n    $fallback.removeClass('card-website-hidden');\n};\n\nfunction fetchProxy($el, url, parseMetadata, showContent, showError) {\n    //console.log('Fetching via proxy:', url);\n    let proxyUrl = `${buddypond.buddyProxy}/api/fetch-metadata?url=${encodeURIComponent(url)}`;\n    //console.log('Proxy URL:', proxyUrl);\n\n    const controller = new AbortController();\n    const timeoutId = setTimeout(() => controller.abort(), 6000); // 6 seconds\n\n    fetch(proxyUrl, {\n        method: 'GET',\n        headers: {\n            'Content-Type': 'application/json',\n            'Authorization': `Bearer ${buddypond.qtokenid}`,\n            'x-me': buddypond.me\n        },\n        signal: controller.signal\n    })\n        .then(response => {\n            clearTimeout(timeoutId);\n            if (!response.ok) throw new Error('Proxy error');\n            return response.json();\n        })\n        .then(metadata => {\n            buddypond.websiteCardCache[url] = metadata;\n            showContent($el, metadata);\n        })\n        .catch(err => {\n            if (err.name === 'AbortError') {\n                console.warn('Fetch aborted due to timeout');\n            } else {\n                console.error('Fetch error:', err);\n            }\n            showFallback($el, url);\n        });\n}\n"],"names":["applyData","el","data","cardClass","parent","showContent","$el","metadata","find","hide","$content","attr","url","text","title","URL","hostname","description","$image","triggerScroll","content","bp","apps","buddylist","scrollToBottom","image","one","console","log","call","this","warn","show","complete","trigger","removeClass","buddypond","websiteCardCache","$","test","showError","addClass","isSameOrigin","startsWith","window","location","origin","parseMetadata","html","doc","DOMParser","parseFromString","getMeta","property","querySelector","getMetaName","name","message","$error","fetch","method","then","response","ok","Error","catch","fetchProxy","showFallback","$fallback","proxyUrl","buddyProxy","encodeURIComponent","controller","AbortController","timeoutId","setTimeout","abort","headers","Authorization","qtokenid","me","signal","clearTimeout","json","err","error"],"mappings":"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"}