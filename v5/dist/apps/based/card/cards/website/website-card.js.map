{"version":3,"file":"website-card.js","sources":["../../../../../../apps/based/card/cards/website/website-card.js"],"sourcesContent":["export default function applyData(el, data) {\n\n    // Helper to show content\n    const showContent = ($el, metadata) => {\n        // console.log('showContent Website metadata:', metadata);\n        $el.find('.card-website-loading').hide();\n        const $content = $el.find('.card-website-content');\n        $content.find('.card-website-link').attr('href', url);\n        $content.find('.card-website-title').text(metadata.title || new URL(url).hostname);\n        $content.find('.card-website-description').text(metadata.description || '');\n        const $image = $content.find('.card-website-image');\n        if (metadata.image) {\n            $image.attr('src', metadata.image).show();\n        } else {\n            $image.hide();\n        }\n        $content.removeClass('card-website-hidden');\n    };\n\n\n    // Initialize cache\n    buddypond.websiteCardCache = buddypond.websiteCardCache || {};\n    const $el = $(el);\n    const { url } = data || {};\n    // console.log('Website card data', { url });\n\n    if (!url || !/^https?:\\/\\//i.test(url)) {\n        showError($el, 'Invalid URL');\n        return;\n    }\n\n    // Check cache\n    if (buddypond.websiteCardCache[url]) {\n        console.log('Using cached metadata for:', url);\n        showContent($el, buddypond.websiteCardCache[url]);\n        return;\n    }\n\n    // Show loading state\n    $el.find('.card-website-loading').show();\n    $el.find('.card-website-content, .card-website-error').addClass('card-website-hidden');\n\n    // Check if URL is same-origin\n    const isSameOrigin = url.startsWith(window.location.origin);\n\n    // Helper to parse HTML for metadata\n    const parseMetadata = (html) => {\n        const parser = new DOMParser();\n        const doc = parser.parseFromString(html, 'text/html');\n        const getMeta = (property) => doc.querySelector(`meta[property=\"${property}\"]`)?.content || '';\n        const getMetaName = (name) => doc.querySelector(`meta[name=\"${name}\"]`)?.content || '';\n        return {\n            title: getMeta('og:title') || doc.title || '',\n            description: getMeta('og:description') || getMetaName('description') || '',\n            image: getMeta('og:image') || getMetaName('twitter:image') || getMetaName('image') || ''\n        };\n    };\n\n    // Helper to show error\n    const showError = ($el, message) => {\n        $el.find('.card-website-loading').hide();\n        const $error = $el.find('.card-website-error');\n        $error.find('.card-website-error-message').text(message);\n        $error.removeClass('card-website-hidden');\n    };\n\n    // Try browser fetch for same-origin URLs\n    if (isSameOrigin) {\n        fetch(url, { method: 'GET' })\n            .then(response => {\n                if (!response.ok) throw new Error('Network error');\n                return response.text();\n            })\n            .then(html => {\n                // console.log('Fetched HTML:', html);\n                const metadata = parseMetadata(html);\n                // console.log('Parsed metadata:', metadata);\n                // Cache metadata\n                buddypond.websiteCardCache[url] = metadata;\n                showContent($el, metadata);\n            })\n            .catch(() => {\n                // Fall back to proxy for same-origin failures\n                fetchProxy($el, url, parseMetadata, showContent, showError);\n            });\n    } else {\n        // Use proxy for cross-origin URLs\n        fetchProxy($el, url, parseMetadata, showContent, showError);\n    }\n}\n\n// Helper to show fallback link\nconst showFallback = ($el, url) => {\n    //console.log('Showing fallback link for:', url);\n    $el.find('.card-website-loading').hide();\n    const $fallback = $el.find('.card-website-fallback');\n    $fallback.find('.card-website-fallback-link')\n        .attr('href', url)\n        .text(new URL(url));\n    $fallback.removeClass('card-website-hidden');\n};\n\nfunction fetchProxy($el, url, parseMetadata, showContent, showError) {\n    //console.log('Fetching via proxy:', url);\n    let proxyUrl = `${buddypond.buddyProxy}/api/fetch-metadata?url=${encodeURIComponent(url)}`;\n    //console.log('Proxy URL:', proxyUrl);\n\n    const controller = new AbortController();\n    const timeoutId = setTimeout(() => controller.abort(), 6000); // 6 seconds\n\n    fetch(proxyUrl, {\n        method: 'GET',\n        headers: {\n            'Content-Type': 'application/json',\n            'Authorization': `Bearer ${buddypond.qtokenid}`,\n            'x-me': buddypond.me\n        },\n        signal: controller.signal\n    })\n        .then(response => {\n            clearTimeout(timeoutId);\n            if (!response.ok) throw new Error('Proxy error');\n            return response.json();\n        })\n        .then(metadata => {\n            buddypond.websiteCardCache[url] = metadata;\n            showContent($el, metadata);\n        })\n        .catch(err => {\n            if (err.name === 'AbortError') {\n                console.warn('Fetch aborted due to timeout');\n            } else {\n                console.error('Fetch error:', err);\n            }\n            showFallback($el, url);\n        });\n}\n"],"names":["applyData","el","data","showContent","$el","metadata","find","hide","$content","attr","url","text","title","URL","hostname","description","$image","image","show","removeClass","buddypond","websiteCardCache","$","test","showError","console","log","addClass","isSameOrigin","startsWith","window","location","origin","parseMetadata","html","doc","DOMParser","parseFromString","getMeta","property","querySelector","content","getMetaName","name","message","$error","fetch","method","then","response","ok","Error","catch","fetchProxy","showFallback","$fallback","proxyUrl","buddyProxy","encodeURIComponent","controller","AbortController","timeoutId","setTimeout","abort","headers","Authorization","qtokenid","me","signal","clearTimeout","json","err","warn","error"],"mappings":"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"}