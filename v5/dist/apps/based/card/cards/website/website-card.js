function e(e,t,o,d){const i=(e,t)=>{e.find(".card-website-loading").hide();const r=e.find(".card-website-content");r.find(".card-website-link").attr("href",a),r.find(".card-website-title").text(t.title||new URL(a).hostname),r.find(".card-website-description").text(t.description||"");const i=r.find(".card-website-image");function n(){d&&d.content&&o.bp&&o.bp.apps&&o.bp.apps.buddylist&&o.bp.apps.buddylist.scrollToBottom(d.content)}t.image&&(i.one("load",(()=>{console.log("Image loaded:",t.image),n.call(this)})).one("error",(()=>{console.warn("Image failed to load:",t.image),n.call(this)})).attr("src",t.image).show(),i[0].complete&&i.trigger("load")),r.removeClass("card-website-hidden")};buddypond.websiteCardCache=buddypond.websiteCardCache||{};const n=$(e),{url:a}=t||{};if(!a||!/^https?:\/\//i.test(a))return void l(n,"Invalid URL");if(buddypond.websiteCardCache[a])return void i(n,buddypond.websiteCardCache[a]);n.find(".card-website-loading").show(),n.find(".card-website-content, .card-website-error").addClass("card-website-hidden");const s=a.startsWith(window.location.origin),c=e=>{const t=(new DOMParser).parseFromString(e,"text/html"),r=e=>t.querySelector(`meta[property="${e}"]`)?.content||"",o=e=>t.querySelector(`meta[name="${e}"]`)?.content||"";return{title:r("og:title")||t.title||"",description:r("og:description")||o("description")||"",image:r("og:image")||o("twitter:image")||o("image")||""}},l=(e,t)=>{e.find(".card-website-loading").hide();const r=e.find(".card-website-error");r.find(".card-website-error-message").text(t),r.removeClass("card-website-hidden")};s?fetch(a,{method:"GET"}).then((e=>{if(!e.ok)throw new Error("Network error");return e.text()})).then((e=>{const t=c(e);buddypond.websiteCardCache[a]=t,i(n,t)})).catch((()=>{r(n,a,c,i)})):r(n,a,c,i)}const t=(e,t)=>{e.find(".card-website-loading").hide();const r=e.find(".card-website-fallback");r.find(".card-website-fallback-link").attr("href",t).text(new URL(t)),r.removeClass("card-website-hidden")};function r(e,r,o,d,i){let n=`${buddypond.buddyProxy}/api/fetch-metadata?url=${encodeURIComponent(r)}`;const a=new AbortController,s=setTimeout((()=>a.abort()),6e3);fetch(n,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${buddypond.qtokenid}`,"x-me":buddypond.me},signal:a.signal}).then((e=>{if(clearTimeout(s),!e.ok)throw new Error("Proxy error");return e.json()})).then((t=>{buddypond.websiteCardCache[r]=t,d(e,t)})).catch((o=>{"AbortError"===o.name?console.warn("Fetch aborted due to timeout"):console.error("Fetch error:",o),t(e,r)}))}export{e as default};
//# sourceMappingURL=website-card.js.map
