class e{constructor(e,t={}){this.bp=e,this.context=null,this.output=null}async init(){this.html=await this.bp.load("/v5/apps/based/image-search/image-search.html"),await this.bp.appendCSS("/v5/apps/based/image-search/image-search.css"),this.bp.searchImages=async(e,t=6)=>await this.fetchImages(e,t),this.bp.searchImage=async e=>{let t=await this.fetchImages(e,10);return t[Math.floor(Math.random()*t.length)]}}async open(e={}){if(e.context&&(this.context=e.context),e.output&&(this.output=e.output),e.provider=e.provider||"giphy-stickers",!this.imageSearchWindow){this.imageSearchWindow=this.bp.apps.ui.windowManager.createWindow({id:"image-search",title:"Search Images",icon:"desktop/assets/images/icons/icon_image-search_64.png",x:250,y:75,width:460,height:500,minWidth:400,minHeight:300,parent:$("#desktop")[0],content:this.html,resizable:!0,minimizable:!0,maximizable:!0,closable:!0,focusable:!0,maximized:!1,minimized:!1,onClose:()=>{this.imageSearchWindow=null}});const t=$("#image-search-form"),i=$("#image-search-input"),a=$("#image-search-results");async function o(){let e=("pond"===this.output?"pond_message_-":"messages/")+this.context;"pond"===this.output&&(e="pond-chat");let t=this.bp.apps.ui.windowManager.getWindow(e);if(!t)return void console.error(`No chat window found with ID: ${e}`);console.log(`context: ${this.context}, type: ${this.type}`),console.log("chatWindow",t);const i=[];for(let e of this.selectedImages){const t=await fetch(e),a=await t.blob();let o=e.split("/").pop().split("?")[0];o=`${Date.now()}_${o}`;const s=new File([a],o,{type:a.type});i.push(s),this.selectedImages.delete(e)}if(0===i.length)return;const a=new DataTransfer;i.forEach((e=>a.items.add(e))),this.bp.apps.droparea.dropTarget=t.container;const o=new DragEvent("drop",{dataTransfer:a,bubbles:!0,cancelable:!0});if(t.container.dispatchEvent(o),t){let e=$(t).attr("id");this.bp.apps.ui.windowManager.focusWindow(e)}else console.warn("No active chat window found to send images to.")}t.on("submit",(async e=>{e.preventDefault();const t=i.val().trim();if(!t)return;a.empty(),console.log("Searching for images with query:",t);const s=await this.fetchImages(t,12,$("#image-search-provider").val());return s.error?($("#image-search-error").html(`<p>${s.error}</p>`),$("#image-search-error").show(),void console.error("Image search error:",s.error)):0===s.length?($("#image-search-error").html("<p>No images found.</p>"),void $("#image-search-error").show()):($("#image-search-error").hide(),$("#image-search-error").html(""),void s.forEach((e=>{const t=$(`<img src="${e}" style="width: 100%; cursor: pointer; border-radius: 4px;" />`);t.on("click",(()=>{this.selectedImages.has(e)?this.selectedImages.delete(e):(this.selectedImages.add(e),o.call(this))})),a.append(t)})))})),this.selectedImages=new Set}return e.provider&&($("#image-search-provider",this.imageSearchWindow.content).val(e.provider),"pexels"===e.provider?($(".pexels-logo",this.imageSearchWindow.content).flexShow(),$(".giphy-logo",this.imageSearchWindow.content).hide()):($(".pexels-logo",this.imageSearchWindow.content).hide(),$(".giphy-logo",this.imageSearchWindow.content).flexShow())),$("#image-search-input",this.imageSearchWindow.content).focus(),$("#image-search-provider",this.imageSearchWindow.content).on("change",(e=>{"pexels"===e.target.value?($(".pexels-logo",this.imageSearchWindow.content).show(),$(".giphy-logo",this.imageSearchWindow.content).hide()):($(".pexels-logo",this.imageSearchWindow.content).hide(),$(".giphy-logo",this.imageSearchWindow.content).show());$("#image-search-input",this.imageSearchWindow.content).val().trim()&&$("#image-search-form",this.imageSearchWindow.content).trigger("submit")})),this.imageSearchWindow}async fetchImages(e,t=12,i="pexels"){try{const a=i||$("#image-search-provider").val()||"google",o=`${buddypond.imageSearchEndpoint}/image-search?q=${encodeURIComponent(e)}&num=${t}&provider=${a}`,s=await fetch(o,{headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.bp.qtokenid}`,"X-Me":this.bp.me}});if(!s.ok)throw new Error(`Image search failed: ${s.status} ${s.statusText}`);return await s.json()}catch(e){return console.warn("ImageSearch error:",e),[]}}}export{e as default};
//# sourceMappingURL=image-search.js.map
