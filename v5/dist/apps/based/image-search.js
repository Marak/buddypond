class e{constructor(e,t={}){this.bp=e,this.context=null,this.output=null}async init(){this.html=await this.bp.load("/v5/apps/based/image-search/image-search.html"),await this.bp.appendCSS("/v5/apps/based/image-search/image-search.css"),this.bp.searchImages=async(e,t=6)=>await this.fetchImages(e,t),this.bp.searchImage=async e=>{let t=await this.fetchImages(e,10);return t[Math.floor(Math.random()*t.length)]}}async open(e={}){if(e.context&&(this.context=e.context),e.output&&(this.output=e.output),!this.imageSearchWindow){this.imageSearchWindow=this.bp.apps.ui.windowManager.createWindow({id:"image-search",title:"Search Images",icon:"desktop/assets/images/icons/icon_image-search_64.png",x:250,y:75,width:460,height:500,minWidth:400,minHeight:300,parent:$("#desktop")[0],content:this.html,resizable:!0,minimizable:!0,maximizable:!0,closable:!0,focusable:!0,maximized:!1,minimized:!1,onClose:()=>{this.imageSearchWindow=null}});const t=$("#image-search-form"),a=$("#image-search-input"),s=$("#image-search-results");async function i(){let e=("pond"===this.output?"pond_message_-":"buddy_message_-")+this.context,t=this.bp.apps.ui.windowManager.getWindow(e);console.log(`context: ${this.context}, type: ${this.type}`),console.log("chatWindow",t);const a=[];for(let e of this.selectedImages){const t=await fetch(e),s=await t.blob(),i=e.split("/").pop().split("?")[0],r=new File([s],i,{type:s.type});a.push(r),this.selectedImages.delete(e)}if(0===a.length)return;const s=new DataTransfer;a.forEach((e=>s.items.add(e))),this.bp.apps.droparea.dropTarget=t.container;const i=new DragEvent("drop",{dataTransfer:s,bubbles:!0,cancelable:!0});if(t.container.dispatchEvent(i),t){let e=$(t).attr("id");this.bp.apps.ui.windowManager.focusWindow(e)}else console.warn("No active chat window found to send images to.")}t.on("submit",(async t=>{t.preventDefault();const r=a.val().trim();if(!r)return;s.empty(),console.log("Searching for images with query:",r);const o=await this.fetchImages(r,12,e.provider);return o.error?($("#image-search-error").html(`<p>${o.error}</p>`),$("#image-search-error").show(),void console.error("Image search error:",o.error)):0===o.length?($("#image-search-error").html("<p>No images found.</p>"),void $("#image-search-error").show()):($("#image-search-error").hide(),$("#image-search-error").html(""),void o.forEach((e=>{const t=$(`<img src="${e}" style="width: 100%; cursor: pointer; border-radius: 4px;" />`);t.on("click",(()=>{this.selectedImages.has(e)?this.selectedImages.delete(e):(this.selectedImages.add(e),i.call(this))})),s.append(t)})))})),this.selectedImages=new Set}return e.provider&&$("#image-search-provider",this.imageSearchWindow.content).val(e.provider),$("#image-search-input",this.imageSearchWindow.content).focus(),this.imageSearchWindow}async fetchImages(e,t=12,a="pexels"){try{const s=a||$("#image-search-provider").val()||"google",i=`${buddypond.imageSearchEndpoint}/image-search?q=${encodeURIComponent(e)}&num=${t}&provider=${s}`,r=await fetch(i,{headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.bp.qtokenid}`,"X-Me":this.bp.me}});if(!r.ok)throw new Error(`Image search failed: ${r.status} ${r.statusText}`);return await r.json()}catch(e){return console.warn("ImageSearch error:",e),[]}}}export{e as default};
//# sourceMappingURL=image-search.js.map
