class e{constructor(e,t={}){return this.bp=e,this.options=t,this.showDots=!0,this}async init(){await this.bp.appendScript("https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"),await this.bp.appendScript("https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"),await this.bp.appendScript("https://cdn.jsdelivr.net/npm/@mediapipe/holistic"),await this.bp.appendScript("https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils"),await this.bp.appendScript("https://cdn.jsdelivr.net/npm/@mediapipe/hands"),await this.bp.load("spellbook"),await this.bp.appendScript("https://cdn.jsdelivr.net/npm/fingerpose/dist/fingerpose.min.js"),await this.bp.appendCSS("/v5/apps/based/computer-vision/computer-vision.css"),this.html=await this.bp.load("/v5/apps/based/computer-vision/computer-vision.html"),this.spellMap={"victory-thumbs_up":{gestures:"âœŒï¸ðŸ‘",spell:"fireball",jutsu:"fireball",type:"jutsu",emoji:"ðŸ”¥",label:"ðŸ”¥ Fireball ðŸ”¥"},"thumbs_up-thumbs_down":{gestures:"ðŸ‘ðŸ‘Ž",spell:"barrelRoll",jutsu:"barrelRoll",type:"jutsu",emoji:"ðŸŒ€",label:"ðŸŒ€ Barrel Roll ðŸŒ€"},"thumbs_down-thumbs_up":{gestures:"ðŸ‘ŽðŸ‘",spell:"barrelRoll",jutsu:"barrelRoll",type:"jutsu",emoji:"ðŸŒ€",label:"ðŸŒ€ Barrel Roll ðŸŒ€"},"point_right-point_left":{gestures:"ðŸ‘‰ðŸ‘ˆ",spell:"lightning",jutsu:"lightning",type:"jutsu",emoji:"âš¡",label:"âš¡ Lightning âš¡"},"point_left-point_right":{gestures:"ðŸ‘ˆðŸ‘‰",spell:"lightning",jutsu:"lightning",type:"jutsu",emoji:"âš¡",label:"âš¡ Lightning âš¡"},"open_palm-open_palm":{gestures:"ðŸ‘ðŸ‘",spell:"earthquake",jutsu:"earthquake",type:"jutsu",emoji:"ðŸŒ",label:"ðŸŒ Earthquake ðŸŒ"},"hang_loose-hang_loose":{gestures:"ðŸ¤™ðŸ¤™",spell:"flood",jutsu:"flood",type:"jutsu",emoji:"ðŸŒŠ",label:"ðŸŒŠ Flood ðŸŒŠ"},"devil_horns-devil_horns":{gestures:"ðŸ¤˜ðŸ¤˜",spell:"vortex",jutsu:"vortex",type:"jutsu",emoji:"ðŸŒªï¸",label:"ðŸŒªï¸ Vortex ðŸŒªï¸"}},console.log(fp.Gestures);const{Finger:e,FingerCurl:t,FingerDirection:i,GestureDescription:s}=fp,n=new s("fist_thumb_in");for(let i of e.all)n.addCurl(i,t.FullCurl,1);const l=new fp.GestureDescription("open_palm");for(let e of fp.Finger.all)l.addCurl(e,fp.FingerCurl.NoCurl,1),l.addDirection(e,fp.FingerDirection.VerticalUp,.9);l.addDirection(fp.Finger.Index,fp.FingerDirection.DiagonalUpLeft,.5),l.addDirection(fp.Finger.Pinky,fp.FingerDirection.DiagonalUpRight,.5);const a=new s("point_up");a.addCurl(e.Index,t.NoCurl,1),a.addDirection(e.Index,i.VerticalUp,1),[e.Thumb,e.Middle,e.Ring,e.Pinky].forEach((e=>{a.addCurl(e,t.FullCurl,1)}));const o=new s("hang_loose");o.addCurl(e.Thumb,t.NoCurl,1),o.addCurl(e.Pinky,t.NoCurl,1),o.addDirection(e.Thumb,i.VerticalUp,1),o.addDirection(e.Thumb,i.DiagonalUpLeft,.9),o.addDirection(e.Thumb,i.DiagonalUpRight,.9);for(let i of[e.Index,e.Middle,e.Ring])o.addCurl(i,t.FullCurl,1),o.addCurl(i,t.HalfCurl,.9);const r=new s("thumbs_down");r.addCurl(e.Thumb,t.NoCurl,1),r.addDirection(e.Thumb,i.VerticalDown,1),r.addDirection(e.Thumb,i.DiagonalDownLeft,.9),r.addDirection(e.Thumb,i.DiagonalDownRight,.9);for(let i of[e.Index,e.Middle,e.Ring,e.Pinky])r.addCurl(i,t.FullCurl,1),r.addCurl(i,t.HalfCurl,.9);const d=new s("tight_victory");for(let s of[e.Index,e.Middle])d.addCurl(s,t.NoCurl,1),d.addDirection(s,i.VerticalUp,1),d.addDirection(s,i.DiagonalUpLeft,.9),d.addDirection(s,i.DiagonalUpRight,.9);for(let i of[e.Ring,e.Pinky])d.addCurl(i,t.FullCurl,1);d.addCurl(e.Thumb,t.HalfCurl,.9);const u=new s("okay");u.addCurl(e.Thumb,t.HalfCurl,1),u.addCurl(e.Index,t.HalfCurl,1),[e.Middle,e.Ring,e.Pinky].forEach((e=>{u.addCurl(e,t.NoCurl,1)}));const h=new s("point");h.addCurl(e.Index,t.NoCurl,1),[e.Thumb,e.Middle,e.Ring,e.Pinky].forEach((e=>{h.addCurl(e,t.FullCurl,1),h.addCurl(e,t.HalfCurl,.9)}));const p=new s("devil_horns");return[e.Index,e.Pinky].forEach((e=>{p.addCurl(e,t.NoCurl,1)})),[e.Middle,e.Ring].forEach((e=>{p.addCurl(e,t.FullCurl,1),p.addCurl(e,t.HalfCurl,.9)})),p.addCurl(e.Thumb,t.NoCurl,.9),p.addCurl(e.Thumb,t.HalfCurl,1),this.GE=new fp.GestureEstimator([fp.Gestures.VictoryGesture,fp.Gestures.ThumbsUpGesture,n,a,l,o,r,d,u,p,h]),this.gestureEmoji={victory:"âœŒï¸",thumbs_up:"ðŸ‘",fist_left:"ðŸ¤›",fist_right:"ðŸ¤œ",point_up:"â˜ï¸",open_palm:"ðŸ–ï¸",hang_loose:"ðŸ¤™",thumbs_down:"ðŸ‘Ž",tight_victory:"ðŸ¤ž",okay:"ðŸ‘Œ",devil_horns:"ðŸ¤˜",point_left:"ðŸ‘ˆ",point_right:"ðŸ‘‰"},this.jutsuQueue=[],this.lastGestureTime=Date.now(),this.hands=new Hands({locateFile:e=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${e}`}),"loaded ComputerVision"}async open(){if(this.win)return this.win.focus(),this.win;return this.win=this.bp.window(this.window()),document.getElementById("toggle-dots-btn").onclick=()=>{this.showDots=!this.showDots,$(".spell-guide",this.win.content).toggle()},this.renderSpellGuide(this.spellMap),function(){const e=["Initializing camera...","Loading vision model...","Warming up tensors...","Calibrating hand gestures...","Syncing overlays...","Finalizing setup..."];let t=0;const i=$("#loading-text",this.win.content),s=setInterval((()=>{i.text(e[t]),t++,t>=e.length&&clearInterval(s)}),1200)}.call(this),this.startObjectDetection(),this.win.maximize(),this.win}window(){return{id:"computer-vision",title:"Jutsu Caster",icon:"desktop/assets/images/icons/icon_jutsu_64.png",x:250,y:75,width:600,height:400,minWidth:400,minHeight:300,parent:$("#desktop")[0],content:this.html,resizable:!0,minimizable:!0,maximizable:!0,closable:!0,focusable:!0,maximized:!1,minimized:!1,onClose:()=>{this.win=null,this.video.srcObject.getTracks().forEach((e=>e.stop())),this.video=null}}}async startObjectDetection(){const e=document.getElementById("video"),t=document.getElementById("canvas"),i=t.getContext("2d"),s=await cocoSsd.load(),n=await navigator.mediaDevices.getUserMedia({video:!0});e.srcObject=n,this.video=e,await new Promise((t=>{e.onloadeddata=()=>t()})),e.play(),e.style.display="none";const l=new Holistic({locateFile:e=>`https://cdn.jsdelivr.net/npm/@mediapipe/holistic/${e}`});l.setOptions({modelComplexity:1,smoothLandmarks:!0,enableSegmentation:!1,refineFaceLandmarks:!0,minDetectionConfidence:.7,minTrackingConfidence:.7,selfieMode:!0});const a=new Hands({locateFile:e=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${e}`});a.setOptions({maxNumHands:2,modelComplexity:1,minDetectionConfidence:.85,minTrackingConfidence:.85,selfieMode:!0}),this.previousGestures={},this.lastGestureTimePerHand={};let o=!1,r=Date.now();setTimeout((()=>{o||($(".instruction-overlay",this.win.content).hide(),o=!0)}),1e4),a.onResults((async e=>{const t=document.getElementById("gesture-trail"),i=document.getElementById("gesture-spell"),s=Date.now();if(e.multiHandLandmarks&&e.multiHandLandmarks.length>0){if(!o){Date.now()-r>7e3&&($(".instruction-overlay",this.win.content).hide(),o=!0)}const n=[];s-this.lastGestureTime>5e3&&(this.jutsuQueue=[],t.innerHTML="",this.previousGestures={},this.lastGestureTimePerHand={});for(let i=0;i<e.multiHandLandmarks.length;i++){const l=e.multiHandLandmarks[i].map((e=>[e.x,e.y,e.z])),a=this.GE.estimate(l,8.5),o=e.multiHandedness?.[i]?.label;if(a.gestures.length>0){let e=a.gestures.reduce(((e,t)=>e.score>t.score?e:t)).name;"point"===e&&(e="Left"===o?"point_left":"point_right"),"fist_thumb_in"===e&&(e="Left"===o?"fist_left":"fist_right");const l=this.gestureEmoji[e]||"â“",r=this.previousGestures[i],d=this.lastGestureTimePerHand[i]||0;if(r!==e&&s-d>500){this.previousGestures[i]=e,this.lastGestureTimePerHand[i]=s,n.push({name:e,emoji:l});const a=document.createElement("span");for(a.textContent=l,a.style.marginRight="6px",t.prepend(a);t.children.length>10;)t.removeChild(t.lastChild);console.log("[Hand Gesture]",e),this.jutsuQueue.push(e)}}else this.previousGestures[i]=null,this.lastGestureTimePerHand[i]=0}if(this.lastGestureTime=s,this.jutsuQueue.length>2&&(this.jutsuQueue=this.jutsuQueue.slice(-2)),n.length>0){await this.handleJutsuCast(this.jutsuQueue,i,this.bp)&&!o&&($(".instruction-overlay",this.win.content).hide(),o=!0)}}}));let d=!1;l.onResults((e=>{if(d||($("#cv-loading",this.win.content).fadeOut(300),d=!0,$(".instruction-overlay",this.win.content).flexShow()),i.clearRect(0,0,t.width,t.height),i.drawImage(e.image,0,0,t.width,t.height),this.showDots&&e.poseLandmarks)for(const s of e.poseLandmarks){const e=s.x*t.width,n=s.y*t.height;i.beginPath(),i.arc(e,n,4,0,2*Math.PI),i.fillStyle="lime",i.fill()}if(this.showDots&&e.faceLandmarks)for(let s=0;s<e.faceLandmarks.length;s+=10){const n=e.faceLandmarks[s],l=n.x*t.width,a=n.y*t.height;i.beginPath(),i.arc(l,a,2,0,2*Math.PI),i.fillStyle="yellow",i.fill()}if(this.showDots&&e.leftHandLandmarks)for(const s of e.leftHandLandmarks){const e=s.x*t.width,n=s.y*t.height;i.beginPath(),i.arc(e,n,4,0,2*Math.PI),i.fillStyle="cyan",i.fill()}if(this.showDots&&e.rightHandLandmarks)for(const s of e.rightHandLandmarks){const e=s.x*t.width,n=s.y*t.height;i.beginPath(),i.arc(e,n,4,0,2*Math.PI),i.fillStyle="magenta",i.fill()}if(e.poseLandmarks){const t=e.poseLandmarks[15],i=e.poseLandmarks[16],s=e.poseLandmarks[11],n=e.poseLandmarks[12];t.x>n.x&&t.x<s.x&&i.x>n.x&&(i.x,s.x),t.x,i.x,t.y,i.y,s.y,n.y,t.y,i.y}}));new Camera(e,{onFrame:async()=>{t.width=e.videoWidth,t.height=e.videoHeight,await l.send({image:e}),await a.send({image:e});const n=await s.detect(e),o=$("#object-list",this.win.content)[0];o.innerHTML="",n.forEach((e=>{const[t,s,n,l]=e.bbox;this.showDots&&(i.beginPath(),i.rect(t,s,n,l),i.lineWidth=2,i.strokeStyle="red",i.fillStyle="red",i.stroke(),i.fillText(e.class,t,s>10?s-5:10));const a=document.createElement("li");a.textContent=`${e.class} (${(100*e.score).toFixed(1)}%)`,o.appendChild(a)}))},width:640,height:480}).start()}async handleJutsuCast(e,t){const i=e.join("-"),s=this.spellMap[i];if(s){console.log(`ðŸ”¥ Jutsu Cast: ${s.jutsu.charAt(0).toUpperCase()+s.jutsu.slice(1)}!`),t.innerHTML=s.label;try{(await this.bp.importModule(`/v5/apps/based/spellbook/spells/${s.spell}/${s.spell}.js`,{},!1)).default.call(this)}catch(e){console.error("Error importing spell module:",e)}return e.length=0,setTimeout((()=>{t.innerHTML=""}),2200),!0}}renderSpellGuide(e){const t=$("#spell-list"),i=new Set;for(const[s,n]of Object.entries(e)){const e=n.jutsu+n.emoji;if(i.has(e))continue;i.add(e);let s=n.label||`${n.emoji} ${n.spell}`;s=n.gestures+` ${s}`,t.append(`<li>${s}</li>`)}}}export{e as default};
//# sourceMappingURL=computer-vision.js.map
