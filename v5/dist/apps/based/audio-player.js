function e(t){const e=document.createElement("div");e.className="audio-track";const i=document.createElement("p");i.textContent=t.metadata.fileName||"No file loaded",e.appendChild(i);const n=document.createElement("button");return n.textContent="Play",n.addEventListener("click",(()=>{console.log("playPauseButton clicked",t.isPlaying()),t.isPlaying()?(t.pause(),n.textContent="Play"):(t.play(),n.textContent="Pause")})),e.appendChild(n),e}class i{constructor(t="workerFetchWithProgress.js"){this.worker=new Worker(t),this.requests={},this.worker.onmessage=t=>{const{type:e,id:i,progress:n,data:s,error:o}=t.data,r=this.requests[i];if(r)switch(e){case"progress":r.onProgress&&r.onProgress(n);break;case"completed":r.resolve&&r.resolve(t.data),delete this.requests[i];break;case"error":r.reject&&r.reject(o),delete this.requests[i]}}}fetch(t,e={},i){const n=Math.random().toString(36).substr(2,9);return this.requests[n]={onProgress:i,id:n},new Promise(((i,s)=>{this.requests[n].resolve=i,this.requests[n].reject=s,this.worker.postMessage({url:t,options:e,id:n})}))}}class n{constructor(t){return this.bp=t,this}async init(){}async fetchWithProgress(t,e={},n){return(new i).fetch(t,e,n)}}class s{constructor(t){this.bp=t,this.fetchInWebWorker=new n}async loadAudioData(t,e={},i=()=>{}){const n=await this.fetchInWebWorker.fetchWithProgress(t,{},i);return{arrayBuffer:n.arrayBufferResponse,blob:n.blobResponse}}}class o{constructor(t={}){var i;return this.id=t.id||`track-${Math.random().toString(36).substr(2,9)}`,this.metadata=t||{},this.metadata.cuePoints=this.metadata.cuePoints||[],this.provider=t.provider||null,this.source=null,this.audioNodes=new Map,this.element=null,this.renderers=new Map,this.currentRenderer="default",this.isLoaded=!1,this.isRendered=!1,(i=o).prototype.load=async function(t={}){if(this.options?.noFile)return this;t.url&&(this.metadata.url=t.url);try{this.provider||(this.provider=new s(this.bp)),console.log("Loading audio track:",this.metadata.url,this);const{arrayBuffer:e,blob:i}=await this.provider.loadAudioData(this.metadata.url,t,(t=>this.loadingProgress(t)));return await this._processAudioData(e,i),await this._setupMediaSource(i)}catch(t){throw console.error(`Failed to load track: ${this.metadata.url}`,t),t}},i.prototype._setupMediaSource=async function(t){return new Promise((async(e,i)=>{const n=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream;if(n)this.audioElement.src=URL.createObjectURL(t),this.audioElement.addEventListener("canplaythrough",(()=>{this.metadata.duration=this.audioElement.duration,s()})),this.audioElement.addEventListener("error",o);else{const e=new MediaSource;this.audioElement.src=URL.createObjectURL(e),e.addEventListener("sourceopen",(async()=>{try{const i=e.addSourceBuffer("audio/mpeg"),n=await t.arrayBuffer();this.metadata.duration=this.audioBuffer.duration,i.addEventListener("updateend",s),i.addEventListener("error",o),i.appendBuffer(n)}catch(t){console.error("Error with MediaSource or SourceBuffer:",t),o(t)}}))}const s=()=>{this.isLoaded||(this.isLoaded=!0,console.log("Track loaded:",this.metadata.url),e(this))},o=t=>{console.error("Audio element error:",t),i(`Failed to load track: ${this.metadata.url}`)};(n||this.url&&this.url.endsWith(".wav"))&&this.audioElement.load()}))},i.prototype._initializeAudioElements=function(){this.audioElement=new Audio,this.audioElement.crossOrigin="anonymous",this.audioElement.preservesPitch=!0},i.prototype._processAudioData=async function(t,e){this.audioData=t,this.blob=e,console.log("Audio data received:",this.audioData),this.audioBuffer=await this.audioContext.decodeAudioData(t),this.metadata.fileSize=this.audioBuffer.length,function(t){const e=[];for(let i=0;i<t.numberOfChannels;i++)e.push(t.getChannelData(i))}(this.audioBuffer)},i.prototype._decodeAudioWithFFmpeg=async function(t){let e=new FFmpeg;return await e.load(),console.log("✅ FFmpeg WASM loaded successfully"),new Promise((async(i,n)=>{try{console.log("⏳ Decoding audio with FFmpeg...");const n="input.mp3",s="output.raw";await e.writeFile(n,await fetchFile(t)),await e.exec(["-i",n,"-f","f32le","-acodec","pcm_f32le","-ar","44100","-ac","2",s]);const o=await e.readFile(s),r=44100,a=2,l=o.length/(4*a),d=(new AudioContext).createBuffer(a,l,r),c=new Float32Array(o.buffer);for(let t=0;t<a;t++){const e=new Float32Array(l);for(let i=0;i<l;i++)e[i]=c[i*a+t];d.copyToChannel(e,t)}console.log("✅ Audio decoded successfully"),i(d)}catch(t){console.log(t),n(new Error(`❌ FFmpeg decoding failed: ${t.message}`))}}))},i.prototype.loadingProgress=function(t){this.emit("audio-track::loading::progress",t)},i.prototype.loadingComplete=function(t){this.emit("audio-track::loading::complete",t)},this.eventListeners={},this.fx={},this._initializeAudioElements(),this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.masterBus=this.audioContext.createGain(),this.distributionNode=this.audioContext.createGain(),this.source=this.audioContext.createMediaElementSource(this.audioElement),this.source.disconnect(),this.source.connect(this.masterBus),this.masterBus.connect(this.distributionNode),this.distributionNode.connect(this.audioContext.destination),this.distributionNode.gain.value=1,this.analyzers=new Map,this.setRenderer("default",e),this}async unload(){console.log("Unloading track:",this),this.metadata={},this.waveform&&this.waveform.destroy(),this.isLoaded&&(this.audioNodes.clear(),this.source&&this.source.disconnect(),this.audioElement&&(this.audioElement.pause(),this.audioElement.src=""),this.audioContext&&this.audioContext.close(),this.audioContext=null,this.audioBuffer=null,this.isLoaded=!1,console.log("track should be fully unloaded now going to rebind with empty data",this),this.databind())}async remove(){await this.unload(),await this.unrender()}setRenderer(t,e){this.renderers.set(t,e),this.currentRenderer=t}databind(){const t=this.renderers.get(this.currentRenderer);if(!t)throw new Error(`No renderer found for name: ${this.currentRenderer}`);const e=t.databind;if(!e)throw new Error(`No databind function found for renderer: ${this.currentRenderer}`);return e(this)}render(){if(this.isRendered)return this.element;const t=this.renderers.get(this.currentRenderer),e=t.render;if(t.databind,console.log("using renderer:",this.currentRenderer,t),!t)throw new Error(`No renderer found for name: ${this.currentRenderer}`);return this.element=e(this),this.isRendered=!0,this.element}unrender(){this.isRendered&&this.element&&(this.element.remove(),this.element=null,this.isRendered=!1)}setData(t){this.metadata={...this.metadata,...t},this.isRendered&&this._updateRenderedData(t)}switchLayout(t){if(!this.renderers.has(t))throw new Error(`No renderer found for name: ${t}`);return this.unrender(),this.currentRenderer=t,this.render()}addNode(t,e){if(console.log("Adding node:",t,e,this),!this.isLoaded||!this.source)throw new Error("Cannot add node: track not loaded");this.audioNodes.has(t)&&this.removeNode(t),this.audioNodes.set(t,e),this._reconnectAudioGraph()}removeNode(t){if(!this.audioNodes.has(t))return;this.audioNodes.get(t).disconnect(),this.audioNodes.delete(t),this._reconnectAudioGraph()}addAnalyzer(t,e){this.analyzers.has(t)&&this.removeAnalyzer(t),this.analyzers.set(t,e),this.distributionNode.connect(e)}removeAnalyzer(t){this.analyzers.has(t)&&(this.distributionNode.disconnect(this.analyzers.get(t)),this.analyzers.delete(t))}async _initializeAudio(){}async _loadAudioFile(t){}_reconnectAudioGraph(){let t=this.masterBus;this.audioNodes.forEach((e=>{t.disconnect(),t.connect(e),t=e})),t.disconnect(),t.connect(this.distributionNode),this.distributionNode.connect(this.audioContext.destination)}_updateRenderedData(t){console.log("Updating rendered data:",t)}pause(){this.audioElement.paused||this.audioElement.pause()}play(){this.audioElement.paused&&(console.log("Playing audio track"),this.audioElement.play())}playPause(){this.audioElement.paused?this.play():this.pause()}setTime(t){this.audioElement.currentTime=t}cueTo(t){let e=(this.metadata.cuePoints[t-1]??0).time;console.log("CUE TO TIME",e),this.setTime(e)}setCuePoint(t,e){let i={time:e,name:`Cue ${t}`,type:"cue"};this.metadata.cuePoints[t-1]=i}isPlaying(){return!this.audioElement.paused}emit(t,e){this.eventListeners[t]&&this.eventListeners[t].forEach((t=>t(e)))}on(t,e){this.eventListeners[t]||(this.eventListeners[t]=[]),this.eventListeners[t].push(e)}toggleMute(){this.audioElement.muted=!this.audioElement.muted}toggleKeyLock(){this.audioElement.preservesPitch=!this.audioElement.preservesPitch}mute(){this.audioElement.muted=!0,this.transport.volumeSliderIcon&&(this.transport.volumeSliderIcon.classList.remove("headphones-active"),this.transport.volumeSliderIcon.classList.add("headphones-inactive"))}unmute(){this.audioElement.muted=!1,this.transport.volumeSliderIcon&&(this.transport.volumeSliderIcon.classList.remove("headphones-inactive"),this.transport.volumeSliderIcon.classList.add("headphones-active"))}setVolume(t){this.audioElement.volume=t}getTitle(){let t=this.metadata,e=t.title||t.fileName;return console.log("attempting to get track title",t,e),e?(t.title?(e=t.title,t.artist&&(e=`${t.artist} - ${t.title}`)):t.artist&&(e=t.artist),e=e.replace("_(mp3.pm)",""),e=e.replace(".mp3",""),e=e.split("_").join(" "),console.log("GOT TRACK TITLE",e),e):"loading track..."}}function r(t,e){console.log("Creating top track controls for:",t),t.id;let i=function(t){const e=document.createElement("div");e.className="titleContainer";const i=document.createElement("span");let n=t.getTitle(t);return i.textContent=`${n}`,i.className="titleElement",i.style.overflow="hidden",i.style.textOverflow="ellipsis",e.appendChild(i),e}(t);t.transport.titleElement=i,e.appendChild(i);let n=function(t){const e=document.createElement("div");e.className="tags-container";const i=document.createElement("div");i.className="tag key-tag",i.innerText=t.metadata.key?t.metadata.key.note:"N/A",e.appendChild(i);const n=document.createElement("div");n.className="tag bpm-tag",n.innerText=t.metadata.bpm?Number(t.metadata.bpm).toFixed(2):"N/A",e.appendChild(n);const s=document.createElement("div");s.className="tag genre-tag",s.innerText=t.metadata.genre||"N/A",e.appendChild(s);const o=document.createElement("div");o.className="tag artist-tag",o.innerText=t.metadata.artist||"N/A",e.appendChild(o);const r=document.createElement("div");return r.className="tag add-tag",r.innerText="+",r.addEventListener("click",(()=>{console.log("Add tag clicked")})),e.appendChild(r),e}(t);t.transport.tagsElement=n,e.appendChild(n);let s=document.createElement("div");s.className="data-container";let o=document.createElement("div");o.className="time-display",o.innerText="00:00",s.appendChild(o);let r=document.createElement("div");r.className="current-bpm",r.innerText=t.metadata.bpm?Number(t.metadata.bpm).toFixed(2):"N/A",s.appendChild(r);let a=document.createElement("div");a.className="key-text",a.innerText=t.metadata.initialKey||"N/A",s.appendChild(a),e.appendChild(s);let l=document.createElement("div");l.className="time-duration",l.innerText="",s.appendChild(l);let d=document.createElement("div");d.className="bpm-text",d.innerText=t.metadata.bpm?Number(t.metadata.bpm).toFixed(2):"N/A",d.addEventListener("click",(async()=>{console.log("Setting BPM to",t.metadata.bpm),await t.setBPM(t.metadata.bpm)})),s.appendChild(d);let c=document.createElement("div");c.className="bpm-percentage",c.innerText="0%",c.style.fontSize="14px !important",s.appendChild(c),t.transport.detailedTimeDisplay=o,t.transport.detailedTimeDuration=l,t.transport.trackBpmPercentage=c,t.transport.currentTrackBpm=r;let h=document.createElement("button");h.classList.add("key-lock-btn","key-lock-btn-active"),h.title="Pitch Bend Key Lock",h.innerHTML='<i class="fas fa-music"></i>',h.addEventListener("click",(async()=>{console.log("Key Lock button clicked"),h.classList.contains("key-lock-btn-active")?(h.classList.remove("key-lock-btn-active"),h.classList.add("key-lock-btn-inactive")):(h.classList.add("key-lock-btn-active"),h.classList.remove("key-lock-btn-inactive")),await t.toggleKeyLock()})),e.appendChild(h)}function a(t,e,i,n,s=null,o="#8a2be2",r=1){if(s||(s={color:"white",backgroundColor:"rgba(0, 0, 0, 0.5)",border:"1px solid white",borderRadius:"5px",paddingLeft:"5px",paddingRight:"5px",marginLeft:"5px",lineHeight:"1em"}),r=i.metadata.beatLength/8,!n||"number"!=typeof n.time)return void console.error("Invalid cue point:",n);let a=n.time,l=n.point||(t+1).toString(),d=document.createElement("span");d.classList.add("region-label"),d.addEventListener("click",(function(t){let e=t.target.textContent;return api.track.cueTo(i.id,e),t.preventDefault(),t.stopPropagation(),!1}));for(let t in s)d.style[t]=s[t];d.textContent=l;let c=a;e.regions.addRegion({start:c,end:c+r,content:d,color:o,drag:!1,resize:!1})}o.prototype.getAudioBuffer=async function(){this.audioBuffer=await this.audioContext.decodeAudioData(audioData)},o.prototype.setBPM=function(t){t=Number(t),console.log("AAAA track.setBPM",this.id,t);let e=this.waveform;if(this){this.currentBPM=t;let i=t/(this.bpm||120);i=Math.round(100*i)/100,e.setPlaybackRate(i),this.audioElement.playbackRate=i,this.detailedContainer.querySelector(".current-bpm"),t.toFixed(2),this.detailedContainer.querySelector(".bpm-percentage")}};const l={renderCuePoints:function(t,e,i="#8a2be2",n=1,s=null){let o=e.metadata.cuePoints||[];o.length&&o.forEach(((o,r)=>{a(r,t,e,o,s,i,n)}))},renderCuePoint:a},d={createCueControls:function(t){let e=document.createElement("div");e.id=`#cueControls-${t.id}`,e.classList.add("cue-controls");let i=d.createCueButtons(t);return e.appendChild(i),e},createCueButtons:function(t){let e=document.createElement("div");e.classList.add("cue-buttons");for(let i=1;i<=8;i++){let n=d.createCueButton(t,i);e.appendChild(n)}return e},createCueButton:function(e,i){let n=document.createElement("button");n.classList.add("cue-button");let s="",o=Number(i)-1;if(e&&e.metadata.cuePoints){let t=e.metadata.cuePoints;t&&t[Number(i)]&&(s="cue-mapped")}return n.innerHTML=`<span class="cue-number ${s}">${i}</span>`,n.dataset.cueNumber=i,e.transport.cueButtons=e.transport.cueButtons||{},e.transport.cueButtons[i]=n,n.addEventListener("mousedown",(function(){e.isPlaying(e.id);let s=e.metadata.cuePoints;if(console.log("using cuePoints",s),s&&s[Number(i)-1])console.log("cueButton mousedown",n.dataset.cueNumber),e.cueTo((o+1).toString());else{console.log("No cue point set for this button");let n=e.waveform.getCurrentTime();console.log("Setting cue point",i,n),e.setCuePoint(i,n),l.renderCuePoint(i-1,e.detailedWaveform,t,cue)}document.querySelectorAll(".cue-button").forEach((t=>{t!==n&&t.classList.remove("btn-active")}))})),n.addEventListener("mouseup",(function(){})),n}};var c=d.createCueControls;function h(t,e,i={}){return new u(t,e,i)}function u(t,e,i={}){const n={...{className:"volume-slider",thumbClassName:"slider-thumb",labelClassName:"label",orientation:"vertical",trackColor:"#333",thumbColor:"#fff",trackWidth:"60px",trackHeight:"200px",thumbWidth:"48px",thumbHeight:"8px",showLabel:!0,showScale:!1,showCenterLine:!1,centerLineColor:"#aeafaf",centerLineLength:"32px",scaleLineLength:"32px",centerLineWidth:"2px",centerLineSpacing:10,progressBarColor:"#4caf50",progressBarSize:"8px",minValue:0,maxValue:1,step:.01,value:0,defaultValue:0,onDoubleClick:t=>{console.log("Must implement double-click handler to reset the value"),this.setValue(t)},onClick:t=>{},onChange:(t,e)=>{console.log("Must implement changeFunction to evoke changes to state")},formatLabel:t=>t.toFixed(2)},...i};this.options=n,this.onClick=n.onClick.bind(this),this.onChange=n.onChange.bind(this),this.onDoubleClick=n.onDoubleClick.bind(this),this.formatLabel=n.formatLabel.bind(this),this.thumbHeight=n.thumbHeight,this.thumbWidth=n.thumbWidth,this.trackWidth=n.trackWidth,this.trackHeight=n.trackHeight,this.orientation=n.orientation,this.defaultValue=n.defaultValue,this.trackLength="vertical"===n.orientation?parseInt(n.trackHeight):parseInt(n.trackWidth);const s=document.createElement("div");if(this.sliderContainer=s,this.minValue=n.minValue,this.maxValue=n.maxValue,this.value=n.value,s.style.background=n.trackColor,s.style.borderRadius="5px",s.classList.add(n.className),s.classList.add("slider-component"),"vertical"===n.orientation?(s.style.width=n.trackWidth,s.style.height=n.trackHeight):(s.style.width=n.trackHeight,s.style.height=n.trackWidth),n.showCenterLine){const t=document.createElement("div");t.style.position="absolute",t.style.background=n.centerLineColor,"vertical"===n.orientation?(t.style.width=n.centerLineLength,t.style.height=n.centerLineWidth,t.style.left=`calc(50% - ${parseInt(n.centerLineLength)/2}px)`,t.style.top="50%"):(t.style.height=n.centerLineLength,t.style.width=n.centerLineWidth,t.style.top=`calc(50% - ${parseInt(n.centerLineLength)/2}px)`,t.style.left="50%"),s.appendChild(t)}if(n.showScale){const t=t=>{const e=document.createElement("div");e.style.position="absolute",e.style.background=n.centerLineColor,e.style.opacity=.2,"vertical"===n.orientation?(e.style.width=n.scaleLineLength,e.style.height=n.centerLineWidth,e.style.left=`calc(50% - ${parseInt(n.scaleLineLength)/2}px)`,e.style.top=`${t}px`):(e.style.height=n.scaleLineLength,e.style.width=n.centerLineWidth,e.style.top=`calc(50% - ${parseInt(n.scaleLineLength)/2}px)`,e.style.left=`${t}px`),s.appendChild(e)},e="vertical"===n.orientation?parseInt(n.trackHeight):parseInt(n.trackWidth),i=e/2,o=n.centerLineSpacing;for(let n=0;i+n<=e||i-n>=0;n+=o)i+n<=e&&t(i+n),i-n>=0&&0!==n&&t(i-n)}if(n.showProgress){const t=document.createElement("div");t.style.position="absolute",t.style.background=n.progressBarColor,t.style.zIndex="1",this.progressBar=t,"vertical"===n.orientation?(t.style.width=n.progressBarSize,t.style.left=`calc(50% - ${parseInt(n.progressBarSize)/2}px)`):(t.style.height=n.progressBarSize,t.style.top=`calc(50% - ${parseInt(n.progressBarSize)/2}px)`),s.appendChild(t)}const o=document.createElement("div");o.classList.add(n.thumbClassName),o.style.position="absolute",o.style.background=n.thumbColor,o.style.borderRadius="4px",o.style.cursor="pointer",o.title=this.options.title||"Track Volume",this.options.sliderThumbStyles&&Object.keys(this.options.sliderThumbStyles).forEach((t=>{o.style[t]=this.options.sliderThumbStyles[t]})),"vertical"===n.orientation?(o.style.width=n.thumbWidth,o.style.height=n.thumbHeight):(o.style.width=n.thumbHeight,o.style.height=n.thumbWidth),this.sliderThumb=o;const r="vertical"===n.orientation?(1-n.value)*this.trackLength:n.value*this.trackLength;"vertical"===n.orientation?o.style.top=r-parseInt(n.thumbHeight)/2+"px":o.style.left=r-parseInt(n.thumbWidth)/2+"px",s.appendChild(o);const a=document.createElement("div");a.classList.add(n.labelClassName),a.textContent=n.value.toFixed(2),a.style.position="absolute",a.style.top="vertical"===n.orientation?"-22px":"50%",a.style.left="vertical"===n.orientation?"50%":"calc(100% + 10px)",a.style.transform="vertical"===n.orientation?"translateX(-50%)":"translateY(-50%)",this.sliderLabel=a,this.options.showLabel||(a.style.display="none"),s.appendChild(a);let l=!1;return o.addEventListener("mousedown",(t=>{this.onClick(this.getValue()),l=!0,this._onChange(t)})),o.addEventListener("touchstart",(t=>{l=!0,this._onChange(t.touches[0])})),document.addEventListener("mousemove",(t=>{l&&this._onChange(t)})),document.addEventListener("touchmove",(t=>{l&&this._onChange(t.touches[0])})),document.addEventListener("mouseup",(()=>{l=!1})),document.addEventListener("touchend",(()=>{l=!1})),s.addEventListener("mousedown",(t=>{t.target!==o&&(this.onClick(this.getValue()),this._onChange(t),l=!0)})),s.addEventListener("touchstart",(t=>{t.target!==o&&(this._onChange(t.touches[0]),l=!0)})),s.addEventListener("touchend",(()=>{l=!1})),s.addEventListener("touchmove",(t=>{l&&this._onChange(t.touches[0])})),s.addEventListener("dblclick",(t=>{this.onDoubleClick(this.defaultValue)})),this.setValue(n.value,!1),this}function p(t,e,i){t.eqNodes||(console.log("Creating EQ nodes for track",t.id),t.eqNodes={lowshelf:t.audioContext.createBiquadFilter(),peaking:t.audioContext.createBiquadFilter(),highshelf:t.audioContext.createBiquadFilter()},t.eqNodes.lowshelf.type="lowshelf",t.eqNodes.lowshelf.frequency.value=200,t.eqNodes.lowshelf.gain.value=0,t.eqNodes.peaking.type="peaking",t.eqNodes.peaking.frequency.value=1e3,t.eqNodes.peaking.Q.value=1,t.eqNodes.peaking.gain.value=0,t.eqNodes.highshelf.type="highshelf",t.eqNodes.highshelf.frequency.value=5e3,t.eqNodes.highshelf.gain.value=0,t.addNode("eq-lowshelf",t.eqNodes.lowshelf),t.addNode("eq-peaking",t.eqNodes.peaking),t.addNode("eq-highshelf",t.eqNodes.highshelf));const n=t.eqNodes[e];n?n.gain.value=i:console.warn(`Invalid EQ type: ${e}`)}function m(t){const{id:e,transport:i}=t,{eq3Container:n}=i;let s=document.createElement("div");s.classList.add("filter-container");const o=document.createElement("button");o.textContent="FILTER",o.classList.add("filterEqSwitch","btn-active");const r=h(t,e,{trackWidth:"110px",trackHeight:"150px",thumbHeight:"24px",thumbWidth:"96px",className:"filter-slider",thumbColor:"yellow",showCenterLine:!0,showScale:!0,minValue:-1,maxValue:1,value:-.911,defaultValue:-1,sliderThumbStyles:{left:"6px"},onChange:e=>function(t,e,i=1){if(!t)return;if(console.log("applyFilter",t.id,e),e=Math.max(-22050,Math.min(22050,Number(e))),i=Math.max(.1,Math.min(10,Number(i))),!t.audioNodes.has("filter")){let e=t.audioContext.createBiquadFilter();console.log("Creating filter node for track",t.id,e),t.addNode("filter",e),t.filterNode=e}const n=t.audioNodes.get("filter"),s=22050;if(e<0){const i=Math.max(-1,Math.min(0,e));t.filterNode.type="lowpass",t.filterNode.frequency.value=s*Math.pow(10/s,-i)}else if(e>0){const i=Math.max(0,Math.min(1,e));t.filterNode.type="highpass",t.filterNode.frequency.value=10*Math.pow(2205,i)}else t.filterNode.type="allpass",t.filterNode.frequency.value=s;n.Q.value=i}(t,e)});return i.filterSlider=r,s.append(r.sliderContainer),o.addEventListener("click",(()=>{"block"===r.sliderContainer.style.display?(r.sliderContainer.style.display="none",o.textContent="FILTER",n.style.display="block",r.style.display="none",n.querySelectorAll("div.label").forEach((t=>{t.style.display="block"}))):(r.sliderContainer.style.display="block",o.textContent="EQ3",n.style.display="none",n.querySelectorAll("div.label").forEach((t=>{t.style.display="none"})))})),s.append(o),s}u.prototype._onChange=function(t){const e=this.sliderContainer.getBoundingClientRect();let i;const n=e.width/1,s=e.height/1;if("vertical"===this.orientation){i=(t.clientY-e.top)/1,i=Math.min(Math.max(i,0),s);const n=1-i/s;this.sliderThumb.style.top=`${Math.min(Math.max(i-parseInt(this.thumbHeight)/2/1,0),s-parseInt(this.thumbHeight)/1)}px`,this.value=n,this.updateProgressBar(n),this.updateLabel(this.formatLabel(n)),this.onChange(n,this.getValue())}else{i=(t.clientX-e.left)/1,i=Math.min(Math.max(i,0),n);const s=i/n;this.sliderThumb.style.left=`${Math.min(Math.max(i-parseInt(this.thumbWidth)/2/1,0),n-parseInt(this.thumbWidth)/1)}px`,this.value=s,this.updateProgressBar(s),this.updateLabel(this.formatLabel(s)),this.onChange(s,this.getValue())}},u.prototype.getValue=function(){return this.value*(this.maxValue-this.minValue)+this.minValue},u.prototype.setValue=function(t,e=!0){const i=Math.min(Math.max(t,this.options.minValue),this.options.maxValue);let n=this.maxValue-this.minValue,s=(i-this.minValue)/n;this.value=s;const o="vertical"===this.orientation?(1-s)*this.trackLength:s*this.trackLength;"vertical"===this.orientation?(this.sliderThumb.style.top=`${Math.min(Math.max(o-parseInt(this.thumbHeight)/2,0),this.trackLength-parseInt(this.thumbHeight))}px`,this.options.showProgress&&(this.progressBar.style.height=(1-s)*this.trackLength+"px",this.progressBar.style.top=s*this.trackLength+"px")):(this.sliderThumb.style.left=`${Math.min(Math.max(o-parseInt(this.thumbWidth)/2,0),this.trackLength-parseInt(this.thumbWidth))}px`,this.options.showProgress&&(this.progressBar.style.width=s*this.trackLength+"px")),this.updateLabel(this.formatLabel(t)),this.updateProgressBar(),e&&this.onChange(s,this.getValue())},u.prototype.updateProgressBar=function(t){if(!this.options.showProgress)return;const e=t*this.trackLength;console.log("value",t,"position",e),"vertical"===this.orientation?(this.progressBar.style.height=`${e}px`,this.progressBar.style.top=this.trackLength-e+"px"):(this.progressBar.style.width=`${e}px`,this.progressBar.style.left="0")},u.prototype.updateLabel=function(t){this.sliderLabel.textContent=this.getValue().toFixed(2)};class g{constructor(t,e){this.track=t,this.trackId=t.id,this.className=e,this.loopButtons=[],this.currentStartIndex=0,this.visibleCount=3,this.selectedBeat=null,this.container=this.createContainer(),this.buttonsWrapper=this.createButtonsWrapper(),this.leftButton=this.createNavButton("left"),this.rightButton=this.createNavButton("right"),this.container.appendChild(this.leftButton),this.container.appendChild(this.buttonsWrapper),this.container.appendChild(this.rightButton)}createContainer(){const t=document.createElement("div");return t.id=`loopControls-${this.trackId}`,t.classList.add("loop-controls",this.className),t}createButtonsWrapper(){const t=document.createElement("div");t.classList.add("loop-buttons-wrapper");const e=document.createElement("div");return e.classList.add("loop-buttons"),t.appendChild(e),t}createNavButton(t){const e=document.createElement("button");return e.textContent="left"===t?"<":">",e.classList.add("loop-nav",`loop-nav-${t}`),e.addEventListener("click",(()=>this.scrollButtons(t))),e}createLoopButtons(t=1/64,e=32){const i=this.buttonsWrapper.querySelector(".loop-buttons");for(let n=t;n<=e;n*=2){const t=this.createLoopButton(n);this.loopButtons.push(t),i.appendChild(t)}this.updateVisibleButtons()}createLoopButton(t){const e=document.createElement("button");return e.classList.add("loop-button"),e.textContent=this.formatBeatText(t),e.dataset.beat=t,e.addEventListener("mousedown",(()=>{this.setLoopBeat(this.track,t,e)})),e}formatBeatText(t){return{[1/64]:"1/64",[1/32]:"1/32",[1/16]:"1/16",[1/8]:"1/8",[1/4]:"1/4",.5:"1/2",1:"1",2:"2",4:"4",8:"8",16:"16",32:"32"}[t]||t}scrollButtons(t){"left"===t&&this.currentStartIndex>0?this.currentStartIndex--:"right"===t&&this.currentStartIndex<this.loopButtons.length-this.visibleCount&&this.currentStartIndex++,this.updateVisibleButtons();let e=this.track;if(e.isLooping){const t=this.loopButtons[this.currentStartIndex];if(t){const i=parseFloat(t.dataset.beat);this.updateActiveLoop(e,i)}this.loopButtons.forEach((t=>t.classList.remove("btn-selected","btn-active"))),t.classList.add("btn-selected","btn-active")}}updateActiveLoop(t,e){document.querySelectorAll(`#loopControls-${this.trackId} .loop-button`).forEach((t=>t.classList.remove("btn-active")));const i=this.loopButtons.find((t=>parseFloat(t.dataset.beat)===e));i&&(i.classList.add("btn-active"),t.loopBeat=e,f(t,e))}updateVisibleButtons(){this.loopButtons.forEach(((t,e)=>{t.style.display=e>=this.currentStartIndex&&e<this.currentStartIndex+this.visibleCount?"inline-block":"none"}))}setBeat(t){const e=this.loopButtons.find((e=>e.dataset.beat==t));e&&(this.scrollToButton(e),e.click())}scrollToButton(t){const e=this.loopButtons.indexOf(t);-1!==e&&(e<this.currentStartIndex?this.currentStartIndex=e:e>=this.currentStartIndex+this.visibleCount&&(this.currentStartIndex=e-this.visibleCount+1),this.updateVisibleButtons())}setLoopBeat(t,e,i){document.querySelectorAll(`#loopControls-${this.trackId} .loop-button`).forEach((t=>t.classList.remove("btn-selected"))),t.isLooping&&t.loopBeat===e?function(t){console.log("STOPPING LOOP",t.id),t.loopRegion&&(t.loopRegion.remove(),t.loopRegion=null,t.isLooping=!1);t.regionOutHandler&&(t.regionOutHandler=null)}(t):(i.classList.add("btn-selected"),f(t,e))}getContainer(){return this.container}setValue(t){this.selectedBeat=t;const e=this.loopButtons.find((e=>e.dataset.beat===t));e&&this.scrollToButton(e)}}function f(t,e,i=null){console.log("LOOPING TRACK",t.id,e),t.isLooping=!0,t.loopBeat=Number(e);const n=t.waveform,s=t.metadata.bpm||120,o=60/s*e;console.log("Loop Duration:",o,"Current BPM:",s);const r=n.getCurrentTime();let a=0;const l=t.metadata.beatGrid;for(let t=0;t<l.length&&l[t]<=r;t++)a=l[t];i&&(a=i),console.log("Closest Beat:",a);const d=a+o,c=a;t.loopStart=c,t.loopEnd=d,t.loopRegion&&t.loopRegion.remove(),t.loopRegion=n.regions.addRegion({start:c,end:d,loop:!1,drag:!1,resize:!1,color:"rgba(0, 123, 255, 0.3)"}),t.regionOutHandler?(r<c||r>d)&&t.regionOutHandler(t.loopRegion):(t.regionOutHandler=e=>{if(e===t.loopRegion&&!t.looping){console.log("Region out - restarting loop");const e=t.loopRegion.start;t.looping=!0,n.regions.un("region-out",t.regionOutHandler),t.setTime(e),setTimeout((()=>{t.looping=!1,n.regions.on("region-out",t.regionOutHandler)}),10)}},n.regions.on("region-out",t.regionOutHandler))}function v(t){let e=t.id,i=document.createElement("div");i.classList.add("transport-util-buttons-container");let n=function(){const t=document.createElement("button");return t.innerHTML='<i class="fa-solid fa-copy"></i>',t.title="Clone track into a new deck",t.classList.add("cloneButton"),t.classList.add("btn-active"),t.addEventListener("click",(async()=>{bp.open("audio-player")})),t}();n.classList.add("fancy-button"),i.appendChild(n),document.getElementById("party-container");let s=function(t){const e=document.createElement("button");return e.innerHTML='<i class="fa-solid fa-record-vinyl"></i>',e.classList.add("nextTrackButton"),e.classList.add("btn-active"),e.title="Load next suggested track",e.addEventListener("click",(()=>{transport.tracks[t]})),e}(e);s.classList.add("fancy-button"),i.appendChild(s),function(){const t=document.createElement("button");return t.innerHTML='<i class="fas fa-music"></i>',t.title="Open track suggestions",t.classList.add("openSuggestionsButton"),t.classList.add("btn-active"),t.addEventListener("click",(()=>{api.ui.toggleLibrary(),setTimeout((()=>{let t=document.getElementById("library-next-tracks-button");t&&t.click()}),222)})),t}().classList.add("fancy-button");let o=function(t){t.id;const e=document.createElement("button");return e.innerHTML='<i class="fa-solid fa-right-from-bracket"></i>',e.title="Unload and close track",e.classList.add("closeButton"),e.classList.add("btn-active"),e.addEventListener("click",(async()=>{await t.unload()})),e}(t);return o.classList.add("fancy-button"),i.appendChild(o),i}function b(t,e){let i=t.id;e||((e=document.createElement("div")).id=`#track${t.id}`,e.classList.add("track-container"),console.log("setupTrackControls making new div...",document.body,e)),t.transport=t.transport||{};let n=document.getElementById(`#rightTrackControls-${i}`),s=document.getElementById(`#topTrackControls-${i}`);s||(s=document.createElement("div"),s.id=`topTrackControls-${i}`,s.className="track-controls",s.classList.add("top-controls"),e.appendChild(s),t.transport.topTrackControls=s),n||(n=document.createElement("div"),n.id=`rightTrackControls-${i}`,n.className="track-controls",n.classList.add("right-controls"),e.appendChild(n),t.transport.rightTrackControls=n),null==e&&((e=document.createElement("div")).id=`#waveform${i}`,console.log("setupTrackControls making new div...",document.body,e),document.body.appendChild(e)),t.transport=t.transport||{},r(t,t.transport.topTrackControls);let o=document.createElement("div");o.className="left-controls",n.appendChild(o);let a=function(t,e){const i=document.createElement("div");i.classList.add("eq-container"),t.transport.eq3Container=i;let n=new h(t,e,{className:"eq-slider-hi",thumbWidth:"32px",thumbHeight:"32px",trackHeight:"150px",trackWidth:"32px",thumbColor:"#00c0e3",minValue:-15,maxValue:15,onChange:function(e,i){p(t,"highshelf",i)}}),s=new h(t,e,{className:"eq-slider-mid",thumbWidth:"32px",thumbHeight:"32px",trackHeight:"150px",trackWidth:"32px",thumbColor:"#00c0e3",minValue:-15,maxValue:15,onChange:function(e,i){p(t,"peaking",i)}}),o=new h(t,e,{className:"eq-slider-lo",thumbWidth:"32px",thumbHeight:"32px",trackHeight:"150px",trackWidth:"32px",thumbColor:"#00c0e3",minValue:-15,maxValue:15,onChange:function(e,i){p(t,"lowshelf",i)}}),r=document.createElement("div");return r.style.display="flex",r.style.justifyContent="center",r.style.alignItems="center",r.style.gap="20px",r.style.position="relative",r.appendChild(n.sliderContainer),r.appendChild(s.sliderContainer),r.appendChild(o.sliderContainer),i.appendChild(r),i}(t);o.appendChild(a);let l=m(t);o.appendChild(l);let d=document.createElement("div");d.className="right-controls",n.appendChild(d);let u=function(t){let e=t.id,i=h(t,e,{trackHeight:"150px",trackWidth:"60px",defaultValue:0,sliderThumbStyles:{left:"6px"},value:0,minValue:-1,maxValue:1,step:.001,showCenterLine:!0,showScale:!0,showLabel:!1,formatLabel:t=>1-t,className:"tempo-slider",onDoubleClick:e=>{t.setBPM(t.metadata.bpm,!0)},onChange:function(e){if(0===e)return void t.setBPM(t.metadata.bpm,!1);let i=60+120*(e=1-e);t.setBPM(i,!1)}});return t.transport.tempoSlider=i,console.log("returning tempoSlider",i),i.sliderContainer}(t);o.appendChild(u);let f=document.createElement("div");f.classList.add("deck-label"),f.textContent=t.currentDeck||"A",d.appendChild(f);let b=function(t,e){let i=new g(t,e);return i.createLoopButtons(),i.setValue("4"),i.getContainer()}(t,"loopControlsA");d.appendChild(b);let y=function(t,e="playPauseCueButtonsA"){t.id;const i=document.createElement("div");i.classList.add(e);const n=document.createElement("button");n.classList.add("cueButton"),n.classList.add("btn-active"),n.title="Cue",n.innerHTML="CUE",n.addEventListener("mousedown",(t=>{n.style.backgroundColor="#666"})),n.addEventListener("mouseup",(t=>{n.style.backgroundColor="#444",n.classList.remove("btn-selected")})),n.addEventListener("mouseleave",(t=>{})),n.addEventListener("mousemove",(t=>{t.buttons}));const s=document.createElement("button");return s.classList.add("playButton"),s.classList.add("btn-active"),s.title="Play/Pause",s.innerHTML='<i class="fa-duotone fa-solid fa-play"></i> <i class="fa-duotone fa-solid fa-solid fa-pause"></i>',s.addEventListener("click",(e=>{console.log("Play/Pause button clicked",t),t.playPause()})),n.addEventListener("mousemove",(t=>{const e=s.getBoundingClientRect();t.clientX>=e.left&&t.clientX<=e.right&&t.clientY>=e.top&&(t.clientY,e.bottom)})),t.transport.playPauseButton=s,i.appendChild(n),i.appendChild(s),i}(t);d.appendChild(y);let C=function(t){let e=t.id,i=document.createElement("div");i.classList.add("volume-slider-container");let n=document.createElement("i");n.classList.add("fa-solid","fa-headphones-simple"),n.classList.add("volumeSliderIcon","headphones"),n.style.fontSize="24px",n.style.marginRight="10px",n.title="Mute / Unmute track",n.addEventListener("click",(()=>{console.log("track",t),t.toggleMute(),n.classList.contains("headphones-inactive")?n.classList.remove("headphones-inactive"):n.classList.add("headphones-inactive")})),t.transport.volumeSliderIcon=n,i.append(n);let s=h(t,e,{minValue:0,maxValue:1,value:1,trackWidth:"20px",trackHeight:"260px",thumbHeight:"48px",thumbWidth:"26px",sliderThumbStyles:{left:"0px"},showLabel:!1,className:"volume-slider",onClick:function(t){},onChange:function(e){t.setVolume(e)}});return t.transport.volumeSlider=s,i.append(s.sliderContainer),i}(t);n.appendChild(C);let w=v(t);e.appendChild(w);let k=document.createElement("div");k.className="bottom-row",e.appendChild(k);let L=c(t);return k.appendChild(L),e}class y{constructor(){this.listeners={}}on(t,e,i){if(this.listeners[t]||(this.listeners[t]=new Set),this.listeners[t].add(e),null==i?void 0:i.once){const i=()=>{this.un(t,i),this.un(t,e)};return this.on(t,i),i}return()=>this.un(t,e)}un(t,e){var i;null===(i=this.listeners[t])||void 0===i||i.delete(e)}once(t,e){return this.on(t,e,{once:!0})}unAll(){this.listeners={}}emit(t,...e){this.listeners[t]&&this.listeners[t].forEach((t=>t(...e)))}}var C=function(t,e,i,n){return new(i||(i=Promise))((function(s,o){function r(t){try{l(n.next(t))}catch(t){o(t)}}function a(t){try{l(n.throw(t))}catch(t){o(t)}}function l(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(r,a)}l((n=n.apply(t,e||[])).next())}))};const w={decode:function(t,e){return C(this,void 0,void 0,(function*(){const i=new AudioContext({sampleRate:e});return i.decodeAudioData(t).finally((()=>i.close()))}))},createBuffer:function(t,e){return"number"==typeof t[0]&&(t=[t]),function(t){const e=t[0];if(e.some((t=>t>1||t<-1))){const i=e.length;let n=0;for(let t=0;t<i;t++){const i=Math.abs(e[t]);i>n&&(n=i)}for(const e of t)for(let t=0;t<i;t++)e[t]/=n}}(t),{duration:e,length:t[0].length,sampleRate:t[0].length/e,numberOfChannels:t.length,getChannelData:e=>null==t?void 0:t[e],copyFromChannel:AudioBuffer.prototype.copyFromChannel,copyToChannel:AudioBuffer.prototype.copyToChannel}}};function k(t,e){const i=e.xmlns?document.createElementNS(e.xmlns,t):document.createElement(t);for(const[t,n]of Object.entries(e))if("children"===t)for(const[t,n]of Object.entries(e))"string"==typeof n?i.appendChild(document.createTextNode(n)):i.appendChild(k(t,n));else"style"===t?Object.assign(i.style,n):"textContent"===t?i.textContent=n:i.setAttribute(t,n.toString());return i}function L(t,e,i){const n=k(t,e||{});return null==i||i.appendChild(n),n}var x=Object.freeze({__proto__:null,createElement:L,default:L}),E=function(t,e,i,n){return new(i||(i=Promise))((function(s,o){function r(t){try{l(n.next(t))}catch(t){o(t)}}function a(t){try{l(n.throw(t))}catch(t){o(t)}}function l(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(r,a)}l((n=n.apply(t,e||[])).next())}))};const T={fetchBlob:function(t,e,i){return E(this,void 0,void 0,(function*(){const n=yield fetch(t,i);if(n.status>=400)throw new Error(`Failed to fetch ${t}: ${n.status} (${n.statusText})`);return function(t,e){E(this,void 0,void 0,(function*(){if(!t.body||!t.headers)return;const i=t.body.getReader(),n=Number(t.headers.get("Content-Length"))||0;let s=0;const o=t=>E(this,void 0,void 0,(function*(){s+=(null==t?void 0:t.length)||0;const i=Math.round(s/n*100);e(i)})),r=()=>E(this,void 0,void 0,(function*(){let t;try{t=yield i.read()}catch(t){return}t.done||(o(t.value),yield r())}));r()}))}(n.clone(),e),n.blob()}))}};var P=function(t,e,i,n){return new(i||(i=Promise))((function(s,o){function r(t){try{l(n.next(t))}catch(t){o(t)}}function a(t){try{l(n.throw(t))}catch(t){o(t)}}function l(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(r,a)}l((n=n.apply(t,e||[])).next())}))};class S extends y{constructor(t){super(),this.isExternalMedia=!1,t.media?(this.media=t.media,this.isExternalMedia=!0):this.media=document.createElement("audio"),t.mediaControls&&(this.media.controls=!0),t.autoplay&&(this.media.autoplay=!0),null!=t.playbackRate&&this.onMediaEvent("canplay",(()=>{null!=t.playbackRate&&(this.media.playbackRate=t.playbackRate)}),{once:!0})}onMediaEvent(t,e,i){return this.media.addEventListener(t,e,i),()=>this.media.removeEventListener(t,e,i)}getSrc(){return this.media.currentSrc||this.media.src||""}revokeSrc(){const t=this.getSrc();t.startsWith("blob:")&&URL.revokeObjectURL(t)}canPlayType(t){return""!==this.media.canPlayType(t)}setSrc(t,e){const i=this.getSrc();if(t&&i===t)return;this.revokeSrc();const n=e instanceof Blob&&(this.canPlayType(e.type)||!t)?URL.createObjectURL(e):t;try{this.media.src=n}catch(e){this.media.src=t}}destroy(){this.media.pause(),this.isExternalMedia||(this.media.remove(),this.revokeSrc(),this.media.src="",this.media.load())}setMediaElement(t){this.media=t}play(){return P(this,void 0,void 0,(function*(){return this.media.play()}))}pause(){this.media.pause()}isPlaying(){return!this.media.paused&&!this.media.ended}setTime(t){this.media.currentTime=t}getDuration(){return this.media.duration}getCurrentTime(){return this.media.currentTime}getVolume(){return this.media.volume}setVolume(t){this.media.volume=t}getMuted(){return this.media.muted}setMuted(t){this.media.muted=t}getPlaybackRate(){return this.media.playbackRate}isSeeking(){return this.media.seeking}setPlaybackRate(t,e){null!=e&&(this.media.preservesPitch=e),this.media.playbackRate=t}getMediaElement(){return this.media}setSinkId(t){return this.media.setSinkId(t)}}var B=function(t,e,i,n){return new(i||(i=Promise))((function(s,o){function r(t){try{l(n.next(t))}catch(t){o(t)}}function a(t){try{l(n.throw(t))}catch(t){o(t)}}function l(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(r,a)}l((n=n.apply(t,e||[])).next())}))},M=function(t,e){var i={};for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&e.indexOf(n)<0&&(i[n]=t[n]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var s=0;for(n=Object.getOwnPropertySymbols(t);s<n.length;s++)e.indexOf(n[s])<0&&Object.prototype.propertyIsEnumerable.call(t,n[s])&&(i[n[s]]=t[n[s]])}return i};class N extends y{constructor(t,e){super(),this.timeouts=[],this.isScrollable=!1,this.audioData=null,this.resizeObserver=null,this.lastContainerWidth=0,this.isDragging=!1,this.subscriptions=[],this.subscriptions=[],this.options=t;const i=this.parentFromOptionsContainer(t.container);this.parent=i;const[n,s]=this.initHtml();i.appendChild(n),this.container=n,this.scrollContainer=s.querySelector(".scroll"),this.wrapper=s.querySelector(".wrapper"),this.canvasWrapper=s.querySelector(".canvases"),this.progressWrapper=s.querySelector(".progress"),this.cursor=s.querySelector(".cursor"),e&&s.appendChild(e),this.initEvents()}parentFromOptionsContainer(t){let e;if("string"==typeof t?e=document.querySelector(t):t instanceof HTMLElement&&(e=t),!e)throw new Error("Container not found");return e}initEvents(){const t=t=>{const e=this.wrapper.getBoundingClientRect(),i=t.clientX-e.left,n=t.clientY-e.top;return[i/e.width,n/e.height]};if(this.wrapper.addEventListener("click",(e=>{const[i,n]=t(e);this.emit("click",i,n)})),this.wrapper.addEventListener("dblclick",(e=>{const[i,n]=t(e);this.emit("dblclick",i,n)})),!0!==this.options.dragToSeek&&"object"!=typeof this.options.dragToSeek||this.initDrag(),this.scrollContainer.addEventListener("scroll",(()=>{const{scrollLeft:t,scrollWidth:e,clientWidth:i}=this.scrollContainer,n=t/e,s=(t+i)/e;this.emit("scroll",n,s,t,t+i)})),"function"==typeof ResizeObserver){const t=this.createDelay(100);this.resizeObserver=new ResizeObserver((()=>{t().then((()=>this.onContainerResize())).catch((()=>{}))})),this.resizeObserver.observe(this.scrollContainer)}}onContainerResize(){const t=this.parent.clientWidth;t===this.lastContainerWidth&&"auto"!==this.options.height||(this.lastContainerWidth=t,this.reRender())}initDrag(){this.subscriptions.push(function(t,e,i,n,s=3,o=0,r=100){if(!t)return()=>{};const a=matchMedia("(pointer: coarse)").matches;let l=()=>{};const d=d=>{if(d.button!==o)return;d.preventDefault(),d.stopPropagation();let c=d.clientX,h=d.clientY,u=!1;const p=Date.now(),m=n=>{if(n.preventDefault(),n.stopPropagation(),a&&Date.now()-p<r)return;const o=n.clientX,l=n.clientY,d=o-c,m=l-h;if(u||Math.abs(d)>s||Math.abs(m)>s){const n=t.getBoundingClientRect(),{left:s,top:r}=n;u||(null==i||i(c-s,h-r),u=!0),e(d,m,o-s,l-r),c=o,h=l}},g=e=>{if(u){const i=e.clientX,s=e.clientY,o=t.getBoundingClientRect(),{left:r,top:a}=o;null==n||n(i-r,s-a)}l()},f=t=>{t.relatedTarget&&t.relatedTarget!==document.documentElement||g(t)},v=t=>{u&&(t.stopPropagation(),t.preventDefault())},b=t=>{u&&t.preventDefault()};document.addEventListener("pointermove",m),document.addEventListener("pointerup",g),document.addEventListener("pointerout",f),document.addEventListener("pointercancel",f),document.addEventListener("touchmove",b,{passive:!1}),document.addEventListener("click",v,{capture:!0}),l=()=>{document.removeEventListener("pointermove",m),document.removeEventListener("pointerup",g),document.removeEventListener("pointerout",f),document.removeEventListener("pointercancel",f),document.removeEventListener("touchmove",b),setTimeout((()=>{document.removeEventListener("click",v,{capture:!0})}),10)}};return t.addEventListener("pointerdown",d),()=>{l(),t.removeEventListener("pointerdown",d)}}(this.wrapper,((t,e,i)=>{this.emit("drag",Math.max(0,Math.min(1,i/this.wrapper.getBoundingClientRect().width)))}),(t=>{this.isDragging=!0,this.emit("dragstart",Math.max(0,Math.min(1,t/this.wrapper.getBoundingClientRect().width)))}),(t=>{this.isDragging=!1,this.emit("dragend",Math.max(0,Math.min(1,t/this.wrapper.getBoundingClientRect().width)))})))}getHeight(t,e){var i;const n=(null===(i=this.audioData)||void 0===i?void 0:i.numberOfChannels)||1;if(null==t)return 128;if(!isNaN(Number(t)))return Number(t);if("auto"===t){const t=this.parent.clientHeight||128;return(null==e?void 0:e.every((t=>!t.overlay)))?t/n:t}return 128}initHtml(){const t=document.createElement("div"),e=t.attachShadow({mode:"open"});return e.innerHTML=`\n      <style>\n        :host {\n          user-select: none;\n          min-width: 1px;\n        }\n        :host audio {\n          display: block;\n          width: 100%;\n        }\n        :host .scroll {\n          overflow-x: auto;\n          overflow-y: hidden;\n          width: 100%;\n          position: relative;\n        }\n        :host .noScrollbar {\n          scrollbar-color: transparent;\n          scrollbar-width: none;\n        }\n        :host .noScrollbar::-webkit-scrollbar {\n          display: none;\n          -webkit-appearance: none;\n        }\n        :host .wrapper {\n          position: relative;\n          overflow: visible;\n          z-index: 2;\n        }\n        :host .canvases {\n          min-height: ${this.getHeight(this.options.height,this.options.splitChannels)}px;\n        }\n        :host .canvases > div {\n          position: relative;\n        }\n        :host canvas {\n          display: block;\n          position: absolute;\n          top: 0;\n          image-rendering: pixelated;\n        }\n        :host .progress {\n          pointer-events: none;\n          position: absolute;\n          z-index: 2;\n          top: 0;\n          left: 0;\n          width: 0;\n          height: 100%;\n          overflow: hidden;\n        }\n        :host .progress > div {\n          position: relative;\n        }\n        :host .cursor {\n          pointer-events: none;\n          position: absolute;\n          z-index: 5;\n          top: 0;\n          left: 0;\n          height: 100%;\n          border-radius: 2px;\n        }\n      </style>\n\n      <div class="scroll" part="scroll">\n        <div class="wrapper" part="wrapper">\n          <div class="canvases" part="canvases"></div>\n          <div class="progress" part="progress"></div>\n          <div class="cursor" part="cursor"></div>\n        </div>\n      </div>\n    `,[t,e]}setOptions(t){if(this.options.container!==t.container){const e=this.parentFromOptionsContainer(t.container);e.appendChild(this.container),this.parent=e}!0!==t.dragToSeek&&"object"!=typeof this.options.dragToSeek||this.initDrag(),this.options=t,this.reRender()}getWrapper(){return this.wrapper}getWidth(){return this.scrollContainer.clientWidth}getScroll(){return this.scrollContainer.scrollLeft}setScroll(t){this.scrollContainer.scrollLeft=t}setScrollPercentage(t){const{scrollWidth:e}=this.scrollContainer,i=e*t;this.setScroll(i)}destroy(){var t,e;this.subscriptions.forEach((t=>t())),this.container.remove(),null===(t=this.resizeObserver)||void 0===t||t.disconnect(),null===(e=this.unsubscribeOnScroll)||void 0===e||e.call(this)}createDelay(t=10){let e,i;const n=()=>{e&&clearTimeout(e),i&&i()};return this.timeouts.push(n),()=>new Promise(((s,o)=>{n(),i=o,e=setTimeout((()=>{e=void 0,i=void 0,s()}),t)}))}convertColorValues(t){if(!Array.isArray(t))return t||"";if(t.length<2)return t[0]||"";const e=document.createElement("canvas"),i=e.getContext("2d"),n=e.height*(window.devicePixelRatio||1),s=i.createLinearGradient(0,0,0,n),o=1/(t.length-1);return t.forEach(((t,e)=>{const i=e*o;s.addColorStop(i,t)})),s}getPixelRatio(){return Math.max(1,window.devicePixelRatio||1)}renderBarWaveform(t,e,i,n){const s=t[0],o=t[1]||t[0],r=s.length,{width:a,height:l}=i.canvas,d=l/2,c=this.getPixelRatio(),h=e.barWidth?e.barWidth*c:1,u=e.barGap?e.barGap*c:e.barWidth?h/2:0,p=e.barRadius||0,m=a/(h+u)/r,g=p&&"roundRect"in i?"roundRect":"rect";i.beginPath();let f=0,v=0,b=0;for(let t=0;t<=r;t++){const r=Math.round(t*m);if(r>f){const t=Math.round(v*d*n),s=t+Math.round(b*d*n)||1;let o=d-t;"top"===e.barAlign?o=0:"bottom"===e.barAlign&&(o=l-s),i[g](f*(h+u),o,h,s,p),f=r,v=0,b=0}const a=Math.abs(s[t]||0),c=Math.abs(o[t]||0);a>v&&(v=a),c>b&&(b=c)}i.fill(),i.closePath()}renderLineWaveform(t,e,i,n){const s=e=>{const s=t[e]||t[0],o=s.length,{height:r}=i.canvas,a=r/2,l=i.canvas.width/o;i.moveTo(0,a);let d=0,c=0;for(let t=0;t<=o;t++){const o=Math.round(t*l);if(o>d){const t=a+(Math.round(c*a*n)||1)*(0===e?-1:1);i.lineTo(d,t),d=o,c=0}const r=Math.abs(s[t]||0);r>c&&(c=r)}i.lineTo(d,a)};i.beginPath(),s(0),s(1),i.fill(),i.closePath()}renderWaveform(t,e,i){if(i.fillStyle=this.convertColorValues(e.waveColor),e.renderFunction)return void e.renderFunction(t,i);let n=e.barHeight||1;if(e.normalize){const e=Array.from(t[0]).reduce(((t,e)=>Math.max(t,Math.abs(e))),0);n=e?1/e:1}e.barWidth||e.barGap||e.barAlign?this.renderBarWaveform(t,e,i,n):this.renderLineWaveform(t,e,i,n)}renderSingleCanvas(t,e,i,n,s,o,r){const a=this.getPixelRatio(),l=document.createElement("canvas");l.width=Math.round(i*a),l.height=Math.round(n*a),l.style.width=`${i}px`,l.style.height=`${n}px`,l.style.left=`${Math.round(s)}px`,o.appendChild(l);const d=l.getContext("2d");if(this.renderWaveform(t,e,d),l.width>0&&l.height>0){const t=l.cloneNode(),i=t.getContext("2d");i.drawImage(l,0,0),i.globalCompositeOperation="source-in",i.fillStyle=this.convertColorValues(e.progressColor),i.fillRect(0,0,l.width,l.height),r.appendChild(t)}}renderMultiCanvas(t,e,i,n,s,o){const r=this.getPixelRatio(),{clientWidth:a}=this.scrollContainer;if(a*r>=i)return void this.renderSingleCanvas(t,e,a,n,0,s,o);const l=i/r;let d=Math.min(N.MAX_CANVAS_WIDTH,a,l),c={};if(e.barWidth||e.barGap){const t=e.barWidth||.5,i=t+(e.barGap||t/2);d%i!==0&&(d=Math.floor(d/i)*i)}const h=i=>{if(i<0||i>=u)return;if(c[i])return;c[i]=!0;const r=i*d,a=Math.min(l-r,d);if(a<=0)return;const h=t.map((t=>{const e=Math.floor(r/l*t.length),i=Math.floor((r+a)/l*t.length);return t.slice(e,i)}));this.renderSingleCanvas(h,e,a,n,r,s,o)},u=Math.ceil(l/d),p=this.scrollContainer.scrollLeft/l,m=Math.floor(p*u);h(m-1),h(m),h(m+1),u>1&&(this.unsubscribeOnScroll=this.on("scroll",(()=>{const{scrollLeft:t}=this.scrollContainer,e=Math.floor(t/l*u);Object.keys(c).length>N.MAX_NODES&&(s.innerHTML="",o.innerHTML="",c={}),h(e-1),h(e),h(e+1)})))}renderChannel(t,e,i,n){var{overlay:s}=e,o=M(e,["overlay"]);const r=document.createElement("div"),a=this.getHeight(o.height,o.splitChannels);r.style.height=`${a}px`,s&&n>0&&(r.style.marginTop=`-${a}px`),this.canvasWrapper.style.minHeight=`${a}px`,this.canvasWrapper.appendChild(r);const l=r.cloneNode();this.progressWrapper.appendChild(l),this.renderMultiCanvas(t,o,i,a,r,l)}render(t){return B(this,void 0,void 0,(function*(){var e;this.timeouts.forEach((t=>t())),this.timeouts=[],this.canvasWrapper.innerHTML="",this.progressWrapper.innerHTML="",null!=this.options.width&&(this.scrollContainer.style.width="number"==typeof this.options.width?`${this.options.width}px`:this.options.width);const i=this.getPixelRatio(),n=this.scrollContainer.clientWidth,s=Math.ceil(t.duration*(this.options.minPxPerSec||0));this.isScrollable=s>n;const o=this.options.fillParent&&!this.isScrollable,r=(o?n:s)*i;if(this.wrapper.style.width=o?"100%":`${s}px`,this.scrollContainer.style.overflowX=this.isScrollable?"auto":"hidden",this.scrollContainer.classList.toggle("noScrollbar",!!this.options.hideScrollbar),this.cursor.style.backgroundColor=`${this.options.cursorColor||this.options.progressColor}`,this.cursor.style.width=`${this.options.cursorWidth}px`,this.audioData=t,this.emit("render"),this.options.splitChannels)for(let i=0;i<t.numberOfChannels;i++){const n=Object.assign(Object.assign({},this.options),null===(e=this.options.splitChannels)||void 0===e?void 0:e[i]);this.renderChannel([t.getChannelData(i)],n,r,i)}else{const e=[t.getChannelData(0)];t.numberOfChannels>1&&e.push(t.getChannelData(1)),this.renderChannel(e,this.options,r,0)}Promise.resolve().then((()=>this.emit("rendered")))}))}reRender(){var t;if(null===(t=this.unsubscribeOnScroll)||void 0===t||t.call(this),delete this.unsubscribeOnScroll,!this.audioData)return;const{scrollWidth:e}=this.scrollContainer,{right:i}=this.progressWrapper.getBoundingClientRect();if(this.render(this.audioData),this.isScrollable&&e!==this.scrollContainer.scrollWidth){const{right:t}=this.progressWrapper.getBoundingClientRect();let e=t-i;e*=2,e=e<0?Math.floor(e):Math.ceil(e),e/=2,this.scrollContainer.scrollLeft+=e}}zoom(t){this.options.minPxPerSec=t,this.reRender()}scrollIntoView(t,e=!1){const{scrollLeft:i,scrollWidth:n,clientWidth:s}=this.scrollContainer,o=t*n,r=i,a=i+s,l=s/2;if(this.isDragging){const t=30;o+t>a?this.scrollContainer.scrollLeft+=t:o-t<r&&(this.scrollContainer.scrollLeft-=t)}else{(o<r||o>a)&&(this.scrollContainer.scrollLeft=o-(this.options.autoCenter?l:0));const t=o-i-l;e&&this.options.autoCenter&&t>0&&(this.scrollContainer.scrollLeft+=Math.min(t,10))}{const t=this.scrollContainer.scrollLeft,e=t/n,i=(t+s)/n;this.emit("scroll",e,i,t,t+s)}}renderProgress(t,e){if(isNaN(t))return;const i=100*t;this.canvasWrapper.style.clipPath=`polygon(${i}% 0, 100% 0, 100% 100%, ${i}% 100%)`,this.progressWrapper.style.width=`${i}%`,this.cursor.style.left=`${i}%`,this.cursor.style.transform=`translateX(-${100===Math.round(i)?this.options.cursorWidth:0}px)`,this.isScrollable&&this.options.autoScroll&&this.scrollIntoView(t,e)}exportImage(t,e,i){return B(this,void 0,void 0,(function*(){const n=this.canvasWrapper.querySelectorAll("canvas");if(!n.length)throw new Error("No waveform data");if("dataURL"===i){const i=Array.from(n).map((i=>i.toDataURL(t,e)));return Promise.resolve(i)}return Promise.all(Array.from(n).map((i=>new Promise(((n,s)=>{i.toBlob((t=>{t?n(t):s(new Error("Could not export image"))}),t,e)})))))}))}}N.MAX_CANVAS_WIDTH=8e3,N.MAX_NODES=10;class R extends y{constructor(){super(...arguments),this.unsubscribe=()=>{}}start(){this.unsubscribe=this.on("tick",(()=>{requestAnimationFrame((()=>{this.emit("tick")}))})),this.emit("tick")}stop(){this.unsubscribe()}destroy(){this.unsubscribe()}}var W=function(t,e,i,n){return new(i||(i=Promise))((function(s,o){function r(t){try{l(n.next(t))}catch(t){o(t)}}function a(t){try{l(n.throw(t))}catch(t){o(t)}}function l(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(r,a)}l((n=n.apply(t,e||[])).next())}))};class A extends y{constructor(t=new AudioContext){super(),this.bufferNode=null,this.playStartTime=0,this.playedDuration=0,this._muted=!1,this._playbackRate=1,this._duration=void 0,this.buffer=null,this.currentSrc="",this.paused=!0,this.crossOrigin=null,this.seeking=!1,this.autoplay=!1,this.addEventListener=this.on,this.removeEventListener=this.un,this.audioContext=t,this.gainNode=this.audioContext.createGain(),this.gainNode.connect(this.audioContext.destination)}load(){return W(this,void 0,void 0,(function*(){}))}get src(){return this.currentSrc}set src(t){if(this.currentSrc=t,this._duration=void 0,!t)return this.buffer=null,void this.emit("emptied");fetch(t).then((e=>{if(e.status>=400)throw new Error(`Failed to fetch ${t}: ${e.status} (${e.statusText})`);return e.arrayBuffer()})).then((e=>this.currentSrc!==t?null:this.audioContext.decodeAudioData(e))).then((e=>{this.currentSrc===t&&(this.buffer=e,this.emit("loadedmetadata"),this.emit("canplay"),this.autoplay&&this.play())}))}_play(){var t;if(!this.paused)return;this.paused=!1,null===(t=this.bufferNode)||void 0===t||t.disconnect(),this.bufferNode=this.audioContext.createBufferSource(),this.buffer&&(this.bufferNode.buffer=this.buffer),this.bufferNode.playbackRate.value=this._playbackRate,this.bufferNode.connect(this.gainNode);let e=this.playedDuration*this._playbackRate;e>=this.duration&&(e=0,this.playedDuration=0),this.bufferNode.start(this.audioContext.currentTime,e),this.playStartTime=this.audioContext.currentTime,this.bufferNode.onended=()=>{this.currentTime>=this.duration&&(this.pause(),this.emit("ended"))}}_pause(){var t;this.paused=!0,null===(t=this.bufferNode)||void 0===t||t.stop(),this.playedDuration+=this.audioContext.currentTime-this.playStartTime}play(){return W(this,void 0,void 0,(function*(){this.paused&&(this._play(),this.emit("play"))}))}pause(){this.paused||(this._pause(),this.emit("pause"))}stopAt(t){var e,i;const n=t-this.currentTime;null===(e=this.bufferNode)||void 0===e||e.stop(this.audioContext.currentTime+n),null===(i=this.bufferNode)||void 0===i||i.addEventListener("ended",(()=>{this.bufferNode=null,this.pause()}),{once:!0})}setSinkId(t){return W(this,void 0,void 0,(function*(){return this.audioContext.setSinkId(t)}))}get playbackRate(){return this._playbackRate}set playbackRate(t){this._playbackRate=t,this.bufferNode&&(this.bufferNode.playbackRate.value=t)}get currentTime(){return(this.paused?this.playedDuration:this.playedDuration+(this.audioContext.currentTime-this.playStartTime))*this._playbackRate}set currentTime(t){const e=!this.paused;e&&this._pause(),this.playedDuration=t/this._playbackRate,e&&this._play(),this.emit("seeking"),this.emit("timeupdate")}get duration(){var t,e;return null!==(t=this._duration)&&void 0!==t?t:(null===(e=this.buffer)||void 0===e?void 0:e.duration)||0}set duration(t){this._duration=t}get volume(){return this.gainNode.gain.value}set volume(t){this.gainNode.gain.value=t,this.emit("volumechange")}get muted(){return this._muted}set muted(t){this._muted!==t&&(this._muted=t,this._muted?this.gainNode.disconnect():this.gainNode.connect(this.audioContext.destination))}canPlayType(t){return/^(audio|video)\//.test(t)}getGainNode(){return this.gainNode}getChannelData(){const t=[];if(!this.buffer)return t;const e=this.buffer.numberOfChannels;for(let i=0;i<e;i++)t.push(this.buffer.getChannelData(i));return t}}var D=function(t,e,i,n){return new(i||(i=Promise))((function(s,o){function r(t){try{l(n.next(t))}catch(t){o(t)}}function a(t){try{l(n.throw(t))}catch(t){o(t)}}function l(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(r,a)}l((n=n.apply(t,e||[])).next())}))};const I={waveColor:"#999",progressColor:"#555",cursorWidth:1,minPxPerSec:0,fillParent:!0,interact:!0,dragToSeek:!1,autoScroll:!0,autoCenter:!0,sampleRate:8e3};class O extends S{static create(t){return new O(t)}constructor(t){const e=t.media||("WebAudio"===t.backend?new A:void 0);super({media:e,mediaControls:t.mediaControls,autoplay:t.autoplay,playbackRate:t.audioRate}),this.plugins=[],this.decodedData=null,this.subscriptions=[],this.mediaSubscriptions=[],this.abortController=null,this.options=Object.assign({},I,t),this.timer=new R;const i=e?void 0:this.getMediaElement();this.renderer=new N(this.options,i),this.initPlayerEvents(),this.initRendererEvents(),this.initTimerEvents(),this.initPlugins();const n=this.options.url||this.getSrc()||"";Promise.resolve().then((()=>{this.emit("init");const{peaks:t,duration:e}=this.options;(n||t&&e)&&this.load(n,t,e).catch((()=>null))}))}updateProgress(t=this.getCurrentTime()){return this.renderer.renderProgress(t/this.getDuration(),this.isPlaying()),t}initTimerEvents(){this.subscriptions.push(this.timer.on("tick",(()=>{if(!this.isSeeking()){const t=this.updateProgress();this.emit("timeupdate",t),this.emit("audioprocess",t)}})))}initPlayerEvents(){this.isPlaying()&&(this.emit("play"),this.timer.start()),this.mediaSubscriptions.push(this.onMediaEvent("timeupdate",(()=>{const t=this.updateProgress();this.emit("timeupdate",t)})),this.onMediaEvent("play",(()=>{this.emit("play"),this.timer.start()})),this.onMediaEvent("pause",(()=>{this.emit("pause"),this.timer.stop()})),this.onMediaEvent("emptied",(()=>{this.timer.stop()})),this.onMediaEvent("ended",(()=>{this.emit("finish")})),this.onMediaEvent("seeking",(()=>{this.emit("seeking",this.getCurrentTime())})),this.onMediaEvent("error",(t=>{this.emit("error",t.error)})))}initRendererEvents(){this.subscriptions.push(this.renderer.on("click",((t,e)=>{this.options.interact&&(this.seekTo(t),this.emit("interaction",t*this.getDuration()),this.emit("click",t,e))})),this.renderer.on("dblclick",((t,e)=>{this.emit("dblclick",t,e)})),this.renderer.on("scroll",((t,e,i,n)=>{const s=this.getDuration();this.emit("scroll",t*s,e*s,i,n)})),this.renderer.on("render",(()=>{this.emit("redraw")})),this.renderer.on("rendered",(()=>{this.emit("redrawcomplete")})),this.renderer.on("dragstart",(t=>{this.emit("dragstart",t)})),this.renderer.on("dragend",(t=>{this.emit("dragend",t)})));{let t;this.subscriptions.push(this.renderer.on("drag",(e=>{if(!this.options.interact)return;let i;this.renderer.renderProgress(e),clearTimeout(t),this.isPlaying()?i=0:!0===this.options.dragToSeek?i=200:"object"==typeof this.options.dragToSeek&&void 0!==this.options.dragToSeek&&(i=this.options.dragToSeek.debounceTime),t=setTimeout((()=>{this.seekTo(e)}),i),this.emit("interaction",e*this.getDuration()),this.emit("drag",e)})))}}initPlugins(){var t;(null===(t=this.options.plugins)||void 0===t?void 0:t.length)&&this.options.plugins.forEach((t=>{this.registerPlugin(t)}))}unsubscribePlayerEvents(){this.mediaSubscriptions.forEach((t=>t())),this.mediaSubscriptions=[]}setOptions(t){this.options=Object.assign({},this.options,t),this.renderer.setOptions(this.options),t.audioRate&&this.setPlaybackRate(t.audioRate),null!=t.mediaControls&&(this.getMediaElement().controls=t.mediaControls)}registerPlugin(t){return t._init(this),this.plugins.push(t),this.subscriptions.push(t.once("destroy",(()=>{this.plugins=this.plugins.filter((e=>e!==t))}))),t}getWrapper(){return this.renderer.getWrapper()}getWidth(){return this.renderer.getWidth()}getScroll(){return this.renderer.getScroll()}setScroll(t){return this.renderer.setScroll(t)}setScrollTime(t){const e=t/this.getDuration();this.renderer.setScrollPercentage(e)}getActivePlugins(){return this.plugins}loadAudio(t,e,i,n){return D(this,void 0,void 0,(function*(){var s;if(this.emit("load",t),!this.options.media&&this.isPlaying()&&this.pause(),this.decodedData=null,!e&&!i){const i=this.options.fetchParams||{};window.AbortController&&!i.signal&&(this.abortController=new AbortController,i.signal=null===(s=this.abortController)||void 0===s?void 0:s.signal);const n=t=>this.emit("loading",t);e=yield T.fetchBlob(t,n,i)}this.setSrc(t,e);const o=yield new Promise((t=>{const e=n||this.getDuration();e?t(e):this.mediaSubscriptions.push(this.onMediaEvent("loadedmetadata",(()=>t(this.getDuration())),{once:!0}))}));if(!t&&!e){const t=this.getMediaElement();t instanceof A&&(t.duration=o)}if(i)this.decodedData=w.createBuffer(i,o||0);else if(e){const t=yield e.arrayBuffer();this.decodedData=yield w.decode(t,this.options.sampleRate)}this.decodedData&&(this.emit("decode",this.getDuration()),this.renderer.render(this.decodedData)),this.emit("ready",this.getDuration())}))}load(t,e,i){return D(this,void 0,void 0,(function*(){try{return yield this.loadAudio(t,void 0,e,i)}catch(t){throw this.emit("error",t),t}}))}loadBlob(t,e,i){return D(this,void 0,void 0,(function*(){try{return yield this.loadAudio("",t,e,i)}catch(t){throw this.emit("error",t),t}}))}zoom(t){if(!this.decodedData)throw new Error("No audio loaded");this.renderer.zoom(t),this.emit("zoom",t)}getDecodedData(){return this.decodedData}exportPeaks({channels:t=2,maxLength:e=8e3,precision:i=1e4}={}){if(!this.decodedData)throw new Error("The audio has not been decoded yet");const n=Math.min(t,this.decodedData.numberOfChannels),s=[];for(let t=0;t<n;t++){const n=this.decodedData.getChannelData(t),o=[],r=n.length/e;for(let t=0;t<e;t++){const e=n.slice(Math.floor(t*r),Math.ceil((t+1)*r));let s=0;for(let t=0;t<e.length;t++){const i=e[t];Math.abs(i)>Math.abs(s)&&(s=i)}o.push(Math.round(s*i)/i)}s.push(o)}return s}getDuration(){let t=super.getDuration()||0;return 0!==t&&t!==1/0||!this.decodedData||(t=this.decodedData.duration),t}toggleInteraction(t){this.options.interact=t}setTime(t){super.setTime(t),this.updateProgress(t),this.emit("timeupdate",t)}seekTo(t){const e=this.getDuration()*t;this.setTime(e)}playPause(){return D(this,void 0,void 0,(function*(){return this.isPlaying()?this.pause():this.play()}))}stop(){this.pause(),this.setTime(0)}skip(t){this.setTime(this.getCurrentTime()+t)}empty(){this.load("",[[0]],.001)}setMediaElement(t){this.unsubscribePlayerEvents(),super.setMediaElement(t),this.initPlayerEvents()}exportImage(){return D(this,arguments,void 0,(function*(t="image/png",e=1,i="dataURL"){return this.renderer.exportImage(t,e,i)}))}destroy(){var t;this.emit("destroy"),null===(t=this.abortController)||void 0===t||t.abort(),this.plugins.forEach((t=>t.destroy())),this.subscriptions.forEach((t=>t())),this.unsubscribePlayerEvents(),this.timer.destroy(),this.renderer.destroy(),super.destroy()}}O.BasePlugin=class extends y{constructor(t){super(),this.subscriptions=[],this.options=t}onInit(){}_init(t){this.wavesurfer=t,this.onInit()}destroy(){this.emit("destroy"),this.subscriptions.forEach((t=>t()))}},O.dom=x;class _{constructor(t){this.media=t.media||null,this.currentTime=0,this.playbackRate=1,this.volume=1,this.eventListeners={},this.container=t.container||document.body,this.waveColor=t.waveColor||"green",this.progressColor=t.progressColor||"blue",this.width=t.width||500,this.height=t.height||100,this.peaks=t.peaks||null,this.showWaveform=!0,"boolean"==typeof t.showWaveform&&(this.showWaveform=t.showWaveform),this.media||console.warn("WaveSurferShim initialized without a media element."),this._setupMediaListeners(),this.showWaveform&&(this._createCanvas(),this.peaks&&this._renderWaveform(this.peaks),this._startAnimationLoop())}_createCanvas(){this.canvas=document.createElement("canvas"),this.canvas.width=this.width,this.canvas.height=this.height,this.canvas.style.border="1px solid #ccc",this.container.appendChild(this.canvas),this.ctx=this.canvas.getContext("2d")}_renderWaveform(t){if(!t)return void console.warn("WaveSurferShim: No peaks provided for rendering.");const e=this._downsampleData(t,this.width);this.ctx.clearRect(0,0,this.width,this.height),this.ctx.strokeStyle=this.waveColor,this.ctx.lineWidth=1,this.ctx.beginPath();for(let t=0;t<e.length;t++){const i=t/e.length*this.width,n=(1-e[t])*(this.height/2),s=this.height/2;this.ctx.moveTo(i,s),this.ctx.lineTo(i,n),this.ctx.moveTo(i,s),this.ctx.lineTo(i,s+(s-n))}this.ctx.stroke()}_updateProgress(){if(!this.media)return;if(!this.showWaveform)return;const t=this.media.currentTime/this.media.duration;this._renderWaveform(this.peaks),this.ctx.fillStyle=this.progressColor,this.ctx.globalAlpha=.5,this.ctx.fillRect(0,0,this.width*t,this.height),this.ctx.globalAlpha=1}_downsampleData(t,e){const i=Math.floor(t.length/e),n=[];for(let e=0;e<t.length;e+=i)n.push(t[e]);return n.map((t=>(t+1)/2))}_startAnimationLoop(){const t=()=>{this._updateProgress(),requestAnimationFrame(t)};t()}play(){this.media?(this.media.play(),this._emit("play"),this._startProgress()):console.warn("WaveSurferShim: No media element to play.")}pause(){this.media?(this.media.pause(),this._emit("pause"),this._stopProgress()):console.warn("WaveSurferShim: No media element to pause.")}seekTo(t){this.currentTime=t,this.media&&(this.media.currentTime=t),this._updateProgress()}_startProgress(){this.media&&(this.progressInterval=setInterval((()=>this._updateProgress()),5))}_stopProgress(){clearInterval(this.progressInterval)}getVolume(){return this.volume}getDuration(){return this.media?this.media.duration:0}seekTo(t){this.currentTime=t,this.media&&(this.media.currentTime=t)}setTime(t){this.currentTime=t,this.media&&(this.media.currentTime=t)}isPlaying(){return!!this.media&&!this.media.paused}getCurrentTime(){return this.media?this.media.currentTime:this.currentTime}setPlaybackRate(t){this.playbackRate=t,this.media&&(this.media.playbackRate=t)}getPlaybackRate(){return this.playbackRate}setVolume(t){this.volume=t,this.media&&(this.media.volume=t)}destroy(){console.log("WaveSurferShim: destroy called."),this.media&&(this.media.pause(),this.media=null),this.progressInterval&&clearInterval(this.progressInterval),this._timeUpdateTimeout&&clearTimeout(this._timeUpdateTimeout),this.eventListeners={}}on(t,e){this.eventListeners[t]||(this.eventListeners[t]=[]),this.eventListeners[t].push(e)}_emit(t,...e){this.eventListeners[t]&&this.eventListeners[t].forEach((t=>t(...e)))}_setupMediaListeners(){this.media&&(this.media.addEventListener("loadeddata",(()=>{this._emit("ready")})),this.media.addEventListener("timeupdate",(()=>{this._emit("audioprocess",this.getCurrentTime())})),this.media.addEventListener("seeked",(()=>{this._emit("seeking",this.getCurrentTime())}))),setTimeout((()=>{this._emit("ready")}),0)}}_.create=function(t){t.container||document.body,console.log("FFFF",t);let e=new _(t),i=document.createElement("div");return i.style.width=t.width+"px",i.style.height=t.height+"px",i.style.color=t.color||"white",i.style.border="1px solid white",i.style.borderRadius="5px",e.container=i,console.log("WAAAV",e),e.regions={},e.regions.addRegion=function(t){let e=document.createElement("div");e.style.position="absolute",e.style.backgroundColor=t.color||"rgba(255, 0, 0, 0.3)",e.style.height="100%",e.style.width=(t.end-t.start)*t.width+"px",e.style.left=t.start*t.width+"px"},e};let z=class{constructor(){this.listeners={}}on(t,e,i){if(this.listeners[t]||(this.listeners[t]=new Set),this.listeners[t].add(e),null==i?void 0:i.once){const i=()=>{this.un(t,i),this.un(t,e)};return this.on(t,i),i}return()=>this.un(t,e)}un(t,e){var i;null===(i=this.listeners[t])||void 0===i||i.delete(e)}once(t,e){return this.on(t,e,{once:!0})}unAll(){this.listeners={}}emit(t,...e){this.listeners[t]&&this.listeners[t].forEach((t=>t(...e)))}},F=class extends z{constructor(t){super(),this.subscriptions=[],this.options=t}onInit(){}_init(t){this.wavesurfer=t,this.onInit()}destroy(){this.emit("destroy"),this.subscriptions.forEach((t=>t()))}};function q(t,e,i,n,s=3,o=0,r=100){if(!t)return()=>{};const a=matchMedia("(pointer: coarse)").matches;let l=()=>{};const d=d=>{if(d.button!==o)return;d.preventDefault(),d.stopPropagation();let c=d.clientX,h=d.clientY,u=!1;const p=Date.now(),m=n=>{if(n.preventDefault(),n.stopPropagation(),a&&Date.now()-p<r)return;const o=n.clientX,l=n.clientY,d=o-c,m=l-h;if(u||Math.abs(d)>s||Math.abs(m)>s){const n=t.getBoundingClientRect(),{left:s,top:r}=n;u||(null==i||i(c-s,h-r),u=!0),e(d,m,o-s,l-r),c=o,h=l}},g=e=>{if(u){const i=e.clientX,s=e.clientY,o=t.getBoundingClientRect(),{left:r,top:a}=o;null==n||n(i-r,s-a)}l()},f=t=>{t.relatedTarget&&t.relatedTarget!==document.documentElement||g(t)},v=t=>{u&&(t.stopPropagation(),t.preventDefault())},b=t=>{u&&t.preventDefault()};document.addEventListener("pointermove",m),document.addEventListener("pointerup",g),document.addEventListener("pointerout",f),document.addEventListener("pointercancel",f),document.addEventListener("touchmove",b,{passive:!1}),document.addEventListener("click",v,{capture:!0}),l=()=>{document.removeEventListener("pointermove",m),document.removeEventListener("pointerup",g),document.removeEventListener("pointerout",f),document.removeEventListener("pointercancel",f),document.removeEventListener("touchmove",b),setTimeout((()=>{document.removeEventListener("click",v,{capture:!0})}),10)}};return t.addEventListener("pointerdown",d),()=>{l(),t.removeEventListener("pointerdown",d)}}function j(t,e){const i=e.xmlns?document.createElementNS(e.xmlns,t):document.createElement(t);for(const[t,n]of Object.entries(e))if("children"===t)for(const[t,n]of Object.entries(e))"string"==typeof n?i.appendChild(document.createTextNode(n)):i.appendChild(j(t,n));else"style"===t?Object.assign(i.style,n):"textContent"===t?i.textContent=n:i.setAttribute(t,n.toString());return i}function H(t,e,i){const n=j(t,e||{});return null==i||i.appendChild(n),n}let V=class extends z{constructor(t,e,i=0){var n,s,o,r,a,l,d,c;super(),this.totalDuration=e,this.numberOfChannels=i,this.minLength=0,this.maxLength=1/0,this.contentEditable=!1,this.subscriptions=[],this.subscriptions=[],this.id=t.id||`region-${Math.random().toString(32).slice(2)}`,this.start=this.clampPosition(t.start),this.end=this.clampPosition(null!==(n=t.end)&&void 0!==n?n:t.start),this.drag=null===(s=t.drag)||void 0===s||s,this.resize=null===(o=t.resize)||void 0===o||o,this.color=null!==(r=t.color)&&void 0!==r?r:"rgba(0, 0, 0, 0.1)",this.minLength=null!==(a=t.minLength)&&void 0!==a?a:this.minLength,this.maxLength=null!==(l=t.maxLength)&&void 0!==l?l:this.maxLength,this.channelIdx=null!==(d=t.channelIdx)&&void 0!==d?d:-1,this.contentEditable=null!==(c=t.contentEditable)&&void 0!==c?c:this.contentEditable,this.element=this.initElement(),this.setContent(t.content),this.setPart(),this.renderPosition(),this.initMouseEvents()}clampPosition(t){return Math.max(0,Math.min(this.totalDuration,t))}setPart(){const t=this.start===this.end;this.element.setAttribute("part",`${t?"marker":"region"} ${this.id}`)}addResizeHandles(t){const e={position:"absolute",zIndex:"2",width:"6px",height:"100%",top:"0",cursor:"ew-resize",wordBreak:"keep-all"},i=H("div",{part:"region-handle region-handle-left",style:Object.assign(Object.assign({},e),{left:"0",borderLeft:"2px solid rgba(0, 0, 0, 0.5)",borderRadius:"2px 0 0 2px"})},t),n=H("div",{part:"region-handle region-handle-right",style:Object.assign(Object.assign({},e),{right:"0",borderRight:"2px solid rgba(0, 0, 0, 0.5)",borderRadius:"0 2px 2px 0"})},t);this.subscriptions.push(q(i,(t=>this.onResize(t,"start")),(()=>null),(()=>this.onEndResizing()),1),q(n,(t=>this.onResize(t,"end")),(()=>null),(()=>this.onEndResizing()),1))}removeResizeHandles(t){const e=t.querySelector('[part*="region-handle-left"]'),i=t.querySelector('[part*="region-handle-right"]');e&&t.removeChild(e),i&&t.removeChild(i)}initElement(){const t=this.start===this.end;let e=0,i=100;this.channelIdx>=0&&this.channelIdx<this.numberOfChannels&&(i=100/this.numberOfChannels,e=i*this.channelIdx);const n=H("div",{style:{position:"absolute",top:`${e}%`,height:`${i}%`,backgroundColor:t?"none":this.color,borderLeft:t?"2px solid "+this.color:"none",borderRadius:"2px",boxSizing:"border-box",transition:"background-color 0.2s ease",cursor:this.drag?"grab":"default",pointerEvents:"all"}});return!t&&this.resize&&this.addResizeHandles(n),n}renderPosition(){const t=this.start/this.totalDuration,e=(this.totalDuration-this.end)/this.totalDuration;this.element.style.left=100*t+"%",this.element.style.right=100*e+"%"}toggleCursor(t){var e;this.drag&&(null===(e=this.element)||void 0===e?void 0:e.style)&&(this.element.style.cursor=t?"grabbing":"grab")}initMouseEvents(){const{element:t}=this;t&&(t.addEventListener("click",(t=>this.emit("click",t))),t.addEventListener("mouseenter",(t=>this.emit("over",t))),t.addEventListener("mouseleave",(t=>this.emit("leave",t))),t.addEventListener("dblclick",(t=>this.emit("dblclick",t))),t.addEventListener("pointerdown",(()=>this.toggleCursor(!0))),t.addEventListener("pointerup",(()=>this.toggleCursor(!1))),this.subscriptions.push(q(t,(t=>this.onMove(t)),(()=>this.toggleCursor(!0)),(()=>{this.toggleCursor(!1),this.drag&&this.emit("update-end")}))),this.contentEditable&&this.content&&(this.content.addEventListener("click",(t=>this.onContentClick(t))),this.content.addEventListener("blur",(()=>this.onContentBlur()))))}_onUpdate(t,e){if(!this.element.parentElement)return;const{width:i}=this.element.parentElement.getBoundingClientRect(),n=t/i*this.totalDuration,s=e&&"start"!==e?this.start:this.start+n,o=e&&"end"!==e?this.end:this.end+n,r=o-s;s>=0&&o<=this.totalDuration&&s<=o&&r>=this.minLength&&r<=this.maxLength&&(this.start=s,this.end=o,this.renderPosition(),this.emit("update",e))}onMove(t){this.drag&&this._onUpdate(t)}onResize(t,e){this.resize&&this._onUpdate(t,e)}onEndResizing(){this.resize&&this.emit("update-end")}onContentClick(t){t.stopPropagation(),t.target.focus(),this.emit("click",t)}onContentBlur(){this.emit("update-end")}_setTotalDuration(t){this.totalDuration=t,this.renderPosition()}play(){this.emit("play")}setContent(t){var e;if(null===(e=this.content)||void 0===e||e.remove(),t){if("string"==typeof t){const e=this.start===this.end;this.content=H("div",{style:{padding:`0.2em ${e?.2:.4}em`,display:"inline-block"},textContent:t})}else this.content=t;this.contentEditable&&(this.content.contentEditable="true"),this.content.setAttribute("part","region-content"),this.element.appendChild(this.content)}else this.content=void 0}setOptions(t){var e,i;if(t.color&&(this.color=t.color,this.element.style.backgroundColor=this.color),void 0!==t.drag&&(this.drag=t.drag,this.element.style.cursor=this.drag?"grab":"default"),void 0!==t.start||void 0!==t.end){const n=this.start===this.end;this.start=this.clampPosition(null!==(e=t.start)&&void 0!==e?e:this.start),this.end=this.clampPosition(null!==(i=t.end)&&void 0!==i?i:n?this.start:this.end),this.renderPosition(),this.setPart()}if(t.content&&this.setContent(t.content),t.id&&(this.id=t.id,this.setPart()),void 0!==t.resize&&t.resize!==this.resize){const e=this.start===this.end;this.resize=t.resize,this.resize&&!e?this.addResizeHandles(this.element):this.removeResizeHandles(this.element)}}remove(){this.emit("remove"),this.subscriptions.forEach((t=>t())),this.element.remove(),this.element=null}};class G extends F{constructor(t){super(t),this.regions=[],this.regionsContainer=this.initRegionsContainer()}static create(t){return new G(t)}onInit(){if(!this.wavesurfer)throw Error("WaveSurfer is not initialized");this.wavesurfer.getWrapper().appendChild(this.regionsContainer);let t=[];this.subscriptions.push(this.wavesurfer.on("timeupdate",(e=>{const i=this.regions.filter((t=>t.start<=e&&(t.end===t.start?t.start+.05:t.end)>=e));i.forEach((e=>{t.includes(e)||this.emit("region-in",e)})),t.forEach((t=>{i.includes(t)||this.emit("region-out",t)})),t=i})))}initRegionsContainer(){return H("div",{style:{position:"absolute",top:"0",left:"0",width:"100%",height:"100%",zIndex:"3",pointerEvents:"none"}})}getRegions(){return this.regions}avoidOverlapping(t){t.content&&setTimeout((()=>{const e=t.content,i=e.getBoundingClientRect(),n=this.regions.map((e=>{if(e===t||!e.content)return 0;const n=e.content.getBoundingClientRect();return i.left<n.left+n.width&&n.left<i.left+i.width?n.height:0})).reduce(((t,e)=>t+e),0);e.style.marginTop=`${n}px`}),10)}adjustScroll(t){var e,i;const n=null===(i=null===(e=this.wavesurfer)||void 0===e?void 0:e.getWrapper())||void 0===i?void 0:i.parentElement;if(!n)return;const{clientWidth:s,scrollWidth:o}=n;if(o<=s)return;const r=n.getBoundingClientRect(),a=t.element.getBoundingClientRect(),l=a.left-r.left,d=a.right-r.left;l<0?n.scrollLeft+=l:d>s&&(n.scrollLeft+=d-s)}virtualAppend(t,e,i){const n=()=>{if(!this.wavesurfer)return;const n=this.wavesurfer.getWidth(),s=this.wavesurfer.getScroll(),o=e.clientWidth,r=this.wavesurfer.getDuration(),a=Math.round(t.start/r*o);a+(Math.round((t.end-t.start)/r*o)||1)>s&&a<s+n?e.appendChild(i):i.remove()};setTimeout((()=>{if(!this.wavesurfer)return;n();const e=this.wavesurfer.on("scroll",n);this.subscriptions.push(t.once("remove",e),e)}),0)}saveRegion(t){this.virtualAppend(t,this.regionsContainer,t.element),this.avoidOverlapping(t),this.regions.push(t);const e=[t.on("update",(e=>{e||this.adjustScroll(t),this.emit("region-update",t,e)})),t.on("update-end",(()=>{this.avoidOverlapping(t),this.emit("region-updated",t)})),t.on("play",(()=>{var e,i;null===(e=this.wavesurfer)||void 0===e||e.play(),null===(i=this.wavesurfer)||void 0===i||i.setTime(t.start)})),t.on("click",(e=>{this.emit("region-clicked",t,e)})),t.on("dblclick",(e=>{this.emit("region-double-clicked",t,e)})),t.once("remove",(()=>{e.forEach((t=>t())),this.regions=this.regions.filter((e=>e!==t)),this.emit("region-removed",t)}))];this.subscriptions.push(...e),this.emit("region-created",t)}addRegion(t){var e,i;if(!this.wavesurfer)throw Error("WaveSurfer is not initialized");const n=this.wavesurfer.getDuration(),s=null===(i=null===(e=this.wavesurfer)||void 0===e?void 0:e.getDecodedData())||void 0===i?void 0:i.numberOfChannels,o=new V(t,n,s);return n?this.saveRegion(o):this.subscriptions.push(this.wavesurfer.once("ready",(t=>{o._setTotalDuration(t),this.saveRegion(o)}))),o}enableDragSelection(t,e=3){var i;const n=null===(i=this.wavesurfer)||void 0===i?void 0:i.getWrapper();if(!(n&&n instanceof HTMLElement))return()=>{};let s=null,o=0;return q(n,((t,e,i)=>{s&&s._onUpdate(t,i>o?"end":"start")}),(e=>{var i,n;if(o=e,!this.wavesurfer)return;const r=this.wavesurfer.getDuration(),a=null===(n=null===(i=this.wavesurfer)||void 0===i?void 0:i.getDecodedData())||void 0===n?void 0:n.numberOfChannels,{width:l}=this.wavesurfer.getWrapper().getBoundingClientRect(),d=e/l*r,c=(e+5)/l*r;s=new V(Object.assign(Object.assign({},t),{start:d,end:c}),r,a),this.regionsContainer.appendChild(s.element)}),(()=>{s&&(this.saveRegion(s),s=null)}),e)}clearRegions(){this.regions.forEach((t=>t.remove()))}destroy(){this.clearRegions(),super.destroy(),this.regionsContainer.remove()}}let U=class{constructor(){this.listeners={}}on(t,e,i){if(this.listeners[t]||(this.listeners[t]=new Set),this.listeners[t].add(e),null==i?void 0:i.once){const i=()=>{this.un(t,i),this.un(t,e)};return this.on(t,i),i}return()=>this.un(t,e)}un(t,e){var i;null===(i=this.listeners[t])||void 0===i||i.delete(e)}once(t,e){return this.on(t,e,{once:!0})}unAll(){this.listeners={}}emit(t,...e){this.listeners[t]&&this.listeners[t].forEach((t=>t(...e)))}},K=class extends U{constructor(t){super(),this.subscriptions=[],this.options=t}onInit(){}_init(t){this.wavesurfer=t,this.onInit()}destroy(){this.emit("destroy"),this.subscriptions.forEach((t=>t()))}};function X(t,e){const i=e.xmlns?document.createElementNS(e.xmlns,t):document.createElement(t);for(const[t,n]of Object.entries(e))if("children"===t)for(const[t,n]of Object.entries(e))"string"==typeof n?i.appendChild(document.createTextNode(n)):i.appendChild(X(t,n));else"style"===t?Object.assign(i.style,n):"textContent"===t?i.textContent=n:i.setAttribute(t,n.toString());return i}function Y(t,e,i){const n=X(t,e||{});return null==i||i.appendChild(n),n}const Q={lineWidth:1,labelSize:11,formatTimeCallback:t=>`${Math.floor(t/60)}:${("0"+Math.floor(t)%60).slice(-2)}`};let J=class t extends K{constructor(t){super(t||{}),this.unsubscribe=()=>{},this.onPointerMove=t=>{if(!this.wavesurfer)return;const e=this.wavesurfer.getWrapper().getBoundingClientRect(),{width:i}=e,n=t.clientX-e.left,s=Math.min(1,Math.max(0,n/i)),o=Math.min(i-this.options.lineWidth-1,n);this.wrapper.style.transform=`translateX(${o}px)`,this.wrapper.style.opacity="1";const r=this.wavesurfer.getDuration()||0;this.label.textContent=this.options.formatTimeCallback(r*s);const a=this.label.offsetWidth;this.label.style.transform=o+a>i?`translateX(-${a+this.options.lineWidth}px)`:"",this.emit("hover",s)},this.onPointerLeave=()=>{this.wrapper.style.opacity="0"},this.options=Object.assign({},Q,t),this.wrapper=Y("div",{part:"hover"}),this.label=Y("span",{part:"hover-label"},this.wrapper)}static create(e){return new t(e)}addUnits(t){return`${t}${"number"==typeof t?"px":""}`}onInit(){if(!this.wavesurfer)throw Error("WaveSurfer is not initialized");const t=this.wavesurfer.options,e=this.options.lineColor||t.cursorColor||t.progressColor;Object.assign(this.wrapper.style,{position:"absolute",zIndex:10,left:0,top:0,height:"100%",pointerEvents:"none",borderLeft:`${this.addUnits(this.options.lineWidth)} solid ${e}`,opacity:"0",transition:"opacity .1s ease-in"}),Object.assign(this.label.style,{display:"block",backgroundColor:this.options.labelBackground,color:this.options.labelColor,fontSize:`${this.addUnits(this.options.labelSize)}`,transition:"transform .1s ease-in",padding:"2px 3px"});const i=this.wavesurfer.getWrapper();i.appendChild(this.wrapper),i.addEventListener("pointermove",this.onPointerMove),i.addEventListener("pointerleave",this.onPointerLeave),i.addEventListener("wheel",this.onPointerMove),this.unsubscribe=()=>{i.removeEventListener("pointermove",this.onPointerMove),i.removeEventListener("pointerleave",this.onPointerLeave),i.removeEventListener("wheel",this.onPointerLeave)}}destroy(){super.destroy(),this.unsubscribe(),this.wrapper.remove()}},Z=class{constructor(){this.listeners={}}on(t,e,i){if(this.listeners[t]||(this.listeners[t]=new Set),this.listeners[t].add(e),null==i?void 0:i.once){const i=()=>{this.un(t,i),this.un(t,e)};return this.on(t,i),i}return()=>this.un(t,e)}un(t,e){var i;null===(i=this.listeners[t])||void 0===i||i.delete(e)}once(t,e){return this.on(t,e,{once:!0})}unAll(){this.listeners={}}emit(t,...e){this.listeners[t]&&this.listeners[t].forEach((t=>t(...e)))}};class tt extends Z{constructor(t){super(),this.subscriptions=[],this.options=t}onInit(){}_init(t){this.wavesurfer=t,this.onInit()}destroy(){this.emit("destroy"),this.subscriptions.forEach((t=>t()))}}function et(t,e){const i=e.xmlns?document.createElementNS(e.xmlns,t):document.createElement(t);for(const[t,n]of Object.entries(e))if("children"===t)for(const[t,n]of Object.entries(e))"string"==typeof n?i.appendChild(document.createTextNode(n)):i.appendChild(et(t,n));else"style"===t?Object.assign(i.style,n):"textContent"===t?i.textContent=n:i.setAttribute(t,n.toString());return i}function it(t,e,i){return et(t,e||{})}const nt={height:20,formatTimeCallback:t=>t/60>1?`${Math.floor(t/60)}:${(t=Math.round(t%60))<10?"0":""}${t}`:""+Math.round(1e3*t)/1e3};class st extends tt{constructor(t){super(t||{}),this.options=Object.assign({},nt,t),this.timelineWrapper=this.initTimelineWrapper()}static create(t){return new st(t)}onInit(){var t;if(!this.wavesurfer)throw Error("WaveSurfer is not initialized");let e=this.wavesurfer.getWrapper();if(this.options.container instanceof HTMLElement)e=this.options.container;else if("string"==typeof this.options.container){const t=document.querySelector(this.options.container);if(!t)throw Error(`No Timeline container found matching ${this.options.container}`);e=t}this.options.insertPosition?(e.firstElementChild||e).insertAdjacentElement(this.options.insertPosition,this.timelineWrapper):e.appendChild(this.timelineWrapper),this.subscriptions.push(this.wavesurfer.on("redraw",(()=>this.initTimeline()))),((null===(t=this.wavesurfer)||void 0===t?void 0:t.getDuration())||this.options.duration)&&this.initTimeline()}destroy(){this.timelineWrapper.remove(),super.destroy()}initTimelineWrapper(){return it("div",{part:"timeline-wrapper",style:{pointerEvents:"none"}})}defaultTimeInterval(t){return t>=25?1:5*t>=25?5:15*t>=25?15:60*Math.ceil(.5/t)}defaultPrimaryLabelInterval(t){return t>=25?10:5*t>=25?6:4}defaultSecondaryLabelInterval(t){return t>=25?5:2}virtualAppend(t,e,i){let n=!1;const s=(s,o)=>{if(!this.wavesurfer)return;const r=i.clientWidth,a=t>s&&t+r<o;a!==n&&(n=a,a?e.appendChild(i):i.remove())};setTimeout((()=>{var t;this.wavesurfer&&(s(0,(null===(t=this.wavesurfer)||void 0===t?void 0:t.getWidth())||0),this.subscriptions.push(this.wavesurfer.on("scroll",((t,e,i,n)=>{s(i,n)}))))}),0)}initTimeline(){var t,e,i,n,s,o,r,a;const l=null!==(i=null!==(e=null===(t=this.wavesurfer)||void 0===t?void 0:t.getDuration())&&void 0!==e?e:this.options.duration)&&void 0!==i?i:0,d=((null===(n=this.wavesurfer)||void 0===n?void 0:n.getWrapper().scrollWidth)||this.timelineWrapper.scrollWidth)/l,c=null!==(s=this.options.timeInterval)&&void 0!==s?s:this.defaultTimeInterval(d),h=null!==(o=this.options.primaryLabelInterval)&&void 0!==o?o:this.defaultPrimaryLabelInterval(d),u=this.options.primaryLabelSpacing,p=null!==(r=this.options.secondaryLabelInterval)&&void 0!==r?r:this.defaultSecondaryLabelInterval(d),m=this.options.secondaryLabelSpacing,g="beforebegin"===this.options.insertPosition,f=it("div",{style:Object.assign({height:`${this.options.height}px`,overflow:"hidden",fontSize:this.options.height/2+"px",whiteSpace:"nowrap"},g?{position:"absolute",top:"0",left:"0",right:"0",zIndex:"2"}:{position:"relative"})});f.setAttribute("part","timeline"),"string"==typeof this.options.style?f.setAttribute("style",f.getAttribute("style")+this.options.style):"object"==typeof this.options.style&&Object.assign(f.style,this.options.style);const v=it("div",{style:{width:"0",height:"50%",display:"flex",flexDirection:"column",justifyContent:g?"flex-start":"flex-end",top:g?"0":"auto",bottom:g?"auto":"0",overflow:"visible",borderLeft:"1px solid currentColor",opacity:`${null!==(a=this.options.secondaryLabelOpacity)&&void 0!==a?a:.25}`,position:"absolute",zIndex:"1"}});for(let t=0,e=0;t<l;t+=c,e++){const i=v.cloneNode(),n=Math.round(100*t)/100%h==0||u&&e%u==0,s=Math.round(100*t)/100%p==0||m&&e%m==0;(n||s)&&(i.style.height="100%",i.style.textIndent="3px",i.textContent=this.options.formatTimeCallback(t),n&&(i.style.opacity="1"));const o=n?"primary":s?"secondary":"tick";i.setAttribute("part",`timeline-notch timeline-notch-${o}`);const r=t*d;i.style.left=`${r}px`,this.virtualAppend(r,f,i)}this.timelineWrapper.innerHTML="",this.timelineWrapper.appendChild(f),this.emit("ready")}}let ot=O,rt=G,at={create:function(t){return{addRegion:function(t){console.log("RegionsPluginShim.addRegion",t)},on:function(t,e){console.log("RegionsPluginShim.on",t,e)}}}};class lt{constructor(t){this.track=t,this.bpm=0,this.audioBuffer=null}async init(t,e,i){this.audioBuffer=this.track.audioBuffer,this.duration=this.audioBuffer.duration,this.trackId=t,this.audioBuffer&&(this.trackLength=e.duration)}async detectBPM(){return this.track.audioBuffer,125}}const dt={};async function ct(t){console.log("detectCuePoints was called",t),t.audioContext,t.audioElement,t.audioBuffer;let e=t.audioBuffer;e.duration;const i=new OfflineAudioContext(1,e.length,e.sampleRate),n=i.createBufferSource();n.buffer=e,n.connect(i.destination),n.start(0);const s=await i.startRendering(),o=s.getChannelData(0),r=s.sampleRate,a=i.createAnalyser();a.fftSize=1024,n.connect(a);const l=new Float32Array(a.frequencyBinCount),d=function(t){if(console.log("generateCuePointsFromBeatGrid was called"),!t||0===t.length)throw new Error("Invalid beatGrid: empty or null.");const e=[];for(let i=0;i<t.length;i++){if(i%64!=0)continue;let n="cue";0===i&&(n="start");const s=t[i];e.push({time:s,type:n})}return e}(t.metadata.beatGrid);await async function(t,e,i,n,s){const o=[],r=256;let a=0,l=!1;const d=1.5;for(let c=0;c<t.length;c+=r){i.getFloatFrequencyData(n);const t=n.slice(0,50).reduce(((t,e)=>t+e),0);t>s&&(t>a*d&&(o.push(c/e),l=!0),a=t),!l&&t<s&&o.push(c/e),l=!1}return o}(o,r,a,l,.01);let c=[...d];Array.from(new Set(c)).sort(((t,e)=>t-e));return c}async function ht(t){let e;if(console.log("stripe.stripeTrack - striping track",t),t.trackElement&&(e=t.trackElement.querySelector(".loading-text")),void 0===t.metadata.title){console.log("CALCULATING ID3 TAGS FOR ",t.metadata.fileName),e&&(e.innerText="Detecting ID3 Tags.\n"),console.log("ttttt prob not defined here",t.blob);try{const e=await async function(t){try{return new Promise(((e,i)=>{jsmediatags.read(t,{onSuccess:function(t){const i={},n={title:"title",artist:"artist",album:"album",year:"year",genre:"genre",track:"trackNumber",TBPM:"bpm",TKEY:"key",COMM:"comment",TCON:"genre",TLEN:"duration",TPE1:"artist",TPE2:"band",TPOS:"discNumber",TIT1:"group",TIT2:"title",TIT3:"subtitle",TYER:"year",TDAT:"date",TIME:"time",TORY:"originalYear",TXXX:"userDefined",WXXX:"userDefinedUrl",TCMP:"compilation",TENC:"encodedBy",TFLT:"fileType",TMED:"mediaType",TMOO:"mood",TPE3:"conductor",TPE4:"remixer"};for(const[e,s]of Object.entries(n)){const n=t.tags[e]?.data||t.tags[e];n&&(i[s]=n)}if(t.tags.POPM){const e=t.tags.POPM;"number"==typeof e.rating&&(i.rating=Math.round(e.rating/255*5)),i.playCount=e.counter||0}e(i)},onError:function(t){console.error("Error reading ID3 tags:",t),i(t)}})}))}catch(t){throw console.error("Failed to fetch the file:",t),t}}(t.blob);console.log("id3Info",e),["title","artist","album","year","genre","initialKey","bpm","duration"].forEach((i=>{void 0!==e[i]&&(t.metadata[i]=e[i])})),console.log("ID3 set props",t.metadata)}catch(e){console.error("Error reading ID3 tags:",e),t.metadata.title=t.metadata.fileName}}if("number"!=typeof t.metadata.bpm){console.log("CALCULATING BPM FOR ",t.metadata.fileName);let e,i=new lt(t);await i.init(t.id,t.audioElement,t.audioContext);try{e=await i.detectBPM(),e=Math.round(100*e)/100,e%1!=0&&(e=Math.ceil(e)),t.metadata.bpm=e,console.log(`Detected BPM for track ${t.metadata.fileName}: ${e}`)}catch(t){console.error("Error detecting BPM",t)}}else console.log("BPM ALREADY FOUND FOR ",t.metadata.fileName,t.metadata.bpm);{console.log("CALCULATING KEY FOR ",t.metadata.fileName);let e=await async function(t){return new Promise(((e,i)=>{const n=new Worker("/v5/apps/based/audio-stripe/vendor/keyFinderProgressiveWorker.js"),s=function(t){const e=[];for(let i=0;i<t.numberOfChannels;i++)e.push(t.getChannelData(i));return e}(t);n.postMessage({funcName:"initialize",data:[t.sampleRate,t.numberOfChannels]}),s.forEach((t=>{n.postMessage({funcName:"feedAudioData",data:[t]})})),n.postMessage({funcName:"finalDetection"}),n.onmessage=t=>{if(console.log("keyFinderWorker event",t),t.data&&t.data.data instanceof Uint8Array){const i=(new TextDecoder).decode(t.data.data);console.log("Detected Key:",i),e(i),n.terminate()}else"error"===t.data.type?(console.error("Error detecting key:",t.data.error),i(new Error(t.data.error)),n.terminate()):console.warn("Unexpected message from keyFinderWorker:",t.data)},n.onerror=t=>{console.error("Worker encountered an error:",t),i(t),n.terminate()}}))}(t.audioBuffer);console.log("estimatedKey",e);const n=function(t){const e=function(t){const[e,i]=t.split(" ");if(!e||!i)return console.error(`Invalid key format: "${t}"`),null;const n="minor"===i.toLowerCase()?"min":"maj";return`${e}${n}`}(t);if(!e)return console.error(`Failed to normalize key: "${t}"`),null;const i=ut[e];if(!i)return console.error(`Key "${e}" not found in keyMap.`),null;return i}(e);console.log(`Detected Key: ${e}, Traktor Key: ${n}`),console.log("current initialKey",t.metadata.initialKey);let s={"1m":"5m","2m":"6m","3m":"7m","4m":"8m","5m":"9m","6m":"10m","7m":"11m","8m":"12m","9m":"1m","10m":"2m","11m":"3m","12m":"4m","1d":"5d","2d":"6d","3d":"7d","4d":"8d","5d":"9d","6d":"10d","7d":"11d","8d":"12d","9d":"1d","10d":"2d","11d":"3d","12d":"4d"}[i=n]||i;console.log("adjustedKey",s),t.metadata.initialKey=s}var i;if(console.log("ATTEMPTING TO CALCULATE FIRST BEAT OFFSET AND DURATION FOR ",t.metadata.fileName,t.metadata),"number"!=typeof t.metadata.firstBeatOffset||"number"!=typeof t.metadata.duration){e&&(e.innerText="Detecting First Beat Offset and Duration for first time.\n This may take a moment"),console.log("CALCULATING firstBeatOffset and duration ",t.metadata.fileName,"existing",t.metadata),console.log("ty",typeof t.metadata.firstBeatOffset,typeof t.metadata.duration);const{firstBeatOffset:i,duration:n}=await async function(t){t.audioContext,t.audioElement,t.audioData;const e=t.audioBuffer,i=e.duration,n=new OfflineAudioContext(1,e.length,e.sampleRate),s=n.createBufferSource();s.buffer=e,s.connect(n.destination),s.start(0);const o=await n.startRendering(),r=o.getChannelData(0),a=o.sampleRate;let l=0;const d=n.createAnalyser();d.fftSize=512,s.connect(d);const c=new Float32Array(d.frequencyBinCount);for(let t=0;t<r.length;t+=128)if(d.getFloatFrequencyData(c),c.slice(0,50).reduce(((t,e)=>t+e),0)>.01){l=t/a;break}for(let t=0;t<r.length;t+=128)if(r.slice(t,t+512).some((t=>Math.abs(t)>.01))){l=t/a;break}return{firstBeatOffset:l,duration:i}}(t);t.metadata.duration=t.audioBuffer.duration,t.metadata.firstBeatOffset=i}else console.log("firstBeatOffset and duration ALREADY FOUND FOR ",t.metadata.fileName,t.metadata);let n=t.metadata.firstBeatOffset;{let e=t.metadata.beatGrid;console.log("BBB CALCULATING BEATGRID FOR ",t.metadata.fileName,e),e&&0!==e.length?console.log("BEATGRID ALREADY FOUND FOR ",t.metadata.fileName,e):(e=dt.calculateGrid(t),console.log("CALCULATED BEATGRID FOR ",t.metadata.fileName,e),t.metadata.beatGrid=e,t.metadata.beatLength=e[1]-e[0]),console.log("what are gridSnaps",e),t.metadata.beatGrid=e.map((t=>t+n))}let s=t.metadata.cuePoints;void 0===s||0===s.length?(console.log("CALCULATING CUEPOINTS FOR ",t.metadata.fileName),s=await ct(t),t.metadata.cuePoints=s):console.log("CUEPOINTS ALREADY FOUND FOR ",t.metadata.fileName,s),t.metadata.cuePoints=s}dt.calculateGrid=function(t){let e=t.audioBuffer.duration,i=t.metadata.bpm;console.log("Using trackDuration",e,i),console.log("beatGrid.calculateGrid    trackDuration",t,e,i);const n=60/i,s=[];for(let t=0;t<=e;t+=n)s.push(t);return[.25,.5,.75].forEach(((t,i)=>{let n=e*t;s.reduce(((t,e)=>Math.abs(e-n)<Math.abs(t-n)?e:t))})),s},dt.visualizeGrid=async function(t,e,i,n=!1){const s=t.getDuration();e.forEach(((e,i)=>{const o=e;if(o<=s){let e="";n&&(e=document.createElement("span"),e.classList.add("region-label"),e.style.color="white",e.style.backgroundColor="rgba(0, 0, 0, 0.5)",e.style.border="1px solid white",e.style.borderRadius="5px",e.style.padding="5px",e.lineHeight="1em",e.textContent=i+1);let s="rgba(174, 175, 175, 0.5)";t.regions.addRegion({start:o,content:e,color:s,drag:!1,resize:!1})}}))};const ut={Amin:"8m",Bbmin:"3m",Bmin:"10m",Cmin:"5m","C#min":"12m",Dbmin:"12m",Dmin:"7m",Ebmin:"2m",Emin:"9m",Fmin:"4m","F#min":"11m",Gbmin:"11m",Gmin:"6m",Abmin:"1m","G#min":"1m",Amaj:"11d",Bbmaj:"6d",Bmaj:"1d",Cmaj:"8d","C#maj":"3d",Dbmaj:"3d",Dmaj:"10d",Ebmaj:"5d",Emaj:"12d",Fmaj:"7d","F#maj":"2d",Gbmaj:"2d",Gmaj:"9d",Abmaj:"4d","G#maj":"4d"};async function pt(t){let e=t,i=t.element;console.log("Loading the track",e,i);let n=function(t){const e=["title","initialKey","bpm","firstBeatOffset","duration"];if(!t)return{hasMetadata:!1,missing:e};const i=e.filter((e=>"firstBeatOffset"===e||"duration"===e?"number"!=typeof t[e]:"beatGrid"===e||"cuePoints"===e?!Array.isArray(t[e])||0===t[e].length:void 0===t[e]));return i.length>0?{hasMetadata:!1,missing:i}:{hasMetadata:!0}}(t.metadata);!n.hasMetadata&&t.audioBuffer&&(console.error("Track is missing metadata",n.missing),await ht(t)),console.log("HAS METADATA",n);let s=i.querySelector(".titleElement"),o=t.getTitle(e);s.textContent=o||"Unknown Track",i.querySelector(".tags-display"),i.querySelector(".time-display").innerText="00:00",i.querySelector(".current-bpm").innerText=e.metadata.bpm?Number(e.metadata.bpm).toFixed(2):"N/A",i.querySelector(".key-text").innerText=e.metadata.initialKey||"N/A",i.querySelector(".time-duration").innerText=function(t){const e=Math.floor(t/60),i=Math.floor(t%60);return`${e.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}`}(e.metadata.duration),i.querySelector(".bpm-text").innerText=e.metadata.bpm?Number(e.metadata.bpm).toFixed(2):"N/A",i.querySelector(".bpm-percentage").innerText="0%";let r=i.querySelectorAll(".waveform-container");r.length&&r.forEach((t=>t.remove())),console.log("Creating waveform for track",e,i);let a=await async function(t,e,i,n){if(t.noWavesurfer&&(ot=_,rt=at),n=n||document.getElementById(e),console.log("createWaveform",t,e,i,n),!n)throw new Error(`Track container not found for trackId: ${e}. Cannot createWaveform()`);let s=document.getElementById(`#waveformContainer${i+1}`),o=document.querySelector(`#overviewWaveform${i+1}`),r=document.querySelector(`#detailedWaveform${i+1}`),a=!1;if(st.create({height:20,insertPosition:"beforebegin",timeInterval:t.metadata.beatLength,primaryLabelInterval:4*t.metadata.beatLength,secondaryLabelInterval:t.metadata.beatLength,formatTimeCallback:(e,i)=>{const n=Math.floor(e/t.metadata.beatLength);return`${Math.floor(n/4)}:${n%4}`},style:{fontSize:"12px",color:"white"}}),st.create({height:10,timeInterval:.1,primaryLabelInterval:1,style:{fontSize:"10px",color:"white"}}),s||(s=document.createElement("div"),s.id=`waveformContainer${i}`,s.className="waveform-container",n.prepend(s)),o||(o=document.createElement("div"),o.id=`overviewWaveform${i}`,o.className="waveform-container-overview",s.prepend(o)),r||(r=document.createElement("div"),r.id=`detailedWaveform${i}`,r.className="waveform-container-detailed",s.prepend(r)),t.detailedContainer=r,!t.audioBuffer){let t=document.createElement("div");t.className="detailed-waveform-placeholder",t.innerText="No audio data available",r.prepend(t);let e=document.createElement("div");return e.className="overview-waveform-placeholder",e.innerText="No audio data available",o.prepend(e),{detailedWaveform:null,overviewWaveform:null,overviewContainer:o,detailedContainer:r}}let l=null;if(!l){console.log("No peaks data available, generating from audioBuffer...slow in main process. Use worker...");let e=t.audioBuffer.getChannelData(0);console.log("track.arrayBuffer",t.arrayBuffer),l=e}let d=rt.create();const c=ot.create({sampleRate:44100,scale:512,showWaveform:!1,container:o,waveColor:"grey",autoCenter:!0,autoCenterImmediately:!0,progressColor:"purple",cursorColor:"red",height:55,barGap:1,barWidth:1,normalize:!0,partialRender:!0,responsive:!1,cursorWidth:1,peaks:l,duration:t.metadata.duration,minPxPerSec:1,scrollParent:!1,plugins:[d,J.create({lineColor:"#ff0000",lineWidth:2,labelBackground:"#555",labelColor:"#fff",labelSize:"11px"})]});c.regions=d;const h=rt.create(),u=ot.create({showWaveform:!1,container:r,waveColor:"purple",autoCenter:!0,autoCenterImmediately:!0,progressColor:"purple",cursorColor:"red",media:t.audioElement,height:140,interact:!0,barWidth:1,barGap:1,pixelRatio:1,partialRender:!0,normalize:!1,dragToSeek:!1,peaks:l,duration:t.metadata.duration,cursorWidth:1,responsive:!1,hideScrollbar:!0,minPxPerSec:130,scrollParent:!1,isScrollable:!1,plugins:[h]});function p(t){const e=Math.floor(t/60),i=Math.floor(t%60);return`${e.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}`}return u.regions=h,t.waveform=u,t.detailedWaveform=u,u.on("audioprocess",(()=>{const t=u.getCurrentTime()/u.getDuration(),e=u.getCurrentTime();n.querySelectorAll(".time-display").forEach((t=>{t.innerText=p(e)})),a||(a=!0,c.seekTo(t),a=!1)})),u.on("seeking",(e=>{const i=u.getCurrentTime();u.getDuration(),t.transport.detailedTimeDisplay&&(t.transport.detailedTimeDisplay.innerText="-"+p(i),t.transport.previousCueTime=i)})),u.on("dragstart",(t=>{console.log("dragstart",t),u.pause()})),u.on("drag",(t=>{console.log("drag",t);const e=u.getDuration()*t;u.seekTo(e)})),u.on("dragend",(t=>{console.log("dragend",t);const e=u.getDuration()*t;u.seekTo(e),u.play()})),c.on("click",((t,e)=>{let i=c.getCurrentTime();return console.log("overviewWaveform mousedown",i),u.setTime(i),!1})),c.on("seeking",(t=>{if(console.log("overviewWaveform seeking to",t),!a){a=!0;const t=c.getCurrentTime()/c.getDuration();u.seekTo(t),a=!1}})),u.on("click",((e,i)=>(console.log("detailedWaveform mousedown"),u.isPlaying(),t.playPause(),!1))),u.on("mouseup",(()=>{console.log("detailedWaveform mouseup")})),console.log("before set",t.overviewWaveform),t.overviewWaveform=c,t.detailedWaveform=u,t.overviewWaveform._=t.overviewWaveform._||{},console.log("after set",t.overviewWaveform),c.setVolume(0),{detailedWaveform:u,overviewWaveform:c,overviewContainer:o,detailedContainer:r}}(e,e.id,1,i),{detailedWaveform:d,overviewWaveform:c,overviewContainer:h,detailedContainer:u}=a;console.log("Waveform created:",d,c,h,u),e.noWavesurfer&&(u.style.display="none",h.style.display="none"),e.audioBuffer&&e.metadata.beatGrid&&setTimeout((()=>{console.log("beatGrid.visualizeGrid",e.metadata.beatGrid,e.metadata.firstBeatOffset),dt.visualizeGrid(d,e.metadata.beatGrid,e.metadata.firstBeatOffset),l.renderCuePoints(d,e,"#8a2be2",e.metadata.beatLength/8,{color:"#aeafaf",backgroundColor:"rgba(0, 0, 0, 0.5)",border:"1px solid white",borderRadius:"5px",paddingLeft:"5px",paddingRight:"5px",marginLeft:"5px",lineHeight:"1em"}),l.renderCuePoints(c,e,"#8a2be2",2*e.metadata.beatLength,{color:"#aeafaf",backgroundColor:"rgba(0, 0, 0, 0.5)",border:"0.2em thin white",borderRadius:"5px",marginLeft:"5px",marginRight:"5px"})}),10)}const mt={deckControlMappings:{deckA:{},deckB:{}},eventListener:null};mt.bindKeys=function(t,e="deckA"){t&&e?(this.unbindKeys(e),this.deckControlMappings[e]=function(t,e){return"deckA"===e?{1:()=>t.cueTo(1),2:()=>t.cueTo(2),3:()=>t.cueTo(3),4:()=>t.cueTo(4),w:()=>t.playPause()}:"deckB"===e?{5:()=>t.cueTo(1),6:()=>t.cueTo(2),7:()=>t.cueTo(3),8:()=>t.cueTo(4),s:()=>t.playPause()}:{}}(t,e),this.eventListener=t=>{this.deckControlMappings[e][t.key]&&(t.preventDefault(),this.deckControlMappings[e][t.key]())},document.addEventListener("keydown",this.eventListener)):console.error("Track instance and deck name are required for binding keys.")},mt.unbindKeys=function(t="deckA"){this.eventListener&&(document.removeEventListener("keydown",this.eventListener),this.eventListener=null),t&&this.deckControlMappings[t]&&(this.deckControlMappings[t]={})};let gt=class{constructor(t,e){this.bp=t,this.config=e,this.container=e.container,this.audioTracks=[]}async init(){console.log("AudioPlayer init",this.config),this.track=new o({}),this.track.setRenderer("pvrtybvx",{render:b,databind:pt});let t=await this.track.render();console.log("rendered audio track",t),this.track.element=t,this.container.appendChild(t),mt.bindKeys(this.track)}async play(){await this.track.play()}async load(t){console.log("AudioPlayer load",t),await this.track.load({url:t}),console.log("created audio track",this.track),await this.track.databind(this.track.element)}async unload(){console.log("AudioPlayer unload"),await this.track.unload(),mt.unbindKeys(this.track)}async close(){console.log("AudioPlayer close"),await this.track.unload(),mt.unbindKeys(this.track)}};const ft={eventListener:null,bindings:{n:t=>t.open("audio-player"),p:t=>t.open("audio-player",{context:"playlist"})},bindKeys:function(t,e="keyboard"){t?(this.unbindKeys(),this.eventListener=e=>{this.bindings[e.key]&&(e.preventDefault(),this.bindings[e.key](t))},document.addEventListener("keydown",this.eventListener)):console.error("Audio player instance is required for binding keys.")},unbindKeys:function(){this.eventListener&&(document.removeEventListener("keydown",this.eventListener),this.eventListener=null)}};let vt=document.createElement("h1");vt.classList.add("logo"),vt.textContent="PVRTY BVX";class bt{constructor(t){this.bp=t,this.AudioPlayer=gt}async init(){console.log("AudioPlayer init"),await this.bp.appendCSS("/v5/apps/based/audio-track/render/pvrtybvx/style.css",!1,!0),await this.bp.appendScript("/v5/apps/based/audio-stripe/vendor/jsmediatags.min.js"),$(document).on("click",(t=>{this.bp.apps.menubar;let e=this.audioPlayers;$(t.target).closest("#menuBar").length,e.forEach((e=>{$(t.target).closest('[data-type="audioPlayer"]').length}))})),this.audioPlayers=[]}play(){alert("play")}load(t){alert(JSON.stringify(t))}async open(t){console.log("AudioPlayer open",t),ft.bindKeys(this.bp);let e="audio-player-"+this.audioPlayers.length;this.bp.apps.menubar;let i=this.bp.apps.ui.windowManager.createWindow({id:e,title:"Audio Player",icon:"desktop/assets/images/icons/icon_audio-player_64.png",x:250,y:75,width:980,height:360,minWidth:200,minHeight:200,parent:$("#desktop")[0],type:"audioPlayer",resizable:!0,minimizable:!0,maximizable:!0,closable:!0,focusable:!0,maximized:!1,minimized:!1,onClose:()=>{this.audioPlayers.find((t=>t.id===e)).close(),this.bp.apps.menubar.setDefaultMenu(),ft.unbindKeys(this.bp)}});console.log("new win",this.audioPlayerWindow),t.url="v5/apps/based/audio-player/vendor/One%20More%20Night%20[MetroGnome%20Remix].mp3",t.container=i.content;let n=new gt(this.bp,t);n.id=e,await n.init(),await n.load(t.url,{}),this.audioPlayers.push(n),await n.play()}createAudioPlayer(t){return new this.AudioPlayer(t)}}export{bt as default};
//# sourceMappingURL=audio-player.js.map
