class t{constructor(t,e=null){this.context=t,this.buffers=Array(8).fill(null),this.recorder=null,this.recordedChunks=[],this.activeSources=new Map,this.pitchStates=new Map,this.gainNode=this.context.createGain(),this.mode=Array(8).fill("one-shot"),this.reversePlayback=Array(8).fill(!1),e?e.addTrack(this.gainNode,this.context):this.gainNode.connect(this.context.destination)}async unload(){this.buffers=Array(8).fill(null),this.recorder=null,this.recordedChunks=[],this.activeSources.clear(),this.pitchStates.clear()}async loadSample(t,e){const s=await t.arrayBuffer(),a=await this.context.decodeAudioData(s);this.buffers[e]=a,this.reversePlayback[e]&&this.reverseBuffer(e)}async recordMicrophone(t){const e=await navigator.mediaDevices.getUserMedia({audio:!0});let s;this.recorder=new MediaRecorder(e),this.recordedChunks=[];const a=new Promise((t=>s=t));return this.recorder.ondataavailable=t=>this.recordedChunks.push(t.data),this.recorder.onstop=async()=>{const e=new Blob(this.recordedChunks,{type:"audio/webm"}),a=await e.arrayBuffer(),i=await this.context.decodeAudioData(a);this.buffers[t]=i,s(i)},this.recorder.start(),{stream:e,bufferPromise:a}}stopMicrophoneRecording(){this.recorder&&"recording"===this.recorder.state&&this.recorder.stop()}recordGlobalBus(t,e){const s=t.audioContext.createMediaStreamDestination();return t.gainNode.connect(s),this.recorder=new MediaRecorder(s.stream),this.recordedChunks=[],this.recorder.ondataavailable=t=>this.recordedChunks.push(t.data),this.recorder.onstop=async()=>{const t=new Blob(this.recordedChunks,{type:"audio/webm"}),s=await t.arrayBuffer();this.buffers[e]=await this.context.decodeAudioData(s)},this.recorder.start(),s.stream}stopGlobalBusRecording(){this.recorder&&"recording"===this.recorder.state&&this.recorder.stop()}playSampleAtPitch(t,e){if(!this.buffers[t])return;const s=this.context.createBufferSource();s.buffer=this.buffers[t],s.playbackRate.value=e,s.connect(this.gainNode),s.start(),this.activeSources.set(t,s),this.pitchStates.set(t,e)}setReverse(t,e){this.reversePlayback[t]=e,e?this.reverseBuffer(t):this.loadSample(originalFile,t)}reverseBuffer(t){const e=this.buffers[t],s=e.numberOfChannels,a=this.context.createBuffer(s,e.length,e.sampleRate);for(let t=0;t<s;t++){const s=e.getChannelData(t),i=a.getChannelData(t);for(let t=0;t<e.length;t++)i[t]=s[e.length-1-t]}this.buffers[t]=a}setMode(t,e){this.mode[t]=e}playSample(t,e=!1){if(!this.buffers[t])return;const s=this.context.createBufferSource();s.buffer=this.buffers[t],s.connect(this.gainNode);const a=this.activeSources.get(t);if(a&&"loop"===this.mode[t]&&a.loop)this.stopSample(t);else switch(console.log("existingSource",a,"this.mode[padIndex]",this.mode[t]),this.mode[t]){case"one-shot":case"hold":case"toggle":case"loop":if(a&&("toggle"===this.mode[t]||"loop"===this.mode[t]))return console.log("STOPPING"),void this.stopSample(t);s.loop="loop"===this.mode[t],s.start(),console.log("setting the activeSources",s),this.activeSources.set(t,s)}}stopSample(t){const e=this.activeSources.get(t);e&&(e.loop=!1,e.stop(),this.activeSources.delete(t))}handlePadPress(t){"hold"===this.mode[t]?this.playSample(t,!0):this.playSample(t)}handlePadRelease(t){"hold"===this.mode[t]&&this.stopSample(t)}stopAllRecordings(){this.recorder&&"recording"===this.recorder.state&&this.recorder.stop()}stopAllSamples(){this.activeSources.forEach((t=>{t.loop=!1,t.stop()})),this.activeSources.clear(),this.pitchStates.clear()}setModWheel(t){const e=5.5*t;console.log("incoming value from -1 to 1",t),console.log("amplifiedValue",e);const s=this.activeSources.entries();for(const[t,a]of s){const s=(this.pitchStates.get(t)||1)*Math.pow(2,e/12);a.playbackRate.value=s}}adjustVolume(t){const e=Math.max(0,Math.min(1,t));this.gainNode.gain.setValueAtTime(e,this.context.currentTime)}}class e{constructor({notes:t,onKeyPlay:e,onModWheelChange:s}){return this.baseNotes=t||this._defaultNotes(),this.currentOctave=0,this.onKeyPlay=e||(()=>{}),this.onModWheelChange=s||(()=>{}),this.keyCount=25,this.isMouseDown=!1,this.container=this._createPianoRollContainer(),this._addEventListeners(),this._render(),this}_defaultNotes(){return[{name:"C",ratio:1},{name:"C#",ratio:1.05946},{name:"D",ratio:1.12246},{name:"D#",ratio:1.18921},{name:"E",ratio:1.25992},{name:"F",ratio:1.33484},{name:"F#",ratio:1.41421},{name:"G",ratio:1.49831},{name:"G#",ratio:1.5874},{name:"A",ratio:1.68179},{name:"A#",ratio:1.7818},{name:"B",ratio:1.88775}]}_createPianoRollContainer(){const t=document.createElement("div");t.classList.add("piano-roll-wrapper");const e=document.createElement("div");e.classList.add("piano-controls");const s=document.createElement("button");s.textContent="- Octave",s.classList.add("piano-octave-btn"),s.addEventListener("click",(()=>this._shiftOctave(-1)));const a=document.createElement("button");a.textContent="+ Octave",a.classList.add("piano-octave-btn"),a.addEventListener("click",(()=>this._shiftOctave(1)));const i=document.createElement("span");i.classList.add("octave-indicator"),i.textContent=`Octave ${this.currentOctave}`,this.octaveIndicator=i,e.appendChild(s),e.appendChild(i),e.appendChild(a),t.appendChild(e);const o=document.createElement("div");o.classList.add("mod-wheel-container");const n=document.createElement("span");n.textContent="Mod Wheel",n.classList.add("mod-wheel-label");const r=document.createElement("input");return r.type="range",r.min="-100",r.max="100",r.value="0",r.classList.add("mod-wheel"),r.addEventListener("input",(t=>this._handleModWheelChange(t.target.value))),r.addEventListener("mouseup",(()=>this._resetModWheel(r))),o.appendChild(n),o.appendChild(r),e.appendChild(o),this.pianoContainer=document.createElement("div"),this.pianoContainer.classList.add("piano-roll"),t.appendChild(this.pianoContainer),t}_render(){this.pianoContainer.innerHTML="";const t=[],e=Math.floor(this.keyCount/2);for(let s=0;s<this.keyCount;s++){const a=this.baseNotes[s%this.baseNotes.length],i=Math.floor((s-e)/this.baseNotes.length);t.push({name:`${a.name}`,ratio:a.ratio*Math.pow(2,i+this.currentOctave)})}t.forEach(((t,e)=>{const s=document.createElement("div");s.classList.add("piano-key",t.name.includes("#")?"piano-black-key":"piano-white-key"),t.name.includes("#")||(s.style.display="flex",s.style.justifyContent="center",s.style.alignItems="flex-end",s.style.paddingBottom="4px"),s.textContent=t.name,s.dataset.ratio=t.ratio,s.addEventListener("mousedown",(()=>this._playKey(t))),s.addEventListener("mouseenter",(()=>{this.isMouseDown&&this._playKey(t)})),this.pianoContainer.appendChild(s)})),this.octaveIndicator.textContent=`Octave ${this.currentOctave}`}_shiftOctave(t){this.currentOctave+=t,this._render()}_addEventListeners(){document.addEventListener("mousedown",(()=>this.isMouseDown=!0)),document.addEventListener("mouseup",(()=>this.isMouseDown=!1))}_playKey(t){this.onKeyPlay&&this.onKeyPlay(t)}_handleModWheelChange(t){const e=t/100;this.onModWheelChange(e)}_resetModWheel(t){const e=setInterval((()=>{const s=parseFloat(t.value);0!==s?(t.value=s+(s>0?-1:1),this._handleModWheelChange(t.value)):clearInterval(e)}),10)}}class s{constructor({audioContext:t,stream:e=null,buffer:s=null,parent:a,width:i,height:o}){this.audioContext=t,this.stream=e,this.buffer=s,this.parent=a,this.canvas=document.createElement("canvas"),this.canvas.classList.add("streaming-waveform"),this.ctx=this.canvas.getContext("2d"),this.canvas.width=i||800,this.canvas.height=o||150,this.parent.innerHTML="",this.parent.appendChild(this.canvas),this.isDrawing=!1,this.currentX=0,this.analyser=null,this.stream?this._setupStream():this.buffer&&this._drawBuffer(),this.playHeadPosition=0}_setupStream(){this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=1024;this.audioContext.createMediaStreamSource(this.stream).connect(this.analyser),this.bufferLength=this.analyser.frequencyBinCount,this.dataArray=new Uint8Array(this.bufferLength),this._startDrawing()}_startDrawing(){this.isDrawing=!0;const t=()=>{if(!this.isDrawing)return;requestAnimationFrame(t),this.analyser.getByteTimeDomainData(this.dataArray);const e=this.ctx.getImageData(2,0,this.canvas.width-2,this.canvas.height);this.ctx.putImageData(e,0,0),this.ctx.fillStyle="#222",this.ctx.fillRect(this.canvas.width-2,0,2,this.canvas.height),this.ctx.lineWidth=1,this.ctx.strokeStyle="#00ff00",this.ctx.beginPath();const s=this.canvas.height/2;for(let t=0;t<this.bufferLength;t++){const e=s+(this.dataArray[t]/255-.5)*s,a=this.canvas.width-2;0===t?this.ctx.moveTo(a,e):this.ctx.lineTo(a,e)}this.ctx.stroke()};t()}setPlayHeadPosition(t){t<0||t>1||(this.playHeadPosition=t,this._redrawBufferWithPlayhead())}_drawBuffer(){this.rawData=this.buffer.getChannelData(0),this.totalSamples=this.rawData.length,this.samplesPerPixel=Math.ceil(this.totalSamples/this.canvas.width),this._redrawBufferWithPlayhead()}renderFinalBuffer(t){this.buffer=t,this.stream=null,this.isDrawing=!1;const e=this.parent.clientWidth;this.canvas.width!==e&&(this.canvas.width=e),this._drawBuffer()}_redrawBufferWithPlayhead(){const t=this.canvas.height/2;this.ctx.fillStyle="#222",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.lineWidth=1,this.ctx.strokeStyle="#00ff00",this.ctx.beginPath();for(let e=0;e<this.canvas.width;e++){const s=e*this.samplesPerPixel,a=s+this.samplesPerPixel;let i=1,o=-1;for(let t=s;t<a;t++){const e=this.rawData[t]||0;e>o&&(o=e),e<i&&(i=e)}const n=t+i*t,r=t+o*t;0===e?this.ctx.moveTo(e,n):this.ctx.lineTo(e,n),this.ctx.lineTo(e,r)}this.ctx.stroke(),this._drawPlayhead()}_drawPlayhead(){const t=Math.floor(this.playHeadPosition*this.canvas.width);this.ctx.strokeStyle="#FF0000",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.moveTo(t,0),this.ctx.lineTo(t,this.canvas.height),this.ctx.stroke()}remove(){this.canvas.remove()}stop(){this.isDrawing=!1}clear(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.currentX=0}}function a(t,e,s={}){const a={...{className:"volume-slider",thumbClassName:"slider-thumb",labelClassName:"label",orientation:"vertical",trackColor:"#333",thumbColor:"#fff",trackWidth:"60px",trackHeight:"200px",thumbWidth:"48px",thumbHeight:"8px",showLabel:!0,showScale:!1,showCenterLine:!1,centerLineColor:"#aeafaf",centerLineLength:"32px",scaleLineLength:"32px",centerLineWidth:"2px",centerLineSpacing:10,progressBarColor:"#4caf50",progressBarSize:"8px",minValue:0,maxValue:1,step:.01,value:0,defaultValue:0,onDoubleClick:t=>{console.log("Must implement double-click handler to reset the value"),this.setValue(t)},onClick:t=>{},onChange:(t,e)=>{console.log("Must implement changeFunction to evoke changes to state")},formatLabel:t=>t.toFixed(2)},...s};this.options=a,this.onClick=a.onClick.bind(this),this.onChange=a.onChange.bind(this),this.onDoubleClick=a.onDoubleClick.bind(this),this.formatLabel=a.formatLabel.bind(this),this.thumbHeight=a.thumbHeight,this.thumbWidth=a.thumbWidth,this.trackWidth=a.trackWidth,this.trackHeight=a.trackHeight,this.orientation=a.orientation,this.defaultValue=a.defaultValue,this.trackLength="vertical"===a.orientation?parseInt(a.trackHeight):parseInt(a.trackWidth);const i=document.createElement("div");if(this.sliderContainer=i,this.minValue=a.minValue,this.maxValue=a.maxValue,this.value=a.value,i.style.background=a.trackColor,i.style.borderRadius="5px",i.classList.add(a.className),i.classList.add("slider-component"),"vertical"===a.orientation?(i.style.width=a.trackWidth,i.style.height=a.trackHeight):(i.style.width=a.trackHeight,i.style.height=a.trackWidth),a.showCenterLine){const t=document.createElement("div");t.style.position="absolute",t.style.background=a.centerLineColor,"vertical"===a.orientation?(t.style.width=a.centerLineLength,t.style.height=a.centerLineWidth,t.style.left=`calc(50% - ${parseInt(a.centerLineLength)/2}px)`,t.style.top="50%"):(t.style.height=a.centerLineLength,t.style.width=a.centerLineWidth,t.style.top=`calc(50% - ${parseInt(a.centerLineLength)/2}px)`,t.style.left="50%"),i.appendChild(t)}if(a.showScale){const t=t=>{const e=document.createElement("div");e.style.position="absolute",e.style.background=a.centerLineColor,e.style.opacity=.2,"vertical"===a.orientation?(e.style.width=a.scaleLineLength,e.style.height=a.centerLineWidth,e.style.left=`calc(50% - ${parseInt(a.scaleLineLength)/2}px)`,e.style.top=`${t}px`):(e.style.height=a.scaleLineLength,e.style.width=a.centerLineWidth,e.style.top=`calc(50% - ${parseInt(a.scaleLineLength)/2}px)`,e.style.left=`${t}px`),i.appendChild(e)},e="vertical"===a.orientation?parseInt(a.trackHeight):parseInt(a.trackWidth),s=e/2,o=a.centerLineSpacing;for(let a=0;s+a<=e||s-a>=0;a+=o)s+a<=e&&t(s+a),s-a>=0&&0!==a&&t(s-a)}if(a.showProgress){const t=document.createElement("div");t.style.position="absolute",t.style.background=a.progressBarColor,t.style.zIndex="1",this.progressBar=t,"vertical"===a.orientation?(t.style.width=a.progressBarSize,t.style.left=`calc(50% - ${parseInt(a.progressBarSize)/2}px)`):(t.style.height=a.progressBarSize,t.style.top=`calc(50% - ${parseInt(a.progressBarSize)/2}px)`),i.appendChild(t)}const o=document.createElement("div");o.classList.add(a.thumbClassName),o.style.position="absolute",o.style.background=a.thumbColor,o.style.borderRadius="4px",o.style.cursor="pointer",o.title=this.options.title||"Track Volume",this.options.sliderThumbStyles&&Object.keys(this.options.sliderThumbStyles).forEach((t=>{o.style[t]=this.options.sliderThumbStyles[t]})),"vertical"===a.orientation?(o.style.width=a.thumbWidth,o.style.height=a.thumbHeight):(o.style.width=a.thumbHeight,o.style.height=a.thumbWidth),this.sliderThumb=o;const n="vertical"===a.orientation?(1-a.value)*this.trackLength:a.value*this.trackLength;"vertical"===a.orientation?o.style.top=n-parseInt(a.thumbHeight)/2+"px":o.style.left=n-parseInt(a.thumbWidth)/2+"px",i.appendChild(o);const r=document.createElement("div");r.classList.add(a.labelClassName),r.textContent=a.value.toFixed(2),r.style.position="absolute",r.style.top="vertical"===a.orientation?"-22px":"50%",r.style.left="vertical"===a.orientation?"50%":"calc(100% + 10px)",r.style.transform="vertical"===a.orientation?"translateX(-50%)":"translateY(-50%)",this.sliderLabel=r,this.options.showLabel||(r.style.display="none"),i.appendChild(r);let l=!1;return o.addEventListener("mousedown",(t=>{this.onClick(this.getValue()),l=!0,this._onChange(t)})),o.addEventListener("touchstart",(t=>{l=!0,this._onChange(t.touches[0])})),document.addEventListener("mousemove",(t=>{l&&this._onChange(t)})),document.addEventListener("touchmove",(t=>{l&&this._onChange(t.touches[0])})),document.addEventListener("mouseup",(()=>{l=!1})),document.addEventListener("touchend",(()=>{l=!1})),i.addEventListener("mousedown",(t=>{t.target!==o&&(this.onClick(this.getValue()),this._onChange(t),l=!0)})),i.addEventListener("touchstart",(t=>{t.target!==o&&(this._onChange(t.touches[0]),l=!0)})),i.addEventListener("touchend",(()=>{l=!1})),i.addEventListener("touchmove",(t=>{l&&this._onChange(t.touches[0])})),i.addEventListener("dblclick",(t=>{this.onDoubleClick(this.defaultValue)})),this.setValue(a.value,!1),this}a.prototype._onChange=function(t){const e=this.sliderContainer.getBoundingClientRect();let s;const a=e.width/1,i=e.height/1;if("vertical"===this.orientation){s=(t.clientY-e.top)/1,s=Math.min(Math.max(s,0),i);const a=1-s/i;this.sliderThumb.style.top=`${Math.min(Math.max(s-parseInt(this.thumbHeight)/2/1,0),i-parseInt(this.thumbHeight)/1)}px`,this.value=a,this.updateProgressBar(a),this.updateLabel(this.formatLabel(a)),this.onChange(a,this.getValue())}else{s=(t.clientX-e.left)/1,s=Math.min(Math.max(s,0),a);const i=s/a;this.sliderThumb.style.left=`${Math.min(Math.max(s-parseInt(this.thumbWidth)/2/1,0),a-parseInt(this.thumbWidth)/1)}px`,this.value=i,this.updateProgressBar(i),this.updateLabel(this.formatLabel(i)),this.onChange(i,this.getValue())}},a.prototype.getValue=function(){return this.value*(this.maxValue-this.minValue)+this.minValue},a.prototype.setValue=function(t,e=!0){const s=Math.min(Math.max(t,this.options.minValue),this.options.maxValue);let a=this.maxValue-this.minValue,i=(s-this.minValue)/a;this.value=i;const o="vertical"===this.orientation?(1-i)*this.trackLength:i*this.trackLength;"vertical"===this.orientation?(this.sliderThumb.style.top=`${Math.min(Math.max(o-parseInt(this.thumbHeight)/2,0),this.trackLength-parseInt(this.thumbHeight))}px`,this.options.showProgress&&(this.progressBar.style.height=(1-i)*this.trackLength+"px",this.progressBar.style.top=i*this.trackLength+"px")):(this.sliderThumb.style.left=`${Math.min(Math.max(o-parseInt(this.thumbWidth)/2,0),this.trackLength-parseInt(this.thumbWidth))}px`,this.options.showProgress&&(this.progressBar.style.width=i*this.trackLength+"px")),this.updateLabel(this.formatLabel(t)),this.updateProgressBar(),e&&this.onChange(i,this.getValue())},a.prototype.updateProgressBar=function(t){if(!this.options.showProgress)return;const e=t*this.trackLength;console.log("value",t,"position",e),"vertical"===this.orientation?(this.progressBar.style.height=`${e}px`,this.progressBar.style.top=this.trackLength-e+"px"):(this.progressBar.style.width=`${e}px`,this.progressBar.style.left="0")},a.prototype.updateLabel=function(t){this.sliderLabel.textContent=this.getValue().toFixed(2)};var i=["808.wav","Snare Mid.wav","Hihat.wav","Clap.wav","Tom High.wav","Tom Low.wav","Cymbal.wav","Rimshot.wav","Claves.wav","Conga High.wav","Conga Mid.wav","Conga Low.wav","Kick Basic.wav","Kick Long.wav","Kick Short.wav","Maracas.wav","Open Hat Short.wav","Open Hat Long.wav","Snare Bright.wav","Snare High.wav","Snare Low.wav","Tom Mid.wav"];class o{constructor(s,o,n={}){this.audioContext=s,this.globalBus=o,this.sampler=new t(s,null),this.fetch=n.fetch||window.fetch.bind(window),this.defaultSounds=n.defaultSounds||["samples/lets-go.mp3","samples/make-some-noise.mp3","samples/drop-it.mp3","samples/airhorn.mp3",null,null,null,null],this.container=document.createElement("div"),this.container.classList.add("sampler-pad-container","track-active"),this.topSection=document.createElement("div"),this.topSection.classList.add("sampler-top-section"),this.container.appendChild(this.topSection),this.buttonGrid=document.createElement("div"),this.buttonGrid.classList.add("sampler-pad"),this.buttonGrid.style.display="grid",this.buttonGrid.style.gridTemplateColumns="repeat(4, 1fr)",this.buttonGrid.style.gap="10px",this.buttonGrid.style.padding="0px",this.buttonGrid.style.borderRadius="10px",this.topSection.appendChild(this.buttonGrid),this.volumeContainer=document.createElement("div"),this.volumeContainer.classList.add("sampler-volume-container"),this.topSection.appendChild(this.volumeContainer);let r=this,l=function(t,e,s={}){return new a(t,e,s)}(null,"sampler-0",{minValue:0,maxValue:1,value:1,trackWidth:"20px",trackHeight:"260px",thumbHeight:"48px",thumbWidth:"24px",sliderThumbStyles:{left:"18px"},showLabel:!1,className:"sampler-volume-slider",thumbClassName:"volume-thumb",onChange:function(t){r.sampler.adjustVolume(t)}});this.volumeSlider=l,this.volumeContainer.append(l.sliderContainer),this.sliceRecordContainer=document.createElement("div"),this.sliceRecordContainer.classList.add("sampler-slice-record-container"),this.topSection.appendChild(this.sliceRecordContainer);const h=this._createLiveSlicedRecordButton();this.sliceRecordContainer.appendChild(h);const d=document.createElement("button");d.textContent="Stop",d.innerHTML='<i class="fa-duotone fa-solid fa-stop"></i>',d.style.fontSize="2.5rem",d.classList.add("sampler-stop-all-button","sampler-record-button"),d.addEventListener("click",(()=>{this.sampler.stopAllSamples(),this.sampler.stopAllRecordings()})),this.sliceRecordContainer.appendChild(d);const c=document.createElement("button");c.innerHTML='<i class="fa-duotone fa-solid fa-piano-keyboard"></i>',c.style.fontSize="32px",c.classList.add("sampler-record-button"),c.addEventListener("click",(()=>{"flex"===this.controlsContainer.style.display?this.controlsContainer.style.display="none":this.controlsContainer.style.display="flex"})),this.showPianoRoll=c,this.sliceRecordContainer.appendChild(c),this.controlsContainer=document.createElement("div"),this.controlsContainer.classList.add("sampler-controls-container"),this.pads=[];for(let t=0;t<8;t++){this.defaultSounds[t]&&this._loadDefaultSound("default",t,this.defaultSounds[t]);const e=this._createPad(t,this.defaultSounds[t]);this.buttonGrid.appendChild(e),this.pads.push(e)}const p=new e({onKeyPlay:t=>{t.ratio;const e=this.lastPlayedPad||0;this.sampler.playSampleAtPitch(e,t.ratio)},onModWheelChange:t=>{this.sampler.setModWheel(t)}});this.controlsContainer.appendChild(p.container);let u=[{id:"default",name:"Pvrty Bvx v1",samples:["dj-horn.mp3","dang-son.mp3","helicopter-helicopter.mp3","yooo.mp3","celebrate.mp3","flawless-victory.wav",null,null]},{id:"tr-808",name:"TR-808",samples:i},{id:"custom",name:"Custom",disabled:!1,samples:[]}],m=this.controlsContainer.querySelector(".piano-controls"),f=document.createElement("div");f.classList.add("sample-bank-select-container");let g=document.createElement("select");g.classList.add("sample-bank-select"),u.forEach((t=>{let e=document.createElement("option");e.value=t.id,e.text=t.name,t.disabled&&(e.disabled=!0),g.add(e)})),g.addEventListener("change",(t=>{let e=t.target.value,s=u.find((t=>t.id===e));this.defaultSounds=s.samples,this.container.querySelectorAll(".sampler-pad").forEach(((t,s)=>{t.querySelector(".sampler-waveform-container").innerHTML="",this._loadDefaultSound(e,s,this.defaultSounds[s])}))})),f.appendChild(g),m.insertBefore(f,m.lastElementChild);const v=document.createElement("div");this.waveformContainer=v,this.container.appendChild(v),this.container.appendChild(this.controlsContainer),this.waveform=null,n.parent&&n.parent.appendChild(this.container),this.lastPlayedPad=0}unload(){this.sampler.unload(),this.container.remove()}adjustVolume(t){this.sampler.adjustVolume(t),this.volumeSlider.setValue(t)}async _loadDefaultSound(t,e,a){a="/v5/apps/based/sampler/packs/"+t+"/"+a;const i=await this.fetch(a),o=await i.arrayBuffer(),n=await this.audioContext.decodeAudioData(o);this.sampler.buffers[e]=n;let r=this.pads[e].querySelector(".sampler-waveform-container");new s({buffer:this.sampler.buffers[e],parent:r,width:196,height:100}),this.pads[e].querySelector(".sampler-pad-label").textContent=a.split("/").pop()}}o.prototype._createPad=function(t,e){const a=document.createElement("div");a.classList.add("sampler-pad");const i=document.createElement("div");i.classList.add("sampler-waveform-container"),i.style.position="absolute",i.style.top="0",i.style.left="0",i.style.zIndex="0";const o=document.createElement("button");o.classList.add("sampler-pad-button"),o.style.position="relative",o.style.zIndex="1",o.style.border="1px solid #555",o.style.color="#FFF",o.addEventListener("mousedown",(()=>{this.sampler.buffers[t]?(this.sampler.handlePadPress(t),this.lastPlayedPad=t):l.click()})),o.addEventListener("mouseup",(()=>{this.sampler.handlePadRelease(t)}));const n=document.createElement("div");if(e){let t=e.split("/").pop();t=t.split(".")[0],n.textContent=t}else n.textContent=`Pad ${t+1}`;n.classList.add("sampler-pad-label"),o.appendChild(n);const r=document.createElement("div");r.classList.add("sampler-pad-controls");const{fileInput:l,iconButton:h}=this._createFileInput(o,this.sampler,t),d=document.createElement("button");d.textContent="Record Mic",d.innerHTML='<i class="fa-duotone fa-solid fa-microphone-lines"></i> Record',d.title="Record audio from microphone",d.classList.add("sampler-record-button"),d.addEventListener("mousedown",(async()=>{p.style.display="flex",d.waveform&&d.waveform.remove(),this.waveform&&this.waveform.remove(),n.textContent="",o.style.background="none",g=Date.now(),v=setInterval((()=>{const t=(Date.now()-g)/1e3,e=String(Math.floor(t/60)).padStart(1,"0"),s=String(t%60).padStart(2,"0"),a=String(Math.floor(t%1*1e3)).padStart(3,"0");m.textContent=`${e}:${s}:${a}`}),10);const{stream:e,bufferPromise:a}=await this.sampler.recordMicrophone(t);this._recordingBufferPromise=a,this.waveform=new s({audioContext:this.audioContext,stream:e,parent:i,width:196,height:100})})),d.addEventListener("mouseup",(async()=>{p.style.display="none",clearInterval(v),m.textContent="0:00",this.sampler.stopMicrophoneRecording(),this.waveform&&this.waveform.stop();const t=await this._recordingBufferPromise;this.waveform.renderFinalBuffer(t)}));const c=document.createElement("select");c.classList.add("sampler-pad-playback-selector"),[{value:"one-shot",label:"One Shot"},{value:"hold",label:"Hold"},{value:"toggle",label:"Toggle"},{value:"loop",label:"Loop"}].forEach(((t,e)=>{let s=document.createElement("option");s.value=t.value,s.innerHTML=t.label,c.appendChild(s)})),c.addEventListener("change",(e=>{this.sampler.stopSample(t),this.sampler.setMode(t,e.target.value)})),r.appendChild(c);const p=document.createElement("div");p.classList.add("recording-overlay"),p.style.display="none",p.style.position="absolute",p.style.top="0",p.style.left="0",p.style.height="50%",p.style.flexDirection="column",p.style.alignItems="center",p.style.justifyContent="center",p.style.color="black",p.style.fontSize="14px",p.style.zIndex="9999";const u=document.createElement("div");u.style.width="80%",u.style.height="50px",u.style.background="green",p.appendChild(u);const m=document.createElement("span");m.textContent="0:00",p.appendChild(m);const f=document.createElement("button");f.textContent="",f.innerHTML='<i class="fa-duotone fa-solid fa-volume-high"></i> Record',f.title="Record audio from global bus",f.classList.add("sampler-record-button");let g=0,v=null;return f.addEventListener("mousedown",(()=>{let e=this.sampler.recordGlobalBus(this.globalBus,t);p.style.display="flex",o.style.background="none",this.waveform&&this.waveform.remove(),g=Date.now(),console.log("sending recording stream to waveform",e),console.log("sending audio context to waveform",this.audioContext),this.waveform=new s({audioContext:this.audioContext,stream:e,parent:i,width:196,height:100}),v=setInterval((()=>{const t=Math.floor((Date.now()-g)/1e3),e=String(Math.floor(t/60)).padStart(1,"0"),s=String(t%60).padStart(2,"0");m.textContent=`${e}:${s}`}),1e3)})),f.addEventListener("mouseup",(()=>{this.sampler.stopGlobalBusRecording(),this.waveform&&this.waveform.stop(),p.style.display="none",clearInterval(v),m.textContent="0:00",console.log("STOP RECORDING")})),a.appendChild(p),r.appendChild(d),r.appendChild(l),r.appendChild(h),a.appendChild(i),a.appendChild(o),a.appendChild(r),a},o.prototype._createFileInput=function(t,e,a){const i=document.createElement("input");i.type="file",i.accept="audio/*",i.style.display="none";const o=document.createElement("button");return o.classList.add("sampler-file-icon-button","sampler-record-button"),o.innerHTML='<i class="fa-duotone fa-regular fa-upload"></i>',o.title="Load Audio Sample",i.addEventListener("change",(async i=>{const o=i.target.files[0];if(o){await e.loadSample(o,a),t.textContent=o.name.split(".")[0];let i=this.pads[a].querySelector(".sampler-waveform-container");i.innerHTML="",new s({buffer:this.sampler.buffers[a],parent:i,width:196,height:100})}})),o.addEventListener("click",(()=>{i.click()})),{fileInput:i,iconButton:o}},o.prototype._createSlicedRecordButton=function(){const t=document.createElement("button");t.textContent="Global Sliced Record",t.innerHTML='<i class="fa-duotone fa-solid fa-cassette-tape"></i>',t.style.fontSize="2.5rem",t.title="Record audio from global output bus and slice into 8 pads",t.classList.add("sampler-record-button"),t.style.gridColumn="span 4";let e=null,a=null,i=[];return t.addEventListener("mousedown",(async()=>{i=[];const t=this.globalBus.audioContext.createMediaStreamDestination();this.globalBus.gainNode.connect(t),e=t.stream,this.waveform=new s({audioContext:this.globalBus.audioContext,stream:e,parent:this.waveformContainer,width:800,height:280}),this.waveformContainer.style.position="absolute",this.waveformContainer.style.top="0",this.waveformContainer.style.left="0",this.waveformContainer.style.zIndex="9999",a=new MediaRecorder(e),a.ondataavailable=t=>i.push(t.data),a.start(),console.log("Sliced recording started...")})),t.addEventListener("mouseup",(async()=>{this.waveform&&(this.waveform.stop(),console.log("Sliced recording stopped."),this.waveform.remove()),a&&"recording"===a.state&&(a.stop(),a.onstop=async()=>{console.log("Sliced recording stopped.");const t=new Blob(i,{type:"audio/webm"}),e=await t.arrayBuffer(),s=await this.audioContext.decodeAudioData(e);this._sliceAndLoadToPads(s)})})),t},o.prototype._createLiveSlicedRecordButton=function(){const t=document.createElement("button");t.title="Record audio from microphone and slice into 8 pads",t.classList.add("sampler-record-button"),t.style.gridColumn="span 4",t.innerHTML='<i class="fa-duotone fa-solid fa-microphone-lines"></i>',t.style.fontSize="2.5rem";let e=null,a=null,i=[],o=null;return t.addEventListener("mousedown",(async()=>{i=[];try{e=await navigator.mediaDevices.getUserMedia({audio:!0}),o=this.audioContext.createMediaStreamSource(e),this.waveform=new s({audioContext:this.audioContext,stream:e,parent:this.waveformContainer,width:800,height:280}),this.waveformContainer.style.position="absolute",this.waveformContainer.style.top="0",this.waveformContainer.style.left="0",a=new MediaRecorder(e),a.ondataavailable=t=>i.push(t.data),a.start(),console.log("Live sliced recording started...")}catch(t){console.error("Microphone access denied or failed:",t)}})),t.addEventListener("mouseup",(async()=>{a&&"recording"===a.state&&(a.stop(),a.onstop=async()=>{console.log("Live sliced recording stopped."),this.waveform&&(this.waveform.stop(),this.waveform.remove()),e.getTracks().forEach((t=>t.stop()));const t=new Blob(i,{type:"audio/webm"}),s=await t.arrayBuffer(),a=await this.audioContext.decodeAudioData(s);this._sliceAndLoadToPads(a)})})),t},o.prototype._sliceAndLoadToPads=async function(t){let e=[];console.log("Beat grid:",e);let a=[];if(e&&e.beatTimes&&e.beatTimes.length>0){const s=e.beatTimes;if(s.length<=8)a=s.slice(0,8);else{const t=Math.floor(s.length/8);for(let e=0;e<8;e++)a.push(s[e*t])}for(0!==a[0]&&a.unshift(0);a.length>8;)a.pop();for(;a.length<8;)a.push(t.duration);console.log("Adjusted slice points based on beats:",a)}else{const e=t.duration/8;for(let t=0;t<8;t++)a.push(t*e);a.push(t.duration)}for(let e=0;e<8;e++){const i=a[e],o=a[e+1]||t.duration,n=this.pads[e],r=n.querySelector(".sampler-waveform-container"),l=this._sliceAudioBuffer(t,i,o);this.sampler.buffers[e]=l;n.querySelector(".sampler-pad-button").innerText="",r.innerHTML="",r.innerHTML="",new s({audioContext:this.audioContext,buffer:l,parent:r,width:196,height:100}),console.log(`Loaded slice ${e+1} from ${i.toFixed(2)}s to ${o.toFixed(2)}s`)}},o.prototype._sliceAudioBuffer=function(t,e,s){const a=t.sampleRate,i=Math.floor(e*a),o=Math.floor(s*a),n=this.audioContext.createBuffer(t.numberOfChannels,o-i,a);for(let e=0;e<t.numberOfChannels;e++){const s=t.getChannelData(e),a=n.getChannelData(e);for(let t=0;t<a.length;t++)a[t]=s[i+t]}return n};class n{constructor(t,e={}){return this.bp=t,"boolean"!=typeof e.window&&(e.window=!0),this.options=e,this}async init(){return this.bp.log("Hello from Example"),await this.bp.load("/v5/apps/based/sampler/sampler.css"),"loaded Example"}async open(t={}){if(!this.samplerHolder){if(this.options.window&&this.bp.apps.ui&&this.bp.apps.ui.windowManager){let t=this.bp.apps.ui.windowManager.createWindow({id:"sampler-0",title:"Sampler",x:50,y:100,width:1e3,height:460,minWidth:600,minHeight:500,className:"sampler-window",parent:$("#desktop")[0],icon:"/desktop/assets/images/icons/icon_midifighter_64.png",resizable:!0,minimizable:!0,maximizable:!0,closable:!0,focusable:!0,maximized:!1,minimized:!1,onClose:()=>{this.samplerHolder=null}});this.samplerHolder=t.content}else this.samplerHolder=document.createElement("div"),this.samplerHolder.className="sampler-window",document.body.appendChild(samplerHolder);let t=new o(new AudioContext,{audioContext:new AudioContext},{fetch:window.fetch.bind(window),defaultSounds:["dj-horn.mp3","dang-son.mp3","helicopter-helicopter.mp3","yooo.mp3","celebrate.mp3","flawless-victory.wav"]});this.samplerHolder.appendChild(t.container),t.adjustVolume(.5),t.showPianoRoll.click()}}}export{n as default};
//# sourceMappingURL=sampler.js.map
