const e={};class t{constructor(t){this.resourceName=t,e[this.resourceName]={},this.memoryStore=e}create(t,r,s){Object.keys(s).forEach((t=>{if(s[t].required&&(void 0===r[t]||null===r[t]))throw new Error(`${t} is required`);if(s[t].unique){if(Object.values(e[this.resourceName]).some((e=>e[t]===r[t])))throw new Error(`${t} must be unique`)}if(s[t].type&&typeof r[t]!==s[t].type)throw new Error(`${t} must be of type ${s[t].type} value is ${r[t]}`)}));const o=Math.random().toString(36).substring(2,10),i={id:o,owner:t};return Object.keys(s).forEach((e=>{i[e]=r[e]||null})),e[this.resourceName][o]=i,i}get(t,r){const s=e[this.resourceName][r];return s&&s.owner===t?s:null}update(t,r,s,o){const i=e[this.resourceName][r];if(!i||i.owner!==t)throw new Error(`${this.resourceName} not found or unauthorized`);return Object.keys(o).forEach((e=>{if(o[e].required&&(void 0===s[e]||null===s[e]))throw new Error(`${e} is required`)})),Object.keys(o).forEach((e=>{void 0!==s[e]&&(i[e]=s[e])})),i}remove(t,r){const s=e[this.resourceName][r];if(!s||s.owner!==t)throw new Error(`${this.resourceName} not found or unauthorized`);return delete e[this.resourceName][r],{success:!0}}search(t,r){return Object.values(e[this.resourceName]).filter((e=>e.owner===t&&Object.keys(r).every((t=>e[t]===r[t]))))}list(t){return Object.values(e[this.resourceName]).filter((e=>e.owner===t))}all(){return Object.values(e[this.resourceName])}}class r{constructor(e,t={}){this.resourceName=e,this.apiEndpoint=t.apiEndpoint,t.bp&&(this.bp=t.bp)}async apiRequest(e,t,r=null,s=null){const o={method:e,headers:{"Content-Type":"application/json"}};r&&(o.body=JSON.stringify(r)),this.bp.qtokenid&&(o.headers.Authorization=`Bearer ${this.bp.qtokenid}`),o.headers["X-Me"]=this.bp.me;let i=`${this.apiEndpoint}/${t}`;if(s){i+=`?${new URLSearchParams(s).toString()}`}const n=await fetch(i,o);if(!n.ok){console.log("API request failed:",n);try{let e=await n.json();throw console.log("API request failed:",e),new Error(`${e.error}`)}catch(e){throw console.log("error",e),new Error(e)}throw new Error(`API request failed: ${json.error}`)}return n.json()}async create(e,t){return console.log("calling create",`${this.resourceName}`,t),this.apiRequest("POST",`${this.resourceName}`,t)}async get(e,t){return this.apiRequest("GET",`${this.resourceName}/${e}/${t}`)}async update(e,t){return console.log(`calling update ${this.resourceName}/${e}`,t),this.apiRequest("PUT",`${this.resourceName}/${e}`,t)}async remove(e){return this.apiRequest("DELETE",`${this.resourceName}/${e}`)}async list(){return console.log("calling list",`${this.resourceName}`),this.apiRequest("GET",`${this.resourceName}`)}async all(){return this.apiRequest("GET",this.resourceName)}async search(e,t,r={}){return this.apiRequest("POST",`${this.resourceName}/search`,t,r)}}class s{constructor(e){this.resourceName=e,this.dbName="BuddyPondResourceDB",this.version=1,this.db=null,this.init()}async init(){return new Promise(((e,t)=>{const r=indexedDB.open(this.dbName,this.version);r.onupgradeneeded=e=>{let t=e.target.result;t.objectStoreNames.contains(this.resourceName)||t.createObjectStore(this.resourceName,{keyPath:"id"})},r.onsuccess=t=>{this.db=t.target.result,e()},r.onerror=e=>{t(`IndexedDB Error: ${e.target.errorCode}`)}}))}async _withStore(e,t){return this.db||await this.init(),new Promise(((r,s)=>{const o=this.db.transaction(this.resourceName,e).objectStore(this.resourceName),i=t(o);i.onsuccess=()=>r(i.result),i.onerror=()=>s(i.error)}))}async create(e,t,r){const s={id:Math.random().toString(36).substring(2,10),owner:e};return Object.keys(r).forEach((e=>{s[e]=t[e]||null})),await this._withStore("readwrite",(e=>e.add(s))),s}async get(e,t){const r=await this._withStore("readonly",(e=>e.get(t)));return r&&r.owner===e?r:null}async update(e,t,r,s){const o=await this.get(e,t);if(!o)throw new Error(`${this.resourceName} not found or unauthorized`);return Object.keys(s).forEach((e=>{void 0!==r[e]&&(o[e]=r[e])})),await this._withStore("readwrite",(e=>e.put(o))),o}async remove(e,t){if(!await this.get(e,t))throw new Error(`${this.resourceName} not found or unauthorized`);return await this._withStore("readwrite",(e=>e.delete(t))),{success:!0}}async list(e){return new Promise(((t,r)=>{this._withStore("readonly",(s=>{const o=s.getAll();o.onsuccess=()=>{t(o.result.filter((t=>t.owner===e)))},o.onerror=()=>r(o.error)}))}))}async all(){return new Promise(((e,t)=>{this._withStore("readonly",(r=>{const s=r.getAll();s.onsuccess=()=>e(s.result),s.onerror=()=>t(s.error)}))}))}}const o={};class i{constructor(e,t){if(this.name=e,this.schema=t.schema||{},this.providerType=t.provider||"memory",0===Object.keys(this.schema).length)throw new Error(`Schema definition is required for resource: ${e}`);o[this.name]=this.schema,this.provider=this._createProvider(this.providerType,t),this.provider.bp=t.bp}_createProvider(e,o){switch(e){case"rest":return new r(this.name,o);case"indexeddb":return new s(this.name,o);default:return new t(this.name)}}create(e,t){return this.provider.create(e,t,this.schema)}get(e,t){return this.provider.get(e,t)}update(e,t,r){return this.provider.update(e,t,r,this.schema)}remove(e,t){return this.provider.remove(e,t)}list(e){return this.provider.list(e)}search(e,t,r){return this.provider.search(e,t,r)}all(){return this.provider.all()}async apiRequest(e,t,r=null){return this.provider.apiRequest(e,t,r)}}class n{constructor(e,t={}){return this.bp=e,this}async init(){this.html=await this.bp.load("/v5/apps/based/buddybux/buddybux.html"),this.css=await this.bp.load("/v5/apps/based/buddybux/buddybux.css");let e="indexeddb";e="memory",this.resource=new i("coin",{provider:e,apiEndpoint:this.bp.config.api,schema:{name:{type:"string"},symbol:{type:"string"},owner:{type:"string"},supply:{type:"number"}},bp:this.bp}),this.portfolioResource=new i("portfolio",{provider:e,apiEndpoint:this.bp.config.api,schema:{owner:{type:"string"},symbol:{type:"string"},amount:{type:"number"},ctime:{type:"number"},utime:{type:"number"}},bp:this.bp}),this.resource.create("Marak",{name:"BuddyBux",symbol:"BUX",owner:this.bp.me,supply:1/0})}async open(){this.buddybuxWindow||(this.buddybuxWindow=this.bp.apps.ui.windowManager.createWindow({id:"buddybux",title:"BuddyBux",icon:"desktop/assets/images/icons/icon_buddybux_64.png",x:250,y:75,width:400,height:500,minWidth:200,minHeight:200,parent:$("#desktop")[0],content:this.html,resizable:!0,minimizable:!0,maximizable:!0,closable:!0,focusable:!0,maximized:!1,minimized:!1,onClose:()=>{this.buddybuxWindow=null}}),this.render(),this.eventBind())}}n.prototype.eventBind=function(){const e=[{threshold:1e3,price:.009},{threshold:2e3,price:.0075},{threshold:5e3,price:.005}];function t(e){const t=Math.floor(1e3*Math.random()),r=String(t).padStart(3,"0").split("");$(".digit").each((function(e){$(this).addClass("spin"),setTimeout((()=>{$(this).removeClass("spin"),$(this).text(r[e])}),500*(e+1))}))}document.getElementById("buddybux-amount").addEventListener("input",(function(){let t=parseInt(this.value)||1;t=Math.min(Math.max(t,1),5e3),this.value=t,document.getElementById("total-price").innerText=`$${function(t){let r=.01*t;for(let s of e)t>=s.threshold&&(r=t*s.price);return r.toFixed(2)}(t)}`})),document.getElementById("stripe-checkout").addEventListener("click",(()=>{let e=document.getElementById("buddybux-amount").value;this.checkoutComplete(e)})),document.getElementById("crypto-checkout").addEventListener("click",(function(){alert("Connecting to MetaMask...")})),this.tabs=new this.bp.apps.ui.Tabs("#buddybux-tabs",this.buddybuxWindow.content),this.tabs.onTab((e=>{console.log(`Switched to tab: ${e}`)})),$("#buddybux-amount").on("input",(function(){const e=$(this).val();$("#total-price").text(`$${(.01*e).toFixed(2)}`)})),$("#send-buddybux").on("click",(function(){const e=$("#recipient").val(),t=$("#send-amount").val();if(e&&t>0){prompt(`Type the buddy name '${e}' to confirm:`)===e?alert(`Successfully sent ${t} BuddyBux to ${e}!`):alert("Confirmation failed. Please try again.")}else alert("Please fill out all fields correctly.")})),$("#check-balance").on("click",(async e=>{let r=await this.portfolioResource.get(this.bp.me);console.log(`Portfolio for ${this.bp.me}:`,r),t(e.target)})),t()},n.prototype.checkoutComplete=async function(e){alert("checkoutComplete "+e),this.portfolioResource.create(this.bp.me,"BUX",{symbol:"BUX",amount:e,owner:this.bp.me,ctime:Date.now(),utime:Date.now()})},n.prototype.balanceOf=async function(){return JSON.stringify({message:"Balance of!"})},n.prototype.render=async function(){await this.bp.load("portfolio");const e=await this.bp.apps.portfolio.resource.search(this.bp.me,{symbol:"BUX",owner:this.bp.me});console.log("buddyBuxResultsbuddyBuxResults",e.results);let t=e.results[0];console.group("BuddyBux",t);let r=t.amount.toLocaleString("en-US",{style:"currency",currency:"USD"});return $("#slot-machine").html(r),this.html};export{n as default};
//# sourceMappingURL=buddybux.js.map
