class e{constructor(e,t={}){this.bp=e}async init(){await this.bp.appendCSS("/v5/apps/based/file-explorer/FileTree/FileTree.css",!1,!0)}create(e,t){return this.options={onFileSelect:t.onFileSelect||(e=>console.log("File selected:",e)),onFolderToggle:t.onFolderToggle||((e,t)=>console.log("Folder toggled:",e,t)),indent:t.indent||20},this.container="string"==typeof e?document.querySelector(e):e,this.treeRoot=document.createElement("div"),this.treeRoot.className="bp-filetree-container",this.container.appendChild(this.treeRoot),this.handleClick=this.handleClick.bind(this),this.renderItem=this.renderItem.bind(this),this.treeRoot.addEventListener("click",this.handleClick),this}handleClick(e){const t=e.target.closest(".bp-filetree-item");if(!t)return;const i="folder"===t.dataset.type,r=t.dataset.path;if(i){const e=t.classList.toggle("bp-filetree-expanded");t.nextElementSibling.style.display=e?"block":"none",this.options.onFolderToggle(r,e)}else this.options.onFileSelect(r,t)}getFileIcon(e){const t={js:"📄",json:"📋",html:"🌐",css:"🎨",png:"🖼️",jpg:"🖼️",pdf:"📑",default:"📄"};return t[e.split(".").pop().toLowerCase()]||t.default}renderItem(e,t=0){const i=document.createElement("div");i.className="bp-filetree-item-container";const r=document.createElement("div");r.className="bp-filetree-item",r.dataset.path=e.path,r.dataset.type=e.type,r.style.paddingLeft=t*this.options.indent+"px";const o=document.createElement("span");o.className="bp-filetree-icon",o.textContent="folder"===e.type?"📁":this.getFileIcon(e.name);const s=document.createElement("span");if(s.className="bp-filetree-name",s.textContent=e.name,r.appendChild(o),r.appendChild(s),i.appendChild(r),"folder"===e.type&&Array.isArray(e.children)){const r=document.createElement("div");r.className="bp-filetree-children",r.style.display="none",e.children.forEach((e=>{r.appendChild(this.renderItem(e,t+1))})),i.appendChild(r)}return i}toggleFolder(e){const t=this.treeRoot.querySelector(`.bp-filetree-item[data-path="${e}"]`);if(!t)return;const i=t.classList.toggle("bp-filetree-expanded");t.nextElementSibling.style.display=i?"block":"none",this.options.onFolderToggle(e,i)}render(e){this.treeRoot.innerHTML="",this.files=e,e.forEach((e=>{this.treeRoot.appendChild(this.renderItem(e))}))}destroy(){this.treeRoot.removeEventListener("click",this.handleClick),this.container.removeChild(this.treeRoot)}buildFileTree(e){const t={children:[]};return e.forEach((e=>{if(!e)return;const i=e.split("/").filter((e=>e.length));let r=t;for(let e=0;e<i.length;e++){const t=i[e],o=e===i.length-1&&t.includes("."),s="/"+i.slice(0,e+1).join("/");let l=r.children.find((e=>e.name===t));l||(l={type:o?"file":"folder",name:t,path:s,children:[]},r.children.push(l)),o||(r=l)}})),t.children}findNodeByPath(e,t){const i=t.split("/").filter((e=>e.length));let r=e;for(let e of i){let t=r.find((t=>t.name===e));if(!t)return null;r=t}return r}mergeTrees(e,t){const i=e.children.map((e=>e.name));t.forEach((t=>{if(i.includes(t.name)){let i=e.children.find((e=>e.name===t.name));"folder"===i.type&&"folder"===t.type&&mergeTrees(i,t.children)}else e.children.push(t)}))}}class t{constructor({parent:e,fileExplorer:t,onUploadComplete:i=()=>{}},r){this.parent=e,this.fileExplorer=t,this.files=[],this.initializeElements(),this.bindEvents(),this.onUploadComplete=i,this.uploadFn=r,this.bp=t.bp}initializeElements(){this.overlay=this.parent.querySelector(".bp-file-explorer-upload-overlay"),this.filesList=this.parent.querySelector(".bp-file-explorer-upload-files-list"),this.totalSize=this.parent.querySelector(".bp-file-explorer-total-size"),this.uploadButton=this.parent.querySelector(".bp-file-explorer-upload-start"),this.cancelButton=this.parent.querySelector(".bp-file-explorer-upload-cancel"),this.progressContainer=this.parent.querySelector(".bp-file-explorer-upload-progress-container"),this.progressBar=this.parent.querySelector(".bp-file-explorer-upload-progress-bar"),this.progressPercentage=this.parent.querySelector(".bp-file-explorer-upload-progress-percentage"),this.currentFile=this.parent.querySelector(".bp-file-explorer-current-file"),this.fileCount=this.parent.querySelector(".bp-file-explorer-file-count")}bindEvents(){this.uploadButton.addEventListener("click",(()=>this.startUpload(this.onUploadComplete))),this.cancelButton.addEventListener("click",(()=>this.hide()))}show(e){this.files=Array.from(e),this.overlay.style.display="flex",this.renderFiles(),this.updateTotalSize(),"Guest"===this.bp.me&&$(".bp-file-explorer-upload-controls").html('<h2>Guest account may not upload files.</hr><br/>Please  <button class="open-app action-button" data-app="buddylist">log in</button> to BuddyPond.')}hide(){this.overlay.style.display="none",this.progressContainer.style.display="none",this.files=[],this.filesList.innerHTML=""}formatSize(e){if(0===e)return"0 B";const t=Math.floor(Math.log(e)/Math.log(1024));return`${(e/Math.pow(1024,t)).toFixed(2)} ${["B","KB","MB","GB"][t]}`}renderFiles(){this.filesList.innerHTML=this.files.map(((e,t)=>`\n        <div class="bp-file-explorer-upload-file-item" data-file-id="${t}">\n          <div class="bp-file-explorer-upload-column-name">${e.path}</div>\n          <div class="bp-file-explorer-upload-column-size">${this.formatSize(e.file.size)}</div>\n          <div class="bp-file-explorer-upload-column-status">Pending</div>\n        </div>\n      `)).join("")}updateTotalSize(){const e=this.files.reduce(((e,t)=>e+t.file.size),0);this.totalSize.textContent=this.formatSize(e),"number"==typeof this.fileExplorer.currentStorageRemaining&&e>this.fileExplorer.currentStorageRemaining&&($(".bp-file-explorer-storage-warning").show(),this.uploadButton.disabled=!0,this.uploadButton.classList.add("disabled"))}async startUpload(e=()=>{}){this.uploadButton.disabled=!0,this.progressContainer.style.display="block";let t=0,i=!0,r=[];for(const e of this.files){t++,this.currentFile.textContent=e.name,this.fileCount.textContent=`(File ${t} of ${this.files.length})`,$(`.bp-file-explorer-upload-file-item[data-file-id="${t-1}"] .bp-file-explorer-upload-column-status`).text("Uploading...");try{await this.uploadFn(e,(e=>{const t=100*e;this.updateProgress(t)})),$(`.bp-file-explorer-upload-file-item[data-file-id="${t-1}"] .bp-file-explorer-upload-column-status`).text("Completed"),this.uploadButton.disabled=!1}catch(e){i=!1,r.push(e),console.error("Upload failed:",e),$(".bp-file-explorer-upload-errors").append(`<div class="bp-file-explorer-upload-error">${e.message}</div>`).show(),$(`.bp-file-explorer-upload-file-item[data-file-id="${t-1}"] .bp-file-explorer-upload-column-status`).text("Failed").addClass("error")}}i?(setTimeout((()=>{$(".bp-file-explorer-upload-status").text("Upload completed"),this.hide(),e()}),2200),this.fileExplorer.refreshFileTree(),setTimeout((()=>{this.fileExplorer.getUsage()}),1e3)):console.error(`Failed to upload ${r.length} files`,r)}async uploadFile(e,t){try{await this.uploadFn(e,t)}catch(e){alert(e.message)}}updateProgress(e){const t=Math.min(100,Math.round(e));this.progressBar.style.width=`${t}%`,this.progressPercentage.textContent=`${t}%`}}let i=class{constructor(e,t={}){this.bp=e,t.fileTree||(t.fileTree={}),this.options=t,this.currentSelectedNode={id:""}}async init(){this.html=await this.bp.load("/v5/apps/based/file-explorer/file-explorer.html"),await this.bp.load("/v5/apps/based/file-explorer/file-explorer.css");let t=await this.bp.importModule("/v5/apps/based/file-explorer/lib/bytes.js",{},!1);this.bytes=t.default,this.fileTreeInstance=new e(this.bp,this.options.fileTree),await this.fileTreeInstance.init(),this.fileTree=this.fileTreeInstance;let i=await this.bp.importModule("/v5/apps/based/file-explorer/lib/mime.js",{},!1);return this.mime=i.default,this.onClick(),"loaded file explorer"}setPreviewAddressBar(e){$(".bp-file-explorer-address-input").val(e);let t=this.bp.config.host;this.bp.emit("browser::setAddressBar",t+"/"+this.bp.me+e)}};i.prototype.handleDrop=function(e){e.preventDefault(),e.stopPropagation(),console.log("file-explorer handling drop event",e);let t=e.dataTransfer.items,i=[".DS_Store",".git",".gitignore",".gitattributes",".gitmodules",".gitkeep",".npmignore",".npmrc",".yarnignore",".yarnrc",".editorconfig",".eslint"],r=[".git","node_modules"];const o=(e,t)=>i.includes(e)||r.some((e=>t.includes(`/${e}/`))),s=(e,t="")=>new Promise(((i,r)=>{if(console.log("processing item:",e,"currentNode",this.currentSelectedNode),this.currentSelectedNode&&console.log("Updated path to scope to the selected folder:",t),e.isFile)e.file((e=>{const r=t+e.name;o(e.name,r)?(console.log("Ignoring file:",r),i([])):(e.filePath=r,console.log(r),i({path:r,file:e}))}),r);else if(e.isDirectory){e.createReader().readEntries((o=>{Promise.all(o.map((i=>s(i,t+e.name+"/")))).then((e=>i(e.flat()))).catch(r)}),r)}})),l=[];for(let e=0;e<t.length;e++){const i=t[e].webkitGetAsEntry?t[e].webkitGetAsEntry():t[e].getAsEntry();i&&(o(i.name,i.fullPath)||("#"!==this.currentSelectedNode.parent?l.push(s(i,this.currentSelectedNode.id+"/")):l.push(s(i))))}Promise.all(l).then((e=>{console.log("All files:",e.flat()),this.uploadOverlay.show(e.flat())})).catch((e=>console.error("Error processing files:",e)))},i.prototype.handleUpload=async function(e,t={includeRootDirectory:!0,path:""}){e.preventDefault(),e.stopPropagation(),console.log("Handling file input event",e);const i=e.target.files;let r=[".DS_Store",".git",".gitignore",".gitattributes",".gitmodules",".gitkeep",".npmignore",".npmrc",".yarnignore",".yarnrc",".editorconfig",".eslint"],o=[".git","node_modules"];const s=(e,i="")=>new Promise((s=>{let l=i+e.webkitRelativePath||e.name;if(!t.includeRootDirectory){const e=l.split("/");e.length>1&&(e.shift(),l=i+e.join("/"))}var n,a;console.log("Processing file:",e.name,l),n=e.name,a=l,r.includes(n)||a.split("/").some((e=>o.includes(e)))?(console.log("Ignoring file:",l),s([])):("#"!==this.currentSelectedNode.parent?e.filePath=this.currentSelectedNode.id+"/"+l:e.filePath=l,console.log("assigning filePath:",e.filePath),s({path:e.filePath,file:e}))})),l=Array.from(i).map((e=>s(e,t.path)));await Promise.all(l).then((e=>{console.log("All processed files:",e.flat()),this.uploadOverlay.show(e.flat())})).catch((e=>console.error("Error processing files:",e)))},i.prototype.open=async function({context:e}){this.options.context=e,this.fileExplorer||(this.fileExplorer=this.fileExplorerInstance.create(),this.fileExplorer.getCloudFiles=this.getCloudFiles.bind(this),this.fileExplorer.refreshFileTree=this.refreshFileTree.bind(this),this.handleDrop=this.fileExplorer.handleDrop.bind(this.fileExplorer),this.handleUpload=this.fileExplorer.handleUpload.bind(this.fileExplorer)),this.fileExplorerWindow?this.options.context?this.fileExplorer.renderPathContents(this.options.context):this.fileExplorer.renderPathContents("/"):(this.fileExplorerWindow=this.bp.apps.ui.windowManager.createWindow({id:"file-explorer",title:"Buddy Files",app:"file-explorer",icon:"desktop/assets/images/icons/icon_file-explorer_64.png",x:100,y:30,width:1e3,height:600,minWidth:200,minHeight:200,parent:$("#desktop")[0],content:this.fileExplorer.container,resizable:!0,minimizable:!0,maximizable:!0,closable:!0,focusable:!0,maximized:!1,minimized:!1,onClose:async()=>{await this.remove(),this.fileExplorerWindow=null}}),this.fileExplorerWindow.container.classList.add("has-droparea"),this.fileExplorerWindow.container.style.userSelect="none",this.create())},i.prototype.create=function(e={}){e.onUploadComplete||(e.onUploadComplete=()=>{});let i=document.createElement("div");return i.innerHTML=this.html,i.classList.add("bp-file-explorer"),this.uploadOverlay=new t({parent:i,fileExplorer:this,onUploadComplete:this.onUploadComplete},(async(e,t)=>{await this.bp.apps.client.api.uploadFile(e.file,t)})),this.uploadOverlay.hide(),this.container=i,$(".bp-file-explorer-address-input",this.container).on("keyup",(e=>{let t=$(".bp-file-explorer-address-input").val();this.renderPathContents(t)})),this},i.prototype.onClick=function(){$(document).on("click",(e=>{let t=$(e.target);if(t.hasClass("bp-file-explorer-column")){let e=t.parent(),i=e.data("type");e.data("name"),e.data("size"),e.data("date");let r=e.data("path");if(this.setPreviewAddressBar("/"+r),"folder"===i){let e=$("#jtree").jstree(!0),t=e.get_node(r),i=t.children;i=i.map((t=>{let i=e.get_node(t);return{name:i.text,type:i.children.length>0?"folder":"file",path:i.id}})),this.setPreviewAddressBar("/"+t.id),this.renderFolderContents(i),$(".bp-file-explorer-file-viewer").hide(),$(".bp-file-explorer-files").show(),$(".bp-file-explorer-header").flexShow(),$(".bp-file-explorer-drag-upload").flexShow()}else this.showFile(this.bp.me,r),$(".bp-file-explorer-drag-upload").hide()}}))},i.prototype.renderFolderContents=function(e){$(".bp-file-explorer-header").flexShow();let t=$(".bp-file-explorer-files",this.container);t.html("");for(let i of e){let e=document.createElement("div");e.classList.add("bp-file-explorer-item"),e.dataset.type=i.type,e.dataset.name=i.name,e.dataset.size=i.size,e.dataset.date=i.date,e.dataset.path=i.path;let r=["name","size","type","date"];for(let t of r){let r=document.createElement("div");r.classList.add("bp-file-explorer-column");let o=i[t];"size"===t&&(o=this.bytes(i[t])),"date"===t&&(o=new Date(i[t]).toLocaleString(),"Invalid Date"===o&&(o=i[t])),r.textContent=o,e.appendChild(r)}t.append(e)}$(".bp-file-explorer-file-viewer-iframe",this.content).hide(),$(".bp-file-explorer-file-viewer-editor",this.content).hide(),$(".bp-file-explorer-files",this.content).show()},i.prototype.renderPathContents=function(e){let t=e.replace(this.bp.me+"/","");this.setPreviewAddressBar(t),e=e.replace("/","");let i=$("#jtree").jstree(!0);""===e&&(e=this.bp.me);let r=i.get_node(e);if(r){if($("#jtree").jstree("select_node",r.id),"file"===(r.children.length>0?"folder":"file"))return void this.showFile(this.bp.me,e);this.currentSelectedNode=r;let t=r.children;if(!this.cloudFiles)return void alert("cloudFiles not loaded cannot show contents");t=t.map((e=>{let t=i.get_node(e),r={},o=t.id.replace(this.bp.me+"/","");return o=t.id,this.cloudFiles.metadata[o]&&(r=this.cloudFiles.metadata[o]),{name:t.text,type:t.children.length>0?"folder":"file",path:t.id,size:r.size,date:r.lastModified}})),this.renderFolderContents(t)}},i.prototype.getUsage=async function(){let e=await this.bp.apps.client.api.getFileUsage();this.currentStorageUsage=e.usage,console.log("got back currentUsage",e);let t=(e.storageLimit||1e7)-e.usage;this.currentStorageRemaining=t,$(".storageUsed",this.content).text(this.bytes(e.usage)),$(".storageRemaining",this.content).text(this.bytes(t))},i.prototype.showFile=async function(e,t,i=!1){if(!t)return void console.error("no file specified");$(".bp-file-explorer-file-viewer").show(),$(".bp-file-explorer-files").hide(),$(".bp-file-explorer-header").flexHide(),t.startsWith("/");let r=t.split(".").pop();if(["js","json","html","css","txt","yml","md"].includes(r)&&(i=!0),!i){let e="/"+t;$(".bp-file-explorer-file-viewer-iframe",this.container).attr("src",e),$(".bp-file-explorer-file-viewer-iframe").show(),$(".bp-file-explorer-file-viewer-editor").hide()}if(i){let e="/"+t;e="https://files.buddypond.com"+e;let i=await fetch(e),o=await i.text(),s=this.mime.getType(e);this.editor?(s&&this.editor.changeEditorLanguage(s),this.editor.editor.setValue(o),this.editor.filePath=e):$(".bp-file-explorer-file-viewer-editor",this.container),$(".bp-file-explorer-file-viewer-iframe").hide(),$(".bp-file-explorer-file-viewer-editor").show(),$(".bp-file-explorer-drag-upload").hide(),"html"===r?$(".pad-editor-button-preview").click():$(".pad-editor-button-edit").click()}};class r{constructor(e,t,i="https://example.com"){return this.bp=e,this.container=t,this.currentUrl=i,this.iframe=null,this.history=[i],this.currentIndex=0,this.baseUrl="",this.init(),this}init(){let e=`\n            <div class="bp-browserwindow-container">\n                <div class="bp-browserwindow-toolbar">\n                    <div class="bp-browserwindow-navigation">\n                        <button class="bp-browserwindow-nav-btn back" disabled>←</button>\n                        <button class="bp-browserwindow-nav-btn forward" disabled>→</button>\n                        <button class="bp-browserwindow-nav-btn reload">↻</button>\n                    </div>\n                    <div class="bp-browserwindow-addressbar">\n                        <span class="ssl-indicator">🔒</span>\n                        <input type="text" class="bp-browserwindow-url" value="${this.currentUrl}">\n                    </div>\n                </div>\n                <div class="bp-browserwindow-content">\n                    <iframe src="about:blank" style="width:100%; height:100%; border:none;"></iframe>\n                </div>\n            </div>\n        `,t=document.createElement("div");t.className="bp-browserwindow",t.innerHTML=e,this.container.append(t),this.iframe=this.container.querySelector("iframe"),this.setupEventListeners(),this.navigate(this.currentUrl),this.bp.on("browser::setAddressBar","update-address-bar-value",(e=>{this.setAddressBar(e)}))}setBaseUrl(e){this.baseUrl=e}setContent(e,t=1){try{const t=this.iframe.contentDocument||this.iframe.contentWindow.document;t.open();const i=`<base href="${this.baseUrl}" target="_blank">`+e;t.write(i),t.close()}catch(i){console.log("Error setting content:",i),this.iframe.src="about:blank",t<9001?setTimeout((()=>{this.setContent(e,t+1)}),100):console.error("Failed to set content after 2 attempts")}}setupEventListeners(){const e=this.container.querySelector(".bp-browserwindow-url"),t=this.container.querySelector(".bp-browserwindow-nav-btn.back"),i=this.container.querySelector(".bp-browserwindow-nav-btn.forward"),r=this.container.querySelector(".bp-browserwindow-nav-btn.reload");e.addEventListener("keypress",(t=>{"Enter"===t.key&&this.navigate(e.value)})),t.addEventListener("click",(()=>this.goBack())),i.addEventListener("click",(()=>this.goForward())),r.addEventListener("click",(()=>this.reload()))}navigate(e){e.startsWith("http://")||e.startsWith("https://")||(e="https://"+e),this.currentIndex<this.history.length-1&&(this.history=this.history.slice(0,this.currentIndex+1)),this.history.push(e),this.currentIndex=this.history.length-1,this.currentUrl=e,this.updateAddressBar(),this.updateNavigationButtons()}goBack(){this.currentIndex>0&&(this.currentIndex--,this.currentUrl=this.history[this.currentIndex],this.updateAddressBar(),this.updateNavigationButtons())}goForward(){this.currentIndex<this.history.length-1&&(this.currentIndex++,this.currentUrl=this.history[this.currentIndex],this.updateAddressBar(),this.updateNavigationButtons())}reload(){this.iframe.src=this.currentUrl}setAddressBar(e){this.container.querySelector(".bp-browserwindow-url").value=e}updateAddressBar(){this.container.querySelector(".bp-browserwindow-url").value=this.currentUrl,this.iframe.src=this.currentUrl}updateNavigationButtons(){const e=this.container.querySelector(".bp-browserwindow-nav-btn.back"),t=this.container.querySelector(".bp-browserwindow-nav-btn.forward");e.disabled=this.currentIndex<=0,t.disabled=this.currentIndex>=this.history.length-1}getHistory(){return{history:this.history,currentIndex:this.currentIndex,currentUrl:this.currentUrl}}}class o{constructor(e,t={}){if(!e)throw new Error("PadEditor requires a parent element");t.files=t.files||[],this.bp=t.bp,this.options=t,this.files=t.files,this.parentElement=e,this.options=t,this.editor=null,this.currentContent="",this.previewMode=!1,this.container=document.createElement("div"),this.container.className="pad-editor",this.container.style.display="flex",this.container.style.flexDirection="column",this.parentElement.appendChild(this.container),this.controls=document.createElement("div"),this.controls.className="editor-controls",this.contentArea=document.createElement("div"),this.contentArea.className="editor-content",this.contentArea.style.display="flex",this.contentArea.style.flex="1",this.editorContainer=document.createElement("div"),this.editorContainer.className="editor-container",this.editorContainer.style.flex="1";let i=this.bp.config.host+"/"+this.bp.me;return this.container.appendChild(this.controls),this.container.appendChild(this.contentArea),this.previewFrame=new r(this.bp,this.container,i),this.previewFrame.setContent("loading..."),this.previewFrame.setBaseUrl(this.bp.config.cdn+"/"+this.bp.me+"/"),this.contentArea.appendChild(this.editorContainer),this.setupControls(),this}setupControls(){[{text:"Preview",action:()=>this.onPreview()},{text:"Edit",action:()=>this.onEdit()},{text:"Update",action:()=>this.onUpdate()},{text:"Delete",action:()=>this.onDelete()}].forEach((({text:e,action:t})=>{const i=document.createElement("button");i.className="desktopButton",i.classList.add("pad-editor-button-"+e.toLowerCase()),i.textContent=e,i.onclick=t,this.controls.appendChild(i)}))}async init(){return await this.loadMonaco(),await this.initializeEditor(),await this.initializeFileTree(this.files),await this.bp.load("browser"),this}async loadMonaco(){return window.require||await this.loadScript("https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.52.2/min/vs/loader.js"),new Promise((e=>{require.config({paths:{vs:"https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.52.2/min/vs"}}),require(["vs/editor/editor.main"],e)}))}loadScript(e){return new Promise(((t,i)=>{const r=document.createElement("script");r.src=e,r.onload=t,r.onerror=i,document.head.appendChild(r)}))}async initializeEditor(){this.editor=monaco.editor.create(this.editorContainer,{value:this.currentContent,language:"html",theme:"vs-dark",automaticLayout:!0,minimap:{enabled:!1}})}changeEditorLanguage(e){const t=this.editor.getModel();monaco.editor.setModelLanguage(t,e)}async initializeFileTree(e=[]){this.options.fileTree&&(this.fileTreeComponent=this.options.fileTree.create(this.fileTree,{onFileSelect:(e,t)=>{this.loadFile(e)},onFolderToggle:(e,t)=>{}}),this.fileTreeComponent.render(e))}loadFile(e){const t=this.options.getFileContent?.(e)||"";this.setContent(t)}getContent(){return this.editor?this.editor.getValue():this.currentContent}setContent(e){this.currentContent=e,this.editor&&this.editor.setValue(e)}togglePreview(e){this.previewMode=e,this.editorContainer.style.display=e?"none":"block"}updatePreview(e){e||(e=this.getContent()),this.previewFrame.setContent(e)}onEdit(){this.togglePreview(!1),this.options.onEdit&&this.options.onEdit(this.getContent())}onUpdate(){this.options.onUpdate&&this.options.onUpdate(this.filePath,this.getContent()),this.previewMode&&this.updatePreview()}onDelete(){this.options.onDelete&&this.options.onDelete(this.filePath)}onPreview(){this.togglePreview(!0),this.options.onPreview&&this.options.onPreview(this.getContent()),this.updatePreview()}onCancel(){this.togglePreview(!1),this.options.onCancel&&this.options.onCancel()}dispose(){this.editor&&this.editor.dispose(),this.container.remove()}}function s(e,t){const i={id:e,text:e,state:{opened:!0},children:[]};t.forEach((t=>{const r=t.split("/").filter((e=>e.length));if(0===r.length)return;let o=i;for(let t=0;t<r.length;t++){const i=r[t],s=t===r.length-1&&i.includes("."),l=e+"/"+r.slice(0,t+1).join("/");let n=o.children.find((e=>e.id===l));n||(n={id:l,text:i,icon:s?"jstree-file":"jstree-folder",children:[],state:{opened:!1,selected:!1}},o.children.push(n)),s||(o=n)}}));try{!function e(t,i=new Set){for(const r of t){if(i.has(r.id))throw console.error(`Duplicate node ID detected: ${r.id}`),new Error(`Duplicate node ID: ${r.id}`);i.add(r.id),r.children.length>0&&e(r.children,i)}}([i])}catch(e){return console.error("Tree validation failed:",e.message),[]}return[i]}class l{constructor(e,t={}){return this.bp=e,this.options=t,this.isPolling=!1,this}async init(){let e=await this.bp.importModule("/v5/apps/based/file-explorer/lib/mime.js",{},!1);return this.mime=e.default,await this.bp.appendScript("/v5/apps/based/file-explorer/vendor/jstree.min.js"),this.bp.log("Hello from File Explorer"),await this.bp.appendCSS("/v5/apps/based/file-explorer/vendor/style.min.css",!1,!0),this.fileExplorerInstance=new i(this.bp,{fileTree:{onFileSelect:(e,t)=>{$(".bp-file-explorer-drag-upload").hide()},onFolderToggle:async(e,t)=>{$(".bp-file-explorer-drag-upload").hide()},onFolderSelect:async(e,t)=>{$(".bp-file-explorer-drag-upload").hide()}}}),await this.fileExplorerInstance.init(),"loaded File Explorer"}async create(){this.fileExplorer||(this.fileExplorer=this.fileExplorerInstance.create({onUploadComplete:this.options.onUploadComplete}),this.fileExplorer.getCloudFiles=this.getCloudFiles.bind(this),this.fileExplorer.refreshFileTree=this.refreshFileTree.bind(this),this.handleDrop=this.fileExplorer.handleDrop.bind(this.fileExplorer),this.handleUpload=this.fileExplorer.handleUpload.bind(this.fileExplorer));let e={},t=document.createElement("div");t.className="pad-editor-holder",$(".bp-file-explorer-file-viewer-editor",this.fileExplorer.content).append(t),this.fileExplorer.getUsage();const i=new o(t,{bp:this.bp,files:[],getFileContent:t=>e[t],onEdit:e=>{$(".editor-content").flexShow(),$(".pad-editor-button-update").show(),$(".pad-editor-button-cancel").show()},onDelete:async e=>{let t=e.replace("https://files.buddypond.com/"+this.bp.me+"/","");try{await this.bp.apps.client.api.removeFile(t);let e=$("#jtree").jstree(!0),i=e.get_node(t);e.delete_node(i)}catch(e){console.error("Error deleting file:",e)}},onUpdate:async(e,t)=>{$(".bp-file-explorer-update-overlay").flexShow();let i=e.replace("https://files.buddypond.com/"+this.bp.me+"/",""),r=this.mime.getType(i);const o=new Blob([t],{type:r}),s=new File([o],i.split("/").pop(),{type:o.type,lastModified:new Date});s.filePath=i;try{await this.bp.apps.client.api.uploadFile(s)}catch(e){alert("Error uploading file: "+e.message)}this.fileExplorer.getUsage(),this.bp.emit("file-explorer::update",{path:i}),$(".bp-file-explorer-update-overlay").flexHide()},onPreview:e=>{},onCancel:()=>{$(".pad-editor-button-update").hide(),$(".pad-editor-button-cancel").hide(),$(".pad-editor-button-preview").click()}});this.editor=i,await i.init(),this.fileExplorer.editor=i,i.editorContainer.style.height="600px";let r=await this.getCloudFiles("",6);const l=s(this.bp.me,r.files);return this.fileExplorer.cloudFiles=r,$("#jtree").jstree({core:{data:l,multiple:!0,check_callback:!0},plugins:["contextmenu"],contextmenu:{items:function(e){var t=$("#jtree").jstree(!0);return{Delete:{separator_before:!1,separator_after:!0,label:"Delete",action:function(i){t.delete_node(e)}}}}}}).on("ready.jstree",((e,t)=>{this.options.context?"default"===this.options.context?this.fileExplorer.renderPathContents("/"):this.fileExplorer.renderPathContents(this.options.context):(this.bp.me,this.fileExplorer.renderPathContents("/"))})).on("select_node.jstree",((e,t)=>{var i=t.instance,r=t.node;console.log("select_node.jstree",t),r.children.length>0&&(e.preventDefault(),console.log("Selected node:",r.id),this.fileExplorer.currentSelectedNode=r,i.toggle_node(r)),$(".bp-file-explorer-drag-upload").hide()})),$(".bp-file-explorer-drag-upload").flexShow(),this.fileExplorer.setPreviewAddressBar("/"),$("#jtree").on("delete_node.jstree",((e,t)=>{let i=t.node.id;this.bp.apps.client.api.removeFile(i).then((()=>{this.fileExplorer.cloudFiles.files=this.fileExplorer.cloudFiles.files.filter((e=>e!==i))}))})),$("#jtree").on("changed.jstree",((e,t)=>{let i=t.instance.get_node(t.selected[0]);i?this.fileExplorer.renderPathContents("/"+i.id):console.log("node not found",t.selected[0])})),$(".upload-files").on("click",(async e=>{let t=document.createElement("input");t.type="file",t.multiple=!0,t.webkitdirectory=!1,t.directory=!1,t.click(),t.onchange=async e=>{e.target.files,await this.handleUpload(e)}})),$(".upload-directory").on("click",(async e=>{let t=document.createElement("input");t.type="file",t.multiple=!0,t.webkitdirectory=!0,t.directory=!0,t.click(),t.onchange=async e=>{e.target.files,await this.handleUpload(e)}})),$(".refresh-files").on("click",(async e=>{await this.refreshFileTree()})),this}async refreshFileTree(){if(this.isPolling)return void console.log("Already polling for changes, please wait...");this.isPolling=!0;let e=0;const t=async()=>{let i=await this.getCloudFiles("",6);if(this.areFilesSame(this.fileExplorer.cloudFiles.files,i.files))e<10&&(e++,setTimeout(t,1e3));else{const e=s(this.bp.me,i.files);this.fileExplorer.cloudFiles=i;let t=$("#jtree").jstree(!0);t.settings.core.data=e,t.refresh(),this.isPolling=!1,this.fileExplorer.getUsage()}e>=10&&(this.isPolling=!1)};t()}areFilesSame(e,t){const i=new Set(e.map((e=>e))),r=new Set(t.map((e=>e)));if(i.size!==r.size)return!1;for(let e of r)if(!i.has(e))return!1;return!0}async remove(){this.fileExplorer&&(this.handleDrop&&$(".bp-file-explorer-drag-upload").off("drop",this.handleDrop),$("#jtree").off("ready.jstree changed.jstree delete_node.jstree"),$("#jtree").jstree("destroy"),this.editor&&(this.editor.destroy?.(),this.editor=null),$(".bp-file-explorer-file-viewer-editor .pad-editor-holder").remove(),$(".bp-file-explorer-drag-upload").remove(),$(".bp-file-explorer-address-input").remove(),this.fileExplorer.destroy?.(),this.fileExplorer=null,this.handleDrop=null,this.handleUpload=null)}async open({context:e}={}){return this.options.context=e,this.onUploadComplete=this.options.onUploadComplete||(()=>{}),this.fileExplorer||(this.fileExplorer=this.fileExplorerInstance.create(),this.fileExplorer.onUploadComplete=this.onUploadComplete,this.fileExplorer.getCloudFiles=this.getCloudFiles.bind(this),this.fileExplorer.refreshFileTree=this.refreshFileTree.bind(this),this.handleDrop=this.fileExplorer.handleDrop.bind(this.fileExplorer),this.handleUpload=this.fileExplorer.handleUpload.bind(this.fileExplorer)),this.fileExplorerWindow?this.options.context?this.fileExplorer.renderPathContents(this.options.context):this.fileExplorer.renderPathContents("/"):(this.fileExplorerWindow=this.bp.apps.ui.windowManager.createWindow({id:"file-explorer",title:"Buddy Files",app:"file-explorer",icon:"desktop/assets/images/icons/icon_file-explorer_64.png",x:100,y:30,width:1e3,height:600,minWidth:200,minHeight:200,parent:$("#desktop")[0],content:this.fileExplorer.container,resizable:!0,minimizable:!0,maximizable:!0,closable:!0,focusable:!0,maximized:!1,minimized:!1,onClose:async()=>{await this.remove(),this.fileExplorerWindow=null}}),this.fileExplorerWindow.container.classList.add("has-droparea"),this.fileExplorerWindow.container.style.userSelect="none",this.create(),this.bp.on("auth::qtoken","reload-file-explorer",(async e=>{this.fileExplorerWindow&&(await this.remove(),this.fileExplorerWindow.close()),this.fileExplorerWindow=null,this.fileExplorer=null,this.open()}))),this.fileExplorerWindow.maximize(),"Guest"===this.bp.me&&($(".upload-message",".bp-file-explorer-drag-upload").html('Guest account files are read-only.<br/>Please  <button class="open-app action-button" data-app="buddylist">log in</button> to BuddyPond.'),$(".storage-used",".bp-file-explorer-drag-upload").remove()),this.fileExplorerWindow}async close(){this.fileExplorerWindow&&(await this.remove(),this.fileExplorerWindow.close(),this.fileExplorerWindow=null)}}l.prototype.getCloudFiles=async function(e,t){return await this.bp.apps.client.api.listFiles(e,t)},l.prototype.buildJsTreeData=s;export{l as default};
//# sourceMappingURL=file-explorer.js.map
