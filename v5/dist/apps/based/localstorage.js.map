{"version":3,"file":"localstorage.js","sources":["../../../apps/based/localstorage/localstorage.js"],"sourcesContent":["export default class LocalStorageManager {\n    constructor(bp, options = {}) {\n        this.bp = bp;\n        this.prefix = options.prefix || '_buddypond_desktop_';\n        this.settings = {};\n        this.state = {};\n    }\n\n    async init() {\n\n        // Legacy API v4 compatibility\n        /*\n        desktop.get = (key) => {\n            return this.get(key);\n        };\n\n        desktop.set = (key, value) => {\n            this.set(key, value);\n        }\n            */\n\n        desktop.removeItem = (key) => {\n            this.removeItem(key);\n        }\n\n        // Emit event for the final key change\n        bp.on('settings', 'update-local-storage-settings', (key, value) => {\n            this.set(key, value);\n        })\n\n        // TODO: remove this for v5, define bp.set and bp.get with bp.data on bp itself\n        //this.bp.get = this.get.bind(this);\n        //this.bp.set = this.set.bind(this);\n        this.bp.settings = this.settings;\n        this.sync();\n    }\n\n    set(key, value) {\n        if (typeof key === 'object') {\n            // Handle object-based batch updates\n            Object.entries(key).forEach(([k, val]) => {\n                this.updateLocalStorage(k, val);\n            });\n        } else {\n            // Handle single key-value update\n            this.updateLocalStorage(key, value);\n        }\n        this.bp.emit('desktop.settings', this.settings);\n    }\n\n    get(key) {\n        try {\n            const item = localStorage.getItem(this.prefix + key);\n            return JSON.parse(item);\n        } catch (err) {\n            alert('Error parsing local storage JSON.');\n            return null;\n        }\n    }\n\n    removeItem(key) {\n        localStorage.removeItem(this.prefix + key);\n        delete this.settings[key];\n        this.bp.emit(`desktop.settings.${key}`, undefined);\n    }\n\n    sync() {\n        Object.keys(localStorage).forEach((key) => {\n            if (key.startsWith(this.prefix)) {\n                const param = key.slice(this.prefix.length);\n                try {\n                    this.settings[param] = JSON.parse(localStorage.getItem(key));\n                } catch (err) {\n                    this.settings[param] = localStorage.getItem(key);\n                }\n            }\n        });\n    }\n\n    updateLocalStorage(key, val) {\n        const previousValue = this.settings[key];\n        this.settings[key] = val;\n        localStorage.setItem(this.prefix + key, JSON.stringify(val));\n        this.state[key] = val;\n\n        // Emit an event if the property has changed\n        if (previousValue !== val) {\n            this.bp.emit(`desktop.settings.${key}`, val);\n        }\n    }\n\n    load(callback) {\n        this.sync();\n        if (typeof callback === 'function') {\n            callback();\n        }\n    }\n}\n"],"names":["LocalStorageManager","constructor","bp","options","this","prefix","settings","state","init","desktop","removeItem","key","on","value","set","sync","Object","entries","forEach","k","val","updateLocalStorage","emit","get","item","localStorage","getItem","JSON","parse","err","alert","undefined","keys","startsWith","param","slice","length","previousValue","setItem","stringify","load","callback"],"mappings":"AAAe,MAAMA,EACjB,WAAAC,CAAYC,EAAIC,EAAU,IACtBC,KAAKF,GAAKA,EACVE,KAAKC,OAASF,EAAQE,QAAU,sBAChCD,KAAKE,SAAW,CAAE,EAClBF,KAAKG,MAAQ,CAAE,CACvB,CAEI,UAAMC,GAaFC,QAAQC,WAAcC,IAClBP,KAAKM,WAAWC,IAIpBT,GAAGU,GAAG,WAAY,iCAAiC,CAACD,EAAKE,KACrDT,KAAKU,IAAIH,EAAKE,MAMlBT,KAAKF,GAAGI,SAAWF,KAAKE,SACxBF,KAAKW,MACb,CAEI,GAAAD,CAAIH,EAAKE,GACc,iBAARF,EAEPK,OAAOC,QAAQN,GAAKO,SAAQ,EAAEC,EAAGC,MAC7BhB,KAAKiB,mBAAmBF,EAAGC,MAI/BhB,KAAKiB,mBAAmBV,EAAKE,GAEjCT,KAAKF,GAAGoB,KAAK,mBAAoBlB,KAAKE,SAC9C,CAEI,GAAAiB,CAAIZ,GACA,IACI,MAAMa,EAAOC,aAAaC,QAAQtB,KAAKC,OAASM,GAChD,OAAOgB,KAAKC,MAAMJ,EACrB,CAAC,MAAOK,GAEL,OADAC,MAAM,qCACC,IACnB,CACA,CAEI,UAAApB,CAAWC,GACPc,aAAaf,WAAWN,KAAKC,OAASM,UAC/BP,KAAKE,SAASK,GACrBP,KAAKF,GAAGoB,KAAK,oBAAoBX,SAAOoB,EAChD,CAEI,IAAAhB,GACIC,OAAOgB,KAAKP,cAAcP,SAASP,IAC/B,GAAIA,EAAIsB,WAAW7B,KAAKC,QAAS,CAC7B,MAAM6B,EAAQvB,EAAIwB,MAAM/B,KAAKC,OAAO+B,QACpC,IACIhC,KAAKE,SAAS4B,GAASP,KAAKC,MAAMH,aAAaC,QAAQf,GAC1D,CAAC,MAAOkB,GACLzB,KAAKE,SAAS4B,GAAST,aAAaC,QAAQf,EAChE,CACA,IAEA,CAEI,kBAAAU,CAAmBV,EAAKS,GACpB,MAAMiB,EAAgBjC,KAAKE,SAASK,GACpCP,KAAKE,SAASK,GAAOS,EACrBK,aAAaa,QAAQlC,KAAKC,OAASM,EAAKgB,KAAKY,UAAUnB,IACvDhB,KAAKG,MAAMI,GAAOS,EAGdiB,IAAkBjB,GAClBhB,KAAKF,GAAGoB,KAAK,oBAAoBX,IAAOS,EAEpD,CAEI,IAAAoB,CAAKC,GACDrC,KAAKW,OACmB,mBAAb0B,GACPA,GAEZ"}