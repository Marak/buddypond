{"version":3,"file":"camera.js","sources":["../../../apps/based/camera/camera.js","../../../apps/based/camera/lib/enumerateDevices.js","../../../apps/based/camera/lib/startCamera.js","../../../apps/based/camera/lib/bindUIEvents.js","../../../apps/based/camera/lib/resizeFullVideo.js","../../../apps/based/camera/lib/snaps/takeSingleSnap.js","../../../apps/based/camera/lib/snaps/recordSnaps.js","../../../apps/based/camera/lib/snaps/createGif.js","../../../apps/based/camera/lib/snaps/takeSnap.js"],"sourcesContent":["import enumerateDevices from './lib/enumerateDevices.js';\nimport startCamera from './lib/startCamera.js';\nimport bindUIEvents from './lib/bindUIEvents.js';\nimport resizeFullVideo from './lib/resizeFullVideo.js';\n\n// snaps\nimport takeSnap from './lib/snaps/takeSnap.js';\nimport takeSingleSnap from './lib/snaps/takeSingleSnap.js';\nimport recordSnaps from './lib/snaps/recordSnaps.js';\nimport createGif from './lib/snaps/createGif.js';\n\nexport default class Camera {\n    constructor(bp, options = {}) {\n        this.bp = bp;\n        this.allDevices = {};\n        this.devices = {\n            videoinput: {},\n            audioinput: {},\n            audiooutput: {}\n        };\n\n        // \"local\" mode indicates the mirror will save photos locally to file-system\n        // This could also be \"snap\" which indicates photos will be sent out as Snaps ( multimedia chat messages )\n        this.mode = 'local';\n\n        this.fullMirror = false;\n        this.showingControls = true;\n\n        // Three view modes available for Mirror: Normal, Half, Full\n        this.viewMode = 'Normal';\n        this.selectedCameraIndex = 0;\n\n        // starts photo record\n        this.MAX_FRAMES_PER_SNAP = 10;\n        this.DEFAULT_SNAP_TIMER = 777;\n        this.CAMERA_SHUTTER_DELAY = 55;\n        this.currentFrame = 0;\n\n        // temporary storage for snaps before being sent out\n        this.snaps = [];\n\n        return this;\n    }\n\n    async init() {\n        this.bp.log('Hello from Example');\n\n        // we can load modules or html fragments or css files here\n        // using this.bp.load() method\n\n        // injects CSS link tag into the head of document\n        await this.bp.load('/v5/apps/based/camera/camera.css');\n        await this.bp.appendScript('/v5/apps/based/camera/vendor/jsman.js');\n        await this.bp.appendScript('/v5/apps/based/camera/lib/CanvasVideo.js');\n        await this.bp.appendScript('/desktop/assets/js/gif.js');\n\n        // fetches html from the fragment and returns it as a string\n        let html = await this.bp.load('/v5/apps/based/camera/camera.html');\n        // await imports the module and returns it\n        // let module = await this.bp.load('/v5/apps/based/_example/_example.js');\n\n        this.html = html;\n\n        return 'loaded Camera';\n    }\n\n    async open(options = {}) {\n\n        if (!this.cameraWindow) {\n            this.cameraWindow = this.bp.apps.ui.windowManager.createWindow({\n                id: 'camera',\n                title: 'Camera',\n                x: 50,\n                y: 100,\n                width: 640,\n                height: 550,\n                minWidth: 200,\n                minHeight: 200,\n                parent: $('#desktop')[0],\n                icon: '/desktop/assets/images/icons/icon_camera_64.png',\n                content: this.html,\n                resizable: true,\n                minimizable: true,\n                maximizable: true,\n                closable: true,\n                focusable: true,\n                maximized: false,\n                minimized: false,\n                onClose: () => {\n\n                    delete this.cameraWindow;\n                    // alert('closing camera');\n\n                    if (this.makingSnap) {\n                        this.cancelSnap();\n                    }\n\n                    // when closing the window for the Mirror App\n                    // stop all tracks associated with open stream\n                    if (this.localStream && this.localStream.getTracks) {\n                        this.localStream.getTracks().forEach(function (track) {\n                            track.stop();\n                        });\n                    }\n\n\n                }\n            });\n\n            $('#mirrorCanvasMe', this.cameraWindow.content).css('width', '100%');\n            $('#mirrorCanvasMe', this.cameraWindow.content).css('height', '100%');\n            //$('#mirrorCanvasMe', this.cameraWindow.content).css('object-fit', 'cover');\n\n            $('#snapDelaySlider', this.cameraWindow.content).show();\n            this.bindUIEvents();\n\n        }\n\n        this.snapContext = options.context;\n        this.snapType = options.type;\n\n        if (options.context) {\n            this.mode = 'snap';\n        } else {\n            this.mode = 'local';\n        }\n\n        if (this.mode === 'local') {\n            $('.approveSnap').attr('title', 'Save to Local');\n        } else {\n            $('.approveSnap').attr('title', 'Approve and Send');\n        }\n\n        /*\n        $('.snapControl').hide();\n        $('.confirmSnap').hide();\n        $('#snapDelaySlider').slider('value', 777);\n        $('#snapDelaySlider').data('delay', 777);\n        */\n\n\n\n\n        await this.enumerateDevices();\n\n        let firstCamera = this.devices.videoinput[Object.keys(this.devices.videoinput)[0]].label;\n        //let defaultCamera = desktop.settings.mirror_selected_camera_device_label;\n\n\n        await this.startCamera(firstCamera);\n\n        // Focus on the newly created or updated window\n        this.bp.apps.ui.windowManager.focusWindow(this.cameraWindow);\n\n    }\n}\n\n\n\nCamera.prototype.enumerateDevices = enumerateDevices;\nCamera.prototype.startCamera = startCamera;\nCamera.prototype.bindUIEvents = bindUIEvents;\nCamera.prototype.resizeFullVideo = resizeFullVideo;\n\n// snaps\nCamera.prototype.takeSingleSnap = takeSingleSnap;\nCamera.prototype.recordSnaps = recordSnaps;\nCamera.prototype.createGif = createGif;\nCamera.prototype.takeSnap = takeSnap;","export default async function enumerateDevices() {\n    try {\n      const devices = await navigator.mediaDevices.enumerateDevices();\n      $('.selectMirrorCamera').html('');\n      let cameraCount = 0;\n      devices.forEach((device, i) => {\n        device.index = i;\n        if (!this.allDevices) {\n          this.allDevices = {};\n        }\n        if (!this.devices) {\n          this.devices = {};\n        }\n        this.allDevices[device.label] = device;\n        this.devices[device.kind] = this.devices[device.kind] || {};\n        this.devices[device.kind][device.label] = device;\n        // console.log(\"device\", device);\n        if (device.kind === 'videoinput') {\n          cameraCount++;\n          let selected = '';\n          if (this.selectedCameraIndex === cameraCount) {\n            selected = 'selected=\"selected\"';\n            device.label = 'ACTIVE';\n          }\n          $('.selectMirrorCamera', this.cameraWindow.content).append(`<option ${selected}>${device.label}</option>`);\n        }\n        if (device.kind === 'audioinput') {\n          // Update audio devices as needed\n          // $('.selectAudio').append(`<option>${device.label}</option>`);\n        }\n      });\n  \n      return devices;\n    } catch (err) {\n      console.error('Error enumerating devices:', err);\n      throw err; // Re-throw the error to be handled by the caller\n    }\n  };\n  ","export default function startCamera(deviceLabel) {\n    // opens local camera device and streams it to <video> tag\n    // takes in optional device label\n    // if no label is provided, will default to first camera found in array\n    // console.log('starting with device label: ', deviceLabel)\n    let that = this;\n        let deviceId = this.devices.videoinput[deviceLabel].deviceId;\n        navigator.mediaDevices.getUserMedia({\n            video: {\n                'deviceId': deviceId\n            },\n            audio: false\n        }).then(function (stream) {\n            stream.getTracks().forEach(function (track) {\n                $('.selectMirrorCamera').val(track.label);\n            });\n            let video = document.querySelector('#mirrorVideoMe');\n\n            video.onplay = function () {\n                if (this.snapContext) {\n                    $('.recordSnap').show();\n                } else {\n                    // desktop.app.mirror.showFullMirror();\n                }\n            };\n\n            video.srcObject = stream;\n            that.localStream = stream;\n            //video.style.display = 'block';\n            $('#mirrorPlaceHolder', that.cameraWindow.content).fadeOut();\n            // show the \n        }).catch((err) => {\n            console.log('error in calling navigator.mediaDevices.getUserMedia', err);\n        });\n \n\n}","export default function bindUIEvents() {\n    let that = this;\n    $(that.cameraWindow.container).resize(function () {\n        console.log('resize');\n        if (that.viewMode === 'Full') {\n            that.resizeFullVideo();\n        }\n    });\n\n    $('#snapDelaySlider').slider({\n        value: 777,\n        min: 1,\n        max: 2222,\n        change: function (event, ui) {\n \n           let inversedValue = 2222 - ui.value;      \n            that.snapDelay = inversedValue;\n            $('#snapsPreview').data('delay', inversedValue);\n            let delay = inversedValue;\n            that.createGif(inversedValue);\n        }\n    });\n\n    function toggleMirrorControls() {\n        if (that.showingControls) {\n            that.showingControls = false;\n            hideMirrorControls();\n        } else {\n            that.showingControls = true;\n            showMirrorControls();\n        }\n    }\n\n    function hideMirrorControls() {\n        $('.mirrorControl').hide();\n        $('.cameraControls').hide();\n        $('.snapControl').hide();\n        $('.snapControls').hide();\n    }\n\n    function showMirrorControls() {\n        if (that.makingSnap) {\n            $('.cameraControls').show();\n            $('.snapControl').show();\n            $('.snapControls').show();\n            if (Object.keys(that.snaps).length > 1) {\n                $('.snapDelaySliderControl').show();\n            }\n        } else {\n            $('.mirrorControl').show();\n            $('.cameraControls').show();\n            $('.snapControl').hide();\n            $('.snapControls').hide();\n        }\n    }\n\n    function toggleMirrorSize() {\n        // 3 view modes we can toggle, Normal, Half, Full\n        if (that.viewMode === 'Normal') {\n            $('#mirrorCanvasMe').css('width', 320);\n            $('#mirrorCanvasMe').css('height', 240);\n            $('#snapsPreview').css('width', 320);\n            $('#snapsPreview').css('height', 240);\n            $('#mirrorCanvasMe').css('padding-top', 32);\n            $('#snapsPreview').css('padding-top', 32);\n            $('#mirrorCanvasMe').css('position', 'relative');\n            that.viewMode = 'Half';\n            $('.showFullMirror').html(that.viewMode + ' View');\n            return;\n        }\n        if (that.viewMode === 'Half') {\n            $('#mirrorCanvasMe').css('padding-top', 0);\n            $('#snapsPreview').css('padding-top', 0);\n            that.resizeFullVideo();\n            that.viewMode = 'Full';\n            $('.showFullMirror').html(that.viewMode + ' View');\n            return;\n        }\n        if (that.viewMode === 'Full') {\n            $('#mirrorCanvasMe').css('width', '100%');\n            $('#mirrorCanvasMe').css('height', '100%');\n            $('#snapsPreview').css('width', 640);\n            $('#snapsPreview').css('height', 480);\n            $('#mirrorCanvasMe').css('padding-top', 0);\n            $('#snapsPreview').css('padding-top', 0);\n            $('#mirrorCanvasMe').css('position', 'relative');\n            that.viewMode = 'Normal';\n            $('.showFullMirror').html(that.viewMode + ' View');\n            return;\n        }\n    }\n\n    $('.showMirrorControls').on('click', function () {\n        toggleMirrorControls();\n    });\n\n    $('.showFullMirror').on('click', function () {\n        toggleMirrorSize();\n    });\n\n    if (that.showingControls) {\n        showMirrorControls();\n    }\n\n\n    $('.selectMirrorCamera').on('change', () => {\n        let newDeviceLabel = $(this).val();\n        this.bp.set('mirror_selected_camera_device_label', newDeviceLabel);\n        // TODO: use localstorage to set device preference\n        that.startCamera(newDeviceLabel);\n    });\n\n    // adds all JSManipulate effects as keys to the drop down\n    Object.keys(JSManipulate).forEach((filter) => {\n        // console.log(\"filter\", filter);\n        $('.selectMirrorFilter', this.cameraWindow.content).append(`<option value=\"${filter}\">${filter}</option>`);\n    });\n\n    $('.selectMirrorFilter', this.cameraWindow.content).on('change', (ev) => {\n        this.canvasVideo.filter = ev.currentTarget.value.toLowerCase();\n    });\n\n    this.canvasVideo = new window.CanvasVideo('#mirrorVideoMe', '#mirrorCanvasMe');\n    this.canvasVideo.bindPlayEvent();\n    // starts snaps photo record\n    that.snaps = [];\n    that.snapsGIF = [];\n\n    $('.takeSingleSnap').on('click', function () {\n        that.makingSnap = true;\n        that.takeSingleSnap();\n    });\n\n    $('.takeSnap').on('click', function () {\n        that.makingSnap = true;\n        that.takeSnap();\n    });\n\n    $('.approveSnap').on('click', function () {\n        let msg = 'I sent a Snap!';\n        $('.mirrorVideoHolder').show();\n        $('#snapsPreview').hide();\n        $('.recordSnap').show();\n        $('.confirmSnap').hide();\n        $('.takeSingleSnap').css('left', '122');\n        $('.cameraControls').show();\n\n        if (that.mode === 'local') {\n            let src = $('#snapsPreview').attr('src');\n            // TODO: create utility function for downloading files\n            let url = src.replace(/^data:image\\/[^;]+/, 'data:application/octet-stream');\n            window.open(url);\n            return;\n        }\n\n        // close mirror ( fow now )\n        // JQDX.closeWindow(that.cameraWindow.content);\n        let snapsGIF = $('#snapsPreview').attr('src');\n        that.cameraWindow.close();\n\n        buddypond.sendSnaps(that.snapType, that.snapContext, msg, snapsGIF, that.snapDelay, 'camera', function (err, uploadedUrl) {\n            that.snaps = [];\n            that.currentFrame = 0;\n            $('.gifFrames').html('');\n            //$('#snapsPreview').attr('src', 'desktop/assets/images/gui/rainbow-tv-loading.gif');\n            $('#snapsPreview').data('stopped', true);\n            $('#snapDelaySlider').slider('value', 777);\n            $('#snapDelaySlider').data('delay', 777);\n            that.makingSnap = false;\n\n\n            // at this point with the new v5 API its expected that the client send a new messages\n            // broadcasting the file upload to the CDN\n\n            // now that we have the url, just send a regular message with the url\n            // the card type should automatically be detected by the server\n            // the the body of the message will be the url with extension of image, video, etc\n\n\n            // context is buddyname or pondname\n            // output is buddy or pond\n\n            let message = {\n                to: that.snapContext,\n                from: bp.me,\n                type: that.snapType,\n                text: uploadedUrl\n            };\n            console.log(\"sending multimedia message\", message);\n            bp.emit('buddy::sendMessage', message);\n\n\n        });\n    });\n\n    that.cancelSnap = function cancelSnap() {\n        // TODO: show frame limit / timer\n        that.snaps = [];\n        that.currentFrame = 0;\n        $('.cameraControls').show();\n        $('.gifFrames').html('');\n        //$('#snapsPreview').attr('src', 'desktop/assets/images/gui/rainbow-tv-loading.gif');\n        $('#snapsPreview').data('stopped', true);\n        $('.mirrorVideoHolder').show();\n        $('#snapsPreview').hide();\n        $('.takeSingleSnap').css('left', '122');\n        $('.recordSnap').show();\n        $('.confirmSnap').hide();\n        $('.snapDelaySliderControl').hide();\n        $('#snapDelaySlider').slider('value', 777);\n        $('#snapDelaySlider').data('delay', 777);\n        that.makingSnap = false;\n    };\n\n    $('.cancelSnap').on('click', function () {\n        that.cancelSnap();\n    });\n\n    $('.continueSnap').on('click', function () {\n        $('.cameraControls').show();\n        $('.mirrorVideoHolder').show();\n        $('#snapsPreview').hide();\n        $('.snapDelaySliderControl').hide();\n        $('.recordSnap').show();\n        $('.confirmSnap').hide();\n        $('.takeSnap').hide();\n        $('.takeSingleSnap').css('left', 244);\n        $('.takeSingleSnap').show();\n        //$('#snapsPreview').data('stopped', true);\n        //that.takeSingleSnap();\n    });\n\n    if (bp.settings.mirror_snaps_camera_countdown_enabled) {\n        $('.cameraCountdownEnabled').prop('checked', 'checked');\n    }\n\n    $('.cameraCountdownEnabled').on('change', () => {\n        alert('change')\n        if ($(this).prop('checked')) {\n            this.bp.set('mirror_snaps_camera_countdown_enabled', true);\n        } else {\n            this.bp.set('mirror_snaps_camera_countdown_enabled', false);\n        }\n    });\n\n\n\n\n}","export default function resizeFullVideo() {\n    $('#snapsPreview').css('width', $('#window_mirror').css('width'));\n    $('#snapsPreview').css('height', $('#window_mirror').css('height'));\n  \n    //$('#mirrorCanvasMe').css('width', $('#window_mirror').css('width'));\n    //$('#mirrorCanvasMe').css('height', $('#window_mirror').css('height'));\n  \n    $('#mirrorCanvasMe').css('position', 'absolute');\n    $('#mirrorCanvasMe').css('top', 0);\n    $('#mirrorCanvasMe').css('left', 0);\n  };","export default function takeSingleSnap () {\n    let that = this;\n    let bp = this.bp;\n    //$('#mirrorCanvasMe').css('width', 640);\n    //$('#mirrorCanvasMe').css('height', 480);\n    $('.recordSnap').hide();\n  \n    if (!this.bp.settings.mirror_snaps_camera_countdown_enabled) {\n      if (that.currentFrame === 0) {\n        this.bp.play('desktop/assets/audio/CAMERA_SNAP.wav');\n        setTimeout(function () {\n          that.recordSnaps(1);\n        }, 44);\n        return;\n      }\n    }\n\n    bp.play('desktop/assets/audio/CAMERA_COUNTDOWN.wav');\n    $('.snapCountDown').show();\n    setTimeout(function () {\n      $('.snapCountDown').html('2...');\n      setTimeout(function () {\n        $('.snapCountDown').html('1...');\n        setTimeout(function () {\n          $('.snapCountDown').hide();\n          $('.snapCountDown').html('3...');\n          setTimeout(function () {\n            if (that.currentFrame === 0) {\n                bp.play('desktop/assets/audio/CAMERA_SNAP.wav');\n                setTimeout(function () {\n                    that.recordSnaps(1);\n                }, 44);\n            }\n          }, 333);\n        }, 1000);\n      }, 1000);\n    }, 1000);\n  };","export default function recordSnaps(maxFrames, delay, mode) {\n  let that = this;\n  $('.cameraControls').hide();\n  delay = delay || $('#snapsPreview').data('delay') || that.DEFAULT_SNAP_TIMER;\n  $('#snapsPreview').data('delay', delay);\n  that.snapDelay = delay;\n  mode = mode || 'photo';\n  $('.recordSnap').hide();\n  $('.mirrorVideoHolder').css('opacity', '1');\n  // runs until max frames or hits stop\n  let destinationCanvas = document.getElementById('snaps');\n  let destCtx = destinationCanvas.getContext('2d');\n\n  if (maxFrames > 1) {\n    bp.play('desktop/assets/audio/CAMERA_SHUTTER.wav', {\n      tryHard: true\n    });\n  }\n\n  destinationCanvas.width = 320;\n  destinationCanvas.height = 240;\n  destCtx.scale(0.5, 0.5);\n\n  destCtx.drawImage(document.getElementById('mirrorCanvasMe'), 0, 0);\n\n  let imagebase64data = destinationCanvas.toDataURL('image/png');\n  let gifbase64data = destinationCanvas.toDataURL('image/gif');\n\n  $('.gifFrames', this.cameraWindow.content).append(`<img src=\"${gifbase64data}\"/>`);\n  imagebase64data = imagebase64data.replace('data:image/png;base64,', '');\n  that.snaps.push(imagebase64data);\n\n  that.currentFrame++;\n  $('.mirrorVideoHolder').css('opacity', '0.88');\n  $('#snapsPreview').data('stopped', false);\n  $('.mirrorVideoHolder').css('opacity', '1');\n  if (that.currentFrame >= maxFrames) {\n    that.currentFrame = 0;\n    setTimeout(function () {\n\n      that.createGif(delay);\n      $('.mirrorVideoHolder').hide();\n      $('#snapsPreview').show();\n      $('.confirmSnap').show();\n      if (mode === 'photo') {\n        $('.retrySnap').hide();\n        $('.retrySingleSnap').show();\n        if (Object.keys(that.snaps).length > 1) {\n          $('.snapDelaySliderControl').show();\n        }\n      } else {\n        $('.continueSnap').hide();\n        $('.retrySingleSnap').hide();\n        $('.retrySnap').show();\n        $('.snapDelaySliderControl').show();\n      }\n    }, that.CAMERA_SHUTTER_DELAY); // TODO: make configurable with existing delay slider\n    return;\n  }\n  setTimeout(function () {\n    that.recordSnaps(maxFrames, delay, mode);\n  }, delay);\n};","export default function createGif (delay) {\n    let gif = new GIF({\n      workers: 2,\n      quality: 3,\n      width: 320,\n      height: 240\n    });\n  \n    gif.on('finished', function (blob) {\n      let reader = new FileReader();\n      reader.readAsDataURL(blob);\n      reader.onloadend = function () {\n        let base64data = reader.result;\n        // console.log('base64data', base64data);\n        $('#snapsPreview').attr('src', base64data);\n      };\n    });\n  \n    // TODO: closer ref?\n    $('.gifFrames img', this.cameraWindow.content).each(function (i, e) {\n      // console.log(\"adding frames to gif\", e, delay);\n      gif.addFrame(e, { delay: delay });\n    });\n  \n    gif.render();\n  };","\nexport default function takeSnap () {\n    let that = this;\n    let bp = this.bp;\n    //$('#mirrorCanvasMe').css('width', 640);\n    //$('#mirrorCanvasMe').css('height', 480);\n    $('.recordSnap').hide();\n\n    if (!this.bp.settings.mirror_snaps_camera_countdown_enabled) {\n      if (that.currentFrame === 0) {\n        // this.bp.play('desktop/assets/audio/CAMERA_SNAP.wav');\n        setTimeout(function () {\n          that.recordSnaps(10, 100, 'film');\n        }, 44);\n        return;\n      }\n    }\n\n  \n    bp.play('desktop/assets/audio/CAMERA_COUNTDOWN.wav');\n    $('.snapCountDown').show();\n    setTimeout(function () {\n      $('.snapCountDown').html('2...');\n      setTimeout(function () {\n        $('.snapCountDown').html('1...');\n        setTimeout(function () {\n          $('.snapCountDown').hide();\n          $('.snapCountDown').html('3...');\n          setTimeout(function () {\n            if (that.currentFrame === 0) {\n              setTimeout(function () {\n                that.recordSnaps(10, 100, 'film');\n              }, 44);\n            }\n          }, 333);\n        }, 1000);\n      }, 1000);\n    }, 1000);\n  };"],"names":["Camera","constructor","bp","options","this","allDevices","devices","videoinput","audioinput","audiooutput","mode","fullMirror","showingControls","viewMode","selectedCameraIndex","MAX_FRAMES_PER_SNAP","DEFAULT_SNAP_TIMER","CAMERA_SHUTTER_DELAY","currentFrame","snaps","init","log","load","appendScript","html","open","cameraWindow","apps","ui","windowManager","createWindow","id","title","x","y","width","height","minWidth","minHeight","parent","$","icon","content","resizable","minimizable","maximizable","closable","focusable","maximized","minimized","onClose","makingSnap","cancelSnap","localStream","getTracks","forEach","track","stop","css","show","bindUIEvents","snapContext","context","snapType","type","attr","enumerateDevices","firstCamera","Object","keys","label","startCamera","focusWindow","prototype","async","navigator","mediaDevices","cameraCount","device","i","index","kind","selected","append","err","console","error","deviceLabel","that","deviceId","getUserMedia","video","audio","then","stream","val","document","querySelector","onplay","srcObject","fadeOut","catch","toggleMirrorControls","hide","showMirrorControls","length","container","resize","resizeFullVideo","slider","value","min","max","change","event","inversedValue","snapDelay","data","createGif","on","newDeviceLabel","set","JSManipulate","filter","ev","canvasVideo","currentTarget","toLowerCase","window","CanvasVideo","bindPlayEvent","snapsGIF","takeSingleSnap","takeSnap","url","replace","close","buddypond","sendSnaps","uploadedUrl","message","to","from","me","text","emit","settings","mirror_snaps_camera_countdown_enabled","prop","alert","play","setTimeout","recordSnaps","maxFrames","delay","destinationCanvas","getElementById","destCtx","getContext","tryHard","scale","drawImage","imagebase64data","toDataURL","gifbase64data","push","gif","GIF","workers","quality","blob","reader","FileReader","readAsDataURL","onloadend","base64data","result","each","e","addFrame","render"],"mappings":"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"}