class t{constructor(t,i={}){return this.bp=t,this.options=i,this.numStrings=8,this.lastPlucked={},this.stringVibrations=Array(this.numStrings).fill(0),this.lastPluckTime=Array(this.numStrings).fill(0),this.cooldown=100,this.fingerPositions={},this.velocityThreshold=.05,this.fingerTrails={},this.trailDuration=500,this}async init(){return await this.bp.appendScript("https://cdn.jsdelivr.net/npm/@mediapipe/hands"),await this.bp.appendScript("https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils"),await this.bp.appendScript("https://cdnjs.cloudflare.com/ajax/libs/tone/15.2.6/Tone.js"),await this.bp.appendCSS("/v5/apps/based/vision-harp/vision-harp.css"),this.html=await this.bp.load("/v5/apps/based/vision-harp/vision-harp.html"),"loaded VisionInstrument"}async open(){if(this.win)return console.log("VisionInstrument window is already open"),this.win.restore(),this.win.focus(),this.win;this.win=this.bp.window(this.window()),this.synth=new Tone.PolySynth(Tone.FMSynth,{harmonicity:3,modulationIndex:10,oscillator:{type:"sine"},envelope:{attack:.01,decay:.2,sustain:.5,release:1.5}});const t=new Tone.Chorus(4,2.5,.3).start(),i=new Tone.Reverb({decay:3,wet:.4}).toDestination(),n=new Tone.Gain(.7).connect(t).connect(i);return this.synth.connect(n),n.toDestination(),this.startLoadingSequence(),this.startVisionInstrument(),this.win.maximize(),this.win}window(){return{id:"vision-harp",title:"Vision Harp",icon:"desktop/assets/images/icons/icon_vision-harp_64.png",x:300,y:100,width:700,height:520,minWidth:400,content:this.html,parent:$("#desktop")[0],resizable:!0,maximizable:!0,closable:!0,onClose:()=>{this.win=null,this.video.srcObject.getTracks().forEach((t=>t.stop())),this.video=null}}}async startVisionInstrument(){this.video=document.getElementById("video");const t=document.getElementById("canvas"),i=t.getContext("2d"),n=document.getElementById("note-indicator"),s=await navigator.mediaDevices.getUserMedia({video:!0});this.video.srcObject=s,await new Promise((t=>this.video.onloadeddata=t)),this.video.play();const e=new Hands({locateFile:t=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${t}`});e.setOptions({maxNumHands:2,modelComplexity:1,minDetectionConfidence:.7,minTrackingConfidence:.7,selfieMode:!0});new Camera(this.video,{onFrame:async()=>await e.send({image:this.video}),width:640,height:480}).start();let a=!1;e.onResults((s=>{a||(a=!0,$(".vision-harp-loading",this.win.content).fadeOut(300)),i.clearRect(0,0,t.width,t.height);const e=t.width,o=t.height;for(let t=0;t<this.numStrings;t++){const n=t*e/this.numStrings+e/(2*this.numStrings),s=this.stringVibrations[t],a=Math.sin(Date.now()/30)*s*5;i.beginPath(),i.moveTo(n+a,0),i.lineTo(n-a,o);const r=360*t/this.numStrings%360;i.strokeStyle=`hsla(${r}, 70%, 70%, 0.8)`,i.lineWidth=2+s,i.stroke(),this.stringVibrations[t]*=.9}if(s.multiHandLandmarks){for(let t=0;t<s.multiHandLandmarks.length;t++){const a=s.multiHandLandmarks[t],r=[4,8,12,16,20];for(let s=0;s<r.length;s++){const h=r[s];if(!this.isFingerExtended(a,h))continue;const l=a[r[s]],c=l.x*e,d=l.y*o;i.beginPath(),i.arc(c,d,6,0,2*Math.PI),i.fillStyle="rgba(255,255,255,0.85)",i.fill();const g=`${t}-${s}`;this.fingerTrails[g]||(this.fingerTrails[g]=[]),this.fingerTrails[g].push({x:c,y:d,time:Date.now()}),this.fingerTrails[g]=this.fingerTrails[g].filter((t=>Date.now()-t.time<this.trailDuration));const m=e/this.numStrings,p=m/2,y=Math.floor((c+p)/m);let u=0;if(this.fingerPositions[g]){const t=this.fingerPositions[g],i=c-t.x,n=d-t.y;u=Math.sqrt(i*i+n*n)}this.fingerPositions[g]={x:c,y:d},u>this.velocityThreshold&&this.lastPlucked[g]!==y&&(this.playNote(y),this.lastPlucked[g]=y,n.innerText=`ðŸŽµ Finger ${s+1} hit string ${y+1}`)}}for(const t of Object.values(this.fingerTrails))for(const n of t){const t=1-(Date.now()-n.time)/this.trailDuration;i.beginPath(),i.arc(n.x,n.y,5,0,2*Math.PI),i.fillStyle=`rgba(0, 255, 255, ${t.toFixed(2)})`,i.fill()}}else this.fingerPositions={}}))}isFingerExtended(t,i){const n=t[i-3],s=t[i-2],e=t[i-1],a=t[i],o={x:e.x-a.x,y:e.y-a.y},r={x:s.x-e.x,y:s.y-e.y},h={x:n.x-s.x,y:n.y-s.y},l=o.x*r.x+o.y*r.y,c=r.x*h.x+r.y*h.y,d=Math.hypot(o.x,o.y),g=Math.hypot(r.x,r.y),m=Math.hypot(h.x,h.y),p=Math.acos(l/(d*g)),y=Math.acos(c/(g*m));return p<.5&&y<.5}playNote(t,i=1){const n=Date.now();if(n-this.lastPluckTime[t]<this.cooldown)return;const s=["C4","D4","E4","G4","A4","C5","D5","E5"],e=s[t%s.length];try{const s=Math.min(1,Math.max(.1,2*i));this.synth.set({volume:20*s-20}),this.synth.triggerAttackRelease(e,"8n"),this.stringVibrations[t]=i,this.lastPluckTime[t]=n}catch(t){console.warn("Error playing note:",t)}}startLoadingSequence(){const t=["Initializing camera...","Loading vision model...","Warming up tensors...","Calibrating hand gestures...","Initializing Synth...","Finalizing setup..."];let i=0;const n=$("#loading-text",this.win.content),s=setInterval((()=>{n.text(t[i]),i++,i>=t.length&&clearInterval(s)}),1200)}}export{t as default};
//# sourceMappingURL=vision-harp.js.map
